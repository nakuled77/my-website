<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelpBuddy - Service Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 40px; max-width: 1200px; margin: 0 auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-container { display: flex; align-items: center; gap: 10px; font-size: 28px; font-weight: 700; color: #667eea; }
        .user-menu { position: relative; }
        .user-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .user-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 10px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); min-width: 180px; display: none; z-index: 1000; overflow: hidden; }
        .user-dropdown.active { display: block; animation: dropdownSlide 0.2s ease-out; }
        /* Auto-uppercase for address fields */
.uppercase-input {
    text-transform: uppercase;
}
        @media (max-width: 480px) {
            .dashboard-header { margin-bottom: 15px; padding-bottom: 12px; }
            .header-left { gap: 10px; }
            .logo-container { font-size: 22px; }
            .user-button { padding: 8px 12px; font-size: 12px; }
            .user-dropdown { min-width: 160px; }
        }
        @keyframes dropdownSlide { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-item { padding: 12px 20px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; color: #333; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f8f9fa; color: #667eea; }
	.dropdown-separator { height: 1px; background: #e0e0e0; margin: 8px 0; }
	h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        h2 { color: #333; margin-bottom: 20px; font-size: 1.5em; }
        h3 { color: #667eea; margin: 20px 0 15px; font-size: 1.2em; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; font-family: inherit; }
        textarea { resize: vertical; min-height: 100px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { padding: 14px 24px; background: #128C7E; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
	.btn:hover { background: #0d6b5f; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(18, 140, 126, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; background: #95a5a6; }
        .btn-full { width: 100%; }
        .btn-secondary { background: #34495e; margin-left: 10px; }
        .btn-respond { background: #128C7E; padding: 8px 16px; font-size: 14px; }
        .btn-select { background: #128C7E; padding: 8px 16px; font-size: 14px; }
        .btn-view-profile { background: #34495e; padding: 8px 16px; font-size: 14px; }
        .btn-cancel { background: #e74c3c; padding: 8px 16px; font-size: 14px; }
        .btn-edit { background: #34495e; padding: 8px 16px; font-size: 14px; color: white; }
        .btn-chat { background: #128C7E; padding: 8px 16px; font-size: 14px; }
        /* Chat button with unread badge */
.chat-btn-wrapper {
    position: relative;
    display: inline-block;
}

.chat-unread-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 18px;
    height: 18px;
    background: #dc3545;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: white;
    padding: 0 5px;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.5);
    border: 2px solid white;
    z-index: 10;
}
	.btn-complete { background: #27ae60; padding: 10px 20px; font-size: 14px; }
        .btn-contact { background: #34495e; padding: 10px 20px; font-size: 14px; }
        
        @media (max-width: 480px) {
            .btn { padding: 10px 16px; font-size: 13px; border-radius: 6px; }
            .btn-full { width: 100%; margin-top: 10px; }
            .btn-secondary { margin-left: 0; margin-top: 8px; width: 100%; }
            .btn-respond, .btn-select, .btn-view-profile, .btn-cancel, .btn-edit, .btn-chat { padding: 6px 10px; font-size: 11px; }
            .btn-complete, .btn-contact { padding: 8px 14px; font-size: 12px; }
        }
        .error { background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .success { background: #efe; border: 1px solid #cfc; color: #3c3; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        /* Success Popup Overlay */
.success-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999999;
    display: none;
    align-items: center;
    justify-content: center;
}

.success-popup-overlay.active {
    display: flex;
}

.success-popup-content {
    background: white;
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: popupSlideIn 0.3s ease-out;
}

@keyframes popupSlideIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.success-popup-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.success-popup-title {
    font-size: 24px;
    font-weight: 700;
    color: #28a745;
    margin-bottom: 15px;
}

.success-popup-message {
    font-size: 16px;
    color: #555;
    line-height: 1.6;
}
	.info { background: #e3f2fd; border: 1px solid #90caf9; color: #1976d2; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .hidden { display: none; }
	/* Chat View Overlay */
#chatView {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    background: white;
}
#chatView.hidden {
    display: none;
}

	.hidden-for-unregistered { display: none !important; }
        .profile-info { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
        .profile-info p { margin-bottom: 10px; color: #555; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input { width: auto; }
        .required { color: #e74c3c; }
        .char-counter { font-size: 12px; color: #999; text-align: right; margin-top: 5px; }
        .urgency-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .urgency-option { flex: 1; min-width: 150px; }
        .urgency-option input[type="radio"] { display: none; }
        .urgency-label { display: block; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .urgency-option input[type="radio"]:checked + .urgency-label { border-color: #667eea; background: #f0f4ff; font-weight: 600; }
        .urgency-label:hover { border-color: #667eea; }
        .request-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .request-card:hover { box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-color: #667eea; transform: translateY(-2px); }
        .request-card.compact { 
    padding: 18px 20px; 
    margin-bottom: 24px; 
    background: #ffffff; 
    border: 3px solid #d0d0d0; 
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}
.request-card.compact:last-child { margin-bottom: 0; }
        .request-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .request-card-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .request-card-left { flex: 1; min-width: 200px; }
        .request-card-right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        /* DESKTOP LAYOUT - MY RESPONSES (applies when NOT on mobile) */
#myResponsesList .request-card-main {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    gap: 10px !important;
}

#myResponsesList .request-card-left {
    flex: 1 !important;
    min-width: 200px !important;
}

#myResponsesList .request-card-right {
    display: flex !important;
    gap: 8px !important;
    flex-wrap: wrap !important;
    align-items: center !important;
    margin-left: 20px !important;
}
/* Desktop: request-summary should display inline */
#myResponsesList .request-summary {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    align-items: center !important;
}

/* Hide Button 2 (desktop button in request-card-right) on BOTH desktop and mobile */
#openRequestsList .request-card-right,
#activeRequestsList .request-card-right {
    display: none !important;
}

/* Desktop: Force button to extreme right - COMPLETE */
div#openRequestsList div.request-card-left div.request-summary:nth-of-type(1),
div#activeRequestsList div.request-card-left div.request-summary:nth-of-type(1) {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: flex-start !important;
    width: 100% !important;
    gap: 0 !important;
}

div#openRequestsList div.request-card-left div.request-summary:nth-of-type(1) > button.btn-select-mobile,
div#activeRequestsList div.request-card-left div.request-summary:nth-of-type(1) > button.btn-select-mobile {
    margin-left: auto !important;
    flex-shrink: 0 !important;
    order: 999 !important;
}
#openRequestsList .request-card-left .request-summary:nth-of-type(1) .btn-select-mobile,
#activeRequestsList .request-card-left .request-summary:nth-of-type(1) .btn-select-mobile {
    margin-left: auto !important;
    flex-shrink: 0 !important;
}
        @media (max-width: 480px) {
            .request-card.compact { 
                padding: 12px 14px; 
                margin-bottom: 16px; 
                border: 2px solid #d0d0d0;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }

		/* Mobile section headers - show on mobile */
.mobile-section-header {
    display: block !important;
}
            .request-card-main { flex-direction: column; align-items: flex-start; gap: 8px; }
            .request-card-left { min-width: 100%; }
            .request-card-right { width: 100%; justify-content: space-between; gap: 6px; }
        }
        .request-title-compact { 
    font-size: 16px; 
    font-weight: 600; 
    color: #667eea; /* ğŸ‘ˆ CHANGED: Purple theme color */
    margin-bottom: 8px; 
    line-height: 1.3;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: -8px -12px 8px -12px;
}

.request-title-compact:hover {
    background: rgba(102, 126, 234, 0.1); /* ğŸ‘ˆ CHANGED: Stronger purple background */
    color: #5568d3; /* ğŸ‘ˆ NEW: Darker purple on hover */
}

.request-title-compact:hover {
    background: rgba(102, 126, 234, 0.05);
}

.request-title-text {
    flex: 1;
}

.request-chevron {
    font-size: 14px;
    transition: transform 0.3s ease;
    color: #667eea;
    font-weight: bold;
}

.request-chevron.expanded {
    transform: rotate(180deg);
}
        /* Urgency bubble indicator */
.urgency-bubble {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    flex-shrink: 0;
}

.urgency-bubble.urgent {
    background: #dc3545;
}

.urgency-bubble.normal {
    background: #ffc107;
}

.urgency-bubble.low {
    background: #28a745;
}

/* Clickable request title */
.request-title-clickable {
    color: #667eea;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
}

.request-title-clickable:hover {
    color: #5568d3;
    text-decoration: underline;
}
	.request-summary { font-size: 13px; color: #666; line-height: 1.4; }
        .request-details { margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0; display: none; }
        .request-details.expanded { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .expand-btn { background: none; border: none; color: #667eea; font-size: 12px; font-weight: 600; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .expand-btn:hover { background: #f0f4ff; }
        .notification-badge { background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .urgent-indicator { background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
        .info-badge { background: #17a2b8; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .action-btn-compact { padding: 8px 14px; font-size: 13px; border-radius: 6px; font-weight: 600; }
        .section-summary { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
        .stat-badge { background: #f0f4ff; color: #667eea; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; border: 1px solid #d0d9ff; }
        .request-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .request-meta { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .meta-item { font-size: 13px; color: #666; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-open { background: #d4edda; color: #155724; }
        .status-in-progress { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .urgency-urgent { color: #dc3545; font-weight: 600; }
        .urgency-normal { color: #ffc107; font-weight: 600; }
        .urgency-low { color: #28a745; font-weight: 600; }
        .request-description { color: #555; margin-bottom: 15px; line-height: 1.5; }
        .request-location { font-size: 14px; color: #666; margin-bottom: 15px; }
        .request-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .response-badge { display: inline-block; background: #007bff; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 10px; }
        .distance-badge { display: inline-block; background: #17a2b8; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-state-text { font-size: 18px; margin-bottom: 30px; }
        .request-limit-warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 500; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .collapsible-section { margin-bottom: 25px; }
        .section-toggle { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; padding: 18px 24px; width: 100%; text-align: left; cursor: pointer; font-size: 16px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .section-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4); }
        .section-toggle:active { transform: translateY(0); }
        .section-toggle-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .section-toggle-right { 
    display: flex; 
    align-items: center; 
    gap: 8px;
    flex-wrap: nowrap;
    justify-content: flex-end;
}
        .toggle-icon { font-size: 20px; transition: transform 0.3s; }
        .toggle-icon.expanded { transform: rotate(180deg); }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .section-content.expanded { max-height: 5000px; transition: max-height 0.5s ease-in; }
        .section-inner { padding: 20px 0 0 0; }
        .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .sub-tab { 
    background: white; 
    border: 2px solid #e0e0e0; 
    color: #666; 
    padding: 10px 14px; 
    border-radius: 10px; 
    cursor: pointer; 
    font-weight: 600; 
    font-size: 13px; 
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex: 1;
    min-width: 0;
    position: relative;
    justify-content: center;
}

.sub-tab > span:first-child {
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    text-align: center;
}

/* Badge row container - holds count + message badges side by side */
.sub-tab-badges {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-wrap: nowrap;
}

.sub-tab .count-badge {
    margin-top: 0;
}

.sub-tab .badge-container {
    margin-top: 0;
}

.sub-tab:hover { 
    border-color: #4285F4; 
    color: #4285F4; 
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
}

.sub-tab.active { 
    background: #4285F4; 
    border-color: #4285F4; 
    color: white;
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
}

.sub-tab.active .count-badge {
    background: rgba(255, 255, 255, 0.3);
    color: white;
}
        .section-toggle { 
    background: linear-gradient(135deg, #4285F4 0%, #34A853 100%); 
    color: white; 
    border: none; 
    border-radius: 12px; 
    padding: 18px 24px; 
    width: 100%; 
    text-align: left; 
    cursor: pointer; 
    font-size: 16px; 
    font-weight: 700; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    transition: all 0.3s; 
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); 
}

.section-toggle:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 6px 16px rgba(66, 133, 244, 0.4); 
}

.count-badge { 
    background: #4285F4; 
    color: white; 
    padding: 4px 10px; 
    border-radius: 12px; 
    font-size: 11px; 
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    text-align: center;
    flex-shrink: 0;
}

.sub-tab .count-badge {
    background: rgba(66, 133, 244, 0.15);
    color: #4285F4;
}

.sub-tab.active .count-badge {
    background: rgba(255, 255, 255, 0.3);
    color: white;
}

/* Chat Bubble Badge Container */
.badge-container {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: relative;
    flex-shrink: 0;
}

/* The Chat Bubble Icon */
.chat-bubble-icon {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    border-radius: 50% 50% 50% 0;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);
    flex-shrink: 0;
    transform: rotate(-45deg);
}

/* White dots inside bubble (optional decorative element) */
.chat-bubble-icon::before {
    content: 'ğŸ’¬';
    position: absolute;
    font-size: 16px;
    transform: rotate(45deg);
    filter: brightness(0) invert(1);
}

/* Red Badge (number circle) */
.unread-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 18px;
    height: 18px;
    background: #dc3545;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: white;
    padding: 0 5px;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.5);
    border: 2px solid white;
    z-index: 10;
}
	.two-column { 
    display: block; /* Changed from 'grid' to 'block' */
    margin-top: 30px; 
}
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification-count { background: #dc3545; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .autocomplete-suggestions { position: absolute; background: white; border: 2px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: calc(100% - 4px); margin-top: -2px; }
        .autocomplete-suggestions.active { display: block; }
        .suggestion-item { padding: 12px 15px; cursor: pointer; transition: background 0.2s; font-size: 14px; color: #333; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: #f0f4ff; color: #667eea; }
        .suggestion-item.loading { text-align: center; color: #999; font-style: italic; }
	.modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.5); 
    z-index: 99999; 
    align-items: center; 
    justify-content: center; 
}
.modal.active { 
    display: flex !important; 
    visibility: visible !important;
}
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 24px; font-weight: 600; color: #333; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .close-btn:hover { color: #333; }
        .provider-card { background: #f5f5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .provider-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .provider-info { font-size: 13px; color: #666; margin-bottom: 8px; }
        .rating-display { font-size: 14px; color: #667eea; font-weight: 600; margin-bottom: 12px; }
        .provider-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .profile-modal-content { background: white; border-radius: 12px; padding: 20px; }
        .profile-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .profile-details { color: #555; line-height: 1.8; }
        .profile-details p { margin-bottom: 10px; }
        /* Chat Styles */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 100px); max-height: 700px; background: #ECE5DD; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .chat-header { background: #128C7E; color: white; padding: 16px 20px; border-radius: 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-header-left { flex: 1; display: flex; flex-direction: column; }
        .chat-partner-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; letter-spacing: 0; }
        .chat-status { font-size: 13px; opacity: 0.9; font-weight: 400; }
        
        @media (max-width: 480px) {
            .chat-container { border-radius: 0; height: calc(100vh - 80px); }
            .chat-header { padding: 12px 16px; }
            .chat-partner-name { font-size: 16px; margin-bottom: 3px; }
            .chat-status { font-size: 12px; }
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px 12px; background: #ECE5DD; display: flex; flex-direction: column; gap: 8px; }
        .message { display: flex; flex-direction: column; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { align-items: flex-end; }
        .message.received { align-items: flex-start; }
        .message-bubble { max-width: 65%; padding: 14px 18px; border-radius: 18px; word-wrap: break-word; line-height: 1.4; font-size: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
        .message.sent .message-bubble { background: #DCF8C6; color: #000; border-radius: 8px 8px 0 8px; font-weight: 400; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); border: none; }
        .message.received .message-bubble { background: #FFFFFF; color: #000; border: none; border-radius: 8px 8px 8px 0; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .message-time { font-size: 12px; color: #999; margin-top: 6px; padding: 0 6px; }
        .message-image { max-width: 100%; max-height: 280px; border-radius: 12px; margin-top: 10px; cursor: pointer; transition: transform 0.2s; }
        .message-image:hover { transform: scale(1.02); }
        .empty-chat-state { display: flex; align-items: center; justify-content: center; height: 100%; color: #999; text-align: center; padding: 20px; }
        .empty-chat-state-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-chat-state-text { font-size: 16px; color: #666; }
        
        .chat-templates { background: #f0f2f5; padding: 16px; border-top: 2px solid #e8e8e8; max-height: 220px; overflow-y: auto; }
        .template-category { margin-bottom: 12px; }
        .template-category:last-child { margin-bottom: 0; }
        .template-category-title { font-weight: 700; color: #667eea; font-size: 13px; cursor: pointer; user-select: none; padding: 10px 12px; background: white; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #667eea; }
        .template-category-title:hover { background: #e9ecef; transform: translateX(2px); }
        .template-items { margin-top: 8px; margin-left: 0; display: none; padding: 0 8px; }
        .template-items.open { display: flex; flex-direction: column; gap: 6px; animation: expandDown 0.2s ease-out; }
        @keyframes expandDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .template-item { padding: 10px 14px; background: white; border-radius: 8px; margin-bottom: 0; font-size: 13px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; color: #555; font-weight: 500; line-height: 1.3; }
        .template-item:hover { background: #667eea; color: white; border-left-color: #764ba2; transform: translateX(4px); box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2); }
        
        .chat-input-area { background: #F0F0F0; padding: 12px 16px; border-top: 1px solid #ddd; border-radius: 0; }
        .privacy-notice { background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); padding: 14px 16px; border-radius: 10px; font-size: 13px; color: #7d5d00; margin-bottom: 16px; border-left: 4px solid #ffc107; display: none; gap: 10px; align-items: flex-start; }
.privacy-notice.show { display: flex; }
.privacy-notice strong { color: #5d4700; font-weight: 700; }
.privacy-info-icon { 
    width: 20px; 
    height: 20px; 
    border-radius: 50%; 
    background: #667eea; 
    color: white; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: 700; 
    font-size: 14px; 
    cursor: pointer; 
    margin-left: 8px; 
    transition: all 0.2s;
}
.privacy-info-icon:hover { background: #764ba2; transform: scale(1.1); }
.chat-action-buttons { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .chat-action-buttons .btn { padding: 10px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; transition: all 0.2s; }
        .contact-request-card { background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); padding: 16px; border-radius: 12px; margin: 10px 0; border-left: 4px solid #ffc107; }
.contact-request-title { font-weight: 700; color: #5d4700; margin-bottom: 10px; font-size: 14px; }
.contact-approval-buttons { display: flex; gap: 10px; margin-top: 12px; }
.btn-approve { background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
.btn-approve:hover { background: #218838; }
.btn-decline { background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
.btn-decline:hover { background: #c82333; }
.contact-status-approved { background: #d4edda; border-left-color: #28a745; color: #155724; }
.contact-status-declined { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
.contact-details-card { background: #e3f2fd; padding: 14px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #2196f3; }
.contact-details-card p { margin: 6px 0; font-size: 13px; color: #0d47a1; }
	.contact-details-card p { margin: 6px 0; font-size: 13px; color: #0d47a1; }

.contact-icon-btn {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    margin: 15px 10px;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    width: calc(100% - 20px);
    justify-content: center;
}
.contact-icon-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
}
.contact-details-card.collapsed {
    display: none;
}
	.chat-input-wrapper { display: flex; gap: 8px; align-items: center; }
        .chat-input-wrapper textarea { flex: 1; min-height: 42px; max-height: 120px; padding: 10px 14px; border: none; border-radius: 21px; font-family: inherit; font-size: 15px; resize: none; background: white; transition: all 0.2s; }
        .chat-input-wrapper textarea:focus { outline: none; box-shadow: 0 0 2px rgba(0, 0, 0, 0.1); }
        .chat-input-wrapper .btn { padding: 12px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; }
.file-input-label { background: #6c757d; color: white; padding: 11px 13px; border-radius: 8px; cursor: pointer; font-size: 18px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 48px; }
.file-input-label:hover { background: #5a6268; transform: scale(1.05); }
.plus-button { background: #6c757d; color: white; padding: 11px 13px; border-radius: 8px; cursor: pointer; font-size: 20px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 48px; border: none; }
.plus-button:hover { background: #5a6268; transform: scale(1.05); }
.template-button { display: inline-flex; }
.template-button.hide { display: none; }
.btn-send { display: none; padding: 12px; min-width: 48px; background: #128C7E; border-radius: 50%; }
.btn-send.show { display: inline-flex; align-items: center; justify-content: center; }
.btn-send:hover { background: #0d6b5f; }
        
        /* Warranty Form */
        .warranty-form { background: linear-gradient(135deg, #f0f4ff 0%, #f8f9fa 100%); padding: 18px; border-radius: 12px; margin-top: 16px; border: 2px solid #e8ecff; }
        .warranty-form h3 { margin-top: 0; margin-bottom: 16px; color: #333; font-size: 15px; font-weight: 700; }
        .warranty-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .warranty-option { flex: 1; min-width: 110px; }
        .warranty-option input[type="radio"] { display: none; }
        .warranty-option label { display: block; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 600; font-size: 13px; color: #555; }
        .warranty-option input[type="radio"]:checked + label { border-color: #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #e9ecff 100%); color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .warranty-form .btn { margin-top: 16px; font-size: 14px; }
        
/* Template Modal Styles */
        .template-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center; }
        .template-modal.active { display: flex; }
        .template-modal-content { background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; max-height: 70vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .template-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .template-modal-title { font-size: 20px; font-weight: 700; color: #333; }
        .template-close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; transition: color 0.2s; }
        .template-close-btn:hover { color: #333; }
        .template-categories { display: flex; flex-direction: column; gap: 16px; }
        .template-category-block { border: 1.5px solid #e8e8e8; border-radius: 12px; overflow: hidden; }
        .template-category-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 16px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; user-select: none; }
        .template-category-header:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .template-category-items { display: none; background: #f9f9f9; }
        .template-category-items.open { display: flex; flex-direction: column; }
        .template-option { padding: 12px 16px; border-bottom: 1px solid #e8e8e8; cursor: pointer; transition: all 0.2s; font-size: 13px; color: #555; line-height: 1.4; }
        .template-option:last-child { border-bottom: none; }
        .template-option:hover { background: #e9ecef; color: #333; padding-left: 20px; }
        .template-button { background: #667eea; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 18px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 44px; height: 44px; }
        .template-button:hover { background: #764ba2; transform: scale(1.05); }

/* Rating Modal Styles */
        .rating-stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .star { font-size: 48px; cursor: pointer; transition: all 0.2s; color: #ddd; user-select: none; }
        .star:hover { transform: scale(1.2); }
        .star.selected { color: #ffc107; }
        .star.hovered { color: #ffc107; }

        /* Mobile Responsive */
        @media (max-width: 768px) { 
            body { padding: 0; background: white; }
            .container { border-radius: 0; padding: 12px; box-shadow: none; }
            h1 { font-size: 1.8em; display: block; margin-bottom: 20px; }
            .logo-container { font-size: 18px; }
            .dashboard-header { margin-bottom: 20px; padding-bottom: 15px; }
            .user-button { padding: 8px 16px; font-size: 13px; }
            .row { grid-template-columns: 1fr; } 
            .two-column { grid-template-columns: 1fr; gap: 20px; }
            .section-toggle { padding: 14px 16px; font-size: 14px; border-radius: 8px; }
            .count-badge { font-size: 11px; padding: 3px 8px; }
            .request-card.compact { padding: 14px 16px; margin-bottom: 12px; }
            .request-title-compact { font-size: 15px; }
            .request-summary { font-size: 12px; }
            .request-card-right { width: 100%; justify-content: flex-start; margin-top: 10px; }
            .btn { padding: 11px 20px; font-size: 14px; }
            .action-btn-compact { padding: 8px 12px; font-size: 12px; }
            .btn-secondary { margin-left: 0; margin-top: 10px; }
            .request-actions { flex-direction: column; }
            .urgency-group { flex-direction: column; gap: 10px; }
            .urgency-option { min-width: 100%; }
            .urgency-label { padding: 14px; font-size: 14px; }
            .sub-tabs { gap: 8px; }
            .sub-tab { padding: 8px 14px; font-size: 13px; }
            .modal-content { max-width: 95%; padding: 20px; border-radius: 12px; }
            .modal-title { font-size: 18px; }
            .chat-container { height: calc(100vh - 60px); max-height: none; border-radius: 0; }
            .chat-header { padding: 14px 16px; }
            .chat-partner-name { font-size: 16px; }
            .chat-status { font-size: 12px; }
            .chat-messages { padding: 16px 12px; gap: 8px; }
            .message-bubble { max-width: 80%; padding: 10px 14px; font-size: 14px; }
            .chat-input-area { padding: 12px; }
            .chat-input-wrapper { gap: 8px; }
            .chat-input-wrapper textarea { min-height: 44px; font-size: 14px; padding: 10px 12px; }
            .chat-input-wrapper .btn { padding: 11px 20px; font-size: 14px; }
            .file-input-label { min-width: 44px; padding: 11px; }
            .template-button { min-width: 44px; height: 44px; }
            .privacy-notice { padding: 10px 12px; font-size: 12px; margin-bottom: 12px; }
            .contact-request-card { padding: 12px; font-size: 12px; }
            .contact-approval-buttons { flex-direction: column; }
            .btn-approve, .btn-decline { width: 100%; }
            .warranty-options { flex-direction: column; }
            .warranty-option { min-width: 100%; }
            .provider-card { padding: 14px; }
            .provider-actions { flex-direction: column; }
            .provider-actions .btn { width: 100%; }
            .star { font-size: 40px; }#myResponsesList .request-summary {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 8px !important;
        align-items: center !important;
    }
    
   /* MY RESPONSES - Mobile layout (mobile only) */
#myResponsesList .request-card {
    padding: 14px !important;
}

#myResponsesList .request-card-main {
    display: block !important;
}

#myResponsesList .request-title-compact {
    width: 100% !important;
    margin-bottom: 12px !important;
}

#myResponsesList .request-card-left {
    display: block !important;
}

/* MY RESPONSES: Force chat button to extreme right - STRONGEST */
div#myResponsesList div.request-card-left div.request-summary:nth-of-type(1) {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: flex-start !important;
    width: 100% !important;
    gap: 0 !important;
    margin-bottom: 8px !important;
}

/* Status badge stays left */
div#myResponsesList div.request-card-left div.request-summary:nth-of-type(1) > span.status-badge {
    flex-shrink: 1 !important;
    white-space: nowrap !important;
}

/* Chat button to extreme right - UNBREAKABLE */
div#myResponsesList div.request-card-left div.request-summary:nth-of-type(1) > div.chat-btn-wrapper,
div#myResponsesList div.request-card-left div.request-summary:nth-of-type(1) > button.btn-chat {
    margin-left: auto !important;
    flex-shrink: 0 !important;
    order: 999 !important;
}

/* Remove the spacer span if it exists (it's not needed anymore) */
#myResponsesList .request-card-left .request-summary:nth-of-type(1) > span[style*="flex"] {
    display: none !important;
}

/* Warranty badge - Row 2: Full width */
#myResponsesList .request-card-left .request-summary:nth-of-type(2) {
    display: block !important;
    margin-bottom: 8px !important;
}

/* User info - Row 3: Full width */
#myResponsesList .request-card-left .request-summary:nth-of-type(3) {
    display: block !important;
}

#myResponsesList .btn-chat {
    margin: 0 !important;
    padding: 8px 12px !important;
    white-space: nowrap !important;
    font-size: 13px !important;
}

#myResponsesList .chat-btn-wrapper {
    display: flex !important;
    align-items: center !important;
}

/* WORK OPPORTUNITIES - Mobile layout (mobile only) */
#nearbyRequestsList .request-card {
    padding: 14px !important;
}

#nearbyRequestsList .request-card-main {
    display: block !important;
}

#nearbyRequestsList .request-title-compact {
    width: 100% !important;
    margin-bottom: 12px !important;
}

#nearbyRequestsList .request-card-left {
    display: block !important;
}

/* First request-summary row (badges) - keep inline */
#nearbyRequestsList .request-card-left .request-summary:nth-of-type(1) {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    align-items: center !important;
    margin-bottom: 8px !important;
}

/* Second request-summary row (user info) - full width */
#nearbyRequestsList .request-card-left .request-summary:nth-of-type(2) {
    display: block !important;
    margin-bottom: 8px !important;
}

/* Respond button - moves to Row 1, extreme right */
#nearbyRequestsList .request-card-right {
    display: block !important;
    width: 100% !important;
    margin-top: -40px !important;
    text-align: right !important;
}

#nearbyRequestsList .btn-respond {
    margin: 0 !important;
    padding: 8px 12px !important;
    white-space: nowrap !important;
    font-size: 13px !important;
}

/* OPEN REQUESTS & ACTIVE REQUESTS - Mobile layout (mobile only) */
#openRequestsList .request-card,
#activeRequestsList .request-card {
    padding: 14px !important;
}

/* MOBILE: Hide Button 2 (desktop button in request-card-right) */
#openRequestsList .request-card-right,
#activeRequestsList .request-card-right {
    display: none !important;
}

#openRequestsList .request-card-main,
#activeRequestsList .request-card-main {
    display: block !important;
}

#openRequestsList .request-title-compact,
#activeRequestsList .request-title-compact {
    width: 100% !important;
    margin-bottom: 12px !important;
}

#openRequestsList .request-card-left,
#activeRequestsList .request-card-left {
    display: block !important;
}

/* First request-summary - Row 1: Status badge ONLY */
#openRequestsList .request-card-left .request-summary:nth-of-type(1),
#activeRequestsList .request-card-left .request-summary:nth-of-type(1) {
    display: flex !important;
    align-items: center !important;
    flex-wrap: nowrap !important;
    gap: 0 !important;
    margin-bottom: 8px !important;
    width: 100% !important;
    justify-content: space-between !important;
}

/* Status badge - stays on left */
#openRequestsList .request-card-left .request-summary:nth-of-type(1) .status-badge,
#activeRequestsList .request-card-left .request-summary:nth-of-type(1) .status-badge {
    flex-shrink: 1 !important;
    white-space: nowrap !important;
}

/* Button 1 - move to extreme right on mobile */
#openRequestsList .request-card-left .request-summary:nth-of-type(1) .btn-select-mobile,
#activeRequestsList .request-card-left .request-summary:nth-of-type(1) .btn-select-mobile {
    margin-left: auto !important;
    flex-shrink: 0 !important;
}

/* Second request-summary - Row 2: Responses badge (if exists) */
#openRequestsList .request-card-left .request-summary:nth-of-type(2),
#activeRequestsList .request-card-left .request-summary:nth-of-type(2) {
    display: block !important;
    margin-bottom: 8px !important;
}

/* Third request-summary - Row 3: Warranty badge (if exists) */
#openRequestsList .request-card-left .request-summary:nth-of-type(3),
#activeRequestsList .request-card-left .request-summary:nth-of-type(3) {
    display: block !important;
    margin-bottom: 8px !important;
}

/* Fourth request-summary - Row 4: Location/timestamp */
#openRequestsList .request-card-left .request-summary:nth-of-type(4),
#activeRequestsList .request-card-left .request-summary:nth-of-type(4) {
    display: block !important;
}

/* View Responses button - extreme right */
#openRequestsList .btn-select,
#activeRequestsList .btn-select {
    margin: 0 !important;
    padding: 8px 12px !important;
    white-space: nowrap !important;
    font-size: 13px !important;
}

/* Chat button with unread badge */
#openRequestsList .chat-btn-wrapper,
#activeRequestsList .chat-btn-wrapper {
    display: inline-flex !important;
    position: relative !important;
    align-items: center !important;
    margin-left: 8px !important;
}

#openRequestsList .btn-chat,
#activeRequestsList .btn-chat {
    margin: 0 !important;
    padding: 8px 12px !important;
    white-space: nowrap !important;
    font-size: 13px !important;
}

(continue with the rest of STEP 4 CSS)
		/* Dashboard logo mobile size */
		.mobile-section-header {
        display: block !important;
    }	
    #dashboardView > div:first-child { padding: 10px 0 8px 0 !important; margin-bottom: 12px !important; }
}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="appLogo">ğŸ¤ HelpBuddy</h1>
        
       <!-- Login View -->
<div id="loginView" class="hidden">
    <h2>Welcome Back</h2>
    <div id="loginError" class="error hidden"></div>
    <form id="loginForm">
        <div class="form-group">
            <label>Email <span class="required">*</span></label>
            <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
            <label>Password <span class="required">*</span></label>
            <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-full">Login</button>
        <div style="text-align: center; margin-top: 20px; font-size: 14px;">
    <a href="#" onclick="showSignup(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">Sign up for new user registration</a>
    <span style="margin: 0 10px; color: #ccc;">|</span>
    <a href="#" onclick="openForgotPasswordModal(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">Forgot Password?</a>
    <span style="margin: 0 10px; color: #ccc;">|</span>
    <a href="#" onclick="openGetHelpModal(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">Get Help</a>
</div>
    </form>
<!-- Footer for Login Page -->
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
        <div style="margin-bottom: 10px;">
            <a href="#" onclick="showTerms(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">ğŸ“œ Terms & Conditions</a>
            <span style="margin: 0 8px; color: #ccc;">|</span>
            <a href="#" onclick="showPrivacy(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">ğŸ”’ Privacy Policy</a>
        </div>
        <div style="margin-bottom: 8px; color: #888;">
            ğŸ“§ Contact: <a href="mailto:helpbuddy.assist@gmail.com" style="color: #667eea; text-decoration: underline; cursor: pointer; font-weight: 500;">helpbuddy.assist@gmail.com</a>
        </div>
        <div style="color: #999;">
            Â© 2025 HelpBuddy - Surender Singh Grewal
        </div>
    </div>
</div>

        <!-- Signup View -->
<div id="signupView" class="hidden">
    <h2>Create Account</h2>    
            <div id="signupError" class="error hidden"></div>
            <div id="signupInfo" class="info hidden"></div>
            <form id="signupForm">
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" id="signupName" required>
                </div>
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
    <label>Phone Number <span class="required">*</span></label>
    <input type="tel" id="signupPhone" pattern="[0-9]{10}" required 
           oninput="validatePhoneInput(this)" title="Enter correct number">
    <div id="signupPhoneError" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;">Enter correct number</div>
</div>
                <div class="form-group">
                    <label>Password <span class="required">*</span></label>
                    <input type="password" id="signupPassword" minlength="6" required>
                </div>
                <h3>ğŸ“ Address Details</h3>
                <div class="form-group">
                    <label>House Number</label>
                    <input type="text" id="houseNumber" class="uppercase-input">
                </div>
                <div class="form-group">
                    <label>Area Name <span class="required">*</span></label>
                    <input type="text" id="areaName" required class="uppercase-input">
                </div>
                <div class="form-group">
                    <label>Landmark</label>
                    <input type="text" id="landmark" class="uppercase-input">
                </div>
                <div class="row">
                    <div class="form-group">
    <label>City <span class="required">*</span></label>
    <input type="text" id="city" placeholder="Type your city name..." required autocomplete="off" class="uppercase-input">
    <div id="citySuggestions" class="autocomplete-suggestions"></div>
</div>
                    <div class="form-group">
    <label>State <span class="required">*</span></label>
    <select id="state" required>
        <option value="">Select State/Union Territory</option>
        <option value="Andhra Pradesh">Andhra Pradesh</option>
        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
        <option value="Assam">Assam</option>
        <option value="Bihar">Bihar</option>
        <option value="Chhattisgarh">Chhattisgarh</option>
        <option value="Goa">Goa</option>
        <option value="Gujarat">Gujarat</option>
        <option value="Haryana">Haryana</option>
        <option value="Himachal Pradesh">Himachal Pradesh</option>
        <option value="Jharkhand">Jharkhand</option>
        <option value="Karnataka">Karnataka</option>
        <option value="Kerala">Kerala</option>
        <option value="Madhya Pradesh">Madhya Pradesh</option>
        <option value="Maharashtra">Maharashtra</option>
        <option value="Manipur">Manipur</option>
        <option value="Meghalaya">Meghalaya</option>
        <option value="Mizoram">Mizoram</option>
        <option value="Nagaland">Nagaland</option>
        <option value="Odisha">Odisha</option>
        <option value="Punjab">Punjab</option>
        <option value="Rajasthan">Rajasthan</option>
        <option value="Sikkim">Sikkim</option>
        <option value="Tamil Nadu">Tamil Nadu</option>
        <option value="Telangana">Telangana</option>
        <option value="Tripura">Tripura</option>
        <option value="Uttar Pradesh">Uttar Pradesh</option>
        <option value="Uttarakhand">Uttarakhand</option>
        <option value="West Bengal">West Bengal</option>
        <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
        <option value="Chandigarh">Chandigarh</option>
        <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
        <option value="National Capital Territory of Delhi">National Capital Territory of Delhi</option>
        <option value="Jammu and Kashmir">Jammu and Kashmir</option>
        <option value="Ladakh">Ladakh</option>
        <option value="Lakshadweep">Lakshadweep</option>
        <option value="Puducherry">Puducherry</option>
    </select>
</div>
                </div>
                <div class="form-group">
                    <label>PIN Code <span class="required">*</span></label>
                    <input type="text" id="pinCode" pattern="[0-9]{6}" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="isProvider" onchange="toggleProviderFieldsSignup()">
                    <label for="isProvider" style="margin: 0;">I want to provide services</label>
                </div>
                
                <div id="signupProviderFields" class="hidden">
                    <h3>ğŸ”§ Provider Settings</h3>
                    <div class="form-group">
                        <label>Service Radius <span class="required">*</span></label>
                        <select id="signupRadius">
                            <option value="2">2 km</option>
                            <option value="5">5 km</option>
                            <option value="10" selected>10 km</option>
                            <option value="15">15 km</option>
                            <option value="20">20 km</option>
                            <option value="30">30 km</option>
                            <option value="50">50 km</option>
                        </select>
                    </div>
                       
                    <div class="form-group">
                        <label>Services I Provide <span class="required">*</span></label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_electrician" value="electrician">
                                <label for="service_electrician" style="margin: 0;">ğŸ”§ Electrician</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_plumber" value="plumber">
                                <label for="service_plumber" style="margin: 0;">ğŸš° Plumber</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_ac_repair" value="ac_repair">
                                <label for="service_ac_repair" style="margin: 0;">â„ï¸ AC Repair</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_carpenter" value="carpenter">
                                <label for="service_carpenter" style="margin: 0;">ğŸ”¨ Carpenter</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_painter" value="painter">
                                <label for="service_painter" style="margin: 0;">ğŸ¨ Painter</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_cleaner" value="cleaner">
                                <label for="service_cleaner" style="margin: 0;">ğŸ§¹ Cleaner</label>
                            </div>
                        </div>
                    </div>
                </div>

		<!-- âœ… Terms & Conditions Checkbox - ADD THIS -->
<div class="checkbox-group" style="margin-top: 30px; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
    <input type="checkbox" id="acceptTerms" required style="width: 20px !important; height: 20px !important; margin: 0 10px 0 0 !important; cursor: pointer !important; flex-shrink: 0 !important;">
    <label for="acceptTerms" style="margin: 0 !important; cursor: pointer !important; flex: 1 !important; line-height: 1.6 !important; color: #856404; font-weight: 500;">
        I agree to the 
        <a href="#" onclick="showTerms(); return false;" style="color: #667eea; text-decoration: underline; font-weight: 700;">Terms & Conditions</a>
        and 
        <a href="#" onclick="showPrivacy(); return false;" style="color: #667eea; text-decoration: underline; font-weight: 700;">Privacy Policy</a>
        <span class="required">*</span>
    </label>
</div>
                
                <button type="submit" class="btn btn-full">Sign Up</button>
                <button type="button" class="btn btn-secondary btn-full" onclick="showLogin()">Back to Login</button>
            </form>
            
            <!-- Footer for Signup Page -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
                <div style="margin-bottom: 10px;">
                    <a href="#" onclick="showTerms(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">ğŸ“œ Terms & Conditions</a>
                    <span style="margin: 0 8px; color: #ccc;">|</span>
                    <a href="#" onclick="showPrivacy(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">ğŸ”’ Privacy Policy</a>
                </div>
                <div style="margin-bottom: 8px; color: #888;">
                    ğŸ“§ Contact: <a href="mailto:helpbuddy.assist@gmail.com" style="color: #667eea; text-decoration: underline; cursor: pointer; font-weight: 500;">helpbuddy.assist@gmail.com</a>
                </div>
                <div style="color: #999;">
                    Â© 2025 HelpBuddy - Surender Singh Grewal
                </div>
            </div>
        </div>

<!-- Password Reset View -->
<div id="passwordResetView" class="hidden">
    <h2>ğŸ”‘ Reset Your Password</h2>
    <div id="passwordResetError" class="error hidden"></div>
    <div id="passwordResetInfo" class="info hidden"></div>
    
    <form id="passwordResetForm">
        <div class="form-group">
            <label>New Password <span class="required">*</span></label>
            <input type="password" id="newPassword" required minlength="6" placeholder="Enter new password (min 6 characters)">
        </div>
        
        <div class="form-group">
            <label>Confirm New Password <span class="required">*</span></label>
            <input type="password" id="confirmNewPassword" required minlength="6" placeholder="Re-enter new password">
        </div>
        
        <button type="submit" class="btn btn-full" id="resetPasswordBtn">ğŸ”’ Reset Password</button>
    </form>
    
    <!-- Footer -->
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
        <div style="color: #999;">Â© 2025 HelpBuddy - Surender Singh Grewal</div>
    </div>
</div>

<!-- Terms & Conditions View -->
<div id="termsView" class="hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px 20px 0 20px;">
        <h2 style="margin: 0; color: #667eea; font-size: 24px;">Terms & Conditions</h2>
        <button class="btn btn-secondary" onclick="closeTermsView()" style="margin: 0;">â† Back</button>
    </div>
    
    <div style="padding: 0 20px 40px 20px; max-width: 900px; margin: 0 auto;">
        <p style="color: #999; font-size: 14px; margin-bottom: 30px;">Last Updated: October 26, 2025</p>
        
        <div style="line-height: 1.8; color: #333;">
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">1. INTRODUCTION</h3>
            <p>Welcome to HelpBuddy ("Platform", "Service", "we", "us", or "our"). HelpBuddy is operated by <strong>Surender Singh Grewal</strong>, based in Bhiwani, Haryana, India.</p>
            <p>By accessing or using HelpBuddy, you agree to be bound by these Terms and Conditions ("Terms"). If you do not agree to these Terms, please do not use our Platform.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">2. DEFINITIONS</h3>
            <p><strong>"User"</strong> means any person who accesses or uses the Platform.</p>
            <p><strong>"Seeker"</strong> means a User who posts service requests.</p>
            <p><strong>"Provider"</strong> means a User who responds to service requests and offers services.</p>
            <p><strong>"Service Request"</strong> means a request for services posted by a Seeker on the Platform.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">3. PLATFORM ROLE AND LIMITATIONS</h3>
            <p><strong>3.1 Intermediary Status:</strong> HelpBuddy is ONLY a connection platform. We:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âŒ Do NOT employ service providers</li>
                <li>âŒ Do NOT guarantee service quality, timeliness, or completion</li>
                <li>âŒ Do NOT handle payments between Seekers and Providers</li>
                <li>âŒ Do NOT verify credentials, licenses, or qualifications of Providers</li>
                <li>âŒ Do NOT perform background checks on Users</li>
                <li>âŒ Are NOT responsible for disputes between Users</li>
            </ul>
            
            <p><strong>3.2 No Liability:</strong> We are not liable for any loss, damage, injury, or dispute arising from services arranged through our Platform. All transactions and interactions are solely between Seekers and Providers.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">4. USER RESPONSIBILITIES</h3>
            <p><strong>4.1 For All Users:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âœ… You must be at least 18 years old to use this Platform</li>
                <li>âœ… You must provide accurate and truthful information</li>
                <li>âœ… You are responsible for maintaining account security</li>
                <li>âœ… You must comply with all applicable laws and regulations</li>
                <li>âœ… You must not misuse the Platform for illegal activities</li>
            </ul>
            
            <p><strong>4.2 For Seekers:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âœ… YOU are responsible for verifying Provider credentials and qualifications</li>
                <li>âœ… YOU are responsible for negotiating prices and payment terms</li>
                <li>âœ… YOU are responsible for inspecting completed work</li>
                <li>âœ… YOU must resolve disputes directly with Providers</li>
            </ul>
            
            <p><strong>4.3 For Providers:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âœ… YOU confirm you are an independent contractor, NOT our employee</li>
                <li>âœ… YOU are responsible for your own insurance, licenses, and permits</li>
                <li>âœ… YOU are responsible for work quality and customer satisfaction</li>
                <li>âœ… YOU must honor any warranties you offer to Seekers</li>
                <li>âœ… YOU are responsible for your own taxes and legal compliance</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">5. PAYMENT AND PRICING</h3>
            <p><strong>5.1 Direct Payment:</strong> All payments are made directly between Seekers and Providers. HelpBuddy does NOT process, hold, or facilitate payments.</p>
            <p><strong>5.2 Platform Usage:</strong> HelpBuddy is currently FREE to use for both Seekers and Providers. We reserve the right to introduce paid features in the future with advance notice.</p>
            <p><strong>5.3 Pricing Disputes:</strong> Any disputes regarding pricing, payments, or refunds must be resolved directly between Seeker and Provider. We are not involved in payment disputes.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">6. PROHIBITED CONDUCT</h3>
            <p>Users must NOT:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âŒ Post false, misleading, or fraudulent information</li>
                <li>âŒ Harass, threaten, or abuse other Users</li>
                <li>âŒ Share inappropriate or offensive content</li>
                <li>âŒ Attempt to bypass Platform features or security measures</li>
                <li>âŒ Use the Platform for any illegal activities</li>
                <li>âŒ Spam or send unsolicited commercial messages</li>
                <li>âŒ Create multiple accounts to manipulate the system</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">7. CONTENT AND INTELLECTUAL PROPERTY</h3>
            <p><strong>7.1 Your Content:</strong> You retain ownership of content you post (service requests, messages, reviews). By posting, you grant us a license to display and distribute your content on the Platform.</p>
            <p><strong>7.2 Our Content:</strong> The HelpBuddy name, logo, design, and Platform features are our intellectual property. You may not copy, modify, or reproduce them without permission.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">8. PRIVACY AND DATA PROTECTION</h3>
            <p>Your use of HelpBuddy is also governed by our Privacy Policy. By using the Platform, you consent to our collection and use of your data as described in the Privacy Policy.</p>
            <p>We comply with the Information Technology Act, 2000 and related Indian data protection laws.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">9. ACCOUNT TERMINATION</h3>
            <p><strong>9.1 By You:</strong> You may delete your account at any time through the Platform settings.</p>
            <p><strong>9.2 By Us:</strong> We reserve the right to suspend or terminate your account if you:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Violate these Terms</li>
                <li>Engage in fraudulent or illegal activities</li>
                <li>Receive multiple complaints from other Users</li>
                <li>Abuse or misuse the Platform</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">10. LIMITATION OF LIABILITY</h3>
            <p><strong>IMPORTANT:</strong> To the maximum extent permitted by law:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>HelpBuddy provides the Platform "AS IS" without warranties of any kind</li>
                <li>We are NOT liable for any damages arising from your use of the Platform</li>
                <li>Our total liability to you shall not exceed â‚¹10,000 (Ten Thousand Rupees)</li>
                <li>We are NOT liable for Provider conduct, service quality, or disputes</li>
                <li>We are NOT liable for any property damage, injury, or financial loss</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">11. DISPUTE RESOLUTION</h3>
            <p><strong>11.1 User Disputes:</strong> Disputes between Seekers and Providers must be resolved directly between the parties. We may provide contact information but do not mediate disputes.</p>
            <p><strong>11.2 Disputes with Platform:</strong> Any disputes with HelpBuddy shall be resolved through arbitration in Bhiwani, Haryana, India, in accordance with the Arbitration and Conciliation Act, 1996.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">12. GOVERNING LAW</h3>
            <p>These Terms are governed by the laws of India. The courts of Bhiwani, Haryana shall have exclusive jurisdiction over any disputes.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">13. CHANGES TO TERMS</h3>
            <p>We reserve the right to modify these Terms at any time. Changes will be posted on this page with an updated "Last Updated" date. Your continued use of the Platform after changes constitutes acceptance of the new Terms.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">14. CONTACT INFORMATION</h3>
            <p>For questions or concerns about these Terms, contact us at:</p>
            <p><strong>Email:</strong> helpbuddy.support@gmail.com</p>
            <p><strong>Location:</strong> Bhiwani, Haryana, India</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">15. SEVERABILITY</h3>
            <p>If any provision of these Terms is found to be invalid or unenforceable, the remaining provisions shall continue in full force and effect.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">16. ACKNOWLEDGMENT</h3>
            <p>By using HelpBuddy, you acknowledge that you have read, understood, and agree to be bound by these Terms and Conditions.</p>
            
            <div style="background: #f0f4ff; padding: 20px; border-radius: 10px; margin-top: 40px; border-left: 4px solid #667eea;">
                <p style="margin: 0; font-weight: 600; color: #333;">âš ï¸ IMPORTANT REMINDER:</p>
                <p style="margin: 10px 0 0 0; color: #555;">HelpBuddy is a connection platform ONLY. We do not employ service providers, guarantee service quality, or handle payments. You are responsible for verifying credentials, negotiating terms, and resolving disputes directly with other users.</p>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Policy View -->
<div id="privacyView" class="hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px 20px 0 20px;">
        <h2 style="margin: 0; color: #667eea; font-size: 24px;">Privacy Policy</h2>
        <button class="btn btn-secondary" onclick="closePrivacyView()" style="margin: 0;">â† Back</button>
    </div>
    
    <div style="padding: 0 20px 40px 20px; max-width: 900px; margin: 0 auto;">
        <p style="color: #999; font-size: 14px; margin-bottom: 30px;">Last Updated: October 26, 2025</p>
        
        <div style="line-height: 1.8; color: #333;">
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">1. INTRODUCTION</h3>
            <p>Welcome to HelpBuddy's Privacy Policy. This policy describes how <strong>Surender Singh Grewal</strong> ("we", "us", "our") collects, uses, stores, and protects your personal information when you use the HelpBuddy platform.</p>
            <p>We are committed to protecting your privacy and handling your data in an open and transparent manner. This Privacy Policy complies with the Information Technology Act, 2000 and related Indian data protection laws.</p>
            <p><strong>By using HelpBuddy, you consent to the data practices described in this policy.</strong></p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">2. INFORMATION WE COLLECT</h3>
            <p><strong>2.1 Information You Provide Directly:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âœ… <strong>Account Information:</strong> Name, email address, phone number, password</li>
                <li>âœ… <strong>Profile Information:</strong> Profile photo, address (house number, area, landmark, city, state, PIN code)</li>
                <li>âœ… <strong>Service Information:</strong> Services you provide (if you're a provider), service radius, service requests you post</li>
                <li>âœ… <strong>Communication Data:</strong> Messages, photos, and other content you share through our chat system</li>
                <li>âœ… <strong>Feedback:</strong> Ratings, reviews, and feedback you provide about other users or the platform</li>
            </ul>
            
            <p><strong>2.2 Information Collected Automatically:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸ“ <strong>Location Data:</strong> GPS coordinates derived from your address for matching you with nearby service requests</li>
                <li>ğŸ•’ <strong>Usage Data:</strong> How you interact with the platform (timestamps, features used)</li>
                <li>ğŸ’» <strong>Device Information:</strong> Browser type, device type, IP address</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">3. HOW WE USE YOUR INFORMATION</h3>
            <p>We use your information for the following purposes:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âœ… <strong>Platform Functionality:</strong> To create and manage your account, match seekers with providers, enable communication</li>
                <li>âœ… <strong>Service Delivery:</strong> To show your service requests to nearby providers, display your responses to seekers</li>
                <li>âœ… <strong>Communication:</strong> To send you notifications about responses, messages, and platform updates</li>
                <li>âœ… <strong>Safety & Security:</strong> To prevent fraud, abuse, and maintain platform integrity</li>
                <li>âœ… <strong>Improvement:</strong> To analyze usage patterns and improve our services</li>
                <li>âœ… <strong>Legal Compliance:</strong> To comply with legal obligations and enforce our Terms & Conditions</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">4. HOW WE SHARE YOUR INFORMATION</h3>
            <p><strong>4.1 With Other Users:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸ“‹ <strong>Service Requests:</strong> Your name, general location (city/area), and request details are visible to providers in your area</li>
                <li>ğŸ‘¤ <strong>Provider Profiles:</strong> Your name, services offered, ratings, and general location are visible to seekers</li>
                <li>ğŸ”’ <strong>Contact Information:</strong> Your phone number and full address are ONLY shared after BOTH parties explicitly approve contact sharing</li>
                <li>ğŸ’¬ <strong>Chat Messages:</strong> Only visible to the parties involved in that specific conversation</li>
            </ul>
            
            <p><strong>4.2 We Do NOT Sell Your Data:</strong></p>
            <p>We do not sell, rent, or trade your personal information to third parties for marketing purposes.</p>
            
            <p><strong>4.3 Legal Requirements:</strong></p>
            <p>We may disclose your information if required by law, court order, or government authority, or to protect our rights, safety, or property.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">5. DATA STORAGE AND SECURITY</h3>
            <p><strong>5.1 Where We Store Your Data:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸ—„ï¸ Your data is stored securely on Supabase cloud servers</li>
                <li>ğŸŒ Data may be stored outside India but is protected by international security standards</li>
                <li>ğŸ“¸ Profile photos are stored as Base64-encoded data in our database</li>
            </ul>
            
            <p><strong>5.2 Security Measures:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸ” Passwords are encrypted and never stored in plain text</li>
                <li>ğŸ”’ Secure HTTPS connection for all data transmission</li>
                <li>ğŸ›¡ï¸ Access controls to limit who can view your data</li>
                <li>âš ï¸ However, no system is 100% secure. We cannot guarantee absolute security of your data</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">6. DATA RETENTION</h3>
            <p><strong>How Long We Keep Your Data:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âœ… <strong>Active Accounts:</strong> We retain your data as long as your account is active</li>
                <li>âœ… <strong>Service History:</strong> Request history, chat logs, and ratings are retained for platform integrity and dispute resolution</li>
                <li>âœ… <strong>Deleted Accounts:</strong> When you delete your account, we remove your personal information within 90 days, except data required for legal compliance</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">7. YOUR RIGHTS AND CHOICES</h3>
            <p>You have the following rights regarding your data:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸ‘ï¸ <strong>Access:</strong> You can view and edit your profile information at any time</li>
                <li>âœï¸ <strong>Correction:</strong> You can update incorrect information through your profile settings</li>
                <li>ğŸ—‘ï¸ <strong>Deletion:</strong> You can delete your account at any time (contact us at helpbuddy.support@gmail.com)</li>
                <li>ğŸš« <strong>Restriction:</strong> You can stop providing services or hide your profile from searches</li>
                <li>ğŸ“¤ <strong>Data Portability:</strong> You can request a copy of your data by contacting us</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">8. COOKIES AND TRACKING</h3>
            <p><strong>8.1 What We Use:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸª We use browser storage (session storage) to keep you logged in</li>
                <li>ğŸ“Š We do NOT use third-party tracking cookies or analytics at this time</li>
                <li>ğŸ”’ No advertising cookies or remarketing pixels</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">9. CHILDREN'S PRIVACY</h3>
            <p>HelpBuddy is NOT intended for users under 18 years of age. We do not knowingly collect information from children under 18. If we discover that a child under 18 has provided us with personal information, we will delete it immediately.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">10. THIRD-PARTY SERVICES</h3>
            <p><strong>Services We Use:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸ—„ï¸ <strong>Supabase:</strong> For database and authentication (subject to their privacy policy)</li>
                <li>ğŸ—ºï¸ <strong>OpenStreetMap Nominatim:</strong> For geocoding addresses (subject to their terms)</li>
            </ul>
            <p>These third-party services have their own privacy policies. We encourage you to review them.</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">11. CHANGES TO THIS PRIVACY POLICY</h3>
            <p>We may update this Privacy Policy from time to time. Changes will be posted on this page with an updated "Last Updated" date. Significant changes will be notified through the platform or via email.</p>
            <p><strong>Your continued use of HelpBuddy after changes constitutes acceptance of the updated policy.</strong></p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">12. LEGAL COMPLIANCE</h3>
            <p>This Privacy Policy complies with:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>ğŸ“œ Information Technology Act, 2000</li>
                <li>ğŸ“œ Information Technology (Reasonable Security Practices and Procedures and Sensitive Personal Data or Information) Rules, 2011</li>
                <li>ğŸ“œ Other applicable Indian data protection laws</li>
            </ul>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">13. CONTACT US</h3>
            <p>If you have questions, concerns, or requests regarding your privacy or this policy, please contact us at:</p>
            <p><strong>ğŸ“§ Email:</strong> helpbuddy.support@gmail.com</p>
            <p><strong>ğŸ“ Location:</strong> Bhiwani, Haryana, India</p>
            <p><strong>ğŸ‘¤ Data Controller:</strong> Surender Singh Grewal</p>
            
            <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">14. GRIEVANCE OFFICER</h3>
            <p>In accordance with the Information Technology Act, 2000, if you have any grievances related to privacy:</p>
            <p><strong>Contact:</strong> Surender Singh Grewal</p>
            <p><strong>Email:</strong> helpbuddy.support@gmail.com</p>
            <p><strong>Response Time:</strong> We aim to respond to all privacy concerns within 30 days</p>
            
            <div style="background: #f0f4ff; padding: 20px; border-radius: 10px; margin-top: 40px; border-left: 4px solid #667eea;">
                <p style="margin: 0; font-weight: 600; color: #333;">ğŸ”’ YOUR PRIVACY MATTERS</p>
                <p style="margin: 10px 0 0 0; color: #555;">We are committed to protecting your privacy and being transparent about how we use your data. Your trust is important to us, and we work hard to maintain it.</p>
            </div>
        </div>
    </div>
</div>

<!-- Password Reset View -->
<div id="passwordResetView" class="hidden">
    <h2>ğŸ”‘ Reset Your Password</h2>
    <div id="passwordResetError" class="error hidden"></div>
    <div id="passwordResetInfo" class="info hidden"></div>
    
    <form id="passwordResetForm">
        <div class="form-group">
            <label>New Password <span class="required">*</span></label>
            <input type="password" id="newPassword" required minlength="6" placeholder="Enter new password (min 6 characters)">
        </div>
        
        <div class="form-group">
            <label>Confirm New Password <span class="required">*</span></label>
            <input type="password" id="confirmNewPassword" required minlength="6" placeholder="Re-enter new password">
        </div>
        
        <button type="submit" class="btn btn-full" id="resetPasswordBtn">ğŸ”’ Reset Password</button>
    </form>
    
    <!-- Footer -->
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
        <div style="color: #999;">Â© 2025 HelpBuddy - Surender Singh Grewal</div>
    </div>
</div>

        <!-- Dashboard View -->
<div id="dashboardView" class="hidden">
    <!-- Row 2: Create Request (LEFT) + User Profile (MIDDLE) + Profile Photo/Back (RIGHT) -->
<div id="dashboardHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 20px;">
    <!-- LEFT: Toggle Button + Create Request Button -->
    <div style="display: flex; align-items: center; gap: 15px;">
        <button id="modeToggleBtn" class="btn" onclick="toggleDashboardMode()" style="margin: 0; display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <span id="modeToggleIcon">ğŸ”§</span>
            <span id="modeToggleText">Provider</span>
            <span style="opacity: 0.7;">â†”ï¸</span>
        </button>
        
    </div>
    
    <!-- MIDDLE: User Profile (for dashboard) -->
    <div class="user-menu" style="display: flex; align-items: center; gap: 12px;">
        <img id="headerUserPhoto" src="" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid #667eea; display: none;">
        <div id="headerUserPhotoPlaceholder" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(102, 126, 234, 0.2); display: flex; align-items: center; justify-content: center; font-size: 28px; border: 2px solid #667eea;">ğŸ‘¤</div>
        <button class="user-button" onclick="toggleUserDropdown()">
            <span id="headerUsername">User</span>
            <span>â–¼</span>
        </button>
        <div class="user-dropdown" id="userDropdown">
    <div class="dropdown-item" onclick="showEditProfile(); toggleUserDropdown();">
        ğŸ‘¤ Profile
    </div>
    <div class="dropdown-item" onclick="openFeedbackModal(); toggleUserDropdown();">
        ğŸ’¬ Send Feedback
    </div>
    <div class="dropdown-item" onclick="openGetHelpModalForLoggedInUser(); toggleUserDropdown();">
        â“ Need Help
    </div>
    <div class="dropdown-separator"></div>
    <div class="dropdown-item" onclick="showTermsFromDropdown(); toggleUserDropdown();">
        ğŸ“œ Terms & Conditions
    </div>
    <div class="dropdown-item" onclick="showPrivacyFromDropdown(); toggleUserDropdown();">
        ğŸ”’ Privacy Policy
    </div>
    <div class="dropdown-separator"></div>
    <div class="dropdown-item" onclick="handleLogout()">
        ğŸšª Logout
    </div>
</div>
    </div>
    
    <!-- Profile Photo (LEFT) + Back Button (RIGHT) - for edit profile page -->
<div id="profileHeaderSection" style="display: none; justify-content: space-between; align-items: center; width: 100%;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <img id="headerProfilePhotoLarge" src="" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; display: none;">
        <div id="headerProfilePhotoLargePlaceholder" style="width: 80px; height: 80px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #999;">ğŸ‘¤</div>
    </div>
    <button class="btn btn-secondary" onclick="smartBack()" style="margin: 0;">â† Back</button>
</div>
</div>
    
    <div class="two-column">
    <!-- LEFT COLUMN: SEEKER SECTION -->
    <div id="seekerSection">
        <!-- Mobile-only Seeker Header -->
        
        
        <div id="requestLimitWarning" class="request-limit-warning hidden">âš ï¸ Maximum 5 open requests reached</div>

	<button class="btn" onclick="showCreateRequestForm()" id="createRequestBtn" style="margin: 0 0 20px 0;">+ Create Request</button>
        <!-- SECTION 1: OPEN REQUESTS -->
        <div class="collapsible-section">
            <button class="section-toggle" onclick="toggleSection('openRequests')">
                <div class="section-toggle-left">
                    <span>ğŸ“‹ OPEN REQUESTS</span>
                    <span class="count-badge" id="openRequestsTotal">0</span>
                </div>
                <div class="section-toggle-right">
                    <span class="toggle-icon" id="openRequestsIcon">â–¼</span>
                </div>
            </button>
            <div class="section-content" id="openRequestsContent">
        <div class="section-inner">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="filterMyRequests('no_response')">
                    <span>No Response</span>
                    <div class="sub-tab-badges">
                        <span class="count-badge" id="noResponseCount">0</span>
                    </div>
                </button>
                <button class="sub-tab" onclick="filterMyRequests('negotiating')">
                    <span>Negotiating</span>
                    <div class="sub-tab-badges">
                        <span class="count-badge" id="negotiatingCount">0</span>
                    </div>
                </button>
            </div>
            <div id="openRequestsList"></div>
        </div>
    </div>
</div>

        <!-- SECTION 2: ACTIVE REQUESTS -->
<div class="collapsible-section">
    <button class="section-toggle" onclick="toggleSection('activeRequests')">
    <div class="section-toggle-left">
        <span>ğŸ”„ ACTIVE REQUESTS</span>
        <span class="count-badge" id="activeRequestsTotal">0</span>
        <div class="badge-container hidden" id="activeRequestsUnreadBadge" style="display: none;">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">0</span>
        </div>
    </div>
    <div class="section-toggle-right">
        <span class="toggle-icon" id="activeRequestsIcon">â–¼</span>
    </div>
</button>
            <div class="section-content" id="activeRequestsContent">
    <div class="section-inner">
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="filterActiveRequests('in_progress')">
                <span>In Progress</span>
        <div class="sub-tab-badges">
            <span class="count-badge" id="inProgressCount">0</span>
            <div class="badge-container hidden" id="inProgressUnread" style="display: none;">
                <div class="chat-bubble-icon"></div>
                <span class="unread-badge">0</span>
            </div>
        </div>
    </button>
	<button class="sub-tab" onclick="filterActiveRequests('pending_completion')">
    <span>Pending Completion</span>
    <div class="sub-tab-badges">
        <span class="count-badge" id="pendingCompletionCount">0</span>
        <div class="badge-container hidden" id="pendingCompletionUnread" style="display: none;">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">0</span>
        </div>
    </div>
</button>
    <button class="sub-tab" onclick="filterActiveRequests('completed')">
        <span>Completed</span>
        <div class="sub-tab-badges">
            <span class="count-badge" id="completedCount">0</span>
            <div class="badge-container hidden" id="completedUnread" style="display: none;">
                <div class="chat-bubble-icon"></div>
                <span class="unread-badge">0</span>
            </div>
        </div>
    </button>
</div>
                    <div id="activeRequestsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN: PROVIDER SECTION -->
<div id="providerSection" class="hidden">
    <!-- Mobile-only Provider Header -->
    

<!-- SECTION 1: OPEN REQUESTS (Provider) -->
<div class="collapsible-section">
    <button class="section-toggle" onclick="toggleSection('providerOpenRequests')">
        <div class="section-toggle-left">
            <span>ğŸ“‹ OPEN REQUESTS</span>
            <span class="count-badge" id="providerOpenRequestsTotal">0</span>
            <div class="badge-container hidden" id="providerOpenRequestsUnread" style="display: none;">
                <div class="chat-bubble-icon"></div>
                <span class="unread-badge">0</span>
            </div>
        </div>
        <div class="section-toggle-right">
            <span class="toggle-icon" id="providerOpenRequestsIcon">â–¼</span>
        </div>
    </button>
    <div class="section-content" id="providerOpenRequestsContent">
        <div class="section-inner">
            <div id="providerOpenRequestsList"></div>
        </div>
    </div>
</div>
    
    <div class="collapsible-section">
    <button class="section-toggle" onclick="toggleSection('myResponses')">
        <div class="section-toggle-left">
            <span>ğŸ”„ ACTIVE REQUESTS</span>
            <span class="count-badge" id="myResponsesTotal">0</span>
        <div class="badge-container hidden" id="myResponsesNew" style="display: none;">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">0</span>
        </div>
    </div>
    <div class="section-toggle-right">
        <span class="toggle-icon" id="myResponsesIcon">â–¼</span>
    </div>
</button>
            <div class="section-content" id="myResponsesContent">
                <div class="section-inner">
                    <div id="myResponsesList"></div>
                </div>
            </div>
        </div>
        
        <div class="collapsible-section">
            <button class="section-toggle" onclick="toggleSection('availableWork')">
                <div class="section-toggle-left">
                    <span>ğŸ’¼ WORK OPPORTUNITIES</span>
                    <span class="count-badge" id="availableWorkTotal">0</span>
                    <span class="new-badge hidden" id="availableWorkNew" style="display: none;">ğŸ†• 0</span>
                </div>
                <div class="section-toggle-right">
                    <span class="toggle-icon" id="availableWorkIcon">â–¼</span>
                </div>
            </button>
            <div class="section-content" id="availableWorkContent">
                <div class="section-inner">
                    <div class="sub-tabs" id="urgencyTabs">
                        <!-- Tabs will be dynamically generated -->
                    </div>
                    <div id="nearbyRequestsList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

        <div id="createRequestView" class="hidden">
    <!-- Header with Back Button on Right -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px 20px 0 20px;">
        <h2 style="margin: 0; color: #667eea; font-size: 24px;">Create Service Request</h2>
        <button class="btn btn-secondary" onclick="showDashboard()" style="margin: 0;">â† Back</button>
    </div>
    
    <div id="createRequestError" class="error hidden"></div>
    <div id="createRequestInfo" class="info hidden"></div>
    
    <form id="createRequestForm">
        <div class="form-group">
            <label>Service Type <span class="required">*</span></label>
            <select id="serviceType" required>
                <option value="">Select Service</option>
                <option value="electrician">ğŸ”§ Electrician</option>
                <option value="plumber">ğŸš° Plumber</option>
                <option value="ac_repair">â„ï¸ AC Repair</option>
                <option value="carpenter">ğŸ”¨ Carpenter</option>
                <option value="painter">ğŸ¨ Painter</option>
                <option value="cleaner">ğŸ§¹ Cleaner</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Title <span class="required">*</span></label>
            <input type="text" id="requestTitle" required minlength="10" maxlength="100">
            <div class="char-counter"><span id="titleCounter">0</span>/100</div>
        </div>
        
        <div class="form-group">
            <label>Description <span class="required">*</span></label>
            <textarea id="requestDescription" required minlength="20" maxlength="500"></textarea>
            <div class="char-counter"><span id="descCounter">0</span>/500</div>
        </div>
        
        <div class="form-group">
            <label>Urgency <span class="required">*</span></label>
            <div class="urgency-group">
                <div class="urgency-option">
                    <input type="radio" name="urgency" id="urgentRadio" value="urgent" required>
                    <label for="urgentRadio" class="urgency-label">ğŸ”´ Urgent</label>
                </div>
                <div class="urgency-option">
                    <input type="radio" name="urgency" id="normalRadio" value="normal" required>
                    <label for="normalRadio" class="urgency-label">ğŸŸ¡ Normal</label>
                </div>
                <div class="urgency-option">
                    <input type="radio" name="urgency" id="lowRadio" value="low" required>
                    <label for="lowRadio" class="urgency-label">ğŸŸ¢ Low</label>
                </div>
            </div>
        </div>
        
        <h3>ğŸ“ Service Location</h3>
        
        <div class="checkbox-group">
            <input type="checkbox" id="differentLocation" onchange="toggleLocationFields()">
            <label for="differentLocation" style="margin: 0;">Use different location for this service</label>
        </div>
        
        <div id="customLocationFields" class="hidden">
            <div class="form-group">
                <label>Area Name <span class="required">*</span></label>
                <input type="text" id="customAreaName">
            </div>
            <div class="form-group">
                <label>Landmark</label>
                <input type="text" id="customLandmark">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>City <span class="required">*</span></label>
                    <input type="text" id="customCity" placeholder="Type to search city..." autocomplete="off">
                    <div id="customCitySuggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="form-group">
                    <label>State <span class="required">*</span></label>
                    <select id="customState">
                        <option value="">Select State</option>
                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="Maharashtra">Maharashtra</option>
                        <!-- Add all other states here -->
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>PIN Code <span class="required">*</span></label>
                <input type="text" id="customPinCode" pattern="[0-9]{6}">
            </div>
        </div>
        
        <!-- âœ… THIS IS THE MISSING SUBMIT BUTTON -->
        <button type="submit" class="btn btn-full" id="submitRequestBtn">Create Request</button>
    </form>
</div> <!-- âœ… CLOSES createRequestView -->
    
<!-- Edit Request View -->
        <div id="editRequestView" class="hidden">
            <button class="btn btn-secondary" onclick="window.history.back()">â† Back</button>
            <h2 style="margin-top: 20px;">Edit Service Request</h2>
            <div id="editRequestError" class="error hidden"></div>
            <div id="editRequestInfo" class="info hidden"></div>
            <form id="editRequestForm">
                <input type="hidden" id="editRequestId">
                
                <div class="form-group">
                    <label>Service Type <span class="required">*</span></label>
                    <select id="editServiceType" disabled>
                        <option value="">Select Service</option>
                        <option value="electrician">ğŸ”§ Electrician</option>
                        <option value="plumber">ğŸš° Plumber</option>
                        <option value="ac_repair">â„ï¸ AC Repair</option>
                        <option value="carpenter">ğŸ”¨ Carpenter</option>
                        <option value="painter">ğŸ¨ Painter</option>
                        <option value="cleaner">ğŸ§¹ Cleaner</option>
                    </select>
                    <small style="color: #999; font-size: 12px;">Service type cannot be changed after creation</small>
                </div>
                
                <div class="form-group">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="editRequestTitle" required minlength="10" maxlength="100">
                    <div class="char-counter"><span id="editTitleCounter">0</span>/100</div>
                </div>
                
                <div class="form-group">
                    <label>Description <span class="required">*</span></label>
                    <textarea id="editRequestDescription" required minlength="20" maxlength="500"></textarea>
                    <div class="char-counter"><span id="editDescCounter">0</span>/500</div>
                </div>
                
                <div class="form-group">
                    <label>Urgency <span class="required">*</span></label>
                    <div class="urgency-group">
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editUrgentRadio" value="urgent" required>
                            <label for="editUrgentRadio" class="urgency-label">ğŸ”´ Urgent</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editNormalRadio" value="normal" required>
                            <label for="editNormalRadio" class="urgency-label">ğŸŸ¡ Normal</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editLowRadio" value="low" required>
                            <label for="editLowRadio" class="urgency-label">ğŸŸ¢ Low</label>
                        </div>
                    </div>
                </div>
                
                <h3>ğŸ“ Service Location</h3>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <p style="color: #333; font-size: 14px; margin-bottom: 8px; font-weight: 600;">ğŸ“ Current Location:</p>
                    <p style="color: #555; font-size: 14px; line-height: 1.6;" id="currentLocationText"></p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px; font-style: italic;">
                        â„¹ï¸ Location and service type cannot be changed after request creation. If you need to change these, please cancel this request and create a new one.
                    </p>
                </div>
                
                <button type="submit" class="btn btn-full" id="updateRequestBtn">ğŸ’¾ Update Request</button>            </form>
        </div>

<!-- Edit Profile View -->
<div id="editProfileView" class="hidden">
    <!-- Header Section with Profile Photo and Back Button -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; padding: 20px 20px 0 20px;">
        <!-- Left: Headings + Profile Photo -->
        <div>
            <h2 style="margin: 0 0 15px 0; color: #667eea; font-size: 24px;">Edit Profile</h2>
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">ğŸ‘¤ Personal Information</h3>
            
            <div style="margin-top: 10px;">
                <img id="currentProfilePhoto" src="" alt="Profile" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; display: none;">
                <div id="noProfilePhoto" style="width: 120px; height: 120px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #999;">ğŸ‘¤</div>
            </div>
        </div>
        
        <!-- Right: Back Button -->
        <div>
            <button class="btn btn-secondary" onclick="smartBack()" style="margin: 0;">â† Back</button>
        </div>
    </div>
    
    <div id="editProfileError" class="error hidden"></div>
    <div id="editProfileInfo" class="info hidden"></div>
    
    <form id="editProfileForm">
        <div class="form-group">
            <label>Change Profile Photo</label>
            <input type="file" id="editPhoto" accept="image/*">
            <small style="color: #999; font-size: 12px;">Max size: 2MB. Leave empty to keep current photo</small>
        </div>

        <div class="form-group">
            <label>Full Name <span class="required">*</span></label>
            <input type="text" id="editName" required>
        </div>

        <div class="form-group">
            <label>Phone Number <span class="required">*</span></label>
            <input type="tel" id="editPhone" maxlength="10" pattern="[6-9][0-9]{9}" required 
                   oninput="validatePhoneInput(this)" title="Enter correct number">
            <div id="editPhoneError" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;">Enter correct number</div>
        </div>

	        <div class="form-group">
            <label>Email ID</label>
            <input type="email" id="editEmail" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
        </div>


        <h3>ğŸ“ Address Details</h3>
        <div class="form-group">
            <label>House Number</label>
            <input type="text" id="editHouseNumber">
        </div>

        <div class="form-group">
            <label>Area Name <span class="required">*</span></label>
            <input type="text" id="editAreaName" required>
        </div>

        <div class="form-group">
            <label>Landmark</label>
            <input type="text" id="editLandmark">
        </div>

        <div class="form-group">
            <label>City <span class="required">*</span></label>
            <input type="text" id="editCity" placeholder="Type your city name..." required autocomplete="off">
            <div id="editCitySuggestions" class="autocomplete-suggestions"></div>
        </div>

        <div class="form-group">
            <label>State <span class="required">*</span></label>
            <select id="editState" required>
                <option value="">Select State/Union Territory</option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Madhya Pradesh">Madhya Pradesh</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttarakhand">Uttarakhand</option>
                <option value="West Bengal">West Bengal</option>
                <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                <option value="Chandigarh">Chandigarh</option>
                <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                <option value="National Capital Territory of Delhi">National Capital Territory of Delhi</option>
                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                <option value="Ladakh">Ladakh</option>
                <option value="Lakshadweep">Lakshadweep</option>
                <option value="Puducherry">Puducherry</option>
            </select>
        </div>

        <div class="form-group">
            <label>PIN Code <span class="required">*</span></label>
            <input type="text" id="editPinCode" pattern="[0-9]{6}" required>
        </div>
        
        <h3>ğŸ”§ Provider Settings</h3>
        <div style="margin-bottom: 20px;">
            <button type="button" class="btn" id="toggleProviderBtn" onclick="toggleProviderStatus()" style="width: 100%;">
                <span id="providerStatusText">Loading...</span>
            </button>
        </div>
        
        <div id="providerSettings" class="hidden">
            <div class="form-group">
                <label>Service Radius <span class="required">*</span></label>
                <select id="editRadius">
                    <option value="2">2 km</option>
                    <option value="5">5 km</option>
                    <option value="10">10 km</option>
                    <option value="15">15 km</option>
                    <option value="20">20 km</option>
                    <option value="30">30 km</option>
                    <option value="50">50 km</option>
                </select>
            </div>
            
            <h3>ğŸ“‹ Services I Provide</h3>
            <div id="currentServicesList" style="margin-bottom: 20px;"></div>
            
            <div class="form-group">
                <label>Add New Service</label>
                <div style="display: flex; gap: 10px;">
                    <select id="newServiceSelect" style="flex: 1;">
                        <option value="">Select Service to Add</option>
                        <option value="electrician">ğŸ”§ Electrician</option>
                        <option value="plumber">ğŸš° Plumber</option>
                        <option value="ac_repair">â„ï¸ AC Repair</option>
                        <option value="carpenter">ğŸ”¨ Carpenter</option>
                        <option value="painter">ğŸ¨ Painter</option>
                        <option value="cleaner">ğŸ§¹ Cleaner</option>
                    </select>
                    <button type="button" class="btn" onclick="addService()">Add Service</button>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-full" id="saveProfileBtn">ğŸ’¾ Save Changes</button>
    </form>
</div>
        <!-- Chat View -->
        <div id="chatView" class="hidden">
            <div class="chat-container">
                <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
    <!-- EXTREME LEFT: Back Button with < symbol -->
    <button onclick="smartBack()" style="background: none; border: none; color: white; padding: 4px; font-size: 24px; font-weight: bold; cursor: pointer; line-height: 1; margin: 0; min-width: auto;">&lt;</button>

    
    <!-- LEFT: Profile Photo + Username (adjacent to back button) -->
    <div style="display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1; margin-left: 12px;" onclick="openChatPartnerProfile()">
        <img id="chatPartnerPhoto" src="" alt="" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white; display: none;">
        <div id="chatPartnerPhotoPlaceholder" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ‘¤</div>
        <div class="chat-header-left">
            <div class="chat-partner-name" id="chatPartnerName">Chat</div>
            <div class="chat-status">Request Status: <span id="chatRequestStatus">In Progress</span></div>
        </div>
    </div>
    
    <!-- RIGHT: Contact Details Symbol (only visible when activated) -->
<button id="contactDetailsHeaderBtn" onclick="openContactDetailsModal()" style="display: none; background: none; border: none; color: #ff3333 !important; padding: 4px; font-size: 24px; cursor: pointer; line-height: 1; margin: 0; transform: rotate(135deg);">ğŸ“</button>


</div>

                
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>
                
                                
                <div class="chat-input-area">
                    <div class="privacy-notice" id="privacyNotice">
                        ğŸ”’ <strong>Privacy Protected:</strong> Phone numbers and addresses are hidden until both parties agree to share contact information.
                    </div>
                    
                    <div class="chat-action-buttons">
    <button class="btn btn-contact" onclick="requestContactSharing()">
        ğŸ“ Request Contact Sharing
        <span class="privacy-info-icon" onclick="event.stopPropagation(); togglePrivacyNotice()">!</span>
    </button>
    
    <!-- PROVIDER: Mark Complete Button -->
    <button class="btn btn-complete" id="markCompleteBtn" onclick="showWarrantyForm()" style="display: none;">âœ… Mark Work Complete</button>
    
    <!-- SEEKER: Accept/Reject Buttons (only visible when completion requested) -->
    <button class="btn btn-complete" id="acceptCompletionBtn" onclick="acceptCompletion()" style="display: none;">âœ… Accept Completion</button>
    <button class="btn btn-cancel" id="rejectCompletionBtn" onclick="rejectCompletion()" style="display: none;">âŒ Reject & Continue Work</button>
</div>

<div id="warrantyForm" class="warranty-form hidden">
    <h3>Select Warranty Period</h3>
    <div class="warranty-options">
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty0" value="0">
            <label for="warranty0">No Warranty</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty15" value="15">
            <label for="warranty15">15 Days</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty30" value="30">
            <label for="warranty30">1 Month</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty90" value="90">
            <label for="warranty90">3 Months</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty180" value="180">
            <label for="warranty180">6 Months</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty365" value="365">
            <label for="warranty365">1 Year</label>
        </div>
    </div>
    <button class="btn btn-full" onclick="completeWork()" style="margin-top: 15px;">Confirm Completion</button>
</div>              
                    <div class="chat-input-wrapper">
                        <button class="plus-button" onclick="showAttachmentOptions()" title="Attach">+</button>
                        <textarea id="chatMessageInput" placeholder="Type your message..." rows="2" oninput="toggleSendButton()"></textarea>
                        <button class="template-button" id="templateBtn" onclick="openTemplateModal()" title="Quick Templates">ğŸ“‹</button>
                        <button class="btn btn-send" id="sendBtn" onclick="sendMessage()">â¤</button>
                    </div>
		<input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                </div>
            </div>
        </div>

        <!-- Responses Modal -->
<div id="responsesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" style="flex: 1; text-align: left;">ğŸ‘¥ Providers Who Responded</h2>
            <button class="close-btn" onclick="closeResponsesModal()" style="color: #dc3545; font-weight: bold;">Ã—</button>
        </div>
        <div id="responsesList"></div>
    </div>
</div>

        <!-- Provider Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">ğŸ‘¤ Provider Profile</h2>
                    <button class="close-btn" onclick="closeProfileModal()">Ã—</button>
                </div>
                <div id="profileContent"></div>
            </div>
        </div>
<!-- Template Modal -->
        <div id="templateModal" class="template-modal">
            <div class="template-modal-content">
                <div class="template-modal-header">
                    <h2 class="template-modal-title">ğŸ“‹ Quick Templates</h2>
                    <button class="template-close-btn" onclick="closeTemplateModal()">Ã—</button>
                </div>
                <div class="template-categories" id="templateCategoriesContainer"></div>
            </div>
        </div>

<!-- Rating Modal -->
        <div id="ratingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">â­ Rate Provider</h2>
                    <button class="close-btn" onclick="closeRatingModal()">Ã—</button>
                </div>
                <div id="ratingModalContent">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="font-size: 16px; color: #555; margin-bottom: 10px;">How was your experience with <strong id="ratingProviderName"></strong>?</p>
                        <p style="font-size: 14px; color: #999;">Your rating helps others make better decisions</p>
                    </div>
                    
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1" onclick="selectRating(1)">â˜†</span>
                        <span class="star" data-rating="2" onclick="selectRating(2)">â˜†</span>
                        <span class="star" data-rating="3" onclick="selectRating(3)">â˜†</span>
                        <span class="star" data-rating="4" onclick="selectRating(4)">â˜†</span>
                        <span class="star" data-rating="5" onclick="selectRating(5)">â˜†</span>
                    </div>
                    
                    <div style="text-align: center; margin: 15px 0;">
                        <span id="ratingText" style="font-size: 18px; font-weight: 600; color: #667eea;">Select Rating</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Review (Optional)</label>
                        <textarea id="ratingReview" placeholder="Share your experience with others..." rows="4" maxlength="500"></textarea>
                        <div class="char-counter"><span id="reviewCounter">0</span>/500</div>
                    </div>
                    
                    <div id="ratingError" class="error hidden"></div>
                    
                    <button class="btn btn-full" onclick="submitRating()" id="submitRatingBtn">Submit Rating</button>
                </div>
            </div>
        </div>

	

	<!-- Feedback Modal -->
<div id="feedbackModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">ğŸ’¬ Send Feedback</h2>
            <button class="close-btn" onclick="closeFeedbackModal()">Ã—</button>
        </div>
        <div style="padding: 20px;">
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                Help us improve HelpBuddy! Share your suggestions, report bugs, or request new features. 
                Your feedback helps us serve you better.
            </p>
            
            <div class="form-group">
                <label>Feedback Type <span class="required">*</span></label>
                <select id="feedbackType" required>
                    <option value="">Select Type</option>
                    <option value="bug">ğŸ› Bug Report</option>
                    <option value="feature">âœ¨ Feature Request</option>
                    <option value="improvement">ğŸ”§ Improvement Suggestion</option>
                    <option value="complaint">ğŸ˜ Complaint</option>
                    <option value="praise">ğŸ‰ Appreciation</option>
                    <option value="other">ğŸ’­ Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Your Feedback <span class="required">*</span></label>
                <textarea id="feedbackMessage" rows="6" maxlength="1000" required placeholder="Please describe your feedback in detail. Be specific so we can help you better."></textarea>
                <div class="char-counter"><span id="feedbackCounter">0</span>/1000</div>
            </div>
            
            <div class="form-group">
                <label>Your Email</label>
                <input type="email" id="feedbackEmail" placeholder="We'll reach out if we need more details" readonly>
                <small style="color: #999; font-size: 12px;">Using your registered email</small>
            </div>
            
            <div id="feedbackError" class="error hidden"></div>
            <div id="feedbackSuccess" class="success hidden"></div>
            
            <button class="btn btn-full" onclick="submitFeedback()" id="submitFeedbackBtn">
                ğŸ“¤ Send Feedback
            </button>
        </div>
    </div>
</div>

        <!-- Contact Details Modal -->
<div id="contactDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div style="display: flex; justify-content: flex-end; padding: 15px 15px 0 15px;">
            <button onclick="closeContactDetailsModal()" style="background: none; border: none; color: #dc3545; font-size: 36px; font-weight: bold; cursor: pointer; line-height: 1; padding: 0;">Ã—</button>
        </div>
        <div id="contactDetailsModalContent" style="padding: 0 20px 20px 20px;">
            <!-- Contact details will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading View -->

        <!-- Loading View -->
        <div id="loadingView" class="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nzhivzzzcanniejzqvsc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56aGl2enp6Y2FubmllanpxdnNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTcxMDEsImV4cCI6MjA3NTIzMzEwMX0.ex0z4DZF38IKc57l6V3X-DofTi6ZZUfPVFrajo1cBRY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let currentProfile = null;
	let currentDashboardMode = null;
	console.log('Step 1: JavaScript loaded');
        console.log('Step 2: Supabase client created');
        let selectedResponseRequest = null;
        let currentChatData = null;
        let chatRefreshInterval = null;
	let currentResponseFilter = 'active';
	window.currentWorkFilter = 'available'; // For Work Opportunities filtering
	let chatOpenedFrom = null; // Track where chat was opened from

        const SERVICE_ICONS = {
            electrician: 'ğŸ”§',
            plumber: 'ğŸš°',
            ac_repair: 'â„ï¸',
            carpenter: 'ğŸ”¨',
            painter: 'ğŸ¨',
            cleaner: 'ğŸ§¹'
        };

        window.addEventListener('DOMContentLoaded', async () => {
    console.log('Step 3: DOMContentLoaded fired');
    
    // FIRST: Check if user is returning from email verification
    const isVerifying = await handleEmailVerification();
    if (isVerifying) {
        console.log('âœ… Email verification handled');
        return;
    }
    
    // â­ NEW: Check if user is resetting password
    const isResettingPassword = await handlePasswordReset();
    if (isResettingPassword) {
        console.log('âœ… Password reset handled');
        return;
    }
    
    // THEN: Check if user is already logged in
    const { data: { user } } = await supabase.auth.getUser();
    console.log('Step 4: Checked user:', user);
    
    if (user) { 
        currentUser = user; 
        await loadProfile(); 
    } else { 
        showLogin(); 
    }
    
    setupCharCounters();
    setupCityAutocomplete();
});

        function hideAllViews() {
    const viewIds = [
        'loginView',
        'signupView', 
        'dashboardView',
        'editProfileView',
        'editRequestView',
        'chatView'
    ];
    
    viewIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('hidden');
            // âœ… DON'T set inline display:none - let CSS handle it
        }
    });
}

        function showLogin() { 
    console.log('ğŸ”µ Showing login page...');
    
    hideAllViews(); 
    
    // âœ… CRITICAL FIX: Explicitly hide signup view
    const signupView = document.getElementById('signupView');
    if (signupView) {
        signupView.classList.add('hidden');
        signupView.style.display = 'none';
    }
    
    // âœ… Hide loading view
    const loadingView = document.getElementById('loadingView');
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.style.display = 'none';
    }
    
    // âœ… Show login view
    const loginView = document.getElementById('loginView');
    if (loginView) {
        loginView.classList.remove('hidden');
        loginView.style.display = 'block';
        loginView.style.visibility = 'visible';
    }
    
    console.log('âœ… Login view now visible');
}
        function showSignup() { 
    hideAllViews(); 
    
    // Explicitly hide login view
    const loginView = document.getElementById('loginView');
    if (loginView) {
        loginView.classList.add('hidden');
        loginView.style.display = 'none';
    }
    
    const signupView = document.getElementById('signupView');
    if (signupView) {
        signupView.classList.remove('hidden');
        signupView.style.display = 'block';
        signupView.style.visibility = 'visible';
        console.log('âœ… Signup view now visible');
    }
}
        function showDashboard() { 
    console.log('Step 8: Calling showDashboard');
    
    hideAllViews(); 

// Initialize dashboard mode
    if (!currentDashboardMode) {
        currentDashboardMode = sessionStorage.getItem('dashboardMode');
        if (!currentDashboardMode) {
            currentDashboardMode = currentProfile.is_provider ? 'provider' : 'seeker';
            sessionStorage.setItem('dashboardMode', currentDashboardMode);
        }
    }
    
    // âœ… EXPLICITLY hide create request view
    const createRequestView = document.getElementById('createRequestView');
    if (createRequestView) {
        createRequestView.classList.add('hidden');
        createRequestView.style.display = 'none';
    }
    
    const dashboardView = document.getElementById('dashboardView');
    if (dashboardView) {
        dashboardView.classList.remove('hidden');
        dashboardView.style.display = 'block';
        dashboardView.style.visibility = 'visible';
    }
    
    // âœ… Hide loading view
    const loadingView = document.getElementById('loadingView');
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.style.display = 'none';
    }
    
    // âœ… Show dashboard elements
    const appLogo = document.getElementById('appLogo');
    const createRequestBtn = document.getElementById('createRequestBtn');
    const userMenu = document.querySelector('.user-menu');
    
    if (appLogo) appLogo.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'block';
    if (userMenu) userMenu.style.display = 'flex';
    
    // âœ… Show user profile photo and username
    const headerUserPhoto = document.getElementById('headerUserPhoto');
    const headerUserPhotoPlaceholder = document.getElementById('headerUserPhotoPlaceholder');
    const userButton = document.querySelector('.user-button');
    
    if (currentProfile?.profile_photo) {
        if (headerUserPhoto) {
            headerUserPhoto.src = currentProfile.profile_photo;
            headerUserPhoto.style.display = 'block';
        }
        if (headerUserPhotoPlaceholder) headerUserPhotoPlaceholder.style.display = 'none';
    } else {
        if (headerUserPhoto) headerUserPhoto.style.display = 'none';
        if (headerUserPhotoPlaceholder) headerUserPhotoPlaceholder.style.display = 'flex';
    }
    
    if (userButton) userButton.style.display = 'flex';
    
    // Show/hide sections based on mode
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    const modeToggleBtn = document.getElementById('modeToggleBtn');
    
    if (currentDashboardMode === 'provider') {
        if (providerSection) providerSection.style.display = 'block';
        if (seekerSection) seekerSection.style.display = 'none';
        if (createRequestBtn) createRequestBtn.style.display = 'none';
        document.getElementById('modeToggleIcon').textContent = 'ğŸ”§';
        document.getElementById('modeToggleText').textContent = 'Provider';
	
	modeToggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
	const userButton = document.querySelector('.user-button');
if (userButton) {
    userButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
}

document.querySelectorAll('button[onclick*="toggleSection(\'providerOpenRequests\')"]').forEach(btn => btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
document.querySelectorAll('button[onclick*="toggleSection(\'myResponses\')"]').forEach(btn => btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
document.querySelectorAll('button[onclick*="toggleSection(\'availableWork\')"]').forEach(btn => btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');

    } else {
        if (seekerSection) seekerSection.style.display = 'block';
        if (providerSection) providerSection.style.display = 'none';
        if (createRequestBtn) createRequestBtn.style.display = 'block';
        if (modeToggleBtn && currentProfile.is_provider) {
            document.getElementById('modeToggleIcon').textContent = 'ğŸ™‹';
            document.getElementById('modeToggleText').textContent = 'Seeker';
	    modeToggleBtn.style.background = 'linear-gradient(135deg, #4285F4 0%, #34A853 100%)';
	    const userButton = document.querySelector('.user-button');
if (userButton) {
    userButton.style.background = 'linear-gradient(135deg, #4285F4 0%, #34A853 100%)';
}


        }
    }
    
    // Show/hide toggle button based on provider status
    if (modeToggleBtn) {
        modeToggleBtn.style.display = currentProfile.is_provider ? 'flex' : 'none';
    }
    
    // Clear chat refresh interval
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
    
    loadDashboardData(); 
    
    console.log('âœ… Dashboard should now be visible');
}

function toggleDashboardMode() {
    currentDashboardMode = currentDashboardMode === 'provider' ? 'seeker' : 'provider';
    sessionStorage.setItem('dashboardMode', currentDashboardMode);
    showDashboard();
}
        function showLoading() { hideAllViews(); document.getElementById('loadingView').classList.remove('hidden'); }
        async function showCreateRequestForm() { 
    hideAllViews(); 
    
    // Hide dashboard sections
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    const createRequestBtn = document.getElementById('createRequestBtn');
    const userMenu = document.querySelector('.user-menu');
    
    if (seekerSection) seekerSection.style.display = 'none';
    if (providerSection) providerSection.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';
    if (userMenu) userMenu.style.display = 'none';
    
    // Show create request form
    document.getElementById('createRequestView').classList.remove('hidden'); 
    document.getElementById('createRequestView').style.display = 'block';
    
    // âœ… Reset the form
    document.getElementById('createRequestForm').reset(); 
    document.getElementById('titleCounter').textContent = '0';
    document.getElementById('descCounter').textContent = '0';
    
    // âœ… CRITICAL FIX: Reset "Use different location" checkbox and hide custom fields
    const differentLocationCheckbox = document.getElementById('differentLocation');
    const customLocationFields = document.getElementById('customLocationFields');
    
    if (differentLocationCheckbox) {
        differentLocationCheckbox.checked = false; // Uncheck the checkbox
    }
    
    if (customLocationFields) {
        customLocationFields.classList.add('hidden'); // Hide the custom location fields
    }
    
    // Filter services based on provider's existing services
    await filterServiceDropdown();
}
        
        async function filterServiceDropdown() {
    const serviceSelect = document.getElementById('serviceType');
    
    // If user is not a provider, show all services
    if (!currentProfile.is_provider) {
        return;
    }
    
    try {
        // Get provider's services
        const { data: providerServices, error } = await supabase
            .from('provider_services')
            .select('service_id')
            .eq('provider_id', currentProfile.user_id);
        
        if (error) {
            console.error('Error fetching provider services:', error);
            return;
        }
        
        // Get list of services the provider already provides
        const providedServices = providerServices ? providerServices.map(s => s.service_id) : [];
        
        // Get all options except the first one (Select Service)
        const options = Array.from(serviceSelect.options).slice(1);
        
        // MOBILE FIX: Remove options instead of hiding them
        options.forEach(option => {
            if (providedServices.includes(option.value)) {
                option.remove();  // Remove from DOM completely
            }
        });
        
    } catch (error) {
        console.error('Error filtering services:', error);
    }
}
        function backToDashboard() { 
    // Clear chat refresh interval
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
    
    showDashboard(); 
}

// Smart back function - goes to previous page or dashboard
function smartBack() {
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
    
    // âœ… Hide ALL possible views (including edit profile)
    const chatView = document.getElementById('chatView');
    const editProfileView = document.getElementById('editProfileView');
    const editRequestView = document.getElementById('editRequestView');
    const createRequestView = document.getElementById('createRequestView');
    
    if (chatView) {
        chatView.classList.add('hidden');
        chatView.style.display = 'none';
    }
    
    if (editProfileView) {
        editProfileView.classList.add('hidden');
        editProfileView.style.display = 'none';
    }
    
    if (editRequestView) {
        editRequestView.classList.add('hidden');
        editRequestView.style.display = 'none';
    }
    
    if (createRequestView) {
        createRequestView.classList.add('hidden');
        createRequestView.style.display = 'none';
    }
    
    // Restore header controls hidden by chat
const userMenu = document.querySelector('.user-menu');
const modeToggleBtn = document.getElementById('modeToggleBtn');
const createRequestBtn = document.getElementById('createRequestBtn');

if (userMenu) userMenu.style.display = 'flex';
if (modeToggleBtn) modeToggleBtn.style.display = currentProfile.is_provider ? 'flex' : 'none';
if (createRequestBtn && currentDashboardMode === 'seeker') createRequestBtn.style.display = 'block';

// Navigate back based on origin
if (chatOpenedFrom === 'responses-modal') {
    // Show responses modal (don't close it, keep it open)
    document.getElementById('responsesModal').classList.add('active');
    chatOpenedFrom = null;
} else {
    showDashboard();
    chatOpenedFrom = null;
}

}

async function showEditProfile() {
    // Hide logo and dashboard elements when on profile page
    const appLogo = document.getElementById('appLogo');
    const dashboardLogo = document.getElementById('dashboardLogo');
    const createRequestBtn = document.getElementById('createRequestBtn');
    
    if (appLogo) appLogo.style.display = 'none';
    if (dashboardLogo) dashboardLogo.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';

    const modeToggleBtn = document.getElementById('modeToggleBtn');
if (modeToggleBtn) modeToggleBtn.style.display = 'none';

    
    // Hide small profile photo and username dropdown
    const headerUserPhoto = document.getElementById('headerUserPhoto');
    const headerUserPhotoPlaceholder = document.getElementById('headerUserPhotoPlaceholder');
    const userButton = document.querySelector('.user-button');
    const userMenu = document.querySelector('.user-menu');
    
if (headerUserPhoto) headerUserPhoto.style.display = 'none';
    if (headerUserPhotoPlaceholder) headerUserPhotoPlaceholder.style.display = 'none';
    if (userButton) userButton.style.display = 'none';
    if (userMenu) userMenu.style.display = 'none';
    
    // âœ… HIDE the old profile header section (we have new back button in form now)
    const profileHeaderSection = document.getElementById('profileHeaderSection');
    if (profileHeaderSection) profileHeaderSection.style.display = 'none';
    // Hide the profile photo in header (we'll keep the one in the form instead)
const headerProfilePhotoLarge = document.getElementById('headerProfilePhotoLarge');
const headerProfilePhotoLargePlaceholder = document.getElementById('headerProfilePhotoLargePlaceholder');

if (headerProfilePhotoLarge) headerProfilePhotoLarge.style.display = 'none';
if (headerProfilePhotoLargePlaceholder) headerProfilePhotoLargePlaceholder.style.display = 'none';
    
    // ... rest of your existing code continues below ...
    // DON'T hide all views - just hide the dashboard CONTENT sections
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    if (seekerSection) seekerSection.style.display = 'none';
    if (providerSection) providerSection.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';
    
    // Show edit profile view
    document.getElementById('editEmail').value = currentUser.email || '';

    const editView = document.getElementById('editProfileView');
    if (editView) {
        editView.classList.remove('hidden');
        editView.style.display = 'block';
        editView.style.visibility = 'visible';
    }
    
    // Pre-fill form with current profile data
    document.getElementById('editName').value = currentProfile.name || '';
    document.getElementById('editPhone').value = currentProfile.phone || '';
    document.getElementById('editHouseNumber').value = currentProfile.house_number || '';
    document.getElementById('editAreaName').value = currentProfile.area_name || '';
    document.getElementById('editLandmark').value = currentProfile.landmark || '';
    document.getElementById('editCity').value = currentProfile.city || '';
    document.getElementById('editState').value = currentProfile.state || '';
    document.getElementById('editPinCode').value = currentProfile.pin_code || '';
    document.getElementById('editRadius').value = currentProfile.radius_km || 10;
    
    // Display current profile photo
    if (currentProfile.profile_photo) {
        document.getElementById('currentProfilePhoto').src = currentProfile.profile_photo;
        document.getElementById('currentProfilePhoto').style.display = 'block';
        document.getElementById('noProfilePhoto').style.display = 'none';
    } else {
        document.getElementById('currentProfilePhoto').style.display = 'none';
        document.getElementById('noProfilePhoto').style.display = 'flex';
    }
    
    // Update provider button
    setTimeout(() => {
        updateProviderButton();
    }, 100);
    
    if (currentProfile.is_provider) {
        await loadCurrentServices();
    }
}

async function loadCurrentServices() {
    try {
        const { data: services, error } = await supabase
            .from('provider_services')
            .select('service_id')
            .eq('provider_id', currentProfile.user_id);
        
        if (error) throw error;
        
        const container = document.getElementById('currentServicesList');
        
        if (!services || services.length === 0) {
            container.innerHTML = '<p style="color: #999; font-style: italic;">No services added yet</p>';
            return;
        }
        
        const serviceNames = {
            electrician: 'ğŸ”§ Electrician',
            plumber: 'ğŸš° Plumber',
            ac_repair: 'â„ï¸ AC Repair',
            carpenter: 'ğŸ”¨ Carpenter',
            painter: 'ğŸ¨ Painter',
            cleaner: 'ğŸ§¹ Cleaner'
        };
        
        container.innerHTML = services.map(s => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <span>${serviceNames[s.service_id] || s.service_id}</span>
                <button type="button" class="btn btn-cancel" onclick="removeService('${s.service_id}')">Remove</button>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading services:', error);
    }
}

async function addService() {
    const select = document.getElementById('newServiceSelect');
    const serviceId = select.value;
    
    if (!serviceId) {
        alert('Please select a service to add');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('provider_services')
            .insert([{
                provider_id: currentProfile.user_id,
                service_id: serviceId,
                service_radius: currentProfile.radius_km || 10
            }]);
        
        if (error) throw error;
        
        alert('âœ… Service added successfully!');
        select.value = '';
        await loadCurrentServices();
        
    } catch (error) {
        alert('Error adding service: ' + error.message);
    }
}

async function removeService(serviceId) {
    if (!confirm('Remove this service? This will permanently delete it from your profile.')) return;
    
    try {
        const { error } = await supabase
            .from('provider_services')
            .delete()
            .eq('provider_id', currentProfile.user_id)
            .eq('service_id', serviceId);
        
        if (error) throw error;
        
        alert('âœ… Service removed successfully!');
        await loadCurrentServices();
        
    } catch (error) {
        alert('Error removing service: ' + error.message);
    }
}

function backFromChat() {
    if (currentChatData && currentChatData.isPreSelection) {
        // If chatting before selection, go back to responses
        viewResponses(currentChatData.requestId);
    } else {
        // If chatting after selection, go to dashboard
        showDashboard();
    }
}

        function setupCharCounters() {
            const titleInput = document.getElementById('requestTitle');
            const descInput = document.getElementById('requestDescription');
            const editTitleInput = document.getElementById('editRequestTitle');
            const editDescInput = document.getElementById('editRequestDescription');
            
            if (titleInput) {
                titleInput.addEventListener('input', (e) => { 
                    document.getElementById('titleCounter').textContent = e.target.value.length; 
                });
            }
            
            if (descInput) {
                descInput.addEventListener('input', (e) => { 
                    document.getElementById('descCounter').textContent = e.target.value.length; 
                });
            }
            
            if (editTitleInput) {
                editTitleInput.addEventListener('input', (e) => { 
                    document.getElementById('editTitleCounter').textContent = e.target.value.length; 
                });
            }
            
            if (editDescInput) {
                editDescInput.addEventListener('input', (e) => { 
                    document.getElementById('editDescCounter').textContent = e.target.value.length; 
                });
            }
        }

        function toggleLocationFields() {
    const checked = document.getElementById('differentLocation').checked;
    document.getElementById('customLocationFields').classList.toggle('hidden', !checked);
}

        function validatePhoneInput(input) {
    const value = input.value;
    const errorId = input.id + 'Error';
    const errorDiv = document.getElementById(errorId);
    
    // Remove any non-digit characters
    input.value = value.replace(/[^0-9]/g, '');
    
    // Restrict to exactly 10 digits (prevent more than 10)
    if (input.value.length > 10) {
        input.value = input.value.substring(0, 10);
    }
    
    // If empty, hide error
    if (input.value.length === 0) {
        if (errorDiv) errorDiv.style.display = 'none';
        return false;
    }
    
    // Must be exactly 10 digits for validation
    if (input.value.length !== 10) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    const phone = input.value;
    
    // ===== VALIDATION RULES =====
    
    // Rule 1: Must start with 6, 7, 8, or 9
    const firstDigit = phone.charAt(0);
    if (!['6', '7', '8', '9'].includes(firstDigit)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 2: All same digits (6666666666)
    if (/^(\d)\1{9}$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 3: Alternating pattern (9898989898, 6767676767)
    if (/^(\d)(\d)\1\2\1\2\1\2\1\2$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 4: Three-digit alternating (989898989, 676767676)
    if (/^(\d)(\d)\1\2\1\2\1\2\1$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 5: Sequential ascending (0123456789, 1234567890, etc.)
    const sequentialPatterns = [
        '0123456789', '1234567890', '2345678901', '3456789012',
        '4567890123', '5678901234', '6789012345', '7890123456',
        '8901234567', '9012345678'
    ];
    if (sequentialPatterns.includes(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 6: Sequential descending (9876543210, 8765432109, etc.)
    const reverseSequentialPatterns = [
        '9876543210', '8765432109', '7654321098', '6543210987',
        '5432109876', '4321098765', '3210987654', '2109876543',
        '1098765432', '0987654321'
    ];
    if (reverseSequentialPatterns.includes(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 7: Too many repeated digits (more than 5 same digits)
    const digitCounts = {};
    for (let digit of phone) {
        digitCounts[digit] = (digitCounts[digit] || 0) + 1;
        if (digitCounts[digit] > 5) {
            if (errorDiv) {
                errorDiv.textContent = 'Enter correct number';
                errorDiv.style.display = 'block';
            }
            return false;
        }
    }
    
    // Rule 8: Repeating pairs (9988776655, 6677889900)
    if (/^(\d)\1(\d)\2(\d)\3(\d)\4(\d)\5$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 9: Common fake numbers (manually curated list)
    const commonFakeNumbers = [
        '9999999999', '8888888888', '7777777777', '6666666666',
        '1234567890', '0987654321', '9876543210',
        '1111111111', '2222222222', '3333333333', '4444444444', '5555555555',
        '9999900000', '8888800000', '7777700000',
        '0000000000', '1231231234', '9879879876'
    ];
    if (commonFakeNumbers.includes(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 10: Lack of digit diversity (must have at least 4 unique digits)
    const uniqueDigits = new Set(phone.split('')).size;
    if (uniqueDigits < 4) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 11: Check for repeating sequences of 3+ digits (888999888, 777666777)
    if (/(\d)\1{2,}/.test(phone)) {
        const matches = phone.match(/(\d)\1{2,}/g);
        if (matches && matches.length > 2) {
            if (errorDiv) {
                errorDiv.textContent = 'Enter correct number';
                errorDiv.style.display = 'block';
            }
            return false;
        }
    }
    
    // All validations passed
    if (errorDiv) errorDiv.style.display = 'none';
    return true;
}

        function toggleProviderFieldsSignup() {
            const checked = document.getElementById('isProvider').checked;
            document.getElementById('signupProviderFields').classList.toggle('hidden', !checked);
        }

function updateProviderButton() {
    const btn = document.getElementById('toggleProviderBtn');
    const text = document.getElementById('providerStatusText');
    const isProvider = currentProfile.is_provider;
    
    if (!btn || !text) return; // Safety check
    
    if (isProvider) {
        text.textContent = 'âœ… Providing Services (Click to Stop)';
        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
    } else {
        text.textContent = 'âŒ Not Providing Services (Click to Start)';
        btn.style.background = 'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)';
    }
    
    document.getElementById('providerSettings').classList.toggle('hidden', !isProvider);
}

async function toggleProviderStatus() {
    const isCurrentlyProvider = currentProfile.is_provider;
    const btn = document.getElementById('toggleProviderBtn');
    const text = document.getElementById('providerStatusText');
    
    if (!isCurrentlyProvider) {
        // User wants to become a provider
        const confirmed = confirm('âš ï¸ Start providing services?\n\nYou will receive notifications for service requests in your selected area. You can add services and set your service radius.');
        
        if (confirmed) {
            currentProfile.is_provider = true;
            updateProviderButton();
        }
    } else {
        // User wants to stop being a provider
        const confirmed = confirm('âš ï¸ Stop providing services?\n\nYou will no longer receive notifications for service requests. All your services will be removed from your profile.');
        
        if (confirmed) {
            currentProfile.is_provider = false;
            updateProviderButton();
        }
    }
}

// Approve completion from chat message button
async function approveCompletionFromChat(messageIndex) {
    if (!confirm('âœ… Accept work completion?\n\nThis will mark the request as completed and you can rate the provider.')) return;
    
    try {
        // Get existing chat messages
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Update the completion request message status
        if (messages[messageIndex]) {
            messages[messageIndex].completion_request_status = 'approved';
        }
        
        // Update request status to completed
        const { error: updateError } = await supabase
            .from('requests')
            .update({ status: 'completed' })
            .eq('id', currentChatData.requestId);
        
        if (updateError) throw updateError;
        
        // Add system message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: 'âœ… Work completion accepted by customer. Request is now completed!',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        // Update chat
        await supabase
            .from('chats')
            .update({ messages: messages })
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId);
        
        // Update chat status display
        document.getElementById('chatRequestStatus').textContent = 'COMPLETED';
        currentChatData.requestStatus = 'completed';
        
        await loadChatMessages();
        
        // Open rating modal
        alert('âœ… Work completion accepted! Please rate the provider.');
        openRatingModal(currentChatData.requestId, currentChatData.providerId, currentChatData.partnerName);
        
    } catch (error) {
        alert('âŒ Error: ' + error.message);
    }
}

// Reject completion from chat message button
async function rejectCompletionFromChat(messageIndex) {
    const reason = prompt('âŒ Reject work completion?\n\nPlease provide a reason for rejection (the provider will see this):');
    
    if (!reason || reason.trim() === '') return;
    
    try {
        // Get existing chat messages
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Update the completion request message status
        if (messages[messageIndex]) {
            messages[messageIndex].completion_request_status = 'declined';
        }
        
        // Update request status back to in_progress
        const { error: updateError } = await supabase
            .from('requests')
            .update({ status: 'in_progress' })
            .eq('id', currentChatData.requestId);
        
        if (updateError) throw updateError;
        
        // Add system message with rejection reason
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: `âŒ Work completion rejected by customer.\n\nReason: ${reason.trim()}\n\nPlease continue working to resolve the issues.`,
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        // Update chat
        await supabase
            .from('chats')
            .update({ messages: messages })
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId);
        
        // Update chat status display
        document.getElementById('chatRequestStatus').textContent = 'IN PROGRESS';
        currentChatData.requestStatus = 'in_progress';
        
        await loadChatMessages();
        
        alert('âŒ Completion rejected. The provider can see your feedback and will continue working.');
        
    } catch (error) {
        alert('âŒ Error: ' + error.message);
    }
}

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: document.getElementById('loginEmail').value.trim(),
                    password: document.getElementById('loginPassword').value
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                
                // âœ… CRITICAL FIX: Explicitly hide login view BEFORE loading profile
                const loginView = document.getElementById('loginView');
                if (loginView) {
                    loginView.classList.add('hidden');
                    loginView.style.display = 'none';
                }
                
                await loadProfile();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // Signup
document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const errorDiv = document.getElementById('signupError');
    const infoDiv = document.getElementById('signupInfo');
    const submitBtn = document.querySelector('#signupForm button[type="submit"]');

    errorDiv.classList.add('hidden');
    infoDiv.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating Account...';

    try {
        console.log('ğŸ”µ STEP 0: Form submission started');
        
        // Validate phone number before proceeding
        const phoneInput = document.getElementById('signupPhone');
        if (!validatePhoneInput(phoneInput)) {
            errorDiv.textContent = 'Please enter a valid phone number';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign Up';
            return;
        }

        const formData = {
            email: document.getElementById('signupEmail').value.trim(),
            password: document.getElementById('signupPassword').value,
            name: document.getElementById('signupName').value.trim(),
            phone: document.getElementById('signupPhone').value.trim(),
            house_number: document.getElementById('houseNumber').value.trim() || null,
            area_name: document.getElementById('areaName').value.trim(),
            landmark: document.getElementById('landmark').value.trim() || null,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pin_code: document.getElementById('pinCode').value.trim(),
            is_provider: document.getElementById('isProvider').checked
        };
        
        console.log('ğŸ”µ STEP 1: Form data collected:', formData);

        // âœ… STEP 1: Get coordinates (with retry on failure)
        showLoading();
        infoDiv.textContent = 'ğŸ“ Locating your address...';
        infoDiv.classList.remove('hidden');
        
        console.log('ğŸ”µ STEP 2: Starting geocoding...');
        
        let coords;
        try {
            coords = await getCoordinates(formData);
            console.log('âœ… STEP 2 COMPLETE: Coordinates obtained:', coords);
        } catch (error) {
            console.error('âŒ STEP 2 FAILED: Geocoding error:', error);
            // Geocoding failed - show clear error
            hideAllViews();
            document.getElementById('signupView').classList.remove('hidden');
            errorDiv.textContent = 'âŒ ' + error.message + '\n\nPlease retry signup with a valid address or allow GPS access.';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign Up';
            infoDiv.classList.add('hidden');
            return; // Stop signup
        }
        
        console.log('ğŸ”µ STEP 3: Calling Supabase signUp...');
        
        // âœ… STEP 2: Create auth user
        infoDiv.textContent = 'ğŸ‘¤ Creating your account...';
        
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: formData.email,
            password: formData.password,
            options: {
                emailRedirectTo: `${window.location.origin}`
            }
        });
        
        console.log('âœ… STEP 3 COMPLETE: Supabase signUp response:', authData, authError);

if (authError) {
    console.error('âŒ STEP 3 FAILED: Auth error:', authError);
    throw authError;
}

// âœ… STEP 4: Use authData.user (no session needed during signup)
console.log('ğŸ”µ STEP 4: Using auth user from signup response...');

if (!authData || !authData.user || !authData.user.id) {
    console.error('âŒ STEP 4 FAILED: No user data in signup response');
    throw new Error('Signup failed. No user data returned.');
}

console.log('âœ… STEP 4 COMPLETE: Auth user ID obtained:', authData.user.id);

console.log('ğŸ”µ STEP 5: Creating profile (WHILE LOGGED IN)...');

// âœ… STEP 5: Create profile WHILE USER IS STILL LOGGED IN
infoDiv.textContent = 'ğŸ’¾ Saving your profile...';

// Calculate verification link expiry time (48 hours from now)
const expiryTime = new Date();
expiryTime.setHours(expiryTime.getHours() + 48);

const { error: profileError } = await supabase.from('profiles').insert([{
    user_id: authData.user.id,
    name: formData.name,
    phone: formData.phone,
    house_number: formData.house_number,
    area_name: formData.area_name,
    landmark: formData.landmark,
    city: formData.city,
    state: formData.state,
    pin_code: formData.pin_code,
    latitude: coords.lat,
    longitude: coords.lng,
    is_provider: formData.is_provider,
    email_verified: false,  // â† NEW: Mark as unverified
    verification_link_expires_at: expiryTime.toISOString(),  // â† NEW: Set 48-hour expiry
    last_verification_email_sent_at: new Date().toISOString()  // â† NEW: Track email send time
}]);

console.log('âœ… STEP 5 COMPLETE: Profile creation result:', profileError);

if (profileError) {
    console.error('âŒ STEP 5 FAILED: Profile error:', profileError);
    throw profileError;
}

        console.log('ğŸ”µ STEP 6: Adding provider services (if applicable)...');

        // âœ… STEP 4: If provider, create services
        if (formData.is_provider) {
            const services = [];
            if (document.getElementById('service_electrician').checked) services.push('electrician');
            if (document.getElementById('service_plumber').checked) services.push('plumber');
            if (document.getElementById('service_ac_repair').checked) services.push('ac_repair');
            if (document.getElementById('service_carpenter').checked) services.push('carpenter');
            if (document.getElementById('service_painter').checked) services.push('painter');
            if (document.getElementById('service_cleaner').checked) services.push('cleaner');
            
            if (services.length > 0) {
                const radius = parseInt(document.getElementById('signupRadius').value) || 10;
                
                const serviceData = services.map(serviceId => ({
                    provider_id: session.user.id,
                    service_id: serviceId,
                    service_radius: radius
                }));
                
                const { error: serviceError } = await supabase.from('provider_services').insert(serviceData);
                console.log('âœ… STEP 6 COMPLETE: Provider services added:', serviceError);
                
                // Update profile with radius
                await supabase.from('profiles').update({ radius_km: radius }).eq('user_id', session.user.id);
            }
        } else {
            console.log('âœ… STEP 6 SKIPPED: Not a provider');
        }

        console.log('âœ… âœ… âœ… SIGNUP COMPLETE! Logging out...');
        
        // âœ… Logout user immediately (force email verification)
        await supabase.auth.signOut();
        
        // âœ… Hide signup view
        const signupView = document.getElementById('signupView');
        if (signupView) {
            signupView.classList.add('hidden');
            signupView.style.display = 'none';
        }
        
        // âœ… Hide info message
        infoDiv.classList.add('hidden');
        
        // âœ… Show success alert
        alert('âœ… Account created successfully!\n\nğŸ“§ Please check your email inbox (and spam folder) for the verification link.\n\nâš ï¸ You MUST verify your email before you can login.');
        
        // âœ… Clear form
        document.getElementById('signupForm').reset();
        
        // âœ… Go to login page
        showLogin();
        
    } catch (error) {
        console.error('âŒ âŒ âŒ SIGNUP FAILED:', error);
        hideAllViews();
        document.getElementById('signupView').classList.remove('hidden');
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
        infoDiv.classList.add('hidden');
    }
});

        // Geocoding
        async function getCoordinates(formData) {
            const strategies = [
                formData.house_number 
                    ? `${formData.house_number}, ${formData.area_name}, ${formData.landmark || ''}, ${formData.city}, ${formData.state}, India`.replace(/,\s*,/g, ',')
                    : null,
                formData.landmark
                    ? `${formData.area_name}, ${formData.landmark}, ${formData.city}, ${formData.state}, India`
                    : null,
                `${formData.area_name}, ${formData.city}, ${formData.state}, India`
            ];

            // Try all geocoding strategies with detailed logging
for (let address of strategies.filter(Boolean)) {
    try {
        console.log('ğŸ” Trying to geocode:', address);
        const coords = await geocodeAddress(address);
        if (coords) {
            console.log('âœ… Geocoding success:', coords);
            return coords;
        }
    } catch (error) {
        console.log('âŒ Geocoding failed for:', address, error);
    }
}

// All geocoding strategies failed - show helpful message
console.log('âš ï¸ All geocoding strategies failed. Requesting GPS...');

            // Mobile-friendly GPS request
return new Promise((resolve, reject) => {
    // Try to get GPS location
    if (!navigator.geolocation) {
        reject(new Error('ğŸš« GPS not supported on your device. Please enter a more specific address (e.g., include landmark) and try again.'));
        return;
    }
    
    // Show a user-friendly alert (works better on mobile than confirm)
    alert('ğŸ“ LOCATION REQUIRED\n\nWe could not find your address on the map.\n\nOn the next screen:\nâ€¢ Click "Allow" to share your GPS location\nâ€¢ This is needed to match you with nearby service providers\n\nNote: Your exact location is never shared publicly.');
    
    // Request GPS location
    navigator.geolocation.getCurrentPosition(
        (position) => {
            console.log('âœ… GPS location obtained:', position.coords);
            resolve({ 
                lat: position.coords.latitude, 
                lng: position.coords.longitude 
            });
        },
        (error) => {
            console.error('âŒ GPS error:', error);
            
            let errorMessage = 'âŒ LOCATION ACCESS DENIED\n\n';
            
            if (error.code === 1) {
                // User denied permission
                errorMessage += 'ğŸš« You denied location access.\n\n';
                errorMessage += 'ğŸ“ Please either:\n';
                errorMessage += '1. Allow location access and retry\n';
                errorMessage += '2. Enter a more specific address with landmark\n';
                errorMessage += '3. Try again with correct address\n\n';
                errorMessage += 'Example: 36 A, RAM CHOWK, NEAR CITY HOSPITAL, BHIWANI, HARYANA, 127021';
            } else if (error.code === 2) {
                // Position unavailable
                errorMessage += 'ğŸ“ GPS signal not available.\n\n';
                errorMessage += 'Please enter a more specific address with landmark and try again.';
            } else if (error.code === 3) {
                // Timeout
                errorMessage += 'â° GPS timeout.\n\n';
                errorMessage += 'Please retry or enter a more specific address.';
            }
            
            reject(new Error(errorMessage));
        },
        {
            enableHighAccuracy: true,
            timeout: 15000, // 15 seconds timeout
            maximumAge: 0
        }
    );
});
        }

        // Geocode using OpenStreetMap (Nominatim)
async function geocodeWithOpenStreetMap(address) {
    try {
        console.log('ğŸ”µ Trying OpenStreetMap:', address);
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1&countrycodes=in`;
        const response = await fetch(url, { headers: { 'User-Agent': 'HelpBuddy/1.0' } });
        const data = await response.json();
        
        if (data && data.length > 0) {
            console.log('âœ… OpenStreetMap SUCCESS:', data[0]);
            return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        }
        console.log('âš ï¸ OpenStreetMap: No results found');
        return null;
    } catch (error) {
        console.error('âŒ OpenStreetMap error:', error);
        return null;
    }
}

// Geocode using OpenCage API
async function geocodeWithOpenCage(address) {
    try {
        console.log('ğŸ”µ Trying OpenCage:', address);
        // You'll need to get a FREE API key from https://opencagedata.com/api
        const apiKey = 'c227c2331da94f6b862df0a4f4149920'; // â† Replace with your key
        
        const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(address)}&key=${apiKey}&countrycode=in&limit=1&language=en`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
            console.log('âœ… OpenCage SUCCESS:', data.results[0]);
            return { 
                lat: data.results[0].geometry.lat, 
                lng: data.results[0].geometry.lng 
            };
        }
        console.log('âš ï¸ OpenCage: No results found');
        return null;
    } catch (error) {
        console.error('âŒ OpenCage error:', error);
        return null;
    }
}

// Master geocoding function with fallback
async function geocodeAddress(address) {
    // Try OpenStreetMap first (free, no limit)
    let coords = await geocodeWithOpenStreetMap(address);
    if (coords) return coords;
    
    // Try OpenCage if OpenStreetMap fails (free 2,500/day)
    coords = await geocodeWithOpenCage(address);
    if (coords) return coords;
    
    // Both failed
    return null;
}

        function getBrowserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) reject(new Error('Geolocation not supported'));
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                    (error) => reject(new Error('Unable to locate address. Please try again or allow location access.'))
                );
            });
        }

        // Convert Image to Base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Load Profile
        async function loadProfile() {
    // Prevent infinite loop
    if (window.isLoadingProfile) {
        console.log('âš ï¸ Already loading profile, skipping...');
        return;
    }
    window.isLoadingProfile = true;
    
    console.log('Step 5: loadProfile started');
    showLoading();
    try {
        console.log('Step 6: Fetching profile for user:', currentUser.id);
        const { data, error } = await supabase.from('profiles').select('*').eq('user_id', currentUser.id).single();
        if (error) throw error;
        
        currentProfile = data;
        console.log('Step 7: Profile loaded:', currentProfile);
        displayProfile(data);
        console.log('Step 8: Calling showDashboard');
        showDashboard();
        
        window.isLoadingProfile = false;  // Reset flag
    } catch (error) {
        window.isLoadingProfile = false;  // Reset flag on error too
        alert('Error loading profile: ' + error.message);
        showLogin();
    }
}

// Handle Password Reset
async function handlePasswordReset() {
    console.log('ğŸ”µ Checking for password reset token...');
    
    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    
    const token = urlParams.get('token') || hashParams.get('access_token');
    const type = urlParams.get('type') || hashParams.get('type');
    
    // Check if this is a password reset callback
    if (!token || type !== 'recovery') {
        return false;
    }
    
    console.log('âœ… Password reset token found, showing reset form...');
    
    // Hide all views
    hideAllViews();
    
    // Show password reset view
    const resetView = document.getElementById('passwordResetView');
    if (resetView) {
        resetView.classList.remove('hidden');
        resetView.style.display = 'block';
        resetView.style.visibility = 'visible';
    }
    
    // Clean URL
    window.history.replaceState({}, document.title, '/');
    
    return true;
}

// Password Reset Form Submission
document.addEventListener('DOMContentLoaded', () => {
    const passwordResetForm = document.getElementById('passwordResetForm');
    if (passwordResetForm) {
        passwordResetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('passwordResetError');
            const infoDiv = document.getElementById('passwordResetInfo');
            const submitBtn = document.getElementById('resetPasswordBtn');
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            
            // Validation
            if (newPassword.length < 6) {
                errorDiv.textContent = 'âŒ Password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'âŒ Passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) throw error;
                
                alert('âœ… Password reset successful! Please login with your new password.');
                
                // âœ… CRITICAL FIX: Hide password reset view explicitly
                const passwordResetView = document.getElementById('passwordResetView');
                if (passwordResetView) {
                    passwordResetView.classList.add('hidden');
                    passwordResetView.style.display = 'none';
                }
                
                // Logout and redirect to login
                await supabase.auth.signOut();
                showLogin();
                
            } catch (error) {
                errorDiv.textContent = 'âŒ Error: ' + error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ”’ Reset Password';
            }
        });
    }
});


// Handle email verification callback
async function handleEmailVerification() {
    console.log('ğŸ”µ Checking for email verification...');
    
    // Check URL for verification tokens
    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    
    // Get token from either query params or hash
    const token = urlParams.get('token') || hashParams.get('access_token');
    const type = urlParams.get('type') || hashParams.get('type');
    
    // If no token, not a verification callback
    if (!token || type !== 'signup') {
        return false;
    }
    
    console.log('âœ… Verification token found, processing...');
    showLoading();
    
    try {
        // Get the current session (Supabase auto-logs in verified users)
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) throw sessionError;
        
        if (!session) {
            throw new Error('No session found after verification');
        }
        
        console.log('âœ… Session found:', session.user.id);
        
        // âœ… NEW: Check if profile exists (it should, because we created it during signup)
        const { data: existingProfile, error: profileError } = await supabase
            .from('profiles')
            .select('email_verified')
            .eq('user_id', session.user.id)
            .maybeSingle();
        
        if (profileError) {
            console.error('âŒ Profile fetch error:', profileError);
            throw new Error('Error loading profile: ' + profileError.message);
        }
        
        if (!existingProfile) {
            // Profile doesn't exist - something went wrong during signup
            throw new Error('Profile not found. Please contact support or try signing up again.');
        }
        
        // âœ… Profile exists - just update email_verified flag
        console.log('ğŸ“ Updating email_verified flag...');
        
        
        
        console.log('âœ… Email verified successfully!');
        
        // Logout the user (they should login manually after verification)
        await supabase.auth.signOut();
        
        // Clean URL
        window.history.replaceState({}, document.title, '/');
        
        // Show success message
        alert('âœ… Email verified successfully!\n\nğŸ‰ Your account is now active.\n\nğŸ‘‰ Please login to access HelpBuddy.');
        
        // Redirect to login page
        showLogin();
        
        return true;
        
    } catch (error) {
        console.error('âŒ Verification error:', error);
        
        // Clean URL
        window.history.replaceState({}, document.title, '/');
        
        // Show error and redirect to login
        alert('âŒ Error verifying email: ' + error.message + '\n\nPlease try logging in. If the problem persists, contact support.');
        
        showLogin();
        
        return false;
    }
}

        function displayProfile(profile) {
    // Update header username and photo
    const headerUsername = document.getElementById('headerUsername');
    const headerPhoto = document.getElementById('headerUserPhoto');
    const headerPhotoPlaceholder = document.getElementById('headerUserPhotoPlaceholder');
    
    if (headerUsername) {
        headerUsername.textContent = profile.name;
    }
    
    // Display profile photo in header
    if (profile.profile_photo) {
        headerPhoto.src = profile.profile_photo;
        headerPhoto.style.display = 'block';
        headerPhotoPlaceholder.style.display = 'none';
    } else {
        headerPhoto.style.display = 'none';
        headerPhotoPlaceholder.style.display = 'flex';
    }
}

        // Load Dashboard Data
        async function loadDashboardData() {
    if (currentProfile.is_provider) {
        document.getElementById('providerSection').classList.remove('hidden');
        loadProviderResponses();
	loadProviderOpenRequests();
        loadNearbyRequests();
    }
    
    document.getElementById('seekerSection').classList.remove('hidden');
    loadUserRequests();
}

        // Load User Requests (Seeker View)
        async function loadUserRequests() {
    try {
        const { data, error } = await supabase
            .from('requests')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Ensure filter is set to 'no_response' on initial load
if (!currentRequestFilter || currentRequestFilter === '') {
    currentRequestFilter = 'no_response';
}

        await displayUserRequests(data || []);
                
                const openRequests = (data || []).filter(r => r.status === 'open');
                document.getElementById('createRequestBtn').disabled = openRequests.length >= 5;
                document.getElementById('requestLimitWarning').classList.toggle('hidden', openRequests.length < 5);
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

async function displayUserRequests(requests) {
    // Determine which container to use based on current filter
let container;
if (currentRequestFilter === 'open' || currentRequestFilter === 'no_response' || currentRequestFilter === 'negotiating') {
    container = document.getElementById('openRequestsList');
} else {
    container = document.getElementById('activeRequestsList');
}

    if (!container) {
        console.error('Container not found for filter:', currentRequestFilter);
        return;
    }

    if (requests.length === 0) {
        // Update ALL badge counts first
        const openRequestsTotalEl = document.getElementById('openRequestsTotal');
        const activeRequestsTotalEl = document.getElementById('activeRequestsTotal');
        const respondedCountEl = document.getElementById('respondedCount');
        const inProgressCountEl = document.getElementById('inProgressCount');
        const completedCountEl = document.getElementById('completedCount');

        if (openRequestsTotalEl) openRequestsTotalEl.textContent = '0';
        if (activeRequestsTotalEl) activeRequestsTotalEl.textContent = '0';
        if (respondedCountEl) respondedCountEl.textContent = '0';
        if (inProgressCountEl) inProgressCountEl.textContent = '0';
        if (completedCountEl) completedCountEl.textContent = '0';

        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <div class="empty-state-text">No service requests yet</div>
                <button class="btn" onclick="showCreateRequestForm()">Create Your First Request</button>
            </div>
        `;
        return;
    }

            // Count statistics
const respondedRequests = [];
const pendingRequests = [];
const responseCountMap = {};
let newMessagesTotal = 0;
let respondedUnreadCount = 0;
let pendingUnreadCount = 0;
let completedUnreadCount = 0;

// Check for responses and new messages
for (let req of requests) {
    if (req.status === 'open') {  // âœ… ONLY count open requests as "responded"
        const { data: responses } = await supabase
            .from('request_responses')
            .select('id')
            .eq('request_id', req.id);
                    
                    const responseCount = responses ? responses.length : 0;
                    responseCountMap[req.id] = responseCount;
                    
                    if (responseCount > 0) {
            respondedRequests.push(req.id);
        }
    } else if (req.status === 'pending_completion') {  // âœ… SKIP in_progress - it has its own tab
        pendingRequests.push(req.id);
    } else if (req.status === 'completed') {
                    respondedRequests.push(req.id);
                }
                
                if ((req.status === 'in_progress' || req.status === 'completed') && req.selected_provider_id) {
                    const { data: chat } = await supabase
    .from('chats')
    .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
    .eq('request_id', req.id)
    .eq('provider_id', req.selected_provider_id)
    .single();
                    
                    if (chat && chat.messages) {
                        // Get last viewed time for seeker
const lastViewedAt = chat.seeker_last_viewed_at;

// Count only messages AFTER last viewed time
const unread = chat.messages.filter(m => 
    m.sender_id !== currentUser.id &&
    (!lastViewedAt || new Date(m.timestamp) > new Date(lastViewedAt))
).length;
                        newMessagesTotal += unread;
                        
                        // Add to category-specific counters
                        if (req.status === 'in_progress') {
                            respondedUnreadCount += unread;
                        } else if (req.status === 'completed') {
                            completedUnreadCount += unread;
                        }
                    }
                } else if (req.status === 'pending_completion' && req.selected_provider_id) {
                    const { data: chat } = await supabase
                        .from('chats')
                        .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
                        .eq('request_id', req.id)
                        .eq('provider_id', req.selected_provider_id)
                        .single();
                    
                    if (chat && chat.messages) {
    // Get last viewed time for seeker
    const lastViewedAt = chat.seeker_last_viewed_at;
    
    // Count only messages AFTER last viewed time
    const unread = chat.messages.filter(m => 
        m.sender_id !== currentUser.id &&
        (!lastViewedAt || new Date(m.timestamp) > new Date(lastViewedAt))
    ).length;
    
    newMessagesTotal += unread;
                        pendingUnreadCount += unread;
                    }
                }
            }

            // Update section badges
            const completedRequests = requests.filter(r => r.status === 'completed');
const pendingCompletionRequests = requests.filter(r => r.status === 'pending_completion');  // âœ… NEW LINE
const negotiatingRequests = requests.filter(r => 
    respondedRequests.includes(r.id) && 
    r.status === 'open'
);
const openWithoutResponse = requests.filter(r => !respondedRequests.includes(r.id) && !pendingRequests.includes(r.id) && r.status === 'open');
            
            // Update section badges with null checks
const openRequestsTotalEl = document.getElementById('openRequestsTotal');
const activeRequestsTotalEl = document.getElementById('activeRequestsTotal');
const respondedCountEl = document.getElementById('respondedCount');
const inProgressCountEl = document.getElementById('inProgressCount');
const completedCountEl = document.getElementById('completedCount');

// Calculate counts for each category
const openCount = openWithoutResponse.length;
const negotiatingCount = negotiatingRequests.length;
const inProgressCount = requests.filter(r => r.status === 'in_progress').length;
const completedCount = completedRequests.length;

// Update No Response and Negotiating counts
const noResponseCountEl = document.getElementById('noResponseCount');
const negotiatingCountEl = document.getElementById('negotiatingCount');
if (noResponseCountEl) noResponseCountEl.textContent = openCount;
if (negotiatingCountEl) negotiatingCountEl.textContent = negotiatingCount;

// Update Open Requests heading (no response + negotiating)
const openTotal = openCount + negotiatingCount;
if (openRequestsTotalEl) openRequestsTotalEl.textContent = openTotal;

// Update Active Requests heading (in progress + pending completion + completed)
const activeTotal = inProgressCount + pendingCompletionRequests.length + completedCount;
if (activeRequestsTotalEl) activeRequestsTotalEl.textContent = activeTotal;

// Update individual tab counts (NO MORE respondedCountEl)
if (inProgressCountEl) inProgressCountEl.textContent = inProgressCount;

// Add pending completion count
const pendingCompletionCountEl = document.getElementById('pendingCompletionCount');
if (pendingCompletionCountEl) pendingCompletionCountEl.textContent = pendingCompletionRequests.length;  // âœ… FIXED

if (completedCountEl) completedCountEl.textContent = completedCount;

// Update Active Requests heading unread badge - ONLY show if there are unread messages
const activeRequestsUnreadBadge = document.getElementById('activeRequestsUnreadBadge');
if (activeRequestsUnreadBadge) {
    if (newMessagesTotal > 0) {
        const unreadBadgeSpan = activeRequestsUnreadBadge.querySelector('.unread-badge');
        if (unreadBadgeSpan) unreadBadgeSpan.textContent = newMessagesTotal;
        activeRequestsUnreadBadge.style.display = 'inline-flex';
        activeRequestsUnreadBadge.classList.remove('hidden');
    } else {
        activeRequestsUnreadBadge.style.display = 'none';
        activeRequestsUnreadBadge.classList.add('hidden');
    }
}    
            
            
            // Update main header badge (MY REQUESTS)
try {
    const mainHeaderBadge = document.getElementById('myRequestsUnreadBadge');
    if (mainHeaderBadge) {
        const unreadBadge = mainHeaderBadge.querySelector('.unread-badge');
        if (newMessagesTotal > 0) {
            if (unreadBadge) unreadBadge.textContent = newMessagesTotal;
            mainHeaderBadge.classList.remove('hidden');
            mainHeaderBadge.style.display = 'inline-flex';
        } else {
            mainHeaderBadge.classList.add('hidden');
            mainHeaderBadge.style.display = 'none';
        }
    }
} catch (error) {
    console.log('Badge update error (main):', error);
}

try {
    const inProgressUnreadBadge = document.getElementById('inProgressUnread');
    if (inProgressUnreadBadge) {
        const badge = inProgressUnreadBadge.querySelector('.unread-badge');
        if (pendingUnreadCount > 0) {
            if (badge) badge.textContent = pendingUnreadCount;
            inProgressUnreadBadge.classList.remove('hidden');
            inProgressUnreadBadge.style.display = 'inline-flex';
        } else {
            inProgressUnreadBadge.classList.add('hidden');
            inProgressUnreadBadge.style.display = 'none';
        }
    }
} catch (error) {
    console.log('Badge update error (in progress):', error);
}

try {
    const completedUnreadBadge = document.getElementById('completedUnread');
    if (completedUnreadBadge) {
        const badge = completedUnreadBadge.querySelector('.unread-badge');
        if (completedUnreadCount > 0) {
            if (badge) badge.textContent = completedUnreadCount;
            completedUnreadBadge.classList.remove('hidden');
            completedUnreadBadge.style.display = 'inline-flex';
        } else {
            completedUnreadBadge.classList.add('hidden');
            completedUnreadBadge.style.display = 'none';
        }
    }
} catch (error) {
    console.log('Badge update error (completed):', error);
}

            // Filter requests based on current filter
let filteredRequests = requests;
if (currentRequestFilter === 'open' || currentRequestFilter === 'no_response') {
    filteredRequests = openWithoutResponse;
} else if (currentRequestFilter === 'negotiating') {
    filteredRequests = negotiatingRequests;
} else if (currentRequestFilter === 'in_progress') {
    filteredRequests = requests.filter(r => r.status === 'in_progress');
} else if (currentRequestFilter === 'pending_completion') {
    filteredRequests = pendingCompletionRequests;  // âœ… FIXED - use the correct array
    filteredRequests = requests.filter(r => pendingRequests.includes(r.id));
} else if (currentRequestFilter === 'completed') {
    filteredRequests = completedRequests;
}

            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div class="empty-state-text">No ${currentRequestFilter} requests</div>
                    </div>
                `;
                return;
            }

            let html = '';            

            for (let req of filteredRequests) {
                const serviceIcon = SERVICE_ICONS[req.service_category] || 'ğŸ”§';
                const isReactivated = req.status === 'in_progress' && req.warranty_end_date;
                
		const reactivatedBadge = isReactivated ? '<span style="color: #dc3545; font-weight: 700; font-size: 11px; margin-left: 6px; background: #fee; padding: 2px 8px; border-radius: 4px;">REACTIVATED</span>' : '';
		const statusClass = `status-${req.status.replace('_', '-')}`;
                let statusText = req.status.replace('_', ' ').toUpperCase();
                const timeAgo = getTimeAgo(new Date(req.created_at));

                let warrantyBadge = '';
                if (req.status === 'completed' && req.warranty_end_date) {
                    const isSeeker = req.user_id === currentUser.id;
                    const isSelectedProvider = req.selected_provider_id === currentProfile.user_id;
                    
                    if (isSeeker || isSelectedProvider) {
                        const warrantyEndDate = new Date(req.warranty_end_date);
                        const today = new Date();
                        const remainingDays = Math.ceil((warrantyEndDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (remainingDays > 0) {
                            warrantyBadge = `<span class="info-badge" style="background: #28a745;">ğŸ›¡ï¸ ${remainingDays} day${remainingDays > 1 ? 's' : ''} warranty left</span>`;
                        } else if (remainingDays === 0) {
                            warrantyBadge = `<span class="info-badge" style="background: #ffc107; color: #333;">ğŸ›¡ï¸ Warranty expires today</span>`;
                        } else {
                            warrantyBadge = `<span class="info-badge" style="background: #dc3545;">ğŸ›¡ï¸ Warranty expired</span>`;
                        }
                    }
                }

                let showChat = false;
                let newMessagesCount = 0;
                let responseCount = 0;
                let showResponses = false;

                if (req.status === 'open') {
                    responseCount = responseCountMap[req.id] || 0;
                    showResponses = responseCount > 0;
                } else if ((req.status === 'in_progress' || req.status === 'pending_completion' || req.status === 'completed') && req.selected_provider_id) {
                    showChat = true;
                    
                    const { data: chat } = await supabase
    .from('chats')
    .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
    .eq('request_id', req.id)
    .eq('provider_id', req.selected_provider_id)
    .single();
                    
                    if (chat && chat.messages) {
                        // Get last viewed time for seeker
                        const lastViewedAt = chat.seeker_last_viewed_at;
                        
                        // Count only messages AFTER last viewed time
                        newMessagesCount = chat.messages.filter(m => 
                            m.sender_id !== currentUser.id &&
                            (!lastViewedAt || new Date(m.timestamp) > new Date(lastViewedAt))
                        ).length;
                    }
                }

                let reactivateButton = '';
                if (req.status === 'completed' && req.warranty_end_date) {
                    const warrantyEndDate = new Date(req.warranty_end_date);
                    const today = new Date();
                    if (warrantyEndDate > today) {
                        reactivateButton = `<button class="btn btn-select action-btn-compact" onclick="reactivateRequest('${req.id}')" style="background: #dc3545 !important;">ğŸ”„ Reactivate</button>`;
                    }
                }
                                
                // Remove new messages badge - it will only show on Chat button
const responsesBadge = showResponses ? `<span class="info-badge">ğŸ‘¥ ${responseCount} Response${responseCount > 1 ? 's' : ''}</span>` : '';

html += `
    <div class="request-card compact">
        <div class="request-card-main">
            <div class="request-card-left">
                <div class="request-title-compact" onclick="toggleRequestDetails(event, '${req.id}')">
                    <span class="urgency-bubble ${req.urgency}"></span>
                    <span class="request-title-text">${serviceIcon} ${req.title}${reactivatedBadge}</span>
                    <span class="request-chevron" id="chevron-${req.id}">â–¼</span>
                </div>
                <div class="request-summary" style="display: flex !important; justify-content: space-between !important; width: 100% !important; align-items: center !important;">
    <span class="status-badge ${statusClass}">${statusText}</span>
    ${showResponses ? `
        <button class="btn btn-select btn-select-mobile" onclick="viewResponses('${req.id}')" style="margin-left: auto !important; flex-shrink: 0 !important;">
            ğŸ‘ï¸ View Responses
        </button>
    ` : ''}
    ${showChat ? `
        <div class="chat-btn-wrapper" style="margin-left: auto !important;">
            <button class="btn btn-chat" onclick="openChat('${req.id}', '${req.selected_provider_id}')">ğŸ’¬ Chat</button>
            ${newMessagesCount > 0 ? `<span class="chat-unread-badge">${newMessagesCount}</span>` : ''}
        </div>
    ` : ''}
</div>
${responsesBadge ? `<div class="request-summary">${responsesBadge}</div>` : ''}
${warrantyBadge || reactivateButton ? `
<div class="request-summary" style="display: flex !important; justify-content: space-between !important; align-items: center !important; width: 100% !important; margin-top: 8px !important;">
    ${warrantyBadge ? `<span>${warrantyBadge}</span>` : '<span></span>'}
    ${reactivateButton ? `<span style="margin-left: auto !important;">${reactivateButton}</span>` : ''}
</div>
` : ''}
<div class="request-summary" style="margin-top: 6px; color: #999;">
    ğŸ“ ${req.request_location_address.split(',').slice(0, 2).join(',')} â€¢ ğŸ•’ ${timeAgo}
</div>
                            </div>
                            <div class="request-card-right">
    ${showChat ? `
    <div class="chat-btn-wrapper">
        <button class="btn btn-chat action-btn-compact" onclick="chatOpenedFrom='responses-modal'; closeResponsesModal(); openChat('${req.id}', '${req.selected_provider_id}')">ğŸ’¬ Chat</button>
        ${newMessagesCount > 0 ? `<span class="chat-unread-badge">${newMessagesCount}</span>` : ''}
    </div>
` : ''}
    ${reactivateButton}
</div>
                        </div>
                        <div class="request-details" id="details-${req.id}">
                            <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                            <div class="request-location" style="margin-top: 8px;"><strong>Full Address:</strong> ${req.request_location_address}</div>
                            <div class="request-meta" style="margin-top: 8px;">
    <span class="meta-item">ğŸ”§ Service: ${req.service_category}</span>
    <span class="meta-item">âš¡ Urgency: ${req.urgency.toUpperCase()}</span>
</div>
                           ${req.status === 'open' ? `
    <div style="display: flex; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
        <button class="btn" style="flex: 1; background: #128C7E; color: white;" onclick="editRequest('${req.id}')">âœï¸ Edit Request</button>
        <button class="btn btn-cancel" style="flex: 1;" onclick="cancelRequest('${req.id}')">âŒ Cancel Request</button>
    </div>
` : ''}
                        </div>
                    </div>
                `;
            }
            
            if (container) {
                container.innerHTML = html;
            } 
	else {
                console.error('Container still null after rendering. Filter:', currentRequestFilter);
            }
        }
            

        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Toggle request details
function toggleRequestDetails(event, requestId) {
    event.stopPropagation();
    const details = document.getElementById('details-' + requestId);
    const chevron = document.getElementById('chevron-' + requestId);
    
    if (!details || !chevron) return; // Safety check
    
    if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        chevron.classList.remove('expanded');
    } else {
        details.classList.add('expanded');
        chevron.classList.add('expanded');
    }
}

        // Open Chat
async function openChat(requestId, providerId, isReadOnly = false) {
    try {
        if (!currentUser || !currentProfile) {
            alert('Session expired. Please login again.');
            showLogin();
            return;
        }
        
        showLoading();
        
        // Load request details
        const { data: request, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (reqError) {
            console.error('âŒ Request fetch error:', reqError);
            throw reqError;
        }
        
        // CHECK IF CHAT EXISTS - if not, create it

        const { data: existingChat, error: chatCheckError } = await supabase
            .from('chats')
            .select('id')
            .eq('request_id', requestId)
            .eq('provider_id', providerId)
            .maybeSingle();

        // If no chat exists, create one
        if (!existingChat) {
            const { error: createError } = await supabase
                .from('chats')
                .insert([{
                    request_id: requestId,
                    provider_id: providerId,
                    messages: []
                }]);
            
            if (createError) {
                console.error('âŒ Error creating chat:', createError);
            } else {
            }
        } else {
        }
        
        // CRITICAL FIX: Determine partner ID based on who is viewing
        let partnerId;
        let partnerProfile;
        
        // If current user is the SEEKER (request owner)
        if (currentProfile.user_id === request.user_id) {
            
            // Partner is the PROVIDER
            partnerId = providerId;
            
            const { data: providerData, error: providerError } = await supabase
                .from('profiles')
                .select('*')
                .eq('user_id', providerId)
                .maybeSingle();
            
            if (providerError) {
                console.error('âŒ Provider fetch error:', providerError);
                alert('âŒ Error loading provider profile: ' + providerError.message);
                showDashboard();
                return;
            }
            
            if (!providerData) {
                console.error('âŒ Provider profile not found');
                alert('âŒ Provider profile not found.');
                showDashboard();
                return;
            }
            
            partnerProfile = providerData;
        } 
        // If current user is the PROVIDER
        else {
            
            // Partner is the SEEKER (request owner)
            partnerId = request.user_id;
            
            const { data: seekerData, error: seekerError } = await supabase
                .from('profiles')
                .select('*')
                .eq('user_id', request.user_id)
                .maybeSingle();
            
            if (seekerError) {
                console.error('âŒ Seeker fetch error:', seekerError);
                alert('âŒ Error loading seeker profile: ' + seekerError.message);
                showDashboard();
                return;
            }
            
            if (!seekerData) {
                console.error('âŒ Seeker profile not found');
                alert('âŒ Seeker profile not found.');
                showDashboard();
                return;
            }
            
            partnerProfile = seekerData;
        }
        
        // Determine chat source
        const chatSource = (currentProfile.user_id === providerId) ? 'myResponses' : 'myRequests';
        
        currentChatData = {
            requestId: requestId,
            providerId: providerId,
            partnerName: partnerProfile.name,
            partnerId: partnerId,
            isProvider: currentProfile.user_id === providerId,
            requestStatus: request.status,
            chatSource: chatSource
        };
        
        // Update chat header (while still showing loading)
        document.getElementById('chatPartnerName').textContent = partnerProfile.name;
        document.getElementById('chatRequestStatus').textContent = request.status.replace('_', ' ').toUpperCase();

        // Update profile photo
        if (partnerProfile.profile_photo) {
            document.getElementById('chatPartnerPhoto').src = partnerProfile.profile_photo;
            document.getElementById('chatPartnerPhoto').style.display = 'block';
            document.getElementById('chatPartnerPhotoPlaceholder').style.display = 'none';
        } else {
            document.getElementById('chatPartnerPhoto').style.display = 'none';
            document.getElementById('chatPartnerPhotoPlaceholder').style.display = 'flex';
        }
        
        // Load messages BEFORE showing chat view
        await loadChatMessages();
        // Mark chat as viewed
        try {
            const viewedField = currentChatData.isProvider ? 'provider_last_viewed_at' : 'seeker_last_viewed_at';
            
            const { error: viewError } = await supabase
                .from('chats')
                .update({ [viewedField]: new Date().toISOString() })
                .eq('request_id', currentChatData.requestId)
                .eq('provider_id', currentChatData.providerId);
            
            if (viewError) {
                console.error('âš ï¸ Error marking chat as viewed:', viewError);
            } else {
            }
        } catch (error) {
            console.error('âš ï¸ Error updating last viewed timestamp:', error);
        }

        // Check contact sharing status and button visibility
        const { data: chatData } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .maybeSingle();

        const contactAlreadyApproved = chatData?.messages?.some(m => 
            m.message_type === 'contact_request' && 
            m.contact_request_status === 'approved'
        );
        const { data: latestRequest } = await supabase
            .from('requests')
            .select('status, selected_provider_id')
            .eq('id', currentChatData.requestId)
            .single();

        const acceptBtn = document.getElementById('acceptCompletionBtn');
        const rejectBtn = document.getElementById('rejectCompletionBtn');
        const markCompleteBtn = document.getElementById('markCompleteBtn');

        if (markCompleteBtn) markCompleteBtn.style.display = 'none';
        if (acceptBtn) acceptBtn.style.display = 'none';
        if (rejectBtn) rejectBtn.style.display = 'none';

        if (latestRequest) {
            if (currentChatData.isProvider && 
    (latestRequest.status === 'in_progress' || latestRequest.status === 'pending_completion') &&  // âœ… ALSO CHECK pending_completion
    latestRequest.selected_provider_id === currentProfile.user_id) {
    // âœ… Only show button if status is EXACTLY 'in_progress' (not pending)
    if (latestRequest.status === 'in_progress' && markCompleteBtn) {
        markCompleteBtn.style.display = 'inline-block';
    }
}
            
            if (!currentChatData.isProvider && latestRequest.status === 'pending_completion') {
                if (acceptBtn) acceptBtn.style.display = 'inline-block';
                if (rejectBtn) rejectBtn.style.display = 'inline-block';
            }
        }

        // Handle read-only mode for non-selected providers OR missed opportunities
        const isNonSelectedProvider = currentChatData.isProvider && 
                                      latestRequest && 
                                      (latestRequest.status === 'in_progress' || 
                                       latestRequest.status === 'completed' || 
                                       latestRequest.status === 'pending_completion') && 
                                      latestRequest.selected_provider_id !== currentProfile.user_id;
        
        if (isNonSelectedProvider || isReadOnly) {
            console.log('âš ï¸ Read-only mode enabled (non-selected provider)');
            const messageInput = document.getElementById('chatMessageInput');
            const sendBtn = document.querySelector('.chat-input-wrapper .btn-send');
            const templateBtn = document.querySelector('.template-button');
            const plusBtn = document.querySelector('.plus-button');
            const actionButtons = document.querySelector('.chat-action-buttons');
            
            if (messageInput) {
                messageInput.disabled = true;
                messageInput.placeholder = 'Read-only: This request was assigned to another provider';
                messageInput.style.background = '#f0f0f0';
                messageInput.style.cursor = 'not-allowed';
            }
            
            if (sendBtn) sendBtn.style.display = 'none';
            if (templateBtn) templateBtn.style.display = 'none';
            if (plusBtn) plusBtn.style.display = 'none';
            if (actionButtons) actionButtons.style.display = 'none';
            
            const chatStatus = document.getElementById('chatRequestStatus');
            if (chatStatus) {
                chatStatus.textContent = 'READ-ONLY - ASSIGNED TO ANOTHER PROVIDER';
                chatStatus.style.color = '#dc3545';
            }
        } else {
            const messageInput = document.getElementById('chatMessageInput');
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = 'Type your message...';
                messageInput.style.background = 'white';
                messageInput.style.cursor = 'text';
            }
        }
        
        // â­ CRITICAL FIX: Show chat view ONLY AFTER everything is loaded

// Hide all main views EXCEPT dashboardView (because chatView is inside it)
const viewsToHide = ['loginView', 'signupView', 'createRequestView', 
                     'editRequestView', 'editProfileView', 'loadingView'];
viewsToHide.forEach(viewId => {
    const view = document.getElementById(viewId);
    if (view) {
        view.classList.add('hidden');
        view.style.display = 'none';
    }
});

// Hide only header controls (keep dashboard sections visible in background)
const createRequestBtn = document.getElementById('createRequestBtn');
const userMenu = document.querySelector('.user-menu');
const modeToggleBtn = document.getElementById('modeToggleBtn');

if (createRequestBtn) createRequestBtn.style.display = 'none';
if (userMenu) userMenu.style.display = 'none';
if (modeToggleBtn) modeToggleBtn.style.display = 'none';
if (modeToggleBtn) modeToggleBtn.style.display = 'none'; // Hide toggle button when chat is open



// Keep dashboardView visible (parent container)
const dashboardView = document.getElementById('dashboardView');
if (dashboardView) {
    dashboardView.classList.remove('hidden');
    dashboardView.style.display = 'block';
}

// Show chatView
const chatView = document.getElementById('chatView');
if (chatView) {
    chatView.classList.remove('hidden');
    chatView.style.display = 'block';
    chatView.style.visibility = 'visible';
}
        
        // Start auto-refresh
        if (chatRefreshInterval) clearInterval(chatRefreshInterval);
        chatRefreshInterval = setInterval(loadChatMessages, 5000);
        
    } catch (error) {
        console.error('âŒ âŒ âŒ ERROR OPENING CHAT:', error);
        alert('Error opening chat: ' + error.message);
        showDashboard();
    }
}

        // Load Chat Messages
async function loadChatMessages() {
    try {
        const { data: chats, error } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .maybeSingle();
        
        const chat = chats;
        
        if (error) {
            console.error('Error fetching chat:', error);
            return;
        }
        
        const messages = chat?.messages || [];
        const container = document.getElementById('chatMessages'); // âœ… MOVED UP - DEFINED BEFORE USE
        
        // If no chat exists and user is non-selected provider, show empty state
        if (!chat && currentChatData.isProvider && currentChatData.requestStatus === 'in_progress') {
            container.innerHTML = '<div class="empty-chat-state"><div class="empty-chat-state-text">No chat history available.</div></div>';
            return;
        }
        
        if (messages.length === 0) {
            container.innerHTML = '<div class="empty-chat-state"><div class="empty-chat-state-text">No messages yet. Start the conversation!</div></div>';
            return;
        }
        
        let html = '';
        messages.forEach((msg, index) => {
            const isSent = msg.sender_id === currentUser.id;
            const messageClass = isSent ? 'sent' : 'received';
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Handle contact request messages
            if (msg.message_type === 'contact_request') {
                const status = msg.contact_request_status || 'pending';
                let cardClass = 'contact-request-card';
                let statusHTML = '';
                
                if (status === 'approved') {
                    cardClass += ' contact-status-approved';
                    statusHTML = '<p style="margin-top: 10px; font-weight: 600;">âœ… Approved - Contact details visible below</p>';
                } else if (status === 'declined') {
                    cardClass += ' contact-status-declined';
                    statusHTML = '<p style="margin-top: 10px; font-weight: 600;">âŒ Declined</p>';
                } else if (!isSent && status === 'pending') {
                    statusHTML = `
                        <div class="contact-approval-buttons">
                            <button class="btn-approve" onclick="approveContactSharing(${index})">âœ… Approve</button>
                            <button class="btn-decline" onclick="declineContactSharing(${index})">âŒ Decline</button>
                        </div>
                    `;
                } else if (isSent && status === 'pending') {
                    statusHTML = '<p style="margin-top: 10px; color: #856404; font-size: 12px;">â³ Waiting for approval...</p>';
                }
                
                html += `
                    <div class="${cardClass}" style="margin: 15px 0;">
                        <div class="contact-request-title">ğŸ“ Contact Sharing Request</div>
                        <p style="font-size: 13px; color: #555;">From: ${msg.sender_name}</p>
                        ${statusHTML}
                    </div>
                `;
            } 

	// Handle completion request messages
else if (msg.message_type === 'completion_request') {
    const status = msg.completion_request_status || 'pending';
    const isSent = msg.sender_id === currentUser.id;
    let cardClass = 'contact-request-card';
    let statusHTML = '';
    
    if (status === 'approved') {
        cardClass += ' contact-status-approved';
        statusHTML = '<p style="margin-top: 10px; font-weight: 600;">âœ… Work completion accepted by customer</p>';
    } else if (status === 'declined') {
        cardClass += ' contact-status-declined';
        statusHTML = '<p style="margin-top: 10px; font-weight: 600;">âŒ Completion rejected - work continues</p>';
    } else if (!isSent && status === 'pending') {
        // SEEKER viewing - show Accept/Reject buttons
        statusHTML = `
            <div class="contact-approval-buttons">
                <button class="btn-approve" onclick="approveCompletionFromChat(${index})">âœ… Accept Completion</button>
                <button class="btn-decline" onclick="rejectCompletionFromChat(${index})">âŒ Reject & Continue Work</button>
            </div>
        `;
    } else if (isSent && status === 'pending') {
        // PROVIDER viewing - show waiting message
        statusHTML = '<p style="margin-top: 10px; color: #856404; font-size: 12px;">â³ Waiting for customer approval...</p>';
    }
    
    html += `
        <div class="${cardClass}" style="margin: 15px 0;">
            <div class="contact-request-title">âœ… Work Completion Request</div>
            <p style="font-size: 13px; color: #555;">From: ${msg.sender_name}</p>
            <p style="font-size: 13px; color: #555; margin-top: 5px;">${msg.message}</p>
            ${statusHTML}
        </div>
    `;
}
            // Handle system messages
            else if (msg.message_type === 'system') {
                html += `
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 8px; font-size: 13px; color: #555;">
                        ${msg.message}
                    </div>
                `;
            }
            // Handle regular messages
            else {
                html += `
                    <div class="message ${messageClass}">
                        <div class="message-bubble">
                            ${msg.message}
                            ${msg.image ? `<img src="${msg.image}" class="message-image" alt="Shared image" onclick="openImagePreview('${msg.image}')">` : ''}
                        </div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }
        });
        
        // Check if contact sharing was approved
        const contactApproved = messages.some(m => 
            m.message_type === 'contact_request' && 
            m.contact_request_status === 'approved'
        );
        
        // Show/hide contact details button in header
        const contactDetailsHeaderBtn = document.getElementById('contactDetailsHeaderBtn');
        const requestContactBtn = document.querySelector('.btn-contact');
        
        if (contactApproved) {
            // Show contact details button in header
            if (contactDetailsHeaderBtn) contactDetailsHeaderBtn.style.display = 'inline-block';
            // Hide request contact sharing button
            if (requestContactBtn) requestContactBtn.style.display = 'none';
        } else {
            // Hide contact details button in header
            if (contactDetailsHeaderBtn) contactDetailsHeaderBtn.style.display = 'none';
            // Show request contact sharing button
            if (requestContactBtn) requestContactBtn.style.display = 'inline-block';
        }
        
        container.innerHTML = html;
        
        // Scroll to bottom to show latest message
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
        
    } catch (error) {
        console.error('Error loading messages:', error);
        const container = document.getElementById('chatMessages');
        if (container) {
            container.innerHTML = '<div class="empty-chat-state"><div class="empty-chat-state-text">Error loading messages. Please refresh.</div></div>';
        }
    }
}


// Open Image Preview (Full Screen)
function openImagePreview(imageUrl) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    modal.innerHTML = `
        <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
        <button style="position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">Ã—</button>
    `;
    
    modal.onclick = () => document.body.removeChild(modal);
    document.body.appendChild(modal);
}
        // Send Message
        async function sendMessage() {
    const input = document.getElementById('chatMessageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Disable button during send to prevent double-clicks
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    try {
        // Get existing chat
        const { data: existingChat, error: fetchError } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Add new message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: message,
            timestamp: new Date().toISOString()
        });
        
        // Upsert chat
        const { error: upsertError } = await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        if (upsertError) throw upsertError;
        
        // Clear input AFTER successful send
        input.value = '';
        
        // Manually toggle buttons after clearing
        sendBtn.classList.remove('show');
        document.getElementById('templateBtn').classList.remove('hide');
        
        // Re-enable button
        sendBtn.disabled = false;
        
        // Reload messages
        await loadChatMessages();
        
    } catch (error) {
        alert('Error sending message: ' + error.message);
        sendBtn.disabled = false;
    }
}

        // Handle Photo Upload
        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const { data: existingChat } = await supabase
                        .from('chats')
                        .select('messages')
                        .eq('request_id', currentChatData.requestId)
                        .eq('provider_id', currentChatData.providerId)
                        .single();
                    
                    let messages = existingChat?.messages || [];
                    
                    messages.push({
                        sender_id: currentUser.id,
                        sender_name: currentProfile.name,
                        message: 'ğŸ“· Shared a photo',
                        image: e.target.result,
                        timestamp: new Date().toISOString()
                    });
                    
                    await supabase
                        .from('chats')
                        .upsert({
                            request_id: currentChatData.requestId,
                            provider_id: currentChatData.providerId,
                            messages: messages
                        }, { onConflict: 'request_id,provider_id' });
                    
                    event.target.value = '';
                    await loadChatMessages();
                    
                } catch (error) {
                    alert('Error uploading photo: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        // Toggle Template Category
        function toggleTemplateCategory(element) {
            const items = element.nextElementSibling;
            const isCurrentlyOpen = items.classList.contains('open');
            
            // Close all other open categories first (accordion behavior)
            document.querySelectorAll('.template-category-items.open').forEach(openItem => {
                if (openItem !== items) {
                    openItem.classList.remove('open');
                    // Update the arrow icon for closed categories
                    const header = openItem.previousElementSibling;
                    if (header && header.textContent.includes('â–¶')) {
                        header.innerHTML = header.innerHTML.replace('â–¶', 'â–¼');
                    }
                }
            });
            
            // Toggle the clicked category
            items.classList.toggle('open');
            element.textContent = element.textContent.includes('â–¼') 
                ? element.textContent.replace('â–¼', 'â–¶')
                : element.textContent.replace('â–¶', 'â–¼');
        }

        // Insert Template
        function insertTemplate(element) {
            document.getElementById('chatMessageInput').value = element.textContent;
            document.getElementById('chatMessageInput').focus();
            closeTemplateModal();
        }

        // Open Template Modal
        function openTemplateModal() {
            const modal = document.getElementById('templateModal');
            const container = document.getElementById('templateCategoriesContainer');
            
            // Determine templates based on chat source (which section the chat came from)
            const templates = (currentChatData.chatSource === 'myRequests') ? seekerTemplatesData : providerTemplatesData;
            
            // Build HTML for modal
            let html = '';
            templates.forEach(category => {
                html += `
                    <div class="template-category-block">
                        <div class="template-category-header" onclick="toggleTemplateCategory(this)">
                            <span>${category.title}</span>
                            <span>â–¼</span>
                        </div>
                        <div class="template-category-items">
                            ${category.items.map(item => `
                                <div class="template-option" onclick="selectTemplateOption(this)">
                                    ${item}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            modal.classList.add('active');
        }

        // Close Template Modal
        function closeTemplateModal() {
    const modal = document.getElementById('templateModal');
    if (modal) {
        modal.classList.remove('active');
        // Reset all category items to closed state
        document.querySelectorAll('.template-category-items').forEach(item => {
            item.classList.remove('open');
        });
        // Reset all arrows to down position
        document.querySelectorAll('.template-category-header span:last-child').forEach(arrow => {
            arrow.textContent = 'â–¼';
        });
    }
}

// Close template modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('templateModal');
    const templateBtn = document.getElementById('templateBtn');
    const modalContent = document.querySelector('.template-modal-content');
    
    if (modal && modal.classList.contains('active')) {
        if (!modalContent.contains(event.target) && event.target !== templateBtn) {
            closeTemplateModal();
        }
    }
});

// Close contact details modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('contactDetailsModal');
    const modalContent = modal?.querySelector('.modal-content');
    const headerBtn = document.getElementById('contactDetailsHeaderBtn');
    
    if (modal && modal.classList.contains('active')) {
        if (!modalContent.contains(event.target) && event.target !== headerBtn) {
            closeContactDetailsModal();
        }
    }
});

// Close contact details modal on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('contactDetailsModal');
        if (modal && modal.classList.contains('active')) {
            closeContactDetailsModal();
        }
    }
});
        // Select Template Option
        // Select Template Option
        function selectTemplateOption(element) {
            const input = document.getElementById('chatMessageInput');
            const sendBtn = document.getElementById('sendBtn');
            const templateBtn = document.getElementById('templateBtn');
            
            // Set the message
            input.value = element.textContent.trim();
            
            // Show send button, hide template button
            if (input.value.trim().length > 0) {
                sendBtn.classList.add('show');
                templateBtn.classList.add('hide');
            }
            
            // Focus input
            input.focus();
            
            // IMPORTANT: Close modal immediately
            closeTemplateModal();
        }

        // Template Data
        const seekerTemplatesData = [
            {
                title: 'ğŸ’¬ Initial Contact',
                items: [
                    'Hi! Can you provide more details about the service?',
                    'What is your availability for this work?',
                    'Can you share your experience with similar work?'
                ]
            },
            {
                title: 'ğŸ“… Scheduling',
                items: [
                    'When can you start the work?',
                    'How long will it take to complete?',
                    'Can you come today or tomorrow?'
                ]
            },
            {
                title: 'ğŸ’° Pricing',
                items: [
                    'What will be the estimated cost?',
                    'Do you charge for inspection/visit?',
                    'Is this price negotiable?'
                ]
            },
            {
                title: 'â„¹ï¸ Additional Info',
                items: [
                    'Do you have the necessary tools and equipment?',
                    'Will you provide materials or should I arrange them?',
                    'Can you share photos of previous work?',
                    'Do you offer any warranty on your work?'
                ]
            },
            {
                title: 'ğŸ¤ Contact & Finalization',
                items: [
                    'Let\'s finalize this deal. Can we exchange contact details?',
                    'I\'d like to proceed with you. When can we meet?',
                    'Sounds good! Please share your contact number.'
                ]
            }
        ];

        const providerTemplatesData = [
            {
                title: 'ğŸ‘‹ Response',
                items: [
                    'Hi! I\'m available and interested in this work.',
                    'I have experience in this type of work. Happy to help!',
                    'I can start immediately. Let me know if you\'d like to proceed.'
                ]
            },
            {
                title: 'ğŸ’° Pricing',
                items: [
                    'The estimated cost will be around â‚¹XXX.',
                    'I can provide a detailed quote after inspection.',
                    'No charges for initial visit and inspection.'
                ]
            },
            {
                title: 'â„¹ï¸ Information Requests',
                items: [
                    'Can you share more details or photos of the problem?',
                    'What is your preferred time for the visit?',
                    'Are there any specific requirements I should know about?'
                ]
            },
            {
                title: 'ğŸ¤ Contact & Finalization',
                items: [
                    'I\'m ready to start. Can we exchange contact details?',
                    'Please share your address so I can visit.',
                    'Let\'s finalize the schedule. Here\'s my contact number.'
                ]
            },
            {
                title: 'âœ… Service Completion',
                items: [
                    'Work completed successfully. Please check and confirm.',
                    'Everything is done. Let me know if you need any adjustments.',
                    'The service is complete. Feel free to contact me during warranty period.'
                ]
            }
        ];

        // Request Contact Sharing
       async function requestContactSharing() {
    if (!confirm('ğŸ“ REQUEST CONTACT SHARING?\n\nâš ï¸ WARNING: If approved, BOTH parties will see:\nâ€¢ Phone number\nâ€¢ Full address\n\nğŸ”’ Contact info will be visible ONLY after the other person approves.\n\nDo you want to send this request?')) return;
    try {
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .maybeSingle();
        
        let messages = existingChat?.messages || [];
        
        // Check if contact request already exists
        const existingRequest = messages.find(m => 
            m.message_type === 'contact_request' && 
            m.contact_request_status === 'pending'
        );
        
        if (existingRequest) {
            alert('âš ï¸ Contact sharing request already sent! Waiting for response.');
            return;
        }
        
        // Add contact request message with special type
        const contactRequestMessage = {
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: 'ğŸ“ Requesting to share contact information for finalizing the deal.',
            message_type: 'contact_request',
            contact_request_status: 'pending',
            timestamp: new Date().toISOString()
        };
        
        messages.push(contactRequestMessage);
        
        const { error: upsertError } = await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        if (upsertError) throw upsertError;
        
        await loadChatMessages();
        alert('âœ… Contact sharing request sent! The other person will see it in the chat.');
        
    } catch (error) {
        alert('âŒ Error sending contact request: ' + error.message);
        console.error('Contact sharing error:', error);
    }
}

	// Approve Contact Sharing
async function approveContactSharing(messageIndex) {
    // Add confirmation dialog
    if (!confirm('âš ï¸ SHARE YOUR CONTACT INFORMATION?\n\nğŸ“± This will share:\nâ€¢ Your phone number\nâ€¢ Your full address\n\nThe other person will be able to see this information immediately.\n\nDo you want to proceed?')) {
        return;
    }
    
    try {
        const { data: existingChat, error: fetchError } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        if (fetchError) throw fetchError;
        
        let messages = existingChat?.messages || [];
        
        // Update the request message status
        if (messages[messageIndex]) {
            messages[messageIndex].contact_request_status = 'approved';
        } else {
            throw new Error('Contact request message not found');
        }
        
        // Add approval notification message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: 'âœ… Contact sharing approved! Contact details are now visible to both parties.',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        const { error: updateError } = await supabase
            .from('chats')
            .update({
                messages: messages
            })
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId);
        
        if (updateError) throw updateError;
        
        // Verify the update was successful
        const { data: verifyChat, error: verifyError } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        if (verifyError) throw new Error('Failed to verify approval was saved');
        
        // Check if the approval was saved
        const approvalSaved = verifyChat?.messages?.some(m => 
            m.message_type === 'system' && 
            m.message.includes('Contact sharing approved')
        );
        
        if (!approvalSaved) throw new Error('Approval not saved properly');
        
        await loadChatMessages();
        alert('âœ… Contact information is now shared with both parties!');
        
    } catch (error) {
        alert('âŒ Error approving contact sharing: ' + error.message);
        console.error('Approval error:', error);
    }
}

// Decline Contact Sharing
async function declineContactSharing(messageIndex) {
    if (!confirm('Decline contact sharing request?')) return;
    
    try {
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Update the request message status
        if (messages[messageIndex]) {
            messages[messageIndex].contact_request_status = 'declined';
        }
        
        // Add decline notification message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: 'âŒ Contact sharing request declined.',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .update({
                messages: messages
            })
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId);
        
        await loadChatMessages();
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
        // Show Warranty Form
        async function showWarrantyForm() {
            // Security check: Only selected provider can show warranty form
            if (!currentChatData.isProvider) {
                alert('âŒ Only the service provider can mark work as complete.');
                return;
            }
            
            // Verify this provider is the selected one
            const { data: request } = await supabase
                .from('requests')
                .select('selected_provider_id, status')
                .eq('id', currentChatData.requestId)
                .single();
            
            if (!request) {
                alert('âŒ Request not found.');
                return;
            }
            
            if (request.selected_provider_id !== currentProfile.user_id) {
                alert('âŒ You are not the selected provider for this request.');
                return;
            }
            
            if (request.status !== 'in_progress') {
                alert('âŒ This request is not in progress.');
                return;
            }
            
            // All checks passed - show the form
            document.getElementById('warrantyForm').classList.remove('hidden');
        }
// Complete Work
async function completeWork() {
    const selectedWarranty = document.querySelector('input[name="warranty"]:checked');
    
    if (!selectedWarranty) {
        alert('Please select a warranty period');
        return;
    }
    
    if (!confirm('Send completion request to the customer?\n\nThe customer will review your work and can approve or reject the completion.')) return;
    
    try {
        const warrantyDays = parseInt(selectedWarranty.value);
        const warrantyEndDate = new Date();
        warrantyEndDate.setDate(warrantyEndDate.getDate() + warrantyDays);
        
        const { error } = await supabase
            .from('requests')
            .update({
                status: 'pending_completion',
                warranty_period: warrantyDays,
                warranty_end_date: warrantyEndDate.toISOString()
            })
            .eq('id', currentChatData.requestId);
        
        if (error) throw error;
        
        // Send completion message
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: `âœ… Provider has completed the work and is offering ${warrantyDays === 0 ? 'no warranty' : warrantyDays + ' days warranty'}.\n\nâ³ Waiting for customer approval...`,
            message_type: 'completion_request',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        alert('âœ… Completion request sent! The customer will review and approve your work.');
        document.getElementById('warrantyForm').classList.add('hidden');
        document.getElementById('markCompleteBtn').style.display = 'none';
        document.getElementById('chatRequestStatus').textContent = 'PENDING APPROVAL';
        currentChatData.requestStatus = 'pending_completion';
        await loadChatMessages();
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Accept Completion (Seeker)
async function acceptCompletion() {
    if (!confirm('âœ… Accept work completion?\n\nThis will mark the request as completed and you can rate the provider.')) return;
    
    try {
        // Update request status to completed
        const { error: updateError } = await supabase
            .from('requests')
            .update({ status: 'completed' })
            .eq('id', currentChatData.requestId);
        
        if (updateError) throw updateError;
        
        // Add system message
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: 'âœ… Work completion accepted by customer. Request is now completed!',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        // Hide accept/reject buttons
        document.getElementById('acceptCompletionBtn').style.display = 'none';
        document.getElementById('rejectCompletionBtn').style.display = 'none';
        
        // Update chat status display
        document.getElementById('chatRequestStatus').textContent = 'COMPLETED';
        currentChatData.requestStatus = 'completed';
        
        await loadChatMessages();
        
        // Open rating modal
        alert('âœ… Work completion accepted! Please rate the provider.');
        openRatingModal(currentChatData.requestId, currentChatData.providerId, currentChatData.partnerName);
        
    } catch (error) {
        alert('âŒ Error: ' + error.message);
    }
}

// Reject Completion (Seeker)
async function rejectCompletion() {
    const reason = prompt('âŒ Reject work completion?\n\nPlease provide a reason for rejection (the provider will see this):');
    
    if (!reason || reason.trim() === '') return;
    
    try {
        // Update request status back to in_progress
        const { error: updateError } = await supabase
            .from('requests')
            .update({ status: 'in_progress' })
            .eq('id', currentChatData.requestId);
        
        if (updateError) throw updateError;
        
        // Add system message with rejection reason
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: `âŒ Work completion rejected by customer.\n\nReason: ${reason.trim()}\n\nPlease continue working to resolve the issues.`,
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        // Hide accept/reject buttons
        document.getElementById('acceptCompletionBtn').style.display = 'none';
        document.getElementById('rejectCompletionBtn').style.display = 'none';
        
        // Update chat status display
        document.getElementById('chatRequestStatus').textContent = 'IN PROGRESS';
        currentChatData.requestStatus = 'in_progress';
        
        await loadChatMessages();
        
        alert('âŒ Completion rejected. The provider can see your feedback and will continue working.');
        
    } catch (error) {
        alert('âŒ Error: ' + error.message);
    }
}           

        // View Responses
        async function viewResponses(requestId) {
            selectedResponseRequest = requestId;
            
            try {
                const { data: responses, error } = await supabase
                    .from('request_responses')
                    .select('*, provider_id')
                    .eq('request_id', requestId);
                
                if (error) throw error;
                
                if (!responses || responses.length === 0) {
                    document.getElementById('responsesList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-text">No responses yet</div>
                        </div>
                    `;
                    document.getElementById('responsesModal').classList.add('active');
                    return;
                }

	// âœ… SORT PROVIDERS BY RATING (HIGHEST FIRST)
        // First, fetch provider profiles with ratings for all responses
        const providerIds = responses.map(r => r.provider_id);
        const { data: providersData, error: provError } = await supabase
            .from('profiles')
            .select('user_id, average_rating, total_ratings')
            .in('user_id', providerIds);
        
        if (provError) throw provError;
        
        // Create a map of provider ratings
        const ratingMap = {};
        (providersData || []).forEach(p => {
            ratingMap[p.user_id] = p.average_rating || 0;
        });
        
        // Sort responses by provider rating (highest first)
        responses.sort((a, b) => {
            const ratingA = ratingMap[a.provider_id] || 0;
            const ratingB = ratingMap[b.provider_id] || 0;
            return ratingB - ratingA; // Descending order
        });
                
                let html = '';
                
                for (let response of responses) {
                    const { data: provider } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('user_id', response.provider_id)
                        .single();
                    
                    let ratingDisplay = 'No ratings yet';
    if (provider.average_rating && provider.average_rating > 0 && provider.total_ratings > 0) {
        const stars = 'â­'.repeat(Math.round(provider.average_rating));
        ratingDisplay = `${stars} ${provider.average_rating}/5 (${provider.total_ratings} ${provider.total_ratings === 1 ? 'rating' : 'ratings'})`;
    }
                    
                    const { data: request } = await supabase
                        .from('requests')
                        .select('request_latitude, request_longitude')
                        .eq('id', requestId)
                        .single();
                    
                    const distance = calculateDistance(
    provider.latitude,          // â† Provider first
    provider.longitude,
    request.request_latitude,   // â† Request second
    request.request_longitude
);
                    
                    const respondedTime = new Date(response.created_at);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - respondedTime) / 60000);
                    const timeAgo = diffMinutes < 1 ? 'Just now' : 
                                   diffMinutes < 60 ? `${diffMinutes} min ago` :
                                   diffMinutes < 1440 ? `${Math.floor(diffMinutes/60)} hours ago` :
                                   `${Math.floor(diffMinutes/1440)} days ago`;
                    
                   const photoHTML = provider.profile_photo 
    ? `<img src="${provider.profile_photo}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #667eea; margin-bottom: 12px;">`
    : `<div style="width: 60px; height: 60px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 12px;">ğŸ‘¤</div>`;

// Check if this provider is selected
                    const { data: requestDetails } = await supabase
                        .from('requests')
                        .select('selected_provider_id, status')
                        .eq('id', requestId)
                        .single();
                    
                    const isSelected = requestDetails?.selected_provider_id === response.provider_id;
                    const requestStatus = requestDetails?.status;
                    
                    // Show different buttons based on selection status
                    let actionButtons = '';

if (isSelected) {
    // Selected provider - always show chat button
    actionButtons = `
        <button class="btn btn-view-profile" onclick="viewProviderProfile('${response.provider_id}')">View Profile</button>
        <button class="btn btn-chat" onclick="chatOpenedFrom='responses-modal'; closeResponsesModal(); openChat('${requestId}', '${response.provider_id}')">ğŸ’¬ Chat</button>
    `;
} else {
    // Not selected - show view profile and select button
    actionButtons = `
        <button class="btn btn-view-profile" onclick="viewProviderProfile('${response.provider_id}')">View Profile</button>
        <button class="btn btn-chat" onclick="chatOpenedFrom='responses-modal'; closeResponsesModal(); openChat('${requestId}', '${response.provider_id}')">ğŸ’¬ Chat</button>
        <button class="btn btn-select" onclick="selectProvider('${requestId}', '${response.provider_id}')">Select Provider</button>
    `;
}
                    
                    html += `
    <div class="provider-card">
        <div style="display: flex; align-items: flex-start; gap: 15px;">
            <div style="flex-shrink: 0;">${photoHTML}</div>
            <div style="flex: 1; min-width: 0;">
                <div class="provider-name" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span>${provider.name}</span>
                    <span class="rating-display" style="margin: 0; font-size: 13px;">${ratingDisplay}</span>
                    ${isSelected ? '<span style="color: #667eea; font-weight: bold; font-size: 12px;">âœ“ SELECTED</span>' : ''}
                </div>
                <div class="provider-info">ğŸ“ ${distance} km away</div>
                <div class="provider-info">ğŸ•’ ${timeAgo}</div>
            </div>
        </div>
        <div class="provider-actions" style="margin-top: 12px;">
            ${actionButtons}
        </div>
    </div>
`;
                }
                
                document.getElementById('responsesList').innerHTML = html;

// Mark that we're in responses modal
chatOpenedFrom = 'responses-modal';
document.getElementById('responsesModal').classList.add('active');
            } catch (error) {
                alert('Error loading responses: ' + error.message);
            }
        }

        // Calculate Distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return parseFloat((R * c).toFixed(2));
        }

        // View Provider Profile
        async function viewProviderProfile(providerId) {
            try {
                const { data: provider } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', providerId)
                    .single();
                
                const { data: services } = await supabase
                    .from('provider_services')
                    .select('service_id')
                    .eq('provider_id', providerId);
                
                const serviceList = services && services.length > 0 
                    ? services.map(s => s.service_id).join(', ')
                    : 'No services listed';
                
                const addr = [provider.house_number, provider.area_name, provider.landmark, provider.city, provider.state, provider.pin_code].filter(Boolean).join(', ');
                
                let ratingDisplay = 'No ratings yet';
let ratingDetailsHTML = '';

if (provider.average_rating && provider.average_rating > 0 && provider.total_ratings > 0) {
    const stars = 'â­'.repeat(Math.round(provider.average_rating));
    ratingDisplay = `${stars} ${provider.average_rating}/5 (${provider.total_ratings} ${provider.total_ratings === 1 ? 'rating' : 'ratings'})`;
    
    // Still fetch review details for display
    const { data: ratings } = await supabase
        .from('ratings')
        .select('rating, review, created_at')
        .eq('provider_id', providerId)
        .order('created_at', { ascending: false });
    
    if (ratings && ratings.length > 0) {
        ratingDetailsHTML = '<hr style="margin: 20px 0;"><h3 style="margin-bottom: 15px;">Recent Reviews:</h3>';
        ratings.slice(0, 3).forEach(r => {
            const reviewStars = 'â­'.repeat(r.rating);
            const reviewDate = new Date(r.created_at).toLocaleDateString();
            ratingDetailsHTML += `
                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${reviewStars} ${r.rating}/5</div>
                    ${r.review ? `<p style="color: #555; margin-bottom: 5px;">"${r.review}"</p>` : ''}
                    <p style="font-size: 12px; color: #999;">${reviewDate}</p>
                </div>
            `;
        });
    }
}
                
                const photoHTML = provider.profile_photo 
                    ? `<div style="text-align: center; margin-bottom: 20px;">
                        <img src="${provider.profile_photo}" 
                             onclick="openImagePreview('${provider.profile_photo}')" 
                             style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; cursor: pointer; transition: transform 0.2s;" 
                             onmouseover="this.style.transform='scale(1.05)'" 
                             onmouseout="this.style.transform='scale(1)'">
                        <p style="font-size: 12px; color: #999; margin-top: 8px;">Click photo to view full size</p>
                       </div>`
                    : `<div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 150px; height: 150px; border-radius: 50%; background: #e0e0e0; display: inline-flex; align-items: center; justify-content: center; font-size: 64px; border: 4px solid #667eea;">ğŸ‘¤</div>
                       </div>`;
                
                document.getElementById('profileContent').innerHTML = `
                    ${photoHTML}
                    <div class="profile-details">
                        <p><strong>ğŸ‘¤ Name:</strong> ${provider.name}</p>
                        <p><strong>â­ Rating:</strong> ${ratingDisplay}</p>
                        <p><strong>ğŸ”§ Services:</strong> ${serviceList}</p>
                        <p><strong>ğŸ“ Address:</strong> ${addr}</p>
                        <p><strong>ğŸ“Œ Note:</strong> Phone number and full contact details will be shared after both parties agree to connect.</p>
                        ${ratingDetailsHTML}
                    </div>
                `;
                
                document.getElementById('profileModal').classList.add('active');
            } catch (error) {
                alert('Error loading profile: ' + error.message);
            }
        }

        // Select Provider
        async function selectProvider(requestId, providerId) {
            if (!confirm('Select this provider? This will change request status to "In Progress" and open chat.')) return;
            
            try {
                const { error } = await supabase
                    .from('requests')
                    .update({ 
                        selected_provider_id: providerId, 
                        status: 'in_progress' 
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                closeResponsesModal();
                closeProfileModal();
                
                alert('âœ… Provider selected! Opening chat...');
                await openChat(requestId, providerId);
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Close Modals
function closeResponsesModal() {
    document.getElementById('responsesModal').classList.remove('active');
}

function closeResponsesModalAndGoBack() {
    document.getElementById('responsesModal').classList.remove('active');
    showDashboard();
}

function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('active');
}

async function displayProviderOpenRequests(data) {
    const container = document.getElementById('providerOpenRequestsList');
    
    if (!data || data.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <div class="empty-state-text">No open requests yet</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    for (let item of data) {
        const req = item.request;
        if (!req) continue;
        
        const icon = SERVICE_ICONS[req.service_category] || 'ğŸ”§';
        const timeAgo = getTimeAgo(new Date(item.created_at));
        const distance = calculateDistance(
            currentProfile.latitude,
            currentProfile.longitude,
            req.request_latitude,
            req.request_longitude
        );
        
        const chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">ğŸ’¬ Chat</button></div>`;
        
        html += `
            <div class="request-card compact">
                <div class="request-card-main">
                    <div class="request-card-left">
                        <div class="request-title-compact" onclick="toggleRequestDetails(event, 'open-${req.id}')">
                            <span class="urgency-bubble ${req.urgency}"></span>
                            <span class="request-title-text">${icon} ${req.title}</span>
                            <span class="request-chevron" id="chevron-open-${req.id}">â–¼</span>
                        </div>
                        <div class="request-summary" style="display: flex !important; justify-content: space-between !important; width: 100% !important; align-items: center !important;">
                            <span class="status-badge status-open">â³ PENDING</span>
                            ${chatButton}
                        </div>
                        <div class="request-summary" style="margin-top: 6px; color: #999;">
                            ğŸ‘¤ ${item.seekerName} â€¢ ğŸ“ ${distance} km â€¢ ğŸ•’ ${timeAgo}
                        </div>
                    </div>
                </div>
                <div class="request-details" id="details-open-${req.id}">
                    <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                    <div class="request-location" style="margin-top: 8px;"><strong>Location:</strong> ${req.request_location_address}</div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Load Provider Responses
        async function loadProviderResponses() {
    try {
        // Get all responses by this provider
        const { data: responses, error: respError } = await supabase
            .from('request_responses')
            .select('*')
            .eq('provider_id', currentProfile.user_id)
            .order('created_at', { ascending: false });
        
        if (respError) throw respError;
        
        if (!responses || responses.length === 0) {
            document.getElementById('myResponsesList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ’¬</div>
                    <div class="empty-state-text">No responses yet. Respond to nearby requests to start!</div>
                </div>
            `;
            document.getElementById('myResponsesTotal').textContent = '0';
            document.getElementById('myResponsesNew').classList.add('hidden');
            return;
        }
        
        // Get full request details for each response
        const requestIds = responses.map(r => r.request_id);
        const { data: requests, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .in('id', requestIds);
        
        if (reqError) throw reqError;
        
        // Get seeker profiles
        const userIds = requests.map(r => r.user_id);
        const { data: seekers, error: seekerError } = await supabase
            .from('profiles')
            .select('user_id, name')
            .in('user_id', userIds);
        
        if (seekerError) throw seekerError;
        
        // Check for unread messages in each chat
        const chatChecks = await Promise.all(responses.map(async (response) => {
            const { data: chat } = await supabase
                .from('chats')
                .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
                .eq('request_id', response.request_id)
                .eq('provider_id', currentProfile.user_id)
                .single();
            
            if (!chat || !chat.messages) return { requestId: response.request_id, hasMessages: false, unreadCount: 0 };

// Get last viewed time for provider
const lastViewedAt = chat.provider_last_viewed_at;

// Count only messages AFTER last viewed time
const unreadCount = chat.messages.filter(m => 
    m.sender_id !== currentProfile.user_id &&
    (!lastViewedAt || new Date(m.timestamp) > new Date(lastViewedAt))
).length;
            
            return { 
                requestId: response.request_id, 
                hasMessages: chat.messages.length > 0,
                unreadCount: unreadCount
            };
        }));
        
        // Combine all data - EXCLUDE missed opportunities (they now belong in Work Opportunities)
const combinedData = responses.map(response => {
    const request = requests.find(r => r.id === response.request_id);
    
    // Skip if request was deleted or invalid
    if (!request || !request.request_latitude || !request.request_longitude) {
        return null;
    }
    
    // Check if this is a "missed opportunity"
    const isMissedOpportunity = (request.status === 'in_progress' || request.status === 'completed' || request.status === 'pending_completion') && 
                               request.selected_provider_id !== currentProfile.user_id;
    
    // CRITICAL: Skip missed opportunities - they belong in Work Opportunities section now
    if (isMissedOpportunity) {
        return null;
    }
    
    const seeker = seekers.find(s => s.user_id === request.user_id);
    const chatInfo = chatChecks.find(c => c.requestId === response.request_id);
    
    return {
        ...response,
        request: request,
        seekerName: seeker?.name || 'Unknown',
        hasMessages: chatInfo?.hasMessages || false,
        unreadCount: chatInfo?.unreadCount || 0
    };
}).filter(data => data !== null);

// Pass only active responses to display function (no missed opportunities)
await displayProviderResponses(combinedData);

// Update total badge (only active responses, excluding missed)
//document.getElementById('myResponsesTotal').textContent = combinedData.length;
        
    } catch (error) {
        console.error('Error loading provider responses:', error);
    } 
}

async function displayProviderResponses(activeResponses) {
    const container = document.getElementById('myResponsesList');
    
    // Check if no active responses
    if (!activeResponses || activeResponses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ’¬</div>
                <div class="empty-state-text">No responses yet. Respond to nearby requests to start!</div>
            </div>
        `;
        document.getElementById('myResponsesTotal').textContent = '0';
        const myResponsesNewEl = document.getElementById('myResponsesNew');
        if (myResponsesNewEl) {
            myResponsesNewEl.classList.add('hidden');
            myResponsesNewEl.style.display = 'none';
        }
        return;
    }
    
    // NEW LOGIC: Separate into 4 categories (MERGED REACTIVATED INTO IN PROGRESS)
const activeNegotiating = activeResponses.filter(r => 
    r.request.status === 'open' // Still negotiating, not selected yet
);

// âœ… MERGED: In Progress now includes BOTH normal + reactivated
const inProgress = activeResponses.filter(r => 
    r.request.status === 'in_progress' // ALL in_progress (both normal + reactivated)
);

const pendingCompletion = activeResponses.filter(r => 
    r.request.status === 'pending_completion' && 
    r.request.selected_provider_id === currentProfile.user_id
);

const completedResponses = activeResponses.filter(r => 
    r.request.status === 'completed'
);
    
    // Calculate unread counts for each category
const activeUnread = activeNegotiating.reduce((sum, r) => sum + (r.unreadCount || 0), 0);
const inProgressUnread = inProgress.reduce((sum, r) => sum + (r.unreadCount || 0), 0);
const pendingCompletionUnread = pendingCompletion.reduce((sum, r) => sum + (r.unreadCount || 0), 0);
const completedUnread = completedResponses.reduce((sum, r) => sum + (r.unreadCount || 0), 0);

document.getElementById('myResponsesTotal').textContent = inProgress.length + pendingCompletion.length + completedResponses.length;

// NEW: Add sub-tabs for Active, In Progress, Pending Completion, Reactivated, Completed
let tabsHTML = '<div class="sub-tabs" style="margin-bottom: 20px;">';

// Tab 2: In Progress
if (true || inProgress.length > 0) {  // Always show
    const unreadBadge = inProgressUnread > 0 ? `
        <div class="badge-container">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">${inProgressUnread}</span>
        </div>
    ` : '';
    
    tabsHTML += `
        <button class="sub-tab ${currentResponseFilter === 'in_progress' ? 'active' : ''}" onclick="filterResponses('in_progress')">
            <span>âš™ï¸ In Progress</span>
            <div class="sub-tab-badges">
                <span class="count-badge">${inProgress.length}</span>
                ${unreadBadge}
            </div>
        </button>
    `;
}

// Tab 3: Pending Completion
if (true || pendingCompletion.length > 0) {
    const unreadBadge = pendingCompletionUnread > 0 ? `
        <div class="badge-container">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">${pendingCompletionUnread}</span>
        </div>
    ` : '';
    
    tabsHTML += `
        <button class="sub-tab ${currentResponseFilter === 'pending_completion' ? 'active' : ''}" onclick="filterResponses('pending_completion')">
            <span>â³ Pending Completion</span>
            <div class="sub-tab-badges">
                <span class="count-badge">${pendingCompletion.length}</span>
                ${unreadBadge}
            </div>
        </button>
    `;
}


// Tab 5: Completed
if (true || completedResponses.length > 0) {
    const unreadBadge = completedUnread > 0 ? `
        <div class="badge-container">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">${completedUnread}</span>
        </div>
    ` : '';
    
    tabsHTML += `
        <button class="sub-tab ${currentResponseFilter === 'completed' ? 'active' : ''}" onclick="filterResponses('completed')">
            <span>âœ… Completed</span>
            <div class="sub-tab-badges">
                <span class="count-badge">${completedResponses.length}</span>
                ${unreadBadge}
            </div>
        </button>
    `;
}

tabsHTML += '</div>';
    
    // NEW: Determine which data to show based on filter
let responsesData = inProgress; // Default to In Progress (no more Active tab)

if (currentResponseFilter === 'in_progress') {
    responsesData = inProgress;
    } else if (currentResponseFilter === 'pending_completion') {  // â† ğŸ†• NEW FILTER
        responsesData = pendingCompletion;
    } else if (currentResponseFilter === 'reactivated') {
        responsesData = reactivated;
    } else if (currentResponseFilter === 'completed') {
        responsesData = completedResponses;
    }
    
    // NEW: If filtered data is empty, show empty state
    if (!responsesData || responsesData.length === 0) {
    let emptyIcon = 'âš™ï¸';
    let emptyText = 'in progress requests';
    
    if (currentResponseFilter === 'in_progress') {
            emptyIcon = 'âš™ï¸';
            emptyText = 'in progress requests';
        } else if (currentResponseFilter === 'pending_completion') {  // â† ğŸ†• NEW EMPTY STATE
            emptyIcon = 'â³';
            emptyText = 'pending completion requests';
        } else if (currentResponseFilter === 'reactivated') {
            emptyIcon = 'ğŸ”';
            emptyText = 'reactivated requests';
        } else if (currentResponseFilter === 'completed') {
            emptyIcon = 'âœ…';
            emptyText = 'completed requests';
        }
        
        container.innerHTML = tabsHTML + `
            <div class="empty-state">
                <div class="empty-state-icon">${emptyIcon}</div>
                <div class="empty-state-text">No ${emptyText} yet</div>
            </div>
        `;
        return;
    }
    
    // Count unread messages from ALL active responses (not just in progress)
    const totalUnread = activeResponses.reduce((sum, d) => sum + (d.unreadCount || 0), 0);
    
    // Update section badges - show total unread count with chat bubble icon
    const myResponsesNewEl = document.getElementById('myResponsesNew');
    if (myResponsesNewEl) {
        if (totalUnread > 0) {
            const unreadBadge = myResponsesNewEl.querySelector('.unread-badge');
            if (unreadBadge) {
                unreadBadge.textContent = totalUnread;
            }
            myResponsesNewEl.classList.remove('hidden');
            myResponsesNewEl.style.display = 'inline-flex';
        } else {
            myResponsesNewEl.classList.add('hidden');
            myResponsesNewEl.style.display = 'none';
        }
    }
    
    let html = tabsHTML; // Start with tabs
    
    for (let data of responsesData) {
        const req = data.request;
        if (!req) continue;
        
        const icon = SERVICE_ICONS[req.service_category] || 'ğŸ”§';
        const timeAgo = getTimeAgo(new Date(data.created_at));
        
        // âœ… ADD THESE TWO LINES HERE:
        const isReactivated = req.status === 'in_progress' && req.warranty_end_date;
        const reactivatedBadge = isReactivated ? '<span style="color: #dc3545; font-weight: 700; font-size: 11px; margin-left: 6px; background: #fee; padding: 2px 8px; border-radius: 4px;">REACTIVATED</span>' : '';

	// Determine status
        let statusBadge = '';
        let chatButton = '';

        if (data.isMissedOpportunity) {
            // Read-only chat button
            chatButton = `<button class="btn btn-chat action-btn-compact" style="background: #6c757d;" onclick="openChat('${req.id}', '${currentProfile.user_id}')">ğŸ‘ï¸ View Chat</button>`;
        } else {
            // Active response - normal buttons with unread badge
            const unreadBadgeHTML = data.unreadCount > 0 ? `<span class="chat-unread-badge">${data.unreadCount}</span>` : '';
            
            if (req.status === 'completed') {
                statusBadge = '<span class="status-badge status-completed">âœ… COMPLETED</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">ğŸ‘ï¸ View Chat</button>${unreadBadgeHTML}</div>`;
            } else if (req.status === 'pending_completion' && req.selected_provider_id === currentProfile.user_id) {  // â† ğŸ†• UPDATED STATUS DISPLAY
                statusBadge = '<span class="status-badge" style="background: #fff3cd; color: #856404;">â³ PENDING APPROVAL</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">ğŸ’¬ Chat</button>${unreadBadgeHTML}</div>`;
            } else if (req.status === 'in_progress' && req.selected_provider_id === currentProfile.user_id) {
                statusBadge = '<span class="status-badge" style="background: #cce5ff; color: #004085;">ğŸ”„ IN PROGRESS</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">ğŸ’¬ Chat</button>${unreadBadgeHTML}</div>`;
            } else if (req.status === 'open') {
                statusBadge = '<span class="status-badge status-open">â³ PENDING</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">ğŸ’¬ Chat</button>${unreadBadgeHTML}</div>`;
            }
        }
        
        // â† ğŸ†• NEW: Show warranty period for pending_completion requests
        let warrantyBadge = '';
        if (req.status === 'pending_completion' && req.warranty_period !== null && req.warranty_period !== undefined) {
            if (req.warranty_period === 0) {
                warrantyBadge = `<span class="info-badge" style="background: #6c757d;">ğŸ›¡ï¸ No warranty offered</span>`;
            } else {
                warrantyBadge = `<span class="info-badge" style="background: #17a2b8;">ğŸ›¡ï¸ ${req.warranty_period} day${req.warranty_period > 1 ? 's' : ''} warranty offered</span>`;
            }
        }
        
        // Calculate remaining warranty if completed
        if (req.status === 'completed' && req.warranty_end_date) {
            // Only show warranty if this provider is the SELECTED provider who did the work
            if (req.selected_provider_id === currentProfile.user_id) {
                const warrantyEndDate = new Date(req.warranty_end_date);
                const today = new Date();
                const remainingDays = Math.ceil((warrantyEndDate - today) / (1000 * 60 * 60 * 24));
                
                if (remainingDays > 0) {
                    warrantyBadge = `<span class="info-badge" style="background: #28a745;">ğŸ›¡ï¸ ${remainingDays} day${remainingDays > 1 ? 's' : ''} warranty</span>`;
                } else if (remainingDays === 0) {
                    warrantyBadge = `<span class="info-badge" style="background: #ffc107; color: #333;">ğŸ›¡ï¸ Warranty expires today</span>`;
                } else {
                    warrantyBadge = `<span class="info-badge" style="background: #dc3545;">ğŸ›¡ï¸ Warranty expired</span>`;
                }
            }
        }
        
        const distance = calculateDistance(
            currentProfile.latitude,
            currentProfile.longitude,
            req.request_latitude,
            req.request_longitude
        );
        
       html += `
    <div class="request-card compact">
        <div class="request-card-main">
            <div class="request-card-left">
                <div class="request-title-compact" onclick="toggleRequestDetails(event, 'resp-${req.id}')">
                    <span class="urgency-bubble ${req.urgency}"></span>
                    <span class="request-title-text">${icon} ${req.title}${reactivatedBadge}</span>
                    <span class="request-chevron" id="chevron-resp-${req.id}">â–¼</span>
                </div>
                <div class="request-summary" style="display: flex !important; justify-content: space-between !important; width: 100% !important; align-items: center !important;">
    ${statusBadge}
    ${chatButton}
</div>
                ${warrantyBadge ? `<div class="request-summary">${warrantyBadge}</div>` : ''}
                <div class="request-summary" style="margin-top: 6px; color: #999;">
                    ğŸ‘¤ ${data.seekerName} â€¢ ğŸ“ ${distance} km â€¢ ğŸ•’ ${timeAgo}
                </div>
            </div>
        </div>
                <div class="request-details" id="details-resp-${req.id}">
                    <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                    <div class="request-location" style="margin-top: 8px;"><strong>Location:</strong> ${req.request_location_address}</div>
                    <div class="request-meta" style="margin-top: 8px;">
                        <span class="meta-item">ğŸ”§ Service: ${req.service_category}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

        // Load Nearby Requests (Provider View)
// Load Nearby Requests (Provider View) - WITH DEBUG LOGS
async function loadNearbyRequests() {
    try {
        console.log('ğŸ”µ ========== LOAD NEARBY REQUESTS DEBUG ==========');
        console.log('ğŸ”µ Current Provider ID:', currentProfile.user_id);
        console.log('ğŸ”µ Provider Name:', currentProfile.name);
        console.log('ğŸ”µ Provider Coordinates:', {
            lat: currentProfile.latitude,
            lng: currentProfile.longitude
        });
        
        // Step 1: Get all open requests
        const { data: allRequests, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .eq('status', 'open');
        
        if (reqError) throw reqError;
        
        console.log('ğŸ”µ Total OPEN requests in database:', allRequests?.length || 0);
        if (allRequests && allRequests.length > 0) {
            console.log('ğŸ”µ All open requests:', allRequests.map(r => ({
                id: r.id,
                title: r.title,
                service: r.service_category,
                location: { lat: r.request_latitude, lng: r.request_longitude },
                address: r.request_location_address
            })));
        }

        // Step 2: Get provider's responses to filter them out
        const { data: myResponses, error: respError } = await supabase
            .from('request_responses')
            .select('request_id')
            .eq('provider_id', currentProfile.user_id);
        
        if (respError) throw respError;
        
        const respondedIds = new Set((myResponses || []).map(r => r.request_id));
        console.log('ğŸ”µ Requests I already responded to:', Array.from(respondedIds));

        const nearby = [];
        
        // Step 3: Get provider's services
        const { data: providerServices, error: servError } = await supabase
            .from('provider_services')
            .select('*')
            .eq('provider_id', currentProfile.user_id);
        
        if (servError) throw servError;
        
        console.log('ğŸ”µ My Services:', providerServices?.map(s => ({
            service: s.service_id,
            radius: s.service_radius
        })) || 'NONE');
        
        if (!providerServices || providerServices.length === 0) {
            console.log('âŒ PROBLEM: Provider has NO services registered!');
            document.getElementById('nearbyRequestsList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âš ï¸</div>
                    <div class="empty-state-text">You haven't added any services yet. Please update your profile to add services.</div>
                </div>
            `;
            document.getElementById('availableWorkTotal').textContent = '0';
            return;
        }
        
        // Step 4: Filter requests
        for (let req of allRequests || []) {
            console.log('ğŸ”µ --- Checking Request:', req.title);
            
            // Skip if already responded
            if (respondedIds.has(req.id)) {
                console.log('â­ï¸ SKIP: Already responded to this request');
                continue;
            }
            
            // Check if request has valid coordinates
            if (!req.request_latitude || !req.request_longitude) {
                console.log('âŒ SKIP: Request has invalid coordinates');
                continue;
            }
            
            // Calculate distance
            const distance = calculateDistance(
                currentProfile.latitude,
                currentProfile.longitude,
                req.request_latitude,
                req.request_longitude
            );
            
            console.log('ğŸ“ Distance:', distance, 'km');
            
            // Check if provider offers this service
            const matchingService = providerServices.find(s => s.service_id === req.service_category);
            
            if (!matchingService) {
                console.log('âŒ SKIP: Provider does NOT offer service:', req.service_category);
                continue;
            }
            
            console.log('âœ… Provider offers this service:', req.service_category);
            console.log('ğŸ“ Service radius:', matchingService.service_radius, 'km');
            
            // Check if within service radius
            if (distance <= matchingService.service_radius) {
                console.log('âœ… MATCH! Request is within radius:', distance, 'km <=', matchingService.service_radius, 'km');
                nearby.push({
                    ...req,
                    distance: distance,
                    serviceRadius: matchingService.service_radius
                });
            } else {
                console.log('âŒ SKIP: Request is OUTSIDE radius:', distance, 'km >', matchingService.service_radius, 'km');
            }
        }

        console.log('ğŸ”µ Total matching requests:', nearby.length);
        console.log('ğŸ”µ ========== END DEBUG ==========');

        // Continue with rest of function (missed opportunities, etc.)
        const { data: allRespondedRequests, error: allReqError } = await supabase
            .from('requests')
            .select('*')
            .in('id', Array.from(respondedIds));

        if (allReqError) throw allReqError;

        const missedOpportunities = [];

        for (let req of allRespondedRequests || []) {
            const isMissed = (req.status === 'in_progress' || req.status === 'completed' || req.status === 'pending_completion') && 
                             req.selected_provider_id !== currentProfile.user_id;
            
            if (isMissed && req.request_latitude && req.request_longitude) {
                const distance = calculateDistance(
                    currentProfile.latitude,
                    currentProfile.longitude,
                    req.request_latitude,
                    req.request_longitude
                );
                
                missedOpportunities.push({
                    ...req,
                    distance: distance
                });
            }
        }

        // Update badges
        const availableCount = nearby.length;
        const totalElement = document.getElementById('availableWorkTotal');
        const newElement = document.getElementById('availableWorkNew');

        if (totalElement) totalElement.textContent = availableCount;

        const lastOpenedAt = currentProfile.available_work_last_opened_at;
        let newCount = 0;

        if (!lastOpenedAt) {
            newCount = nearby.length;
        } else {
            const lastOpenedDate = new Date(lastOpenedAt);
            newCount = nearby.filter(r => {
                const requestCreatedAt = new Date(r.created_at);
                return requestCreatedAt > lastOpenedDate;
            }).length;
        }

        if (newElement) {
            if (newCount > 0) {
                newElement.textContent = `ğŸ†• ${newCount}`;
                newElement.classList.remove('hidden');
                newElement.style.display = 'inline-block';
            } else {
                newElement.classList.add('hidden');
                newElement.style.display = 'none';
            }
        }

        displayNearbyRequests(nearby, missedOpportunities);
        
    } catch (error) {
        console.error('âŒ Error loading nearby requests:', error);
    }
}

// Step 6: Pass both available and missed to display function
async function displayNearbyRequests(availableRequests, missedRequests) {
    const container = document.getElementById('nearbyRequestsList');
const tabsContainer = document.getElementById('urgencyTabs');

// Handle empty state for both available and missed
if ((!availableRequests || availableRequests.length === 0) && (!missedRequests || missedRequests.length === 0)) {
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ’¼</div>
            <div class="empty-state-text">No work opportunities available</div>
        </div>
    `;
    tabsContainer.innerHTML = '';
    document.getElementById('availableWorkTotal').textContent = '0';
    document.getElementById('availableWorkNew').classList.add('hidden');
    return;
}

// Determine which data to show based on current filter
let requests = availableRequests || [];
if (window.currentWorkFilter === 'missed') {
    requests = missedRequests || [];
}

    // Count by urgency for tabs
    const urgentCount = requests.filter(r => r.urgency === 'urgent').length;
    const normalCount = requests.filter(r => r.urgency === 'normal').length;
    const flexibleCount = requests.filter(r => r.urgency === 'low').length;
    const newCount = requests.filter(r => {
        const hoursSince = (new Date() - new Date(r.created_at)) / (1000 * 60 * 60);
        return hoursSince < 2;
    }).length;

    // Update section badges
    document.getElementById('availableWorkTotal').textContent = requests.length;
    if (newCount > 0) {
        document.getElementById('availableWorkNew').textContent = `ğŸ†• ${newCount}`;
        document.getElementById('availableWorkNew').classList.remove('hidden');
    } else {
        document.getElementById('availableWorkNew').classList.add('hidden');
    }

    // Build subtabs for Available Work and Missed Opportunities
const availableCount = availableRequests ? availableRequests.length : 0;
const missedCount = missedRequests ? missedRequests.length : 0;
const currentFilter = window.currentWorkFilter || 'available';

let tabsHTML = '';

// Available Work tab
if (availableCount > 0) {
    tabsHTML += `<button class="sub-tab ${currentFilter === 'available' ? 'active' : ''}" onclick="filterWorkOpportunities('available')">ğŸ“ Available Work <span class="count-badge">${availableCount}</span></button>`;
}

// Missed Opportunities tab
if (missedCount > 0) {
    tabsHTML += `<button class="sub-tab ${currentFilter === 'missed' ? 'active' : ''}" onclick="filterWorkOpportunities('missed')">â›” Missed Opportunities <span class="count-badge">${missedCount}</span></button>`;
}

tabsContainer.innerHTML = tabsHTML;

    // Filter by urgency
    let filteredRequests = requests;
    if (currentUrgencyFilter !== 'all') {
        filteredRequests = requests.filter(r => r.urgency === currentUrgencyFilter);
    }

    if (filteredRequests.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <div class="empty-state-text">No ${currentUrgencyFilter} requests available</div>
            </div>
        `;
        return;
    }

    // Build HTML for requests
    let html = '';
    
    for (let req of filteredRequests) {
        const icon = SERVICE_ICONS[req.service_category] || 'ğŸ”§';
        const timeAgo = getTimeAgo(new Date(req.created_at));                                         
        const newBadge = ((new Date() - new Date(req.created_at)) / (1000 * 60 * 60)) < 2 ? '<span class="info-badge">ğŸ†• NEW</span>' : '';
        
        html += `
    <div class="request-card compact">
        <div class="request-card-main">
            <div class="request-card-left">
                <div class="request-title-compact" onclick="toggleRequestDetails(event, 'nearby-${req.id}')">
    <span class="urgency-bubble ${req.urgency}"></span>
    <span class="request-title-text">${icon} ${req.title}</span>
    <span class="request-chevron" id="chevron-nearby-${req.id}">â–¼</span>
</div>
                        <div class="request-summary">
    <span class="info-badge">ğŸ“ ${req.distance} km</span>
    ${newBadge}
</div>
                        <div class="request-summary" style="margin-top: 6px; color: #999;">
                            ğŸ•’ ${timeAgo} â€¢ ğŸ”§ ${req.service_category}
                        </div>
                    </div>
                    <div class="request-card-right">
    ${window.currentWorkFilter === 'missed' 
        ? `<button class="btn btn-respond action-btn-compact" style="background: #6c757d;" onclick="openChat('${req.id}', '${currentProfile.user_id}', true)">ğŸ‘ï¸ View Chat</button>`
        : `<button class="btn btn-respond action-btn-compact" onclick="respondToRequest('${req.id}')">Respond</button>`
    }
</div>
                </div>
                <div class="request-details" id="details-nearby-${req.id}">
                    <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                    <div class="request-location" style="margin-top: 8px;"><strong>Location:</strong> ${req.request_location_address}</div>
                    <div class="request-meta" style="margin-top: 8px;">
                        <span class="meta-item">ğŸ“ Distance: ${req.distance} km</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}                		

// Respond to Request (Provider)
        async function respondToRequest(requestId) {
            const respondBtn = event.target;
            respondBtn.disabled = true;
            respondBtn.textContent = 'Checking...';
            
            try {
                const { data: existingResponse, error: checkError } = await supabase
                    .from('request_responses')
                    .select('id')
                    .eq('request_id', requestId)
                    .eq('provider_id', currentProfile.user_id);

                if (checkError) throw checkError;

                if (existingResponse && existingResponse.length > 0) {
                    alert('âš ï¸ You have already responded to this request!');
                    respondBtn.textContent = 'âœ… Responded';
                    respondBtn.style.background = '#6c757d';
                    respondBtn.disabled = false;
                    return;
                }

                const { error: insertError } = await supabase
                    .from('request_responses')
                    .insert([{
                        request_id: requestId,
                        provider_id: currentProfile.user_id,
                        status: 'pending',
                        availability: 'available',
                        response_message: `Hi! I am interested in providing this service.`
                    }]);

                if (insertError) throw insertError;

                alert('âœ… Response sent successfully! The seeker will see your response and can chat with you.');

// Reload dashboard to move request from Available Work to My Responses
await loadProviderResponses();
await loadNearbyRequests();

// Change button to show "Responded"
respondBtn.textContent = 'âœ… Responded';
respondBtn.style.background = '#6c757d';
respondBtn.disabled = false;
                
            } catch (error) {
                alert('âŒ Error: ' + error.message);
                respondBtn.disabled = false;
                respondBtn.textContent = 'Respond to Request';
            }
        }

        // Cancel Request
async function cancelRequest(requestId) {
    if (!confirm('âš ï¸ Are you sure you want to cancel this request?\n\nğŸ—‘ï¸ This will permanently delete the request and remove it from all providers.')) return;
    
    try {
        // Step 1: Delete all chat messages for this request
        const { error: chatError } = await supabase
            .from('chats')
            .delete()
            .eq('request_id', requestId);
        
        if (chatError) console.error('Error deleting chats:', chatError);
        
        // Step 2: Delete all provider responses
        const { error: responseError } = await supabase
            .from('request_responses')
            .delete()
            .eq('request_id', requestId);
        
        if (responseError) console.error('Error deleting responses:', responseError);
        
        // Step 3: Delete all ratings for this request
        const { error: ratingError } = await supabase
            .from('ratings')
            .delete()
            .eq('request_id', requestId);
        
        if (ratingError) console.error('Error deleting ratings:', ratingError);
        
        // Step 4: Finally delete the request itself
        const { error: requestError } = await supabase
            .from('requests')
            .delete()
            .eq('id', requestId);
        
        if (requestError) throw requestError;
        
        alert('âœ… Request cancelled successfully and removed from all providers');
        loadUserRequests();
        
    } catch (error) {
        alert('Error cancelling request: ' + error.message);
    }
}

// Reactivate Request (during warranty period)
        async function reactivateRequest(requestId) {
            if (!confirm('ğŸ”„ Reactivate this request?\n\nThe provider will be notified that you need service again within the warranty period. The same process will repeat.')) return;
            
            try {
                // Get request details to find selected provider
                const { data: request, error: reqError } = await supabase
                    .from('requests')
                    .select('selected_provider_id')
                    .eq('id', requestId)
                    .single();
                
                if (reqError || !request) throw reqError || new Error('Request not found');
                
                // Update request status
                const { error: updateError } = await supabase
                    .from('requests')
                    .update({
                        status: 'in_progress',
                    })
                    .eq('id', requestId);
                
                if (updateError) throw updateError;
                
                // Add system message to chat
                const { data: existingChat } = await supabase
                    .from('chats')
                    .select('messages')
                    .eq('request_id', requestId)
                    .eq('provider_id', request.selected_provider_id)
                    .single();
                
                let messages = existingChat?.messages || [];
                
                messages.push({
                    sender_id: currentUser.id,
                    sender_name: currentProfile.name,
                    message: 'ğŸ”„ Seeker has reactivated this request. Service needed again within warranty period.',
                    message_type: 'system',
                    timestamp: new Date().toISOString()
                });
                
                await supabase
                    .from('chats')
                    .upsert({
                        request_id: requestId,
                        provider_id: request.selected_provider_id,
                        messages: messages
                    }, { onConflict: 'request_id,provider_id' });
                
                alert('âœ… Request reactivated! The provider will be notified.');
                loadUserRequests();
                
            } catch (error) {
                alert('Error reactivating request: ' + error.message);
            }
        }

// Edit Request - Load form with existing data
        async function editRequest(requestId) {
            try {
                showLoading();
                
                // Check if request has any responses
                const { data: responses } = await supabase
                    .from('request_responses')
                    .select('id')
                    .eq('request_id', requestId);
                
                if (responses && responses.length > 0) {
                    alert('âš ï¸ Cannot edit request after providers have responded. Please cancel and create a new request.');
                    showDashboard();
                    return;
                }
                
                // Load request data
                const { data: request, error } = await supabase
                    .from('requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (error) throw error;
                
                if (request.status !== 'open') {
                    alert('âš ï¸ Only open requests can be edited.');
                    showDashboard();
                    return;
                }
                
                // Show edit view and populate form
                hideAllViews();
                document.getElementById('editRequestView').classList.remove('hidden');
                
                // Populate form fields
                document.getElementById('editRequestId').value = request.id;
                document.getElementById('editServiceType').value = request.service_category;
                document.getElementById('editRequestTitle').value = request.title;
                document.getElementById('editRequestDescription').value = request.description;
                
                // Update character counters
                document.getElementById('editTitleCounter').textContent = request.title.length;
                document.getElementById('editDescCounter').textContent = request.description.length;
                
                // Set urgency
                document.getElementById('editUrgentRadio').checked = request.urgency === 'urgent';
                document.getElementById('editNormalRadio').checked = request.urgency === 'normal';
                document.getElementById('editLowRadio').checked = request.urgency === 'low';
                
                // Show current location (read-only)
                document.getElementById('currentLocationText').textContent = request.request_location_address;
                
            } catch (error) {
                alert('Error loading request: ' + error.message);
                showDashboard();
            }
        }

// Edit Request Form Submission
        document.getElementById('editRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('editRequestError');
            const infoDiv = document.getElementById('editRequestInfo');
            const submitBtn = document.getElementById('updateRequestBtn');

            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';

            try {
                const requestId = document.getElementById('editRequestId').value;
                const title = document.getElementById('editRequestTitle').value.trim();
                const description = document.getElementById('editRequestDescription').value.trim();
                const urgency = document.querySelector('input[name="editUrgency"]:checked').value;

                const updateData = {
                    title: title,
                    description: description,
                    urgency: urgency
                };

                infoDiv.textContent = 'ğŸ’¾ Updating request...';
                infoDiv.classList.remove('hidden');
                const { error } = await supabase
                    .from('requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                infoDiv.classList.add('hidden');
                alert('âœ… Request updated successfully!');
                showDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¾ Update Request';
                infoDiv.classList.add('hidden');
            }
        });

        // Create Request
        document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('createRequestError');
            const infoDiv = document.getElementById('createRequestInfo');
            const submitBtn = document.getElementById('submitRequestBtn');

            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';

            try {
                const serviceType = document.getElementById('serviceType').value;
                const title = document.getElementById('requestTitle').value.trim();
                const description = document.getElementById('requestDescription').value.trim();
                const urgency = document.querySelector('input[name="urgency"]:checked').value;

                const useDifferentLocation = document.getElementById('differentLocation').checked;
                let locationData;

                if (useDifferentLocation) {
                    const customLocation = {
                        area_name: document.getElementById('customAreaName').value.trim(),
                        landmark: document.getElementById('customLandmark').value.trim() || null,
                        city: document.getElementById('customCity').value,
                        state: document.getElementById('customState').value,
                        pin_code: document.getElementById('customPinCode').value.trim()
                    };

                    infoDiv.textContent = 'ğŸ“ Finding service location...';
                    infoDiv.classList.remove('hidden');

                    const coords = await getCoordinates(customLocation);
                    
                    locationData = {
                        address: [customLocation.area_name, customLocation.landmark, customLocation.city, customLocation.state, customLocation.pin_code].filter(Boolean).join(', '),
                        latitude: coords.lat,
                        longitude: coords.lng
                    };
                } else {
                    locationData = {
                        address: [currentProfile.area_name, currentProfile.landmark, currentProfile.city, currentProfile.state, currentProfile.pin_code].filter(Boolean).join(', '),
                        latitude: currentProfile.latitude,
                        longitude: currentProfile.longitude
                    };
                }

                infoDiv.textContent = 'ğŸ’¾ Creating request...';

                const { error } = await supabase.from('requests').insert([{
                    user_id: currentUser.id,
                    service_category: serviceType,
                    title: title,
                    description: description,
                    urgency: urgency,
                    request_location_address: locationData.address,
                    request_latitude: locationData.latitude,
                    request_longitude: locationData.longitude,
                    status: 'open',
                    chat_status: 'active'
                }]);

                if (error) throw error;

                infoDiv.classList.add('hidden');
                alert('âœ… Request created successfully!');
                showDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Request';
                infoDiv.classList.add('hidden');
            }
        });

// Edit Profile Form Submission
document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const errorDiv = document.getElementById('editProfileError');
    const infoDiv = document.getElementById('editProfileInfo');
    const submitBtn = document.getElementById('saveProfileBtn');
    
    errorDiv.classList.add('hidden');
    infoDiv.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    try {
        const formData = {
            name: document.getElementById('editName').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            house_number: document.getElementById('editHouseNumber').value.trim() || null,
            area_name: document.getElementById('editAreaName').value.trim(),
            landmark: document.getElementById('editLandmark').value.trim() || null,
            city: document.getElementById('editCity').value,
            state: document.getElementById('editState').value,
            pin_code: document.getElementById('editPinCode').value.trim(),
            is_provider: currentProfile.is_provider,
            radius_km: parseInt(document.getElementById('editRadius').value)
        };
        
        // Handle profile photo update
        const photoFile = document.getElementById('editPhoto').files[0];
        if (photoFile) {
            if (photoFile.size > 2 * 1024 * 1024) {
                throw new Error('Profile photo size should be less than 2MB');
            }
            infoDiv.textContent = 'ğŸ“¸ Uploading new profile photo...';
            infoDiv.classList.remove('hidden');
            formData.profile_photo = await convertImageToBase64(photoFile);
        } else {
            // Don't update photo if no file selected - keep existing
            delete formData.profile_photo;
        }
        
        // Check if address changed
        const addressChanged = 
            formData.house_number !== currentProfile.house_number ||
            formData.area_name !== currentProfile.area_name ||
            formData.landmark !== currentProfile.landmark ||
            formData.city !== currentProfile.city ||
            formData.state !== currentProfile.state ||
            formData.pin_code !== currentProfile.pin_code;
        

        if (addressChanged) {
            infoDiv.textContent = 'ğŸ“ Updating location...';
            infoDiv.classList.remove('hidden');
            
            const coords = await getCoordinates(formData);
            formData.latitude = coords.lat;
            formData.longitude = coords.lng;
            
        }
        
        infoDiv.textContent = 'ğŸ’¾ Saving profile...';
        infoDiv.classList.remove('hidden');
        
        // Update profile
        const { error: profileError } = await supabase
            .from('profiles')
            .update(formData)
            .eq('user_id', currentProfile.user_id);
        
        if (profileError) throw profileError;
        
        // If provider was toggled OFF, remove all services
        if (!formData.is_provider && currentProfile.is_provider) {
            const { error: deleteError } = await supabase
                .from('provider_services')
                .delete()
                .eq('provider_id', currentProfile.user_id);
            
            if (deleteError) throw deleteError;
        }
        
        // If radius changed, update all existing services
        if (formData.is_provider && formData.radius_km !== currentProfile.radius_km) {
            const { error: updateRadiusError } = await supabase
                .from('provider_services')
                .update({ service_radius: formData.radius_km })
                .eq('provider_id', currentProfile.user_id);
            
            if (updateRadiusError) throw updateRadiusError;
        }
        
        alert('âœ… Profile updated successfully!');

// Re-enable button before redirect
submitBtn.disabled = false;
submitBtn.textContent = 'ğŸ’¾ Save Changes';
infoDiv.classList.add('hidden');

// Reload profile data silently (without showing loading screen)
const { data, error } = await supabase.from('profiles').select('*').eq('user_id', currentUser.id).single();
if (!error) {
    currentProfile = data;
}

// âœ… CRITICAL: Hide edit profile view explicitly
const editView = document.getElementById('editProfileView');
if (editView) {
    editView.classList.add('hidden');
    editView.style.display = 'none';
}

// Go back to dashboard
showDashboard();
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ Save Changes';
        infoDiv.classList.add('hidden');
    }
});

        // Logout
        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
            }
            
            await supabase.auth.signOut();
            currentUser = null;
            currentProfile = null;
	sessionStorage.removeItem('dashboardMode');
            location.reload();
        }

// Collapsible Section Management
        let currentRequestFilter = 'no_response'; // Default for OPEN REQUESTS
let currentActiveRequestsFilter = 'in_progress'; // NEW: Default for ACTIVE REQUESTS
let currentUrgencyFilter = 'all';
	
	// User dropdown toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('active');
}

// Show Terms from Dropdown
function showTermsFromDropdown() {
    toggleUserDropdown();
    showTerms();
}

// Show Privacy from Dropdown
function showPrivacyFromDropdown() {
    toggleUserDropdown();
    showPrivacy();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('userDropdown');
    
    if (userMenu && dropdown && !userMenu.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});
        
	async function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            
            // Check if this section is currently expanded
            const isCurrentlyExpanded = content.classList.contains('expanded');
            
            // List of all collapsible sections
const allSections = ['openRequests', 'activeRequests', 'myResponses', 'availableWork', 'providerOpenRequests'];
            
            // Close ALL sections first (accordion behavior)
            allSections.forEach(section => {
                const sectionContent = document.getElementById(section + 'Content');
                const sectionIcon = document.getElementById(section + 'Icon');
                
                if (sectionContent) sectionContent.classList.remove('expanded');
                if (sectionIcon) sectionIcon.classList.remove('expanded');
            });
            
            // If the clicked section was closed, open it now
            // If it was already open, leave it closed (toggle behavior)
            if (!isCurrentlyExpanded) {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                
                // NEW: If opening "Work Opportunities", mark all requests as seen
                if (sectionId === 'availableWork' && currentProfile && currentProfile.is_provider) {
                    await markAvailableWorkAsSeen();
                }
                
                // FIX: Auto-load content for Active Requests section
if (sectionId === 'activeRequests') {
    // Trigger the default In Progress tab
    setTimeout(() => {
        filterActiveRequests('in_progress');
    }, 100);
}
            }
        }

        function filterMyRequests(filter) {
    currentRequestFilter = filter;
    
    // Update active tab - remove all active classes first
    const allTabs = document.querySelectorAll('#seekerSection .sub-tab');
    if (allTabs && allTabs.length > 0) {
        allTabs.forEach(tab => {
            tab.classList.remove('active');
        });
    }
    
    // Add active class to clicked tab
    if (event && event.target) {
        const clickedButton = event.target.closest('.sub-tab');
        if (clickedButton) {
            clickedButton.classList.add('active');
        }
    }

if (!currentRequestFilter || currentRequestFilter === 'responded') {
    currentRequestFilter = 'in_progress';
}
    
    // Reload and filter requests
    loadUserRequests();
}

function filterActiveRequests(filter) {
    currentRequestFilter = filter;
    
    // Update active tab - remove all active classes first
    const allTabs = document.querySelectorAll('#activeRequestsContent .sub-tab');
    if (allTabs && allTabs.length > 0) {
        allTabs.forEach(tab => {
            tab.classList.remove('active');
        });
    }
    
    // Add active class to clicked tab OR default to 'responded' tab
    if (event && event.target) {
        const clickedButton = event.target.closest('.sub-tab');
        if (clickedButton) {
            clickedButton.classList.add('active');
        }
    } else {
        // âœ… NEW: If no event (default load), highlight the 'in_progress' tab
        const inProgressTab = Array.from(allTabs).find(tab => 
            tab.textContent.includes('In Progress') || tab.getAttribute('onclick')?.includes("'in_progress'")
        );
        if (inProgressTab) {
            inProgressTab.classList.add('active');
        }
    }
    
    // Reload and filter requests
    loadUserRequests();
}

        function filterByUrgency(urgency) {
            currentUrgencyFilter = urgency;
            
            // Update active tab
            document.querySelectorAll('#urgencyTabs .sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload and filter nearby requests
            loadNearbyRequests();
        }

        function filterResponses(filter) {
            currentResponseFilter = filter;
            
            // Update active tab - find tabs within MY RESPONSES section only
            const responsesTabs = document.querySelectorAll('#myResponsesList .sub-tab');
            if (responsesTabs && responsesTabs.length > 0) {
                responsesTabs.forEach(tab => {
                    tab.classList.remove('active');
                });
            }
            
            // Add active class to clicked tab
            if (event && event.target) {
                const clickedButton = event.target.closest('.sub-tab');
                if (clickedButton) {
                    clickedButton.classList.add('active');
                }
            }
            
            // Reload provider responses with new filter
            loadProviderResponses();
        }

        function updateSectionBadges() {
            // This will be called after loading data to update badge counts
        }

	// Mark all available work requests as seen
        async function markAvailableWorkAsSeen() {
            try {
                const now = new Date().toISOString();
                
                // Update profile with current timestamp
                const { error } = await supabase
                    .from('profiles')
                    .update({ available_work_last_opened_at: now })
                    .eq('user_id', currentProfile.user_id);
                
                if (error) throw error;
                
                // Update local profile
                currentProfile.available_work_last_opened_at = now;
                
                // Reload nearby requests to update badge to 0
                await loadNearbyRequests();
                
            } catch (error) {
                console.error('Error marking available work as seen:', error);
            }
        }

	// Filter work opportunities (Available vs Missed)
function filterWorkOpportunities(filter) {
    window.currentWorkFilter = filter;
    
    // Update active tab
    const tabs = document.querySelectorAll('#urgencyTabs .sub-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // Reload nearby requests to refresh display
    loadNearbyRequests();
}
	
	
        // ========== AUTOCOMPLETE FUNCTIONS ==========
	
        // Debounce function to avoid too many API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Fetch city suggestions from Nominatim
        async function getCitySuggestions(query) {
    if (query.length < 2) return [];
    
    try {
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)},India&format=json&limit=8&addressdetails=1&accept-language=en`;
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'HelpBuddy/1.0' }
                });
                const data = await response.json();
                
                // Extract unique city names
const cities = [];
const seen = new Set();

// Regex to detect Hindi/Devanagari characters
const hindiRegex = /[\u0900-\u097F]/;

data.forEach(item => {
    const city = item.address?.city || 
                item.address?.town || 
                item.address?.village || 
                item.address?.municipality;
    
    const state = item.address?.state || '';
    
    // Filter out any results with Hindi characters
    if (city && !seen.has(city.toLowerCase()) && !hindiRegex.test(city) && !hindiRegex.test(state)) {
        seen.add(city.toLowerCase());
        cities.push({
            name: city,
            state: state
        });
    }
});

return cities;
            } catch (error) {
                console.error('Error fetching city suggestions:', error);
                return [];
            }
        }

        
        // Setup city autocomplete
        function setupCityAutocomplete() {
    // Setup for SIGNUP form (id="city")
    const cityInput = document.getElementById('city');
    if (cityInput && !cityInput.hasAttribute('data-autocomplete-setup')) {
        setupCityAutocompleteForField(cityInput, 'citySuggestions', 'state');
        cityInput.setAttribute('data-autocomplete-setup', 'true');
    }
    
    // Setup for EDIT PROFILE form (id="editCity")
    const editCityInput = document.getElementById('editCity');
    if (editCityInput && !editCityInput.hasAttribute('data-autocomplete-setup')) {
        setupCityAutocompleteForField(editCityInput, 'editCitySuggestions', 'editState');
        editCityInput.setAttribute('data-autocomplete-setup', 'true');
    }
    
    // Setup for CREATE REQUEST different location (id="customCity")
    const customCityInput = document.getElementById('customCity');
    if (customCityInput && !customCityInput.hasAttribute('data-autocomplete-setup')) {
        setupCityAutocompleteForField(customCityInput, 'customCitySuggestions', 'customState');
        customCityInput.setAttribute('data-autocomplete-setup', 'true');
    }
}

        // Generic setup for any city field
        function setupCityAutocompleteForField(inputElement, suggestionsId, stateFieldId) {
            const debouncedSearch = debounce(async (query) => {
                if (query.length < 2) {
                    document.getElementById(suggestionsId).classList.remove('active');
                    return;
                }
                
                // Show loading
                const container = document.getElementById(suggestionsId);
                if (!container) return;
                
                container.innerHTML = '<div class="suggestion-item loading">Searching...</div>';
                container.classList.add('active');
                
                const suggestions = await getCitySuggestions(query);
                showCitySuggestionsForField(inputElement, suggestions, suggestionsId, stateFieldId);
            }, 300);
            
            inputElement.addEventListener('input', (e) => {
                debouncedSearch(e.target.value.trim());
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                const suggestionsContainer = document.getElementById(suggestionsId);
                if (suggestionsContainer && !inputElement.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.classList.remove('active');
                }
            });
        }

        // Show suggestions for specific field
        function showCitySuggestionsForField(inputElement, suggestions, suggestionsId, stateFieldId) {
            const container = document.getElementById(suggestionsId);
            if (!container) return;
            
            if (suggestions.length === 0) {
                container.classList.remove('active');
                return;
            }
            
            let html = '';
            suggestions.forEach(item => {
                const cityName = item.name.replace(/'/g, "\\'");
                const stateName = item.state.replace(/'/g, "\\'");
                html += `
                    <div class="suggestion-item" onclick="selectCityForField('${inputElement.id}', '${cityName}', '${stateFieldId}', '${stateName}', '${suggestionsId}')">
                        ${item.name}${item.state ? ', ' + item.state : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.classList.add('active');
        }

        // Select city for specific field
        function selectCityForField(inputId, cityName, stateFieldId, stateName, suggestionsId) {
            const cityInput = document.getElementById(inputId);
            if (cityInput) {
                cityInput.value = cityName;
            }
            
            // Auto-fill state if available
            const stateField = document.getElementById(stateFieldId);
            if (stateName && stateField) {
                if (stateField.tagName === 'SELECT') {
                    // Try to find matching state in dropdown
                    const options = Array.from(stateField.options);
                    const matchingOption = options.find(opt => opt.value === stateName);
                    if (matchingOption) {
                        stateField.value = stateName;
                    }
                } else {
                    // If it's a text input (for future state autocomplete)
                    stateField.value = stateName;
                }
            }
            
            // Hide suggestions
            const container = document.getElementById(suggestionsId);
            if (container) {
                container.classList.remove('active');
            }
        }

	// Rating System Functions
        let currentRatingData = null;
        let selectedRating = 0;

        function openRatingModal(requestId, providerId, providerName) {
            currentRatingData = { requestId, providerId, providerName };
            selectedRating = 0;
            
            document.getElementById('ratingProviderName').textContent = providerName;
            document.getElementById('ratingReview').value = '';
            document.getElementById('reviewCounter').textContent = '0';
            document.getElementById('ratingError').classList.add('hidden');
            document.getElementById('ratingText').textContent = 'Select Rating';
            
            // Reset stars
            document.querySelectorAll('.star').forEach(star => {
                star.classList.remove('selected');
                star.textContent = 'â˜†';
            });
            
            document.getElementById('ratingModal').classList.add('active');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
            currentRatingData = null;
            selectedRating = 0;
        }

	// Contact Details Modal Functions
        async function openContactDetailsModal() {
            try {
                // Get partner's profile
                const { data: partnerProfile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', currentChatData.partnerId)
                    .single();
                
                if (error || !partnerProfile) {
                    alert('Error loading contact details');
                    return;
                }
                
                const partnerAddress = [
                    partnerProfile.house_number,
                    partnerProfile.area_name,
                    partnerProfile.landmark,
                    partnerProfile.city,
                    partnerProfile.state,
                    partnerProfile.pin_code
                ].filter(Boolean).join(', ');
                
                document.getElementById('contactDetailsModalContent').innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 12px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘¤</div>
                            <h3 style="color: #333; margin-bottom: 5px;">${partnerProfile.name}</h3>
                        </div>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin-bottom: 15px;">
                            <p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>ğŸ“± Phone:</strong> <a href="tel:${partnerProfile.phone}" style="color: #2196f3; text-decoration: none; font-weight: 600;">${partnerProfile.phone}</a></p>
                            <p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>ğŸ“ Address:</strong> ${partnerAddress}</p>
                        </div>
                        <p style="font-size: 12px; color: #666; text-align: center; font-style: italic; background: #fff3cd; padding: 10px; border-radius: 6px; margin: 0;">
                            ğŸ”’ This information is visible because both parties approved contact sharing
                        </p>
                    </div>
                `;
                
                document.getElementById('contactDetailsModal').classList.add('active');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function closeContactDetailsModal() {
            document.getElementById('contactDetailsModal').classList.remove('active');
        }	

        function selectRating(rating) {
            selectedRating = rating;
            
            const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('ratingText').textContent = ratingTexts[rating];
            
            // Update star display
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('selected');
                    star.textContent = 'â˜…';
                } else {
                    star.classList.remove('selected');
                    star.textContent = 'â˜†';
                }
            });
        }

	async function openChatPartnerProfile() {
    try {
        // Get partner's full profile
        const { data: partnerProfile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', currentChatData.partnerId)
            .single();
        
        if (error || !partnerProfile) {
            alert('Error loading partner profile');
            return;
        }
        
        // Get partner's services if they are a provider
        let servicesHTML = '';
        if (partnerProfile.is_provider) {
            const { data: services } = await supabase
                .from('provider_services')
                .select('service_id')
                .eq('provider_id', partnerProfile.user_id);
            
            if (services && services.length > 0) {
                const serviceNames = {
                    electrician: 'ğŸ”§ Electrician',
                    plumber: 'ğŸš° Plumber',
                    ac_repair: 'â„ï¸ AC Repair',
                    carpenter: 'ğŸ”¨ Carpenter',
                    painter: 'ğŸ¨ Painter',
                    cleaner: 'ğŸ§¹ Cleaner'
                };
                servicesHTML = '<h3 style="margin-top: 20px; margin-bottom: 10px;">Services Provided:</h3><div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                services.forEach(s => {
                    servicesHTML += `<span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">${serviceNames[s.service_id] || s.service_id}</span>`;
                });
                servicesHTML += '</div>';
            }
        }
        
        // Get partner's ratings
        let ratingsHTML = '';
if (partnerProfile.average_rating && partnerProfile.average_rating > 0 && partnerProfile.total_ratings > 0) {
    const stars = 'â­'.repeat(Math.round(partnerProfile.average_rating));
    ratingsHTML = `<h3 style="margin-top: 20px; margin-bottom: 10px;">Rating: ${stars} ${partnerProfile.average_rating}/5 (${partnerProfile.total_ratings} ${partnerProfile.total_ratings === 1 ? 'review' : 'reviews'})</h3>`;
    
    // Fetch review details for display
    const { data: ratings } = await supabase
        .from('ratings')
        .select('rating, review, created_at')
        .eq('provider_id', partnerProfile.user_id)
        .order('created_at', { ascending: false });
    
    if (ratings && ratings.length > 0) {
        ratingsHTML += '<div style="margin-top: 10px;">';
        ratings.slice(0, 3).forEach(r => {
            const reviewStars = 'â­'.repeat(r.rating);
            const reviewDate = new Date(r.created_at).toLocaleDateString();
            ratingsHTML += `
                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${reviewStars} ${r.rating}/5</div>
                    ${r.review ? `<p style="color: #555; margin-bottom: 5px; font-size: 14px;">"${r.review}"</p>` : ''}
                    <p style="font-size: 12px; color: #999;">${reviewDate}</p>
                </div>
            `;
        });
        ratingsHTML += '</div>';
    }
}
        
        // Build full address
        const partnerAddress = [
            partnerProfile.house_number,
            partnerProfile.area_name,
            partnerProfile.landmark,
            partnerProfile.city,
            partnerProfile.state,
            partnerProfile.pin_code
        ].filter(Boolean).join(', ');
        
        // Build profile photo HTML
        const photoHTML = partnerProfile.profile_photo 
            ? `<img src="${partnerProfile.profile_photo}" 
                    onclick="event.stopPropagation(); openImagePreview('${partnerProfile.profile_photo}')" 
                    style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; cursor: pointer; transition: transform 0.2s; margin-bottom: 15px;" 
                    onmouseover="this.style.transform='scale(1.05)'" 
                    onmouseout="this.style.transform='scale(1)'"
                    title="Click to view full size">`
            : `<div style="width: 120px; height: 120px; border-radius: 50%; background: #e0e0e0; display: inline-flex; align-items: center; justify-content: center; font-size: 48px; border: 4px solid #667eea; margin-bottom: 15px;">ğŸ‘¤</div>`;
        
        // Display in modal
        document.getElementById('profileContent').innerHTML = `
            <div style="text-align: center;">
                ${photoHTML}
                <h2 style="color: #333; margin: 10px 0;">${partnerProfile.name}</h2>
            </div>
            
            <div style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin: 20px 0;">
                <p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>ğŸ“ Address:</strong> ${partnerAddress}</p>
                ${partnerProfile.is_provider ? `<p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>ğŸ“ Service Radius:</strong> ${partnerProfile.radius_km} km</p>` : ''}
            </div>
            
            ${servicesHTML}
            ${ratingsHTML}
            
            <p style="font-size: 12px; color: #666; text-align: center; font-style: italic; background: #fff3cd; padding: 10px; border-radius: 6px; margin-top: 20px;">
                ğŸ”’ Full contact details are visible only after both parties approve contact sharing
            </p>
        `;
        
        document.getElementById('profileModal').classList.add('active');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}	

async function submitRating() {
    if (selectedRating === 0) {
        document.getElementById('ratingError').textContent = 'Please select a rating';
        document.getElementById('ratingError').classList.remove('hidden');
        return;
    }
    
    const submitBtn = document.getElementById('submitRatingBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
        const review = document.getElementById('ratingReview').value.trim();
        
const { error } = await supabase
    .from('ratings')
    .insert([{
        request_id: currentRatingData.requestId,
        seeker_id: currentUser.id,
        provider_id: currentRatingData.providerId,
        rating: selectedRating,
        review: review || null,
        created_at: new Date().toISOString()  // âœ… Add this line
    }]);

        
        if (error) throw error;
        
        alert('âœ… Rating submitted successfully! Thank you for your feedback.');
        closeRatingModal();
        await loadUserRequests();
        viewResponses(currentRatingData.requestId);
        
    } catch (error) {
        document.getElementById('ratingError').textContent = 'Error: ' + error.message;
        document.getElementById('ratingError').classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Rating';
    }
}

// ==================== FEEDBACK SYSTEM ====================

// Open Feedback Modal
function openFeedbackModal() {
    // Close user dropdown menu first
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) dropdown.classList.remove('active');
    
    console.log('ğŸ”µ Opening feedback modal...');
    
    const modal = document.getElementById('feedbackModal');
    if (!modal) {
        console.error('âŒ Feedback modal not found');
        return;
    }
    
    const messageInput = document.getElementById('feedbackMessage');
    const emailInput = document.getElementById('feedbackEmail');
    const typeSelect = document.getElementById('feedbackType');
    const errorDiv = document.getElementById('feedbackError');
    const successDiv = document.getElementById('feedbackSuccess');
    const counterSpan = document.getElementById('feedbackCounter');
    
    // Reset form
    if (typeSelect) typeSelect.value = '';
    if (messageInput) {
        messageInput.value = '';
        if (counterSpan) counterSpan.textContent = '0';
    }
    if (emailInput && currentProfile) {
        emailInput.value = currentProfile.email || (currentUser ? currentUser.email : '');
    }
    if (errorDiv) errorDiv.classList.add('hidden');
    if (successDiv) successDiv.classList.add('hidden');
    
    // NUCLEAR FIX: Use setAttribute to override ALL inline styles with !important
modal.setAttribute('style', 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; min-width: 100vw !important; min-height: 100vh !important; max-width: 100vw !important; max-height: 100vh !important; z-index: 999999 !important; visibility: visible !important; opacity: 1 !important; background: rgba(0,0,0,0.5) !important; pointer-events: auto !important; align-items: center !important; justify-content: center !important;');
modal.classList.add('active');
    
    console.log('âœ… Feedback modal opened');
    console.log('Has active class:', modal.classList.contains('active'));
    console.log('Display style:', window.getComputedStyle(modal).display);
}

// Close Feedback Modal
function closeFeedbackModal() {
    const modal = document.getElementById('feedbackModal');
    if (modal) {
        modal.classList.remove('active');
        modal.setAttribute('style', 'display: none; position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 999999 !important;');
    }
}

// Submit Feedback
async function submitFeedback() {
    const type = document.getElementById('feedbackType').value;
    const message = document.getElementById('feedbackMessage').value.trim();
    const email = document.getElementById('feedbackEmail').value;
    const errorDiv = document.getElementById('feedbackError');
    const successDiv = document.getElementById('feedbackSuccess');
    const submitBtn = document.getElementById('submitFeedbackBtn');
    
    // Hide previous messages
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    
    // Validation
    if (!type) {
        errorDiv.textContent = 'âš ï¸ Please select feedback type';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    if (!message || message.length < 10) {
        errorDiv.textContent = 'âš ï¸ Please provide at least 10 characters of feedback';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'ğŸ“¤ Sending...';
    
    try {
        // Insert feedback into Supabase
        const { error } = await supabase
            .from('feedback')
            .insert([{
                user_id: currentUser.id,
                user_name: currentProfile.name,
                user_email: email,
                feedback_type: type,
                message: message,
                status: 'new'
            }]);
        
        if (error) throw error;
        
        // Show success popup
        showSuccessPopup('We will contact you at <strong>' + email + '</strong> soon.');
        
        // Reset form
        resetHelpForm();
        
        // Close modal and popup after 3 seconds
        setTimeout(() => {
            closeGetHelpModal();
            hideSuccessPopup();
        }, 3000);
        
    } catch (error) {
        errorDiv.textContent = 'âŒ Error submitting feedback: ' + error.message;
        errorDiv.classList.remove('hidden');
    } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“¤ Send Feedback';
    }
}

// Character counter for feedback message
document.addEventListener('DOMContentLoaded', () => {
    const feedbackInput = document.getElementById('feedbackMessage');
    if (feedbackInput) {
        feedbackInput.addEventListener('input', (e) => {
            const counter = document.getElementById('feedbackCounter');
            if (counter) {
                counter.textContent = e.target.value.length;
            }
        });
    }
});

// Close feedback modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('feedbackModal');
    const modalContent = modal?.querySelector('.modal-content');
    
    if (modal && modal.classList.contains('active')) {
        // Check if click is on the modal background (not on modal-content or inside it)
        if (event.target === modal) {
            closeFeedbackModal();
        }
    }
});

// Close feedback modal on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('feedbackModal');
        if (modal && modal.classList.contains('active')) {
            closeFeedbackModal();
        }
    }
});

// ==================== GET HELP MODAL FUNCTIONS ====================

// FAQ Data
const faqData = [
    {
        icon: 'âŒ',
        title: "Can't Login",
        solution: "Make sure your email and password are correct. Password is case-sensitive. If you recently signed up, check if you've verified your email address."
    },
    {
        icon: 'ğŸ“§',
        title: "Email Verification Not Received",
        solution: "Check your spam/junk folder. The verification email is sent from HelpBuddy. If you still don't see it, try signing up again or contact support."
    },
    {
        icon: 'ğŸ”‘',
        title: "Forgot Password",
        solution: "Click on 'Forgot Password?' link on the login page. Enter your registered email to receive password reset instructions."
    },
    {
        icon: 'ğŸŒ',
        title: "Page Loading Slowly",
        solution: "Try refreshing the page (Ctrl+R or Cmd+R). Clear your browser cache and cookies. Check your internet connection. Try using a different browser."
    },
    {
        icon: 'ğŸ“±',
        title: "Account Issues",
        solution: "If your account is locked or suspended, contact support with your registered email. For profile update issues, try logging out and logging back in."
    },
    {
        icon: 'ğŸ”’',
        title: "Email Already Registered",
        solution: "This email is already in use. Try logging in instead. If you forgot your password, use the 'Forgot Password?' option. If someone else used your email, contact support immediately."
    }
];

// Open Get Help Modal
function openGetHelpModal() {
    console.log('ğŸ”µ Opening Get Help modal...');
    
    const modal = document.getElementById('getHelpModal');
    if (!modal) {
        console.error('âŒ Get Help modal not found');
        return;
    }
    
    // Reset to FAQ screen
    showGetHelpFaq();
    
    // Build FAQ list
    buildFaqList();
    
    // Reset form
    resetHelpForm();
    
    // Show modal
    modal.classList.add('active');
    
    console.log('âœ… Get Help modal opened');
}

// Close Get Help Modal
function closeGetHelpModal() {
    const modal = document.getElementById('getHelpModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// Open Get Help Modal for Logged-In Users (with Contact Support visible)
function openGetHelpModalForLoggedInUser() {
    openGetHelpModal();
    
    // Show the Contact Support button for logged-in users
    const contactBtn = document.querySelector('.hidden-for-unregistered');
    if (contactBtn) {
        contactBtn.classList.remove('hidden-for-unregistered');
    }
}

// Open Forgot Password Modal
function openForgotPasswordModal() {
    const modal = document.getElementById('forgotPasswordModal');
    const emailInput = document.getElementById('forgotPasswordEmail');
    const errorDiv = document.getElementById('forgotPasswordError');
    const successDiv = document.getElementById('forgotPasswordSuccess');
    
    // Reset form
    if (emailInput) emailInput.value = '';
    if (errorDiv) errorDiv.classList.add('hidden');
    if (successDiv) successDiv.classList.add('hidden');
    
    // Show modal
    if (modal) {
        modal.classList.add('active');
    }
}

// Close Forgot Password Modal
function closeForgotPasswordModal() {
    const modal = document.getElementById('forgotPasswordModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// Send Password Reset Link
async function sendPasswordResetLink() {
    const emailInput = document.getElementById('forgotPasswordEmail');
    const errorDiv = document.getElementById('forgotPasswordError');
    const successDiv = document.getElementById('forgotPasswordSuccess');
    const submitBtn = document.getElementById('sendResetLinkBtn');
    
    const email = emailInput.value.trim();
    
    // Hide previous messages
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    
    // Validation
    if (!email) {
        errorDiv.textContent = 'âš ï¸ Please enter your email address';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    // Email format validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        errorDiv.textContent = 'âš ï¸ Please enter a valid email address';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Checking...';
    
    try {
        // Send reset link (Supabase handles non-existent emails silently)
submitBtn.textContent = 'Sending...';

const { error: resetError } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: `${window.location.origin}`
});

if (resetError) throw resetError;

// Success message (shown even if email doesn't exist - security feature)
successDiv.textContent = 'âœ… If this email is registered, a password reset link has been sent. Please check your inbox (and spam folder).';
successDiv.classList.remove('hidden');
emailInput.value = '';
        
    } catch (error) {
        errorDiv.textContent = 'âŒ Error: ' + error.message;
        errorDiv.classList.remove('hidden');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“§ Send Reset Link';
    }
}

// Show FAQ Screen
function showGetHelpFaq() {
    document.getElementById('getHelpFaqScreen').classList.remove('hidden');
    document.getElementById('getHelpFormScreen').classList.add('hidden');
}

// Show Contact Support Form
function showContactSupportForm() {
    document.getElementById('getHelpFaqScreen').classList.add('hidden');
    document.getElementById('getHelpFormScreen').classList.remove('hidden');
    
    // Pre-fill email if user is logged in
    const emailInput = document.getElementById('helpEmail');
    if (currentUser && currentProfile) {
        emailInput.value = currentProfile.email || currentUser.email || '';
        emailInput.readOnly = true;
    } else {
        emailInput.value = '';
        emailInput.readOnly = false;
    }
}

// Build FAQ List
function buildFaqList() {
    const container = document.getElementById('faqList');
    if (!container) return;
    
    let html = '';
    faqData.forEach((faq, index) => {
        html += `
            <div class="faq-item" style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #667eea;">
                <div class="faq-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer;" onclick="toggleFaqItem(${index})">
                    <span style="font-size: 24px;">${faq.icon}</span>
                    <strong style="color: #333; flex: 1;">${faq.title}</strong>
                    <span class="faq-chevron" id="faq-chevron-${index}" style="color: #667eea; font-weight: bold;">â–¼</span>
                </div>
                <div class="faq-solution" id="faq-solution-${index}" style="display: none; color: #555; line-height: 1.6; padding-left: 34px; margin-top: 8px;">
                    ${faq.solution}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Toggle FAQ Item
function toggleFaqItem(index) {
    const solution = document.getElementById('faq-solution-' + index);
    const chevron = document.getElementById('faq-chevron-' + index);
    
    if (solution.style.display === 'none') {
        solution.style.display = 'block';
        chevron.textContent = 'â–²';
    } else {
        solution.style.display = 'none';
        chevron.textContent = 'â–¼';
    }
}

// Reset Help Form
function resetHelpForm() {
    const issueType = document.getElementById('helpIssueType');
    const message = document.getElementById('helpMessage');
    const email = document.getElementById('helpEmail');
    const counter = document.getElementById('helpMessageCounter');
    const errorDiv = document.getElementById('helpError');
    const successDiv = document.getElementById('helpSuccess');
    
    if (issueType) issueType.value = '';
    if (message) {
        message.value = '';
        if (counter) counter.textContent = '0';
    }
    if (email) email.value = '';
    if (errorDiv) errorDiv.classList.add('hidden');
    if (successDiv) successDiv.classList.add('hidden');
}

// Character counter for help message
document.addEventListener('DOMContentLoaded', () => {
    const helpMessageInput = document.getElementById('helpMessage');
    if (helpMessageInput) {
        helpMessageInput.addEventListener('input', (e) => {
            const counter = document.getElementById('helpMessageCounter');
            if (counter) {
                counter.textContent = e.target.value.length;
            }
        });
    }
});

// Submit Help Request
async function submitHelpRequest() {
    const issueType = document.getElementById('helpIssueType').value;
    const message = document.getElementById('helpMessage').value.trim();
    const email = document.getElementById('helpEmail').value.trim();
    const errorDiv = document.getElementById('helpError');
    const successDiv = document.getElementById('helpSuccess');
    const submitBtn = document.getElementById('submitHelpBtn');
    
    // Hide previous messages
    if (errorDiv) errorDiv.classList.add('hidden');
    if (successDiv) successDiv.classList.add('hidden');
    
    // Validation
    if (!issueType) {
        if (errorDiv) {
            errorDiv.textContent = 'âš ï¸ Please select an issue type';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    if (!message || message.length < 10) {
        if (errorDiv) {
            errorDiv.textContent = 'âš ï¸ Please describe your problem (at least 10 characters)';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    if (!email) {
        if (errorDiv) {
            errorDiv.textContent = 'âš ï¸ Please provide your email address';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        if (errorDiv) {
            errorDiv.textContent = 'âš ï¸ Please enter a valid email address';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    // Disable button
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ğŸ“¤ Sending...';
    }
    
    try {
        console.log('ğŸ”µ Submitting help request to Supabase...');
        
        // Insert help request into Supabase
        const { error } = await supabase
            .from('login_help_requests')
            .insert([{
                user_email: email,
                issue_type: issueType,
                message: message,
                status: 'new'
            }]);
        
        if (error) {
            console.error('âŒ Supabase error:', error);
            throw error;
        }
        
        console.log('âœ… Help request submitted successfully!');
        
        // Show success popup
        console.log('ğŸ”µ Calling showSuccessPopup...');
        showSuccessPopup('We will contact you at <strong>' + email + '</strong> soon.');
        
        // Reset form
        resetHelpForm();
        
        // Close modal and popup after 3 seconds
        setTimeout(() => {
            console.log('ğŸ”µ Closing modal and popup...');
            closeGetHelpModal();
            hideSuccessPopup();
        }, 3000);
        
    } catch (error) {
        console.error('âŒ Error submitting help request:', error);
        if (errorDiv) {
            errorDiv.textContent = 'âŒ Error submitting request: ' + error.message;
            errorDiv.classList.remove('hidden');
        }
    } finally {
        // Re-enable button
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸ“¤ Send Help Request';
        }
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('getHelpModal');
    const modalContent = modal?.querySelector('.modal-content');
    
    if (modal && modal.classList.contains('active')) {
        if (event.target === modal) {
            closeGetHelpModal();
        }
    }
});

// Close modal on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('getHelpModal');
        if (modal && modal.classList.contains('active')) {
            closeGetHelpModal();
        }
    }
});

// Show Success Popup
function showSuccessPopup(message) {
    const popup = document.getElementById('successPopup');
    const messageEl = document.getElementById('successPopupMessage');
    
    if (messageEl) {
        messageEl.innerHTML = message;
    }
    
    if (popup) {
        popup.classList.add('active');
    }
}

// Hide Success Popup
function hideSuccessPopup() {
    const popup = document.getElementById('successPopup');
    if (popup) {
        popup.classList.remove('active');
    }
}

       // Toggle Send Button based on text input
        function toggleSendButton() {
            const input = document.getElementById('chatMessageInput');
            const sendBtn = document.getElementById('sendBtn');
            const templateBtn = document.getElementById('templateBtn');
            
            if (input.value.trim().length > 0) {
                sendBtn.classList.add('show');
                templateBtn.classList.add('hide');
            } else {
                sendBtn.classList.remove('show');
                templateBtn.classList.remove('hide');
            }
        }

        // Toggle Privacy Notice
        function togglePrivacyNotice() {
            const notice = document.getElementById('privacyNotice');
            notice.classList.toggle('show');
        }

        // Show Attachment Options
        function showAttachmentOptions() {
            document.getElementById('photoInput').click();
        }

// Show Terms & Conditions
function showTerms() {
    console.log('ğŸ”µ Opening Terms & Conditions...');
    
    // Hide all main views first
    hideAllViews();
    
    // âœ… Hide dashboard sections
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    const dashboardHeader = document.getElementById('dashboardHeader');
    const createRequestBtn = document.getElementById('createRequestBtn');
    const userMenu = document.querySelector('.user-menu');
    
    if (seekerSection) seekerSection.style.display = 'none';
    if (providerSection) providerSection.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';
    if (dashboardHeader) dashboardHeader.style.display = 'none';
    if (userMenu) userMenu.style.display = 'none';
    
    // âœ… CRITICAL FIX: Explicitly hide ALL other views
    const loadingView = document.getElementById('loadingView');
    const loginView = document.getElementById('loginView');
    const signupView = document.getElementById('signupView');
    const privacyView = document.getElementById('privacyView');
    const editProfileView = document.getElementById('editProfileView');
    const createRequestView = document.getElementById('createRequestView');
    const chatView = document.getElementById('chatView');
    
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.style.display = 'none';
    }
    if (loginView) {
        loginView.classList.add('hidden');
        loginView.style.display = 'none';
    }
    if (signupView) {
        signupView.classList.add('hidden');
        signupView.style.display = 'none';
    }
    if (privacyView) {
        privacyView.classList.add('hidden');
        privacyView.style.display = 'none';
    }
    if (editProfileView) {
        editProfileView.classList.add('hidden');
        editProfileView.style.display = 'none';
    }
    if (createRequestView) {
        createRequestView.classList.add('hidden');
        createRequestView.style.display = 'none';
    }
    if (chatView) {
        chatView.classList.add('hidden');
        chatView.style.display = 'none';
    }
    
    // Show Terms & Conditions
    const termsView = document.getElementById('termsView');
    if (termsView) {
        termsView.classList.remove('hidden');
        termsView.style.display = 'block';
        termsView.style.visibility = 'visible';
    }
    
    console.log('âœ… Terms & Conditions should now be visible (full-screen)');
}

// Close Terms & Conditions
function closeTermsView() {
    console.log('ğŸ”µ Closing Terms & Conditions...');
    
    const termsView = document.getElementById('termsView');
    if (termsView) {
        termsView.classList.add('hidden');
        termsView.style.display = 'none';
    }
    
    // âœ… CRITICAL FIX: Hide loading view when closing
    const loadingView = document.getElementById('loadingView');
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.style.display = 'none';
    }

const dashboardHeader = document.getElementById('dashboardHeader');
if (dashboardHeader) dashboardHeader.style.display = 'flex';
    
    // Check if user is logged in or not
    if (currentUser && currentProfile) {
        // User is logged in - go back to dashboard
        console.log('âœ… User logged in - showing dashboard');
        showDashboard();
    } else {
        // User not logged in - go back to login
        console.log('âœ… User not logged in - showing login');
        
        // âœ… Explicitly show login view
        const loginView = document.getElementById('loginView');
        if (loginView) {
            loginView.classList.remove('hidden');
            loginView.style.display = 'block';
            loginView.style.visibility = 'visible';
        }
    }
}

// Show Privacy Policy
function showPrivacy() {
    console.log('ğŸ”µ Opening Privacy Policy...');
    
    // Hide all main views first
    hideAllViews();
    
    // âœ… CRITICAL FIX: Explicitly hide ALL other views INCLUDING EDIT PROFILE
    const loadingView = document.getElementById('loadingView');
    const loginView = document.getElementById('loginView');
    const signupView = document.getElementById('signupView');
    const termsView = document.getElementById('termsView');
    const editProfileView = document.getElementById('editProfileView'); // â† ğŸ†• ADDED
    const createRequestView = document.getElementById('createRequestView'); // â† ğŸ†• ADDED
    const chatView = document.getElementById('chatView'); // â† ğŸ†• ADDED
    
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.style.display = 'none';
    }
    if (loginView) {
        loginView.classList.add('hidden');
        loginView.style.display = 'none';
    }
    if (signupView) {
        signupView.classList.add('hidden');
        signupView.style.display = 'none';
    }
    if (termsView) {
        termsView.classList.add('hidden');
        termsView.style.display = 'none';
    }
    // â† ğŸ†• HIDE EDIT PROFILE VIEW
    if (editProfileView) {
        editProfileView.classList.add('hidden');
        editProfileView.style.display = 'none';
    }
    // â† ğŸ†• HIDE CREATE REQUEST VIEW
    if (createRequestView) {
        createRequestView.classList.add('hidden');
        createRequestView.style.display = 'none';
    }
    // â† ğŸ†• HIDE CHAT VIEW
    if (chatView) {
        chatView.classList.add('hidden');
        chatView.style.display = 'none';
    }
    
    // Hide dashboard UI elements (but keep dashboardView container)
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    const dashboardHeader = document.getElementById('dashboardHeader');
    const createRequestBtn = document.getElementById('createRequestBtn');
    const userMenu = document.querySelector('.user-menu');
    const appLogo = document.getElementById('appLogo');
    
    if (seekerSection) seekerSection.style.display = 'none';
    if (providerSection) providerSection.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';
    if (dashboardHeader) dashboardHeader.style.display = 'none';
    if (userMenu) userMenu.style.display = 'none';
    if (appLogo) appLogo.style.display = 'none';
    
    // Keep dashboardView visible (because privacyView is inside it)
    const dashboardView = document.getElementById('dashboardView');
    if (dashboardView) {
        dashboardView.classList.remove('hidden');
        dashboardView.style.display = 'block';
        dashboardView.style.visibility = 'visible';
    }
    
    // Show Privacy Policy
    const privacyView = document.getElementById('privacyView');
    if (privacyView) {
        privacyView.classList.remove('hidden');
        privacyView.style.display = 'block';
        privacyView.style.visibility = 'visible';
    }
    
    console.log('âœ… Privacy Policy should now be visible (full-screen)');
}

// Close Privacy Policy
function closePrivacyView() {
    console.log('ğŸ”µ Closing Privacy Policy...');
    
    const privacyView = document.getElementById('privacyView');
    if (privacyView) {
        privacyView.classList.add('hidden');
        privacyView.style.display = 'none';
    }
    
    // âœ… CRITICAL FIX: Hide loading view when closing
    const loadingView = document.getElementById('loadingView');
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.style.display = 'none';
    }

const dashboardHeader = document.getElementById('dashboardHeader');
if (dashboardHeader) dashboardHeader.style.display = 'flex';
    
    // If user is logged in, restore dashboard
    if (currentUser && currentProfile) {
        console.log('âœ… User logged in - showing dashboard');
        
        // Show dashboard UI elements again
        const seekerSection = document.getElementById('seekerSection');
        const providerSection = document.getElementById('providerSection');
        const createRequestBtn = document.getElementById('createRequestBtn');
        const userMenu = document.querySelector('.user-menu');
        
        if (seekerSection) seekerSection.style.display = 'block';
        if (providerSection && currentProfile.is_provider) providerSection.style.display = 'block';
        if (createRequestBtn) createRequestBtn.style.display = 'block';
        if (userMenu) userMenu.style.display = 'flex';
        
        // Show dashboard (which will handle the rest)
        showDashboard();
    } else {
        // If not logged in, go to login
        console.log('âœ… User not logged in - showing login');
        
        // âœ… Explicitly show login view
        const loginView = document.getElementById('loginView');
        if (loginView) {
            loginView.classList.remove('hidden');
            loginView.style.display = 'block';
            loginView.style.visibility = 'visible';
        }
    }
}

// Load Provider's Open Requests (Negotiating)
async function loadProviderOpenRequests() {
    try {
        const { data: responses, error: respError } = await supabase
            .from('request_responses')
            .select('*')
            .eq('provider_id', currentProfile.user_id)
            .order('created_at', { ascending: false });
        
        if (respError) throw respError;
        
        if (!responses || responses.length === 0) {
            document.getElementById('providerOpenRequestsList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <div class="empty-state-text">No open requests yet</div>
                </div>
            `;
            document.getElementById('providerOpenRequestsTotal').textContent = '0';
            return;
        }
        
        const requestIds = responses.map(r => r.request_id);
        const { data: requests, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .in('id', requestIds);
        
        if (reqError) throw reqError;
        
        // Filter only OPEN status (negotiating)
        const openRequests = requests.filter(r => r.status === 'open');
        
        document.getElementById('providerOpenRequestsTotal').textContent = openRequests.length;
        
        if (openRequests.length === 0) {
            document.getElementById('providerOpenRequestsList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <div class="empty-state-text">No open requests yet</div>
                </div>
            `;
            return;
        }
        
        // Get seeker profiles and chat info
        const userIds = openRequests.map(r => r.user_id);
        const { data: seekers } = await supabase
            .from('profiles')
            .select('user_id, name')
            .in('user_id', userIds);

        const combinedData = responses
            .filter(response => openRequests.find(r => r.id === response.request_id))
            .map(response => {
                const request = openRequests.find(r => r.id === response.request_id);
                const seeker = seekers?.find(s => s.user_id === request.user_id);
                return {
                    ...response,
                    request: request,
                    seekerName: seeker?.name || 'Unknown',
                    unreadCount: 0
                };
            });

        await displayProviderOpenRequests(combinedData);
        
    } catch (error) {
        console.error('Error loading provider open requests:', error);
    }
}

</script>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal" style="display: none; position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 999999 !important; pointer-events: none !important;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">ğŸ’¬ Send Feedback</h2>
            <button class="close-btn" onclick="closeFeedbackModal()">Ã—</button>
        </div>
        <div style="padding: 20px;">
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                Help us improve HelpBuddy! Share your suggestions, report bugs, or request new features. 
                Your feedback helps us serve you better.
            </p>
            
            <div class="form-group">
                <label>Feedback Type <span class="required">*</span></label>
                <select id="feedbackType" required>
                    <option value="">Select Type</option>
                    <option value="bug">ğŸ› Bug Report</option>
                    <option value="feature">âœ¨ Feature Request</option>
                    <option value="improvement">ğŸ”§ Improvement Suggestion</option>
                    <option value="complaint">ğŸ˜ Complaint</option>
                    <option value="praise">ğŸ‰ Appreciation</option>
                    <option value="other">ğŸ’­ Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Your Feedback <span class="required">*</span></label>
                <textarea id="feedbackMessage" rows="6" maxlength="1000" required placeholder="Please describe your feedback in detail. Be specific so we can help you better."></textarea>
                <div class="char-counter"><span id="feedbackCounter">0</span>/1000</div>
            </div>
            
            <div class="form-group">
                <label>Your Email</label>
                <input type="email" id="feedbackEmail" placeholder="We'll reach out if we need more details" readonly>
                <small style="color: #999; font-size: 12px;">Using your registered email</small>
            </div>
            
            <div id="feedbackError" class="error hidden"></div>
            <div id="feedbackSuccess" class="success hidden"></div>
            
            <button class="btn btn-full" onclick="submitFeedback()" id="submitFeedbackBtn">
                ğŸ“¤ Send Feedback
            </button>
        </div>
    </div>
</div>

<!-- Get Help Modal -->
<div id="getHelpModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">â“ Get Help</h2>
            <button class="close-btn" onclick="closeGetHelpModal()" style="color: #dc3545;">Ã—</button>
        </div>
        
        <!-- FAQ Screen (shown by default) -->
        <div id="getHelpFaqScreen" style="padding: 20px;">
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                Find answers to common problems below. If you don't find what you're looking for, you can contact our support team.
            </p>
            
            <div id="faqList">
                <!-- FAQ items will be inserted here by JavaScript -->
            </div>
            
            <button class="btn btn-full hidden-for-unregistered" onclick="showContactSupportForm()" style="margin-top: 20px;">
                ğŸ“§ Still need help? Contact Support
            </button>
        </div>
        
        <!-- Contact Support Form (hidden by default) -->
        <div id="getHelpFormScreen" class="hidden" style="padding: 20px;">
            <button class="btn btn-secondary" onclick="showGetHelpFaq()" style="margin-bottom: 20px;">
                â† Back to FAQ
            </button>
            
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                Describe your problem below and we'll get back to you as soon as possible.
            </p>
            
            <div class="form-group">
                <label>Issue Type <span class="required">*</span></label>
                <select id="helpIssueType" required>
                    <option value="">Select Issue Type</option>
                    <option value="cant_login">âŒ Can't Login</option>
                    <option value="email_verification">ğŸ“§ Email Verification Not Received</option>
                    <option value="forgot_password">ğŸ”‘ Forgot Password</option>
                    <option value="page_loading">ğŸŒ Page Loading Slowly</option>
                    <option value="account_issues">ğŸ“± Account Issues</option>
                    <option value="email_registered">ğŸ”’ Email Already Registered</option>
                    <option value="other">ğŸ’­ Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Describe Your Problem <span class="required">*</span></label>
                <textarea id="helpMessage" rows="6" maxlength="1000" required placeholder="Please describe your problem in detail..."></textarea>
                <div class="char-counter"><span id="helpMessageCounter">0</span>/1000</div>
            </div>
            
            <div class="form-group">
                <label>Your Email <span class="required">*</span></label>
                <input type="email" id="helpEmail" required placeholder="your.email@example.com">
            </div>
            
            <div id="helpError" class="error hidden"></div>
            <div id="helpSuccess" class="success hidden"></div>
            
            <button class="btn btn-full" onclick="submitHelpRequest()" id="submitHelpBtn">
                ğŸ“¤ Send Help Request
            </button>
        </div>
    </div>
</div>

<!-- Success Popup -->
<div id="successPopup" class="success-popup-overlay">
    <div class="success-popup-content">
        <div class="success-popup-icon">âœ…</div>
        <div class="success-popup-title">Request Sent Successfully!</div>
        <div class="success-popup-message" id="successPopupMessage">
            We've received your help request and will contact you soon.
        </div>
    </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">ğŸ”‘ Reset Password</h2>
            <button class="close-btn" onclick="closeForgotPasswordModal()">Ã—</button>
        </div>
        <div style="padding: 20px;">
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                Enter your registered email address and we'll send you a link to reset your password.
            </p>
            
            <div class="form-group">
                <label>Email Address <span class="required">*</span></label>
                <input type="email" id="forgotPasswordEmail" required placeholder="your.email@example.com" autocomplete="email">
            </div>
            
            <div id="forgotPasswordError" class="error hidden"></div>
            <div id="forgotPasswordSuccess" class="success hidden"></div>
            
            <button class="btn btn-full" onclick="sendPasswordResetLink()" id="sendResetLinkBtn">
                ğŸ“§ Send Reset Link
            </button>
            
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="closeForgotPasswordModal(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px;">â† Back to Login</a>
            </div>
        </div>
    </div>
</div>

</body>
</html>