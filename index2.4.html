<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelpBuddy - Service Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 40px; max-width: 1200px; margin: 0 auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-container { display: flex; align-items: center; gap: 10px; font-size: 28px; font-weight: 700; color: #667eea; }
        .user-menu { position: relative; }
        .user-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .user-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 10px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); min-width: 180px; display: none; z-index: 1000; overflow: hidden; }
        .user-dropdown.active { display: block; animation: dropdownSlide 0.2s ease-out; }
        
        @media (max-width: 480px) {
            .dashboard-header { margin-bottom: 15px; padding-bottom: 12px; }
            .header-left { gap: 10px; }
            .logo-container { font-size: 22px; }
            .user-button { padding: 8px 12px; font-size: 12px; }
            .user-dropdown { min-width: 160px; }
        }
        @keyframes dropdownSlide { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-item { padding: 12px 20px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; color: #333; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f8f9fa; color: #667eea; }
	h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        h2 { color: #333; margin-bottom: 20px; font-size: 1.5em; }
        h3 { color: #667eea; margin: 20px 0 15px; font-size: 1.2em; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; font-family: inherit; }
        textarea { resize: vertical; min-height: 100px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { padding: 14px 24px; background: #128C7E; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn:hover { background: #0d6b5f; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(18, 140, 126, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; background: #95a5a6; }
        .btn-full { width: 100%; }
        .btn-secondary { background: #34495e; margin-left: 10px; }
        .btn-respond { background: #128C7E; padding: 8px 16px; font-size: 14px; }
        .btn-select { background: #128C7E; padding: 8px 16px; font-size: 14px; }
        .btn-view-profile { background: #34495e; padding: 8px 16px; font-size: 14px; }
        .btn-cancel { background: #e74c3c; padding: 8px 16px; font-size: 14px; }
        .btn-edit { background: #34495e; padding: 8px 16px; font-size: 14px; color: white; }
        .btn-chat { background: #128C7E; padding: 8px 16px; font-size: 14px; }
        /* Chat button with unread badge */
.chat-btn-wrapper {
    position: relative;
    display: inline-block;
}

.chat-unread-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 18px;
    height: 18px;
    background: #dc3545;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: white;
    padding: 0 5px;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.5);
    border: 2px solid white;
    z-index: 10;
}
	.btn-complete { background: #27ae60; padding: 10px 20px; font-size: 14px; }
        .btn-contact { background: #34495e; padding: 10px 20px; font-size: 14px; }
        
        @media (max-width: 480px) {
            .btn { padding: 10px 16px; font-size: 13px; border-radius: 6px; }
            .btn-full { width: 100%; margin-top: 10px; }
            .btn-secondary { margin-left: 0; margin-top: 8px; width: 100%; }
            .btn-respond, .btn-select, .btn-view-profile, .btn-cancel, .btn-edit, .btn-chat { padding: 6px 10px; font-size: 11px; }
            .btn-complete, .btn-contact { padding: 8px 14px; font-size: 12px; }
        }
        .error { background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .success { background: #efe; border: 1px solid #cfc; color: #3c3; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .info { background: #e3f2fd; border: 1px solid #90caf9; color: #1976d2; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .hidden { display: none; }
        .profile-info { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
        .profile-info p { margin-bottom: 10px; color: #555; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input { width: auto; }
        .required { color: #e74c3c; }
        .char-counter { font-size: 12px; color: #999; text-align: right; margin-top: 5px; }
        .urgency-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .urgency-option { flex: 1; min-width: 150px; }
        .urgency-option input[type="radio"] { display: none; }
        .urgency-label { display: block; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .urgency-option input[type="radio"]:checked + .urgency-label { border-color: #667eea; background: #f0f4ff; font-weight: 600; }
        .urgency-label:hover { border-color: #667eea; }
        .request-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .request-card:hover { box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-color: #667eea; transform: translateY(-2px); }
        .request-card.compact { 
    padding: 18px 20px; 
    margin-bottom: 24px; 
    background: #ffffff; 
    border: 3px solid #d0d0d0; 
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}
.request-card.compact:last-child { margin-bottom: 0; }
        .request-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .request-card-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .request-card-left { flex: 1; min-width: 200px; }
        .request-card-right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        
        @media (max-width: 480px) {
            .request-card.compact { 
                padding: 12px 14px; 
                margin-bottom: 16px; 
                border: 2px solid #d0d0d0;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            .request-card-main { flex-direction: column; align-items: flex-start; gap: 8px; }
            .request-card-left { min-width: 100%; }
            .request-card-right { width: 100%; justify-content: space-between; gap: 6px; }
        }
        .request-title-compact { 
    font-size: 16px; 
    font-weight: 600; 
    color: #667eea; /* 👈 CHANGED: Purple theme color */
    margin-bottom: 8px; 
    line-height: 1.3;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: -8px -12px 8px -12px;
}

.request-title-compact:hover {
    background: rgba(102, 126, 234, 0.1); /* 👈 CHANGED: Stronger purple background */
    color: #5568d3; /* 👈 NEW: Darker purple on hover */
}

.request-title-compact:hover {
    background: rgba(102, 126, 234, 0.05);
}

.request-title-text {
    flex: 1;
}

.request-chevron {
    font-size: 14px;
    transition: transform 0.3s ease;
    color: #667eea;
    font-weight: bold;
}

.request-chevron.expanded {
    transform: rotate(180deg);
}
        /* Urgency bubble indicator */
.urgency-bubble {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    flex-shrink: 0;
}

.urgency-bubble.urgent {
    background: #dc3545;
}

.urgency-bubble.normal {
    background: #ffc107;
}

.urgency-bubble.low {
    background: #28a745;
}

/* Clickable request title */
.request-title-clickable {
    color: #667eea;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
}

.request-title-clickable:hover {
    color: #5568d3;
    text-decoration: underline;
}
	.request-summary { font-size: 13px; color: #666; line-height: 1.4; }
        .request-details { margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0; display: none; }
        .request-details.expanded { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .expand-btn { background: none; border: none; color: #667eea; font-size: 12px; font-weight: 600; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .expand-btn:hover { background: #f0f4ff; }
        .notification-badge { background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .urgent-indicator { background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
        .info-badge { background: #17a2b8; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .action-btn-compact { padding: 8px 14px; font-size: 13px; border-radius: 6px; font-weight: 600; }
        .section-summary { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
        .stat-badge { background: #f0f4ff; color: #667eea; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; border: 1px solid #d0d9ff; }
        .request-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .request-meta { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .meta-item { font-size: 13px; color: #666; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-open { background: #d4edda; color: #155724; }
        .status-in-progress { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .urgency-urgent { color: #dc3545; font-weight: 600; }
        .urgency-normal { color: #ffc107; font-weight: 600; }
        .urgency-low { color: #28a745; font-weight: 600; }
        .request-description { color: #555; margin-bottom: 15px; line-height: 1.5; }
        .request-location { font-size: 14px; color: #666; margin-bottom: 15px; }
        .request-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .response-badge { display: inline-block; background: #007bff; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 10px; }
        .distance-badge { display: inline-block; background: #17a2b8; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-state-text { font-size: 18px; margin-bottom: 30px; }
        .request-limit-warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 500; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .collapsible-section { margin-bottom: 25px; }
        .section-toggle { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; padding: 18px 24px; width: 100%; text-align: left; cursor: pointer; font-size: 16px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .section-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4); }
        .section-toggle:active { transform: translateY(0); }
        .section-toggle-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .section-toggle-right { 
    display: flex; 
    align-items: center; 
    gap: 8px;
    flex-wrap: nowrap;
    justify-content: flex-end;
}
        .toggle-icon { font-size: 20px; transition: transform 0.3s; }
        .toggle-icon.expanded { transform: rotate(180deg); }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .section-content.expanded { max-height: 5000px; transition: max-height 0.5s ease-in; }
        .section-inner { padding: 20px 0 0 0; }
        .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .sub-tab { 
    background: white; 
    border: 2px solid #e0e0e0; 
    color: #666; 
    padding: 10px 14px; 
    border-radius: 10px; 
    cursor: pointer; 
    font-weight: 600; 
    font-size: 13px; 
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex: 1;
    min-width: 0;
    position: relative;
    justify-content: center;
}

.sub-tab > span:first-child {
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    text-align: center;
}

/* Badge row container - holds count + message badges side by side */
.sub-tab-badges {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-wrap: nowrap;
}

.sub-tab .count-badge {
    margin-top: 0;
}

.sub-tab .badge-container {
    margin-top: 0;
}

.sub-tab:hover { 
    border-color: #4285F4; 
    color: #4285F4; 
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
}

.sub-tab.active { 
    background: #4285F4; 
    border-color: #4285F4; 
    color: white;
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
}

.sub-tab.active .count-badge {
    background: rgba(255, 255, 255, 0.3);
    color: white;
}
        .section-toggle { 
    background: linear-gradient(135deg, #4285F4 0%, #34A853 100%); 
    color: white; 
    border: none; 
    border-radius: 12px; 
    padding: 18px 24px; 
    width: 100%; 
    text-align: left; 
    cursor: pointer; 
    font-size: 16px; 
    font-weight: 700; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    transition: all 0.3s; 
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); 
}

.section-toggle:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 6px 16px rgba(66, 133, 244, 0.4); 
}

.count-badge { 
    background: #4285F4; 
    color: white; 
    padding: 4px 10px; 
    border-radius: 12px; 
    font-size: 11px; 
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    text-align: center;
    flex-shrink: 0;
}

.sub-tab .count-badge {
    background: rgba(66, 133, 244, 0.15);
    color: #4285F4;
}

.sub-tab.active .count-badge {
    background: rgba(255, 255, 255, 0.3);
    color: white;
}

/* Chat Bubble Badge Container */
.badge-container {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: relative;
    flex-shrink: 0;
}

/* The Chat Bubble Icon */
.chat-bubble-icon {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    border-radius: 50% 50% 50% 0;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);
    flex-shrink: 0;
    transform: rotate(-45deg);
}

/* White dots inside bubble (optional decorative element) */
.chat-bubble-icon::before {
    content: '💬';
    position: absolute;
    font-size: 16px;
    transform: rotate(45deg);
    filter: brightness(0) invert(1);
}

/* Red Badge (number circle) */
.unread-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 18px;
    height: 18px;
    background: #dc3545;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: white;
    padding: 0 5px;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.5);
    border: 2px solid white;
    z-index: 10;
}
	.two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification-count { background: #dc3545; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .autocomplete-suggestions { position: absolute; background: white; border: 2px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: calc(100% - 4px); margin-top: -2px; }
        .autocomplete-suggestions.active { display: block; }
        .suggestion-item { padding: 12px 15px; cursor: pointer; transition: background 0.2s; font-size: 14px; color: #333; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: #f0f4ff; color: #667eea; }
        .suggestion-item.loading { text-align: center; color: #999; font-style: italic; }
	.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 24px; font-weight: 600; color: #333; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .close-btn:hover { color: #333; }
        .provider-card { background: #f5f5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .provider-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .provider-info { font-size: 13px; color: #666; margin-bottom: 8px; }
        .rating-display { font-size: 14px; color: #667eea; font-weight: 600; margin-bottom: 12px; }
        .provider-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .profile-modal-content { background: white; border-radius: 12px; padding: 20px; }
        .profile-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .profile-details { color: #555; line-height: 1.8; }
        .profile-details p { margin-bottom: 10px; }
        /* Chat Styles */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 100px); max-height: 700px; background: #ECE5DD; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .chat-header { background: #128C7E; color: white; padding: 16px 20px; border-radius: 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-header-left { flex: 1; display: flex; flex-direction: column; }
        .chat-partner-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; letter-spacing: 0; }
        .chat-status { font-size: 13px; opacity: 0.9; font-weight: 400; }
        
        @media (max-width: 480px) {
            .chat-container { border-radius: 0; height: calc(100vh - 80px); }
            .chat-header { padding: 12px 16px; }
            .chat-partner-name { font-size: 16px; margin-bottom: 3px; }
            .chat-status { font-size: 12px; }
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px 12px; background: #ECE5DD; display: flex; flex-direction: column; gap: 8px; }
        .message { display: flex; flex-direction: column; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { align-items: flex-end; }
        .message.received { align-items: flex-start; }
        .message-bubble { max-width: 65%; padding: 14px 18px; border-radius: 18px; word-wrap: break-word; line-height: 1.4; font-size: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
        .message.sent .message-bubble { background: #DCF8C6; color: #000; border-radius: 8px 8px 0 8px; font-weight: 400; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); border: none; }
        .message.received .message-bubble { background: #FFFFFF; color: #000; border: none; border-radius: 8px 8px 8px 0; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .message-time { font-size: 12px; color: #999; margin-top: 6px; padding: 0 6px; }
        .message-image { max-width: 100%; max-height: 280px; border-radius: 12px; margin-top: 10px; cursor: pointer; transition: transform 0.2s; }
        .message-image:hover { transform: scale(1.02); }
        .empty-chat-state { display: flex; align-items: center; justify-content: center; height: 100%; color: #999; text-align: center; padding: 20px; }
        .empty-chat-state-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-chat-state-text { font-size: 16px; color: #666; }
        
        .chat-templates { background: #f0f2f5; padding: 16px; border-top: 2px solid #e8e8e8; max-height: 220px; overflow-y: auto; }
        .template-category { margin-bottom: 12px; }
        .template-category:last-child { margin-bottom: 0; }
        .template-category-title { font-weight: 700; color: #667eea; font-size: 13px; cursor: pointer; user-select: none; padding: 10px 12px; background: white; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #667eea; }
        .template-category-title:hover { background: #e9ecef; transform: translateX(2px); }
        .template-items { margin-top: 8px; margin-left: 0; display: none; padding: 0 8px; }
        .template-items.open { display: flex; flex-direction: column; gap: 6px; animation: expandDown 0.2s ease-out; }
        @keyframes expandDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .template-item { padding: 10px 14px; background: white; border-radius: 8px; margin-bottom: 0; font-size: 13px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; color: #555; font-weight: 500; line-height: 1.3; }
        .template-item:hover { background: #667eea; color: white; border-left-color: #764ba2; transform: translateX(4px); box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2); }
        
        .chat-input-area { background: #F0F0F0; padding: 12px 16px; border-top: 1px solid #ddd; border-radius: 0; }
        .privacy-notice { background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); padding: 14px 16px; border-radius: 10px; font-size: 13px; color: #7d5d00; margin-bottom: 16px; border-left: 4px solid #ffc107; display: none; gap: 10px; align-items: flex-start; }
.privacy-notice.show { display: flex; }
.privacy-notice strong { color: #5d4700; font-weight: 700; }
.privacy-info-icon { 
    width: 20px; 
    height: 20px; 
    border-radius: 50%; 
    background: #667eea; 
    color: white; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: 700; 
    font-size: 14px; 
    cursor: pointer; 
    margin-left: 8px; 
    transition: all 0.2s;
}
.privacy-info-icon:hover { background: #764ba2; transform: scale(1.1); }
.chat-action-buttons { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .chat-action-buttons .btn { padding: 10px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; transition: all 0.2s; }
        .contact-request-card { background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); padding: 16px; border-radius: 12px; margin: 10px 0; border-left: 4px solid #ffc107; }
.contact-request-title { font-weight: 700; color: #5d4700; margin-bottom: 10px; font-size: 14px; }
.contact-approval-buttons { display: flex; gap: 10px; margin-top: 12px; }
.btn-approve { background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
.btn-approve:hover { background: #218838; }
.btn-decline { background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
.btn-decline:hover { background: #c82333; }
.contact-status-approved { background: #d4edda; border-left-color: #28a745; color: #155724; }
.contact-status-declined { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
.contact-details-card { background: #e3f2fd; padding: 14px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #2196f3; }
.contact-details-card p { margin: 6px 0; font-size: 13px; color: #0d47a1; }
	.contact-details-card p { margin: 6px 0; font-size: 13px; color: #0d47a1; }

.contact-icon-btn {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    margin: 15px 10px;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    width: calc(100% - 20px);
    justify-content: center;
}
.contact-icon-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
}
.contact-details-card.collapsed {
    display: none;
}
	.chat-input-wrapper { display: flex; gap: 8px; align-items: center; }
        .chat-input-wrapper textarea { flex: 1; min-height: 42px; max-height: 120px; padding: 10px 14px; border: none; border-radius: 21px; font-family: inherit; font-size: 15px; resize: none; background: white; transition: all 0.2s; }
        .chat-input-wrapper textarea:focus { outline: none; box-shadow: 0 0 2px rgba(0, 0, 0, 0.1); }
        .chat-input-wrapper .btn { padding: 12px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; }
.file-input-label { background: #6c757d; color: white; padding: 11px 13px; border-radius: 8px; cursor: pointer; font-size: 18px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 48px; }
.file-input-label:hover { background: #5a6268; transform: scale(1.05); }
.plus-button { background: #6c757d; color: white; padding: 11px 13px; border-radius: 8px; cursor: pointer; font-size: 20px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 48px; border: none; }
.plus-button:hover { background: #5a6268; transform: scale(1.05); }
.template-button { display: inline-flex; }
.template-button.hide { display: none; }
.btn-send { display: none; padding: 12px; min-width: 48px; background: #128C7E; border-radius: 50%; }
.btn-send.show { display: inline-flex; align-items: center; justify-content: center; }
.btn-send:hover { background: #0d6b5f; }
        
        /* Warranty Form */
        .warranty-form { background: linear-gradient(135deg, #f0f4ff 0%, #f8f9fa 100%); padding: 18px; border-radius: 12px; margin-top: 16px; border: 2px solid #e8ecff; }
        .warranty-form h3 { margin-top: 0; margin-bottom: 16px; color: #333; font-size: 15px; font-weight: 700; }
        .warranty-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .warranty-option { flex: 1; min-width: 110px; }
        .warranty-option input[type="radio"] { display: none; }
        .warranty-option label { display: block; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 600; font-size: 13px; color: #555; }
        .warranty-option input[type="radio"]:checked + label { border-color: #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #e9ecff 100%); color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .warranty-form .btn { margin-top: 16px; font-size: 14px; }
        
/* Template Modal Styles */
        .template-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center; }
        .template-modal.active { display: flex; }
        .template-modal-content { background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; max-height: 70vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .template-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .template-modal-title { font-size: 20px; font-weight: 700; color: #333; }
        .template-close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; transition: color 0.2s; }
        .template-close-btn:hover { color: #333; }
        .template-categories { display: flex; flex-direction: column; gap: 16px; }
        .template-category-block { border: 1.5px solid #e8e8e8; border-radius: 12px; overflow: hidden; }
        .template-category-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 16px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; user-select: none; }
        .template-category-header:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .template-category-items { display: none; background: #f9f9f9; }
        .template-category-items.open { display: flex; flex-direction: column; }
        .template-option { padding: 12px 16px; border-bottom: 1px solid #e8e8e8; cursor: pointer; transition: all 0.2s; font-size: 13px; color: #555; line-height: 1.4; }
        .template-option:last-child { border-bottom: none; }
        .template-option:hover { background: #e9ecef; color: #333; padding-left: 20px; }
        .template-button { background: #667eea; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 18px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 44px; height: 44px; }
        .template-button:hover { background: #764ba2; transform: scale(1.05); }

/* Rating Modal Styles */
        .rating-stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .star { font-size: 48px; cursor: pointer; transition: all 0.2s; color: #ddd; user-select: none; }
        .star:hover { transform: scale(1.2); }
        .star.selected { color: #ffc107; }
        .star.hovered { color: #ffc107; }

        /* Mobile Responsive */
        @media (max-width: 768px) { 
            body { padding: 0; background: white; }
            .container { border-radius: 0; padding: 12px; box-shadow: none; }
            h1 { font-size: 1.8em; display: block; margin-bottom: 20px; }
            .logo-container { font-size: 18px; }
            .dashboard-header { margin-bottom: 20px; padding-bottom: 15px; }
            .user-button { padding: 8px 16px; font-size: 13px; }
            .row { grid-template-columns: 1fr; } 
            .two-column { grid-template-columns: 1fr; gap: 20px; }
            .section-toggle { padding: 14px 16px; font-size: 14px; border-radius: 8px; }
            .count-badge { font-size: 11px; padding: 3px 8px; }
            .request-card.compact { padding: 14px 16px; margin-bottom: 12px; }
            .request-title-compact { font-size: 15px; }
            .request-summary { font-size: 12px; }
            .request-card-right { width: 100%; justify-content: flex-start; margin-top: 10px; }
            .btn { padding: 11px 20px; font-size: 14px; }
            .action-btn-compact { padding: 8px 12px; font-size: 12px; }
            .btn-secondary { margin-left: 0; margin-top: 10px; }
            .request-actions { flex-direction: column; }
            .urgency-group { flex-direction: column; gap: 10px; }
            .urgency-option { min-width: 100%; }
            .urgency-label { padding: 14px; font-size: 14px; }
            .sub-tabs { gap: 8px; }
            .sub-tab { padding: 8px 14px; font-size: 13px; }
            .modal-content { max-width: 95%; padding: 20px; border-radius: 12px; }
            .modal-title { font-size: 18px; }
            .chat-container { height: calc(100vh - 60px); max-height: none; border-radius: 0; }
            .chat-header { padding: 14px 16px; }
            .chat-partner-name { font-size: 16px; }
            .chat-status { font-size: 12px; }
            .chat-messages { padding: 16px 12px; gap: 8px; }
            .message-bubble { max-width: 80%; padding: 10px 14px; font-size: 14px; }
            .chat-input-area { padding: 12px; }
            .chat-input-wrapper { gap: 8px; }
            .chat-input-wrapper textarea { min-height: 44px; font-size: 14px; padding: 10px 12px; }
            .chat-input-wrapper .btn { padding: 11px 20px; font-size: 14px; }
            .file-input-label { min-width: 44px; padding: 11px; }
            .template-button { min-width: 44px; height: 44px; }
            .privacy-notice { padding: 10px 12px; font-size: 12px; margin-bottom: 12px; }
            .contact-request-card { padding: 12px; font-size: 12px; }
            .contact-approval-buttons { flex-direction: column; }
            .btn-approve, .btn-decline { width: 100%; }
            .warranty-options { flex-direction: column; }
            .warranty-option { min-width: 100%; }
            .provider-card { padding: 14px; }
            .provider-actions { flex-direction: column; }
            .provider-actions .btn { width: 100%; }
            .star { font-size: 40px; }
		/* MY RESPONSES - Chat button fixed on right (mobile only) */
    #myResponsesList .request-card {
        padding: 16px !important;
    }
    
    #myResponsesList .request-card-main {
        display: grid !important;
        grid-template-columns: 1fr auto !important;
        gap: 16px !important;
        align-items: start !important;
    }
    
    #myResponsesList .request-card-left {
        min-width: 0 !important;
        overflow: hidden !important;
    }
    
    #myResponsesList .request-summary {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
    }
    
    #myResponsesList .request-card-right {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 100% !important;
    }
    
    #myResponsesList .chat-btn-wrapper {
        display: flex !important;
        align-items: center !important;
    }
    
    #myResponsesList .btn-chat {
        margin: 0 !important;
        padding: 10px 16px !important;
        white-space: nowrap !important;
        font-size: 14px !important;
    }
		/* Dashboard logo mobile size */
		.mobile-section-header {
        display: block !important;
    }	
    #dashboardView > div:first-child { padding: 10px 0 8px 0 !important; margin-bottom: 12px !important; }
}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="appLogo">🤝 HelpBuddy</h1>
        
       <!-- Login View -->
<div id="loginView" class="hidden">
    <h2>Welcome Back</h2>
    <div id="loginError" class="error hidden"></div>
    <form id="loginForm">
        <div class="form-group">
            <label>Email <span class="required">*</span></label>
            <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
            <label>Password <span class="required">*</span></label>
            <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-full">Login</button>
        <div style="text-align: center; margin-top: 20px; font-size: 14px;">
            <a href="#" onclick="showSignup(); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">Sign up for new user registration</a>
            <span style="margin: 0 10px; color: #ccc;">|</span>
            <a href="#" onclick="alert('Password reset feature coming soon!'); return false;" style="color: #667eea; text-decoration: none; font-weight: 500;">Forgot Password?</a>
        </div>
    </form>
</div>

        <!-- Signup View -->
<div id="signupView" class="hidden">
    <h2>Create Account</h2>    
            <div id="signupError" class="error hidden"></div>
            <div id="signupInfo" class="info hidden"></div>
            <form id="signupForm">
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" id="signupName" required>
                </div>
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
    <label>Phone Number <span class="required">*</span></label>
    <input type="tel" id="signupPhone" pattern="[0-9]{10}" required 
           oninput="validatePhoneInput(this)" title="Enter correct number">
    <div id="signupPhoneError" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;">Enter correct number</div>
</div>
                <div class="form-group">
                    <label>Password <span class="required">*</span></label>
                    <input type="password" id="signupPassword" minlength="6" required>
                </div>
                <h3>📍 Address Details</h3>
                <div class="form-group">
                    <label>House Number</label>
                    <input type="text" id="houseNumber">
                </div>
                <div class="form-group">
                    <label>Area Name <span class="required">*</span></label>
                    <input type="text" id="areaName" required>
                </div>
                <div class="form-group">
                    <label>Landmark</label>
                    <input type="text" id="landmark">
                </div>
                <div class="row">
                    <div class="form-group">
    <label>City <span class="required">*</span></label>
    <input type="text" id="city" placeholder="Type your city name..." required autocomplete="off">
    <div id="citySuggestions" class="autocomplete-suggestions"></div>
</div>
                    <div class="form-group">
    <label>State <span class="required">*</span></label>
    <select id="state" required>
        <option value="">Select State/Union Territory</option>
        <option value="Andhra Pradesh">Andhra Pradesh</option>
        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
        <option value="Assam">Assam</option>
        <option value="Bihar">Bihar</option>
        <option value="Chhattisgarh">Chhattisgarh</option>
        <option value="Goa">Goa</option>
        <option value="Gujarat">Gujarat</option>
        <option value="Haryana">Haryana</option>
        <option value="Himachal Pradesh">Himachal Pradesh</option>
        <option value="Jharkhand">Jharkhand</option>
        <option value="Karnataka">Karnataka</option>
        <option value="Kerala">Kerala</option>
        <option value="Madhya Pradesh">Madhya Pradesh</option>
        <option value="Maharashtra">Maharashtra</option>
        <option value="Manipur">Manipur</option>
        <option value="Meghalaya">Meghalaya</option>
        <option value="Mizoram">Mizoram</option>
        <option value="Nagaland">Nagaland</option>
        <option value="Odisha">Odisha</option>
        <option value="Punjab">Punjab</option>
        <option value="Rajasthan">Rajasthan</option>
        <option value="Sikkim">Sikkim</option>
        <option value="Tamil Nadu">Tamil Nadu</option>
        <option value="Telangana">Telangana</option>
        <option value="Tripura">Tripura</option>
        <option value="Uttar Pradesh">Uttar Pradesh</option>
        <option value="Uttarakhand">Uttarakhand</option>
        <option value="West Bengal">West Bengal</option>
        <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
        <option value="Chandigarh">Chandigarh</option>
        <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
        <option value="National Capital Territory of Delhi">National Capital Territory of Delhi</option>
        <option value="Jammu and Kashmir">Jammu and Kashmir</option>
        <option value="Ladakh">Ladakh</option>
        <option value="Lakshadweep">Lakshadweep</option>
        <option value="Puducherry">Puducherry</option>
    </select>
</div>
                </div>
                <div class="form-group">
                    <label>PIN Code <span class="required">*</span></label>
                    <input type="text" id="pinCode" pattern="[0-9]{6}" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="isProvider" onchange="toggleProviderFieldsSignup()">
                    <label for="isProvider" style="margin: 0;">I want to provide services</label>
                </div>
                
                <div id="signupProviderFields" class="hidden">
                    <h3>🔧 Provider Settings</h3>
                    <div class="form-group">
                        <label>Service Radius <span class="required">*</span></label>
                        <select id="signupRadius">
                            <option value="2">2 km</option>
                            <option value="5">5 km</option>
                            <option value="10" selected>10 km</option>
                            <option value="15">15 km</option>
                            <option value="20">20 km</option>
                            <option value="30">30 km</option>
                            <option value="50">50 km</option>
                        </select>
                    </div>
                       
                    <div class="form-group">
                        <label>Services I Provide <span class="required">*</span></label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_electrician" value="electrician">
                                <label for="service_electrician" style="margin: 0;">🔧 Electrician</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_plumber" value="plumber">
                                <label for="service_plumber" style="margin: 0;">🚰 Plumber</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_ac_repair" value="ac_repair">
                                <label for="service_ac_repair" style="margin: 0;">❄️ AC Repair</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_carpenter" value="carpenter">
                                <label for="service_carpenter" style="margin: 0;">🔨 Carpenter</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_painter" value="painter">
                                <label for="service_painter" style="margin: 0;">🎨 Painter</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="service_cleaner" value="cleaner">
                                <label for="service_cleaner" style="margin: 0;">🧹 Cleaner</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-full">Sign Up</button>
                <button type="button" class="btn btn-secondary btn-full" onclick="showLogin()">Back to Login</button>
            </form>
        </div>

        <!-- Dashboard View -->
<div id="dashboardView" class="hidden">
    <!-- Row 2: Create Request (LEFT) + User Profile (MIDDLE) + Profile Photo/Back (RIGHT) -->
<div id="dashboardHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 20px;">
    <!-- LEFT: Create Request Button -->
    <button class="btn" onclick="showCreateRequestForm()" id="createRequestBtn" style="margin: 0;">+ Create Request</button>
    
    <!-- MIDDLE: User Profile (for dashboard) -->
    <div class="user-menu" style="display: flex; align-items: center; gap: 12px;">
        <img id="headerUserPhoto" src="" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid #667eea; display: none;">
        <div id="headerUserPhotoPlaceholder" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(102, 126, 234, 0.2); display: flex; align-items: center; justify-content: center; font-size: 28px; border: 2px solid #667eea;">👤</div>
        <button class="user-button" onclick="toggleUserDropdown()">
            <span id="headerUsername">User</span>
            <span>▼</span>
        </button>
        <div class="user-dropdown" id="userDropdown">
            <div class="dropdown-item" onclick="showEditProfile(); toggleUserDropdown();">
                👤 Profile
            </div>
            <div class="dropdown-item" onclick="handleLogout()">
                🚪 Logout
            </div>
        </div>
    </div>
    
    <!-- Profile Photo (LEFT) + Back Button (RIGHT) - for edit profile page -->
<div id="profileHeaderSection" style="display: none; justify-content: space-between; align-items: center; width: 100%;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <img id="headerProfilePhotoLarge" src="" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; display: none;">
        <div id="headerProfilePhotoLargePlaceholder" style="width: 80px; height: 80px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #999;">👤</div>
    </div>
    <button class="btn btn-secondary" onclick="smartBack()" style="margin: 0;">← Back</button>
</div>
</div>
    
    <div class="two-column">
    <!-- LEFT COLUMN: SEEKER SECTION -->
    <div id="seekerSection">
        <!-- Mobile-only Seeker Header -->
        <div class="mobile-section-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; font-weight: 700; font-size: 16px; text-align: center; display: none;">
            🙋 MY REQUESTS (Seeker)
        </div>
        
        <div id="requestLimitWarning" class="request-limit-warning hidden">⚠️ Maximum 5 open requests reached</div>
        
        <!-- SECTION 1: OPEN REQUESTS -->
        <div class="collapsible-section">
            <button class="section-toggle" onclick="toggleSection('openRequests')">
                <div class="section-toggle-left">
                    <span>📋 OPEN REQUESTS</span>
                    <span class="count-badge" id="openRequestsTotal">0</span>
                </div>
                <div class="section-toggle-right">
                    <span class="toggle-icon" id="openRequestsIcon">▼</span>
                </div>
            </button>
            <div class="section-content" id="openRequestsContent">
                <div class="section-inner">
                    <div id="openRequestsList"></div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: ACTIVE REQUESTS -->
<div class="collapsible-section">
    <button class="section-toggle" onclick="toggleSection('activeRequests')">
    <div class="section-toggle-left">
        <span>🔄 ACTIVE REQUESTS</span>
        <span class="count-badge" id="activeRequestsTotal">0</span>
        <div class="badge-container hidden" id="activeRequestsUnreadBadge" style="display: none;">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">0</span>
        </div>
    </div>
    <div class="section-toggle-right">
        <span class="toggle-icon" id="activeRequestsIcon">▼</span>
    </div>
</button>
            <div class="section-content" id="activeRequestsContent">
                <div class="section-inner">
                    <div class="sub-tabs">
    <button class="sub-tab active" onclick="filterActiveRequests('responded')">
        <span>Responded</span>
        <div class="sub-tab-badges">
            <span class="count-badge" id="respondedCount">0</span>
            <div class="badge-container hidden" id="respondedUnread" style="display: none;">
                <div class="chat-bubble-icon"></div>
                <span class="unread-badge">0</span>
            </div>
        </div>
    </button>
    <button class="sub-tab" onclick="filterActiveRequests('in_progress')">
        <span>In Progress</span>
        <div class="sub-tab-badges">
            <span class="count-badge" id="inProgressCount">0</span>
            <div class="badge-container hidden" id="inProgressUnread" style="display: none;">
                <div class="chat-bubble-icon"></div>
                <span class="unread-badge">0</span>
            </div>
        </div>
    </button>
    <button class="sub-tab" onclick="filterActiveRequests('completed')">
        <span>Completed</span>
        <div class="sub-tab-badges">
            <span class="count-badge" id="completedCount">0</span>
            <div class="badge-container hidden" id="completedUnread" style="display: none;">
                <div class="chat-bubble-icon"></div>
                <span class="unread-badge">0</span>
            </div>
        </div>
    </button>
</div>
                    <div id="activeRequestsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN: PROVIDER SECTION -->
<div id="providerSection" class="hidden">
    <!-- Mobile-only Provider Header -->
    <div class="mobile-section-header" style="background: linear-gradient(135deg, #34A853 0%, #128C7E 100%); color: white; padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; font-weight: 700; font-size: 16px; text-align: center; display: none;">
        🔧 PROVIDER SECTION
    </div>
    
    <div class="collapsible-section">
        <button class="section-toggle" onclick="toggleSection('myResponses')">
    <div class="section-toggle-left">
        <span>💬 MY RESPONSES</span>
        <span class="count-badge" id="myResponsesTotal">0</span>
        <div class="badge-container hidden" id="myResponsesNew" style="display: none;">
            <div class="chat-bubble-icon"></div>
            <span class="unread-badge">0</span>
        </div>
    </div>
    <div class="section-toggle-right">
        <span class="toggle-icon" id="myResponsesIcon">▼</span>
    </div>
</button>
            <div class="section-content" id="myResponsesContent">
                <div class="section-inner">
                    <div id="myResponsesList"></div>
                </div>
            </div>
        </div>
        
        <div class="collapsible-section">
            <button class="section-toggle" onclick="toggleSection('availableWork')">
                <div class="section-toggle-left">
                    <span>💼 WORK OPPORTUNITIES</span>
                    <span class="count-badge" id="availableWorkTotal">0</span>
                    <span class="new-badge hidden" id="availableWorkNew" style="display: none;">🆕 0</span>
                </div>
                <div class="section-toggle-right">
                    <span class="toggle-icon" id="availableWorkIcon">▼</span>
                </div>
            </button>
            <div class="section-content" id="availableWorkContent">
                <div class="section-inner">
                    <div class="sub-tabs" id="urgencyTabs">
                        <!-- Tabs will be dynamically generated -->
                    </div>
                    <div id="nearbyRequestsList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

        <div id="createRequestView" class="hidden">
    <!-- Header with Back Button on Right -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px 20px 0 20px;">
        <h2 style="margin: 0; color: #667eea; font-size: 24px;">Create Service Request</h2>
        <button class="btn btn-secondary" onclick="showDashboard()" style="margin: 0;">← Back</button>
    </div>
            <div id="createRequestError" class="error hidden"></div>
            <div id="createRequestInfo" class="info hidden"></div>
            <form id="createRequestForm">
                <div class="form-group">
                    <label>Service Type <span class="required">*</span></label>
                    <select id="serviceType" required>
                        <option value="">Select Service</option>
                        <option value="electrician">🔧 Electrician</option>
                        <option value="plumber">🚰 Plumber</option>
                        <option value="ac_repair">❄️ AC Repair</option>
                        <option value="carpenter">🔨 Carpenter</option>
                        <option value="painter">🎨 Painter</option>
                        <option value="cleaner">🧹 Cleaner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="requestTitle" required minlength="10" maxlength="100">
                    <div class="char-counter"><span id="titleCounter">0</span>/100</div>
                </div>
                <div class="form-group">
                    <label>Description <span class="required">*</span></label>
                    <textarea id="requestDescription" required minlength="20" maxlength="500"></textarea>
                    <div class="char-counter"><span id="descCounter">0</span>/500</div>
                </div>
                <div class="form-group">
                    <label>Urgency <span class="required">*</span></label>
                    <div class="urgency-group">
                        <div class="urgency-option">
                            <input type="radio" name="urgency" id="urgentRadio" value="urgent" required>
                            <label for="urgentRadio" class="urgency-label">🔴 Urgent</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="urgency" id="normalRadio" value="normal" required>
                            <label for="normalRadio" class="urgency-label">🟡 Normal</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="urgency" id="lowRadio" value="low" required>
                            <label for="lowRadio" class="urgency-label">🟢 Low</label>
                        </div>
                    </div>
                </div>
                <h3>📍 Service Location</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="differentLocation" onchange="toggleLocationFields()">
                    <label for="differentLocation" style="margin: 0;">Use different location for this service</label>
                </div>
                <div id="customLocationFields" class="hidden">
    <div class="form-group">
        <label>Area Name <span class="required">*</span></label>
        <input type="text" id="customAreaName">
    </div>
    <div class="form-group">
        <label>Landmark</label>
        <input type="text" id="customLandmark">
    </div>
    <div class="row">
        <div class="form-group">
    <label>City <span class="required">*</span></label>
    <select id="customCity">
        <option value="">Select City</option>
        <option value="Ahmedabad">Ahmedabad</option>
        <option value="Bengaluru">Bengaluru</option>
        <option value="Chennai">Chennai</option>
        <option value="Delhi">Delhi</option>
        <option value="Hyderabad">Hyderabad</option>
        <option value="Kolkata">Kolkata</option>
        <option value="Mumbai">Mumbai</option>
        <option value="Pune">Pune</option>
        
        <option value="Agra">Agra</option>
        <option value="Ajmer">Ajmer</option>
        <option value="Akola">Akola</option>
        <option value="Aligarh">Aligarh</option>
        <option value="Allahabad">Allahabad (Prayagraj)</option>
        <option value="Amravati">Amravati</option>
        <option value="Amritsar">Amritsar</option>
        <option value="Asansol">Asansol</option>
        <option value="Aurangabad">Aurangabad</option>
        <option value="Bareilly">Bareilly</option>
        <option value="Belagavi">Belagavi (Belgaum)</option>
        <option value="Bhavnagar">Bhavnagar</option>
        <option value="Bhilai">Bhilai</option>
        <option value="Bhiwandi">Bhiwandi</option>
        <option value="Bhopal">Bhopal</option>
        <option value="Bhubaneswar">Bhubaneswar</option>
        <option value="Bikaner">Bikaner</option>
        <option value="Bilaspur">Bilaspur</option>
        <option value="Bokaro Steel City">Bokaro Steel City</option>
        <option value="Chandigarh">Chandigarh</option>
        <option value="Coimbatore">Coimbatore</option>
        <option value="Cuttack">Cuttack</option>
        <option value="Dehradun">Dehradun</option>
        <option value="Dhanbad">Dhanbad</option>
        <option value="Dombivli">Dombivli</option>
        <option value="Durgapur">Durgapur</option>
        <option value="Faridabad">Faridabad</option>
        <option value="Ghaziabad">Ghaziabad</option>
        <option value="Gorakhpur">Gorakhpur</option>
        <option value="Guntur">Guntur</option>
        <option value="Gurgaon">Gurgaon (Gurugram)</option>
        <option value="Guwahati">Guwahati</option>
        <option value="Gwalior">Gwalior</option>
        <option value="Hubballi–Dharwad">Hubballi–Dharwad</option>
        <option value="Indore">Indore</option>
        <option value="Jabalpur">Jabalpur</option>
        <option value="Jaipur">Jaipur</option>
        <option value="Jalandhar">Jalandhar</option>
        <option value="Jammu">Jammu</option>
        <option value="Jamshedpur">Jamshedpur</option>
        <option value="Jamnagar">Jamnagar</option>
        <option value="Jodhpur">Jodhpur</option>
        <option value="Kakinada">Kakinada</option>
        <option value="Kanpur">Kanpur</option>
        <option value="Karnal">Karnal</option>
        <option value="Kochi">Kochi</option>
        <option value="Kolhapur">Kolhapur</option>
        <option value="Kota">Kota</option>
        <option value="Kozhikode">Kozhikode</option>
        <option value="Kumbakonam">Kumbakonam</option>
        <option value="Kurnool">Kurnool</option>
        <option value="Ludhiana">Ludhiana</option>
        <option value="Lucknow">Lucknow</option>
        <option value="Madurai">Madurai</option>
        <option value="Mangaluru">Mangaluru</option>
        <option value="Meerut">Meerut</option>
        <option value="Mohali">Mohali</option>
        <option value="Moradabad">Moradabad</option>
        <option value="Mysuru">Mysuru</option>
        <option value="Nagpur">Nagpur</option>
        <option value="Nanded">Nanded</option>
        <option value="Nashik">Nashik</option>
        <option value="Nellore">Nellore</option>
        <option value="Noida">Noida</option>
        <option value="Patna">Patna</option>
        <option value="Pimpri-Chinchwad">Pimpri-Chinchwad</option>
        <option value="Puducherry">Puducherry</option>
        <option value="Raipur">Raipur</option>
        <option value="Rajkot">Rajkot</option>
        <option value="Ranchi">Ranchi</option>
        <option value="Rourkela">Rourkela</option>
        <option value="Saharanpur">Saharanpur</option>
        <option value="Salem">Salem</option>
        <option value="Shimla">Shimla</option>
        <option value="Siliguri">Siliguri</option>
        <option value="Solapur">Solapur</option>
        <option value="Srinagar">Srinagar</option>
        <option value="Surat">Surat</option>
        <option value="Thiruvananthapuram">Thiruvananthapuram</option>
        <option value="Thrissur">Thrissur</option>
        <option value="Tiruchirappalli">Tiruchirappalli</option>
        <option value="Tirunelveli">Tirunelveli</option>
        <option value="Ujjain">Ujjain</option>
        <option value="Vadodara">Vadodara</option>
        <option value="Varanasi">Varanasi</option>
        <option value="Vasai-Virar">Vasai-Virar</option>
        <option value="Vijayawada">Vijayawada</option>
        <option value="Visakhapatnam">Visakhapatnam</option>
        <option value="Warangal">Warangal</option>
        </select>
</div><div class="form-group">
    <label>State <span class="required">*</span></label>
    <select id="customState">
        <option value="">Select State/Union Territory</option>
        <option value="Andhra Pradesh">Andhra Pradesh</option>
        <option value="Arunachal Pradesh">Arunachal Pradesh</option>
        <option value="Assam">Assam</option>
        <option value="Bihar">Bihar</option>
        <option value="Chhattisgarh">Chhattisgarh</option>
        <option value="Goa">Goa</option>
        <option value="Gujarat">Gujarat</option>
        <option value="Haryana">Haryana</option>
        <option value="Himachal Pradesh">Himachal Pradesh</option>
        <option value="Jharkhand">Jharkhand</option>
        <option value="Karnataka">Karnataka</option>
        <option value="Kerala">Kerala</option>
        <option value="Madhya Pradesh">Madhya Pradesh</option>
        <option value="Maharashtra">Maharashtra</option>
        <option value="Manipur">Manipur</option>
        <option value="Meghalaya">Meghalaya</option>
        <option value="Mizoram">Mizoram</option>
        <option value="Nagaland">Nagaland</option>
        <option value="Odisha">Odisha</option>
        <option value="Punjab">Punjab</option>
        <option value="Rajasthan">Rajasthan</option>
        <option value="Sikkim">Sikkim</option>
        <option value="Tamil Nadu">Tamil Nadu</option>
        <option value="Telangana">Telangana</option>
        <option value="Tripura">Tripura</option>
        <option value="Uttar Pradesh">Uttar Pradesh</option>
        <option value="Uttarakhand">Uttarakhand</option>
        <option value="West Bengal">West Bengal</option>
        <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
        <option value="Chandigarh">Chandigarh</option>
        <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
        <option value="National Capital Territory of Delhi">National Capital Territory of Delhi</option>
        <option value="Jammu and Kashmir">Jammu and Kashmir</option>
        <option value="Ladakh">Ladakh</option>
        <option value="Lakshadweep">Lakshadweep</option>
        <option value="Puducherry">Puducherry</option>
    </select>
</div>
                    </div>
                    <div class="form-group">
                        <label>PIN Code <span class="required">*</span></label>
                        <input type="text" id="customPinCode" pattern="[0-9]{6}">
                    </div>
                </div>
                <button type="submit" class="btn btn-full" id="submitRequestBtn">Create Request</button>
            </form>
        </div>
<!-- Edit Request View -->
        <div id="editRequestView" class="hidden">
            <button class="btn btn-secondary" onclick="window.history.back()">← Back</button>
            <h2 style="margin-top: 20px;">Edit Service Request</h2>
            <div id="editRequestError" class="error hidden"></div>
            <div id="editRequestInfo" class="info hidden"></div>
            <form id="editRequestForm">
                <input type="hidden" id="editRequestId">
                
                <div class="form-group">
                    <label>Service Type <span class="required">*</span></label>
                    <select id="editServiceType" disabled>
                        <option value="">Select Service</option>
                        <option value="electrician">🔧 Electrician</option>
                        <option value="plumber">🚰 Plumber</option>
                        <option value="ac_repair">❄️ AC Repair</option>
                        <option value="carpenter">🔨 Carpenter</option>
                        <option value="painter">🎨 Painter</option>
                        <option value="cleaner">🧹 Cleaner</option>
                    </select>
                    <small style="color: #999; font-size: 12px;">Service type cannot be changed after creation</small>
                </div>
                
                <div class="form-group">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="editRequestTitle" required minlength="10" maxlength="100">
                    <div class="char-counter"><span id="editTitleCounter">0</span>/100</div>
                </div>
                
                <div class="form-group">
                    <label>Description <span class="required">*</span></label>
                    <textarea id="editRequestDescription" required minlength="20" maxlength="500"></textarea>
                    <div class="char-counter"><span id="editDescCounter">0</span>/500</div>
                </div>
                
                <div class="form-group">
                    <label>Urgency <span class="required">*</span></label>
                    <div class="urgency-group">
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editUrgentRadio" value="urgent" required>
                            <label for="editUrgentRadio" class="urgency-label">🔴 Urgent</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editNormalRadio" value="normal" required>
                            <label for="editNormalRadio" class="urgency-label">🟡 Normal</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editLowRadio" value="low" required>
                            <label for="editLowRadio" class="urgency-label">🟢 Low</label>
                        </div>
                    </div>
                </div>
                
                <h3>📍 Service Location</h3>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <p style="color: #333; font-size: 14px; margin-bottom: 8px; font-weight: 600;">📍 Current Location:</p>
                    <p style="color: #555; font-size: 14px; line-height: 1.6;" id="currentLocationText"></p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px; font-style: italic;">
                        ℹ️ Location and service type cannot be changed after request creation. If you need to change these, please cancel this request and create a new one.
                    </p>
                </div>
                
                <button type="submit" class="btn btn-full" id="updateRequestBtn">💾 Update Request</button>            </form>
        </div>

<!-- Edit Profile View -->
<div id="editProfileView" class="hidden">
    <!-- Header Section with Profile Photo and Back Button -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; padding: 20px 20px 0 20px;">
        <!-- Left: Headings + Profile Photo -->
        <div>
            <h2 style="margin: 0 0 15px 0; color: #667eea; font-size: 24px;">Edit Profile</h2>
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">👤 Personal Information</h3>
            
            <div style="margin-top: 10px;">
                <img id="currentProfilePhoto" src="" alt="Profile" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; display: none;">
                <div id="noProfilePhoto" style="width: 120px; height: 120px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #999;">👤</div>
            </div>
        </div>
        
        <!-- Right: Back Button -->
        <div>
            <button class="btn btn-secondary" onclick="smartBack()" style="margin: 0;">← Back</button>
        </div>
    </div>
    
    <div id="editProfileError" class="error hidden"></div>
    <div id="editProfileInfo" class="info hidden"></div>
    
    <form id="editProfileForm">
        <div class="form-group">
            <label>Change Profile Photo</label>
            <input type="file" id="editPhoto" accept="image/*">
            <small style="color: #999; font-size: 12px;">Max size: 2MB. Leave empty to keep current photo</small>
        </div>

        <div class="form-group">
            <label>Full Name <span class="required">*</span></label>
            <input type="text" id="editName" required>
        </div>

        <div class="form-group">
            <label>Phone Number <span class="required">*</span></label>
            <input type="tel" id="editPhone" maxlength="10" pattern="[6-9][0-9]{9}" required 
                   oninput="validatePhoneInput(this)" title="Enter correct number">
            <div id="editPhoneError" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;">Enter correct number</div>
        </div>

        <h3>📍 Address Details</h3>
        <div class="form-group">
            <label>House Number</label>
            <input type="text" id="editHouseNumber">
        </div>

        <div class="form-group">
            <label>Area Name <span class="required">*</span></label>
            <input type="text" id="editAreaName" required>
        </div>

        <div class="form-group">
            <label>Landmark</label>
            <input type="text" id="editLandmark">
        </div>

        <div class="form-group">
            <label>City <span class="required">*</span></label>
            <input type="text" id="editCity" placeholder="Type your city name..." required autocomplete="off">
            <div id="editCitySuggestions" class="autocomplete-suggestions"></div>
        </div>

        <div class="form-group">
            <label>State <span class="required">*</span></label>
            <select id="editState" required>
                <option value="">Select State/Union Territory</option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Madhya Pradesh">Madhya Pradesh</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttarakhand">Uttarakhand</option>
                <option value="West Bengal">West Bengal</option>
                <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                <option value="Chandigarh">Chandigarh</option>
                <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                <option value="National Capital Territory of Delhi">National Capital Territory of Delhi</option>
                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                <option value="Ladakh">Ladakh</option>
                <option value="Lakshadweep">Lakshadweep</option>
                <option value="Puducherry">Puducherry</option>
            </select>
        </div>

        <div class="form-group">
            <label>PIN Code <span class="required">*</span></label>
            <input type="text" id="editPinCode" pattern="[0-9]{6}" required>
        </div>
        
        <h3>🔧 Provider Settings</h3>
        <div style="margin-bottom: 20px;">
            <button type="button" class="btn" id="toggleProviderBtn" onclick="toggleProviderStatus()" style="width: 100%;">
                <span id="providerStatusText">Loading...</span>
            </button>
        </div>
        
        <div id="providerSettings" class="hidden">
            <div class="form-group">
                <label>Service Radius <span class="required">*</span></label>
                <select id="editRadius">
                    <option value="2">2 km</option>
                    <option value="5">5 km</option>
                    <option value="10">10 km</option>
                    <option value="15">15 km</option>
                    <option value="20">20 km</option>
                    <option value="30">30 km</option>
                    <option value="50">50 km</option>
                </select>
            </div>
            
            <h3>📋 Services I Provide</h3>
            <div id="currentServicesList" style="margin-bottom: 20px;"></div>
            
            <div class="form-group">
                <label>Add New Service</label>
                <div style="display: flex; gap: 10px;">
                    <select id="newServiceSelect" style="flex: 1;">
                        <option value="">Select Service to Add</option>
                        <option value="electrician">🔧 Electrician</option>
                        <option value="plumber">🚰 Plumber</option>
                        <option value="ac_repair">❄️ AC Repair</option>
                        <option value="carpenter">🔨 Carpenter</option>
                        <option value="painter">🎨 Painter</option>
                        <option value="cleaner">🧹 Cleaner</option>
                    </select>
                    <button type="button" class="btn" onclick="addService()">Add Service</button>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-full" id="saveProfileBtn">💾 Save Changes</button>
    </form>
</div>
        <!-- Chat View -->
        <div id="chatView" class="hidden">
            <div class="chat-container">
                <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
    <!-- LEFT: Profile Photo + Username -->
    <div style="display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1;" onclick="openChatPartnerProfile()">
        <img id="chatPartnerPhoto" src="" alt="" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white; display: none;">
        <div id="chatPartnerPhotoPlaceholder" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 20px;">👤</div>
        <div class="chat-header-left">
            <div class="chat-partner-name" id="chatPartnerName">Chat</div>
            <div class="chat-status">Request Status: <span id="chatRequestStatus">In Progress</span></div>
        </div>
    </div>
    
    <!-- RIGHT: Contact Details Button + Back Button -->
    <div style="display: flex; align-items: center; gap: 10px;">
        <button id="contactDetailsHeaderBtn" class="btn" onclick="openContactDetailsModal()" style="display: none; padding: 8px 16px; font-size: 13px; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; font-weight: 600;">
            📞 Contact Details
        </button>
        <button class="btn btn-secondary" onclick="smartBack()" style="margin: 0; background: rgba(255,255,255,0.2); border: 2px solid white; color: white;">← Back</button>
    </div>
</div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>
                
                                
                <div class="chat-input-area">
                    <div class="privacy-notice" id="privacyNotice">
                        🔒 <strong>Privacy Protected:</strong> Phone numbers and addresses are hidden until both parties agree to share contact information.
                    </div>
                    
                    <div class="chat-action-buttons">
    <button class="btn btn-contact" onclick="requestContactSharing()">
        📞 Request Contact Sharing
        <span class="privacy-info-icon" onclick="event.stopPropagation(); togglePrivacyNotice()">!</span>
    </button>
    
    <!-- PROVIDER: Mark Complete Button -->
    <button class="btn btn-complete" id="markCompleteBtn" onclick="showWarrantyForm()" style="display: none;">✅ Mark Work Complete</button>
    
    <!-- SEEKER: Accept/Reject Buttons (only visible when completion requested) -->
    <button class="btn btn-complete" id="acceptCompletionBtn" onclick="acceptCompletion()" style="display: none;">✅ Accept Completion</button>
    <button class="btn btn-cancel" id="rejectCompletionBtn" onclick="rejectCompletion()" style="display: none;">❌ Reject & Continue Work</button>
</div>

<div id="warrantyForm" class="warranty-form hidden">
    <h3>Select Warranty Period</h3>
    <div class="warranty-options">
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty0" value="0">
            <label for="warranty0">No Warranty</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty15" value="15">
            <label for="warranty15">15 Days</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty30" value="30">
            <label for="warranty30">1 Month</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty90" value="90">
            <label for="warranty90">3 Months</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty180" value="180">
            <label for="warranty180">6 Months</label>
        </div>
        <div class="warranty-option">
            <input type="radio" name="warranty" id="warranty365" value="365">
            <label for="warranty365">1 Year</label>
        </div>
    </div>
    <button class="btn btn-full" onclick="completeWork()" style="margin-top: 15px;">Confirm Completion</button>
</div>              
                    <div class="chat-input-wrapper">
                        <button class="plus-button" onclick="showAttachmentOptions()" title="Attach">+</button>
                        <textarea id="chatMessageInput" placeholder="Type your message..." rows="2" oninput="toggleSendButton()"></textarea>
                        <button class="template-button" id="templateBtn" onclick="openTemplateModal()" title="Quick Templates">📋</button>
                        <button class="btn btn-send" id="sendBtn" onclick="sendMessage()">➤</button>
                    </div>
		<input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                </div>
            </div>
        </div>

        <!-- Responses Modal -->
<div id="responsesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <button class="btn btn-secondary" onclick="closeResponsesModalAndGoBack()" style="padding: 8px 16px; font-size: 14px; margin-right: auto;">← Back to Dashboard</button>
            <h2 class="modal-title" style="flex: 1; text-align: center;">👥 Providers Who Responded</h2>
            <button class="close-btn" onclick="closeResponsesModal()">×</button>
        </div>
        <div id="responsesList"></div>
    </div>
</div>

        <!-- Provider Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">👤 Provider Profile</h2>
                    <button class="close-btn" onclick="closeProfileModal()">×</button>
                </div>
                <div id="profileContent"></div>
            </div>
        </div>
<!-- Template Modal -->
        <div id="templateModal" class="template-modal">
            <div class="template-modal-content">
                <div class="template-modal-header">
                    <h2 class="template-modal-title">📋 Quick Templates</h2>
                    <button class="template-close-btn" onclick="closeTemplateModal()">×</button>
                </div>
                <div class="template-categories" id="templateCategoriesContainer"></div>
            </div>
        </div>

<!-- Rating Modal -->
        <div id="ratingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">⭐ Rate Provider</h2>
                    <button class="close-btn" onclick="closeRatingModal()">×</button>
                </div>
                <div id="ratingModalContent">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="font-size: 16px; color: #555; margin-bottom: 10px;">How was your experience with <strong id="ratingProviderName"></strong>?</p>
                        <p style="font-size: 14px; color: #999;">Your rating helps others make better decisions</p>
                    </div>
                    
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1" onclick="selectRating(1)">☆</span>
                        <span class="star" data-rating="2" onclick="selectRating(2)">☆</span>
                        <span class="star" data-rating="3" onclick="selectRating(3)">☆</span>
                        <span class="star" data-rating="4" onclick="selectRating(4)">☆</span>
                        <span class="star" data-rating="5" onclick="selectRating(5)">☆</span>
                    </div>
                    
                    <div style="text-align: center; margin: 15px 0;">
                        <span id="ratingText" style="font-size: 18px; font-weight: 600; color: #667eea;">Select Rating</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Review (Optional)</label>
                        <textarea id="ratingReview" placeholder="Share your experience with others..." rows="4" maxlength="500"></textarea>
                        <div class="char-counter"><span id="reviewCounter">0</span>/500</div>
                    </div>
                    
                    <div id="ratingError" class="error hidden"></div>
                    
                    <button class="btn btn-full" onclick="submitRating()" id="submitRatingBtn">Submit Rating</button>
                </div>
            </div>
        </div>

        <!-- Contact Details Modal -->
<div id="contactDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
    <button class="btn btn-secondary" onclick="closeResponsesModalAndGoBack()" style="padding: 8px 16px; font-size: 14px; margin-right: 10px;">← Back</button>
    <h2 class="modal-title" style="flex: 1;">👥 Providers Who Responded</h2>
    <button class="close-btn" onclick="closeResponsesModal()">×</button>
</div>
        <div id="contactDetailsModalContent" style="padding: 20px 0;">
            <!-- Contact details will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading View -->

        <!-- Loading View -->
        <div id="loadingView" class="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nzhivzzzcanniejzqvsc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56aGl2enp6Y2FubmllanpxdnNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTcxMDEsImV4cCI6MjA3NTIzMzEwMX0.ex0z4DZF38IKc57l6V3X-DofTi6ZZUfPVFrajo1cBRY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let currentProfile = null;
	console.log('Step 1: JavaScript loaded');
        console.log('Step 2: Supabase client created');
        let selectedResponseRequest = null;
        let currentChatData = null;
        let chatRefreshInterval = null;
	let currentResponseFilter = 'active';
	window.currentWorkFilter = 'available'; // For Work Opportunities filtering
	let chatOpenedFrom = null; // Track where chat was opened from

        const SERVICE_ICONS = {
            electrician: '🔧',
            plumber: '🚰',
            ac_repair: '❄️',
            carpenter: '🔨',
            painter: '🎨',
            cleaner: '🧹'
        };

        window.addEventListener('DOMContentLoaded', async () => {
    console.log('Step 3: DOMContentLoaded fired');
    const { data: { user } } = await supabase.auth.getUser();
    console.log('Step 4: Checked user:', user);
    if (user) { 
        currentUser = user; 
        await loadProfile(); 
    } else { 
        showLogin(); 
    }
    setupCharCounters();
    setupCityAutocomplete();
});

        function hideAllViews() {
    const viewIds = [
        'loginView',
        'signupView', 
        'dashboardView',
        'editProfileView',
        'editRequestView',
        'chatView'
    ];
    
    viewIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('hidden');
            // ✅ DON'T set inline display:none - let CSS handle it
        }
    });
}

        function showLogin() { 
    hideAllViews(); 
    const loginView = document.getElementById('loginView');
    if (loginView) {
        loginView.classList.remove('hidden');
        loginView.style.display = 'block';
        loginView.style.visibility = 'visible';
        console.log('✅ Login view now visible');
    }
}
        function showSignup() { 
    hideAllViews(); 
    
    // Explicitly hide login view
    const loginView = document.getElementById('loginView');
    if (loginView) {
        loginView.classList.add('hidden');
        loginView.style.display = 'none';
    }
    
    const signupView = document.getElementById('signupView');
    if (signupView) {
        signupView.classList.remove('hidden');
        signupView.style.display = 'block';
        signupView.style.visibility = 'visible';
        console.log('✅ Signup view now visible');
    }
}
        function showDashboard() { 
    console.log('Step 8: Calling showDashboard');
    
    hideAllViews(); 
    
    // ✅ EXPLICITLY hide create request view
    const createRequestView = document.getElementById('createRequestView');
    if (createRequestView) {
        createRequestView.classList.add('hidden');
        createRequestView.style.display = 'none';
    }
    
    const dashboardView = document.getElementById('dashboardView');
    if (dashboardView) {
        dashboardView.classList.remove('hidden');
        dashboardView.style.display = 'block';
        dashboardView.style.visibility = 'visible';
    }
    
    // ✅ Hide loading view
    const loadingView = document.getElementById('loadingView');
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.style.display = 'none';
    }
    
    // ✅ Show dashboard elements
    const appLogo = document.getElementById('appLogo');
    const createRequestBtn = document.getElementById('createRequestBtn');
    const userMenu = document.querySelector('.user-menu');
    
    if (appLogo) appLogo.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'block';
    if (userMenu) userMenu.style.display = 'flex';
    
    // ✅ Show user profile photo and username
    const headerUserPhoto = document.getElementById('headerUserPhoto');
    const headerUserPhotoPlaceholder = document.getElementById('headerUserPhotoPlaceholder');
    const userButton = document.querySelector('.user-button');
    
    if (currentProfile?.profile_photo) {
        if (headerUserPhoto) {
            headerUserPhoto.src = currentProfile.profile_photo;
            headerUserPhoto.style.display = 'block';
        }
        if (headerUserPhotoPlaceholder) headerUserPhotoPlaceholder.style.display = 'none';
    } else {
        if (headerUserPhoto) headerUserPhoto.style.display = 'none';
        if (headerUserPhotoPlaceholder) headerUserPhotoPlaceholder.style.display = 'flex';
    }
    
    if (userButton) userButton.style.display = 'flex';
    
    // ✅ Show dashboard content sections
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    
    if (seekerSection) seekerSection.style.display = 'block';
    if (providerSection && currentProfile?.is_provider) providerSection.style.display = 'block';
    
    // Clear chat refresh interval
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
    
    loadDashboardData(); 
    
    console.log('✅ Dashboard should now be visible');
}
        function showLoading() { hideAllViews(); document.getElementById('loadingView').classList.remove('hidden'); }
        async function showCreateRequestForm() { 
    hideAllViews(); 
    
    // Hide dashboard sections
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    const createRequestBtn = document.getElementById('createRequestBtn');
    const userMenu = document.querySelector('.user-menu');
    
    if (seekerSection) seekerSection.style.display = 'none';
    if (providerSection) providerSection.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';
    if (userMenu) userMenu.style.display = 'none';
    
    // Show create request form
    document.getElementById('createRequestView').classList.remove('hidden'); 
    document.getElementById('createRequestView').style.display = 'block';
    
    document.getElementById('createRequestForm').reset(); 
    document.getElementById('titleCounter').textContent = '0';
    document.getElementById('descCounter').textContent = '0';
    
    // Filter services based on provider's existing services
    await filterServiceDropdown();
}
        
        async function filterServiceDropdown() {
            const serviceSelect = document.getElementById('serviceType');
            
            // If user is not a provider, show all services
            if (!currentProfile.is_provider) {
                return;
            }
            
            try {
                // Get provider's services
                const { data: providerServices, error } = await supabase
                    .from('provider_services')
                    .select('service_id')
                    .eq('provider_id', currentProfile.user_id);
                
                if (error) {
                    console.error('Error fetching provider services:', error);
                    return;
                }
                
                // Get list of services the provider already provides
                const providedServices = providerServices ? providerServices.map(s => s.service_id) : [];
                
                // Get all options except the first one (Select Service)
                const options = Array.from(serviceSelect.options).slice(1);
                
                // Hide options for services the provider already provides
                options.forEach(option => {
                    if (providedServices.includes(option.value)) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = '';
                    }
                });
                
            } catch (error) {
                console.error('Error filtering services:', error);
            }
        }
        function backToDashboard() { 
    // Clear chat refresh interval
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
    
    showDashboard(); 
}

// Smart back function - goes to previous page or dashboard
function smartBack() {
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
    
    // ✅ Hide ALL possible views (including edit profile)
    const chatView = document.getElementById('chatView');
    const editProfileView = document.getElementById('editProfileView');
    const editRequestView = document.getElementById('editRequestView');
    const createRequestView = document.getElementById('createRequestView');
    
    if (chatView) {
        chatView.classList.add('hidden');
        chatView.style.display = 'none';
    }
    
    if (editProfileView) {
        editProfileView.classList.add('hidden');
        editProfileView.style.display = 'none';
    }
    
    if (editRequestView) {
        editRequestView.classList.add('hidden');
        editRequestView.style.display = 'none';
    }
    
    if (createRequestView) {
        createRequestView.classList.add('hidden');
        createRequestView.style.display = 'none';
    }
    
    // Show dashboard sections again
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    const createRequestBtn = document.getElementById('createRequestBtn');
    
    if (seekerSection) seekerSection.style.display = 'block';
    if (providerSection && currentProfile.is_provider) providerSection.style.display = 'block';
    if (createRequestBtn) createRequestBtn.style.display = 'inline-block';
    
    if (chatOpenedFrom === 'responses-modal') {
        closeResponsesModal();
        viewResponses(currentChatData.requestId);
        chatOpenedFrom = null;
    } else {
        showDashboard();
        chatOpenedFrom = null;
    }
}

async function showEditProfile() {
    // Hide logo and dashboard elements when on profile page
    const appLogo = document.getElementById('appLogo');
    const dashboardLogo = document.getElementById('dashboardLogo');
    const createRequestBtn = document.getElementById('createRequestBtn');
    
    if (appLogo) appLogo.style.display = 'none';
    if (dashboardLogo) dashboardLogo.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';
    
    // Hide small profile photo and username dropdown
    const headerUserPhoto = document.getElementById('headerUserPhoto');
    const headerUserPhotoPlaceholder = document.getElementById('headerUserPhotoPlaceholder');
    const userButton = document.querySelector('.user-button');
    const userMenu = document.querySelector('.user-menu');
    
if (headerUserPhoto) headerUserPhoto.style.display = 'none';
    if (headerUserPhotoPlaceholder) headerUserPhotoPlaceholder.style.display = 'none';
    if (userButton) userButton.style.display = 'none';
    if (userMenu) userMenu.style.display = 'none';
    
    // ✅ HIDE the old profile header section (we have new back button in form now)
    const profileHeaderSection = document.getElementById('profileHeaderSection');
    if (profileHeaderSection) profileHeaderSection.style.display = 'none';
    // Hide the profile photo in header (we'll keep the one in the form instead)
const headerProfilePhotoLarge = document.getElementById('headerProfilePhotoLarge');
const headerProfilePhotoLargePlaceholder = document.getElementById('headerProfilePhotoLargePlaceholder');

if (headerProfilePhotoLarge) headerProfilePhotoLarge.style.display = 'none';
if (headerProfilePhotoLargePlaceholder) headerProfilePhotoLargePlaceholder.style.display = 'none';
    
    // ... rest of your existing code continues below ...
    // DON'T hide all views - just hide the dashboard CONTENT sections
    const seekerSection = document.getElementById('seekerSection');
    const providerSection = document.getElementById('providerSection');
    if (seekerSection) seekerSection.style.display = 'none';
    if (providerSection) providerSection.style.display = 'none';
    if (createRequestBtn) createRequestBtn.style.display = 'none';
    
    // Show edit profile view
    const editView = document.getElementById('editProfileView');
    if (editView) {
        editView.classList.remove('hidden');
        editView.style.display = 'block';
        editView.style.visibility = 'visible';
    }
    
    // Pre-fill form with current profile data
    document.getElementById('editName').value = currentProfile.name || '';
    document.getElementById('editPhone').value = currentProfile.phone || '';
    document.getElementById('editHouseNumber').value = currentProfile.house_number || '';
    document.getElementById('editAreaName').value = currentProfile.area_name || '';
    document.getElementById('editLandmark').value = currentProfile.landmark || '';
    document.getElementById('editCity').value = currentProfile.city || '';
    document.getElementById('editState').value = currentProfile.state || '';
    document.getElementById('editPinCode').value = currentProfile.pin_code || '';
    document.getElementById('editRadius').value = currentProfile.radius_km || 10;
    
    // Display current profile photo
    if (currentProfile.profile_photo) {
        document.getElementById('currentProfilePhoto').src = currentProfile.profile_photo;
        document.getElementById('currentProfilePhoto').style.display = 'block';
        document.getElementById('noProfilePhoto').style.display = 'none';
    } else {
        document.getElementById('currentProfilePhoto').style.display = 'none';
        document.getElementById('noProfilePhoto').style.display = 'flex';
    }
    
    // Update provider button
    setTimeout(() => {
        updateProviderButton();
    }, 100);
    
    if (currentProfile.is_provider) {
        await loadCurrentServices();
    }
}

async function loadCurrentServices() {
    try {
        const { data: services, error } = await supabase
            .from('provider_services')
            .select('service_id')
            .eq('provider_id', currentProfile.user_id);
        
        if (error) throw error;
        
        const container = document.getElementById('currentServicesList');
        
        if (!services || services.length === 0) {
            container.innerHTML = '<p style="color: #999; font-style: italic;">No services added yet</p>';
            return;
        }
        
        const serviceNames = {
            electrician: '🔧 Electrician',
            plumber: '🚰 Plumber',
            ac_repair: '❄️ AC Repair',
            carpenter: '🔨 Carpenter',
            painter: '🎨 Painter',
            cleaner: '🧹 Cleaner'
        };
        
        container.innerHTML = services.map(s => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <span>${serviceNames[s.service_id] || s.service_id}</span>
                <button type="button" class="btn btn-cancel" onclick="removeService('${s.service_id}')">Remove</button>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading services:', error);
    }
}

async function addService() {
    const select = document.getElementById('newServiceSelect');
    const serviceId = select.value;
    
    if (!serviceId) {
        alert('Please select a service to add');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('provider_services')
            .insert([{
                provider_id: currentProfile.user_id,
                service_id: serviceId,
                service_radius: currentProfile.radius_km || 10
            }]);
        
        if (error) throw error;
        
        alert('✅ Service added successfully!');
        select.value = '';
        await loadCurrentServices();
        
    } catch (error) {
        alert('Error adding service: ' + error.message);
    }
}

async function removeService(serviceId) {
    if (!confirm('Remove this service? This will permanently delete it from your profile.')) return;
    
    try {
        const { error } = await supabase
            .from('provider_services')
            .delete()
            .eq('provider_id', currentProfile.user_id)
            .eq('service_id', serviceId);
        
        if (error) throw error;
        
        alert('✅ Service removed successfully!');
        await loadCurrentServices();
        
    } catch (error) {
        alert('Error removing service: ' + error.message);
    }
}

function backFromChat() {
    if (currentChatData && currentChatData.isPreSelection) {
        // If chatting before selection, go back to responses
        viewResponses(currentChatData.requestId);
    } else {
        // If chatting after selection, go to dashboard
        showDashboard();
    }
}

        function setupCharCounters() {
            const titleInput = document.getElementById('requestTitle');
            const descInput = document.getElementById('requestDescription');
            const editTitleInput = document.getElementById('editRequestTitle');
            const editDescInput = document.getElementById('editRequestDescription');
            
            if (titleInput) {
                titleInput.addEventListener('input', (e) => { 
                    document.getElementById('titleCounter').textContent = e.target.value.length; 
                });
            }
            
            if (descInput) {
                descInput.addEventListener('input', (e) => { 
                    document.getElementById('descCounter').textContent = e.target.value.length; 
                });
            }
            
            if (editTitleInput) {
                editTitleInput.addEventListener('input', (e) => { 
                    document.getElementById('editTitleCounter').textContent = e.target.value.length; 
                });
            }
            
            if (editDescInput) {
                editDescInput.addEventListener('input', (e) => { 
                    document.getElementById('editDescCounter').textContent = e.target.value.length; 
                });
            }
        }

        function toggleLocationFields() {
            const checked = document.getElementById('differentLocation').checked;
            document.getElementById('customLocationFields').classList.toggle('hidden', !checked);
        }

        function validatePhoneInput(input) {
    const value = input.value;
    const errorId = input.id + 'Error';
    const errorDiv = document.getElementById(errorId);
    
    // Remove any non-digit characters
    input.value = value.replace(/[^0-9]/g, '');
    
    // Restrict to exactly 10 digits (prevent more than 10)
    if (input.value.length > 10) {
        input.value = input.value.substring(0, 10);
    }
    
    // If empty, hide error
    if (input.value.length === 0) {
        if (errorDiv) errorDiv.style.display = 'none';
        return false;
    }
    
    // Must be exactly 10 digits for validation
    if (input.value.length !== 10) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    const phone = input.value;
    
    // ===== VALIDATION RULES =====
    
    // Rule 1: Must start with 6, 7, 8, or 9
    const firstDigit = phone.charAt(0);
    if (!['6', '7', '8', '9'].includes(firstDigit)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 2: All same digits (6666666666)
    if (/^(\d)\1{9}$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 3: Alternating pattern (9898989898, 6767676767)
    if (/^(\d)(\d)\1\2\1\2\1\2\1\2$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 4: Three-digit alternating (989898989, 676767676)
    if (/^(\d)(\d)\1\2\1\2\1\2\1$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 5: Sequential ascending (0123456789, 1234567890, etc.)
    const sequentialPatterns = [
        '0123456789', '1234567890', '2345678901', '3456789012',
        '4567890123', '5678901234', '6789012345', '7890123456',
        '8901234567', '9012345678'
    ];
    if (sequentialPatterns.includes(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 6: Sequential descending (9876543210, 8765432109, etc.)
    const reverseSequentialPatterns = [
        '9876543210', '8765432109', '7654321098', '6543210987',
        '5432109876', '4321098765', '3210987654', '2109876543',
        '1098765432', '0987654321'
    ];
    if (reverseSequentialPatterns.includes(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 7: Too many repeated digits (more than 5 same digits)
    const digitCounts = {};
    for (let digit of phone) {
        digitCounts[digit] = (digitCounts[digit] || 0) + 1;
        if (digitCounts[digit] > 5) {
            if (errorDiv) {
                errorDiv.textContent = 'Enter correct number';
                errorDiv.style.display = 'block';
            }
            return false;
        }
    }
    
    // Rule 8: Repeating pairs (9988776655, 6677889900)
    if (/^(\d)\1(\d)\2(\d)\3(\d)\4(\d)\5$/.test(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 9: Common fake numbers (manually curated list)
    const commonFakeNumbers = [
        '9999999999', '8888888888', '7777777777', '6666666666',
        '1234567890', '0987654321', '9876543210',
        '1111111111', '2222222222', '3333333333', '4444444444', '5555555555',
        '9999900000', '8888800000', '7777700000',
        '0000000000', '1231231234', '9879879876'
    ];
    if (commonFakeNumbers.includes(phone)) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 10: Lack of digit diversity (must have at least 4 unique digits)
    const uniqueDigits = new Set(phone.split('')).size;
    if (uniqueDigits < 4) {
        if (errorDiv) {
            errorDiv.textContent = 'Enter correct number';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    // Rule 11: Check for repeating sequences of 3+ digits (888999888, 777666777)
    if (/(\d)\1{2,}/.test(phone)) {
        const matches = phone.match(/(\d)\1{2,}/g);
        if (matches && matches.length > 2) {
            if (errorDiv) {
                errorDiv.textContent = 'Enter correct number';
                errorDiv.style.display = 'block';
            }
            return false;
        }
    }
    
    // All validations passed
    if (errorDiv) errorDiv.style.display = 'none';
    return true;
}

        function toggleProviderFieldsSignup() {
            const checked = document.getElementById('isProvider').checked;
            document.getElementById('signupProviderFields').classList.toggle('hidden', !checked);
        }

function updateProviderButton() {
    const btn = document.getElementById('toggleProviderBtn');
    const text = document.getElementById('providerStatusText');
    const isProvider = currentProfile.is_provider;
    
    if (!btn || !text) return; // Safety check
    
    if (isProvider) {
        text.textContent = '✅ Providing Services (Click to Stop)';
        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
    } else {
        text.textContent = '❌ Not Providing Services (Click to Start)';
        btn.style.background = 'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)';
    }
    
    document.getElementById('providerSettings').classList.toggle('hidden', !isProvider);
}

async function toggleProviderStatus() {
    const isCurrentlyProvider = currentProfile.is_provider;
    const btn = document.getElementById('toggleProviderBtn');
    const text = document.getElementById('providerStatusText');
    
    if (!isCurrentlyProvider) {
        // User wants to become a provider
        const confirmed = confirm('⚠️ Start providing services?\n\nYou will receive notifications for service requests in your selected area. You can add services and set your service radius.');
        
        if (confirmed) {
            currentProfile.is_provider = true;
            updateProviderButton();
        }
    } else {
        // User wants to stop being a provider
        const confirmed = confirm('⚠️ Stop providing services?\n\nYou will no longer receive notifications for service requests. All your services will be removed from your profile.');
        
        if (confirmed) {
            currentProfile.is_provider = false;
            updateProviderButton();
        }
    }
}

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: document.getElementById('loginEmail').value.trim(),
                    password: document.getElementById('loginPassword').value
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                
                // ✅ CRITICAL FIX: Explicitly hide login view BEFORE loading profile
                const loginView = document.getElementById('loginView');
                if (loginView) {
                    loginView.classList.add('hidden');
                    loginView.style.display = 'none';
                }
                
                await loadProfile();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // Signup
document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorDiv = document.getElementById('signupError');
    const infoDiv = document.getElementById('signupInfo');
    
    errorDiv.classList.add('hidden');
    infoDiv.classList.add('hidden');
    
    try {
	// Validate phone number before proceeding
        const phoneInput = document.getElementById('signupPhone');
        if (!validatePhoneInput(phoneInput)) {
            errorDiv.textContent = 'Please enter a valid phone number';
            errorDiv.classList.remove('hidden');
            return;
        }	

        const formData = {
            email: document.getElementById('signupEmail').value.trim(),
            password: document.getElementById('signupPassword').value,
            name: document.getElementById('signupName').value.trim(),
            phone: document.getElementById('signupPhone').value.trim(),
            house_number: document.getElementById('houseNumber').value.trim() || null,
            area_name: document.getElementById('areaName').value.trim(),
            landmark: document.getElementById('landmark').value.trim() || null,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pin_code: document.getElementById('pinCode').value.trim(),
            is_provider: document.getElementById('isProvider').checked
        };

        infoDiv.textContent = '📍 Finding your location...';        infoDiv.classList.remove('hidden');

        const coords = await getCoordinates(formData);

        infoDiv.textContent = '🔐 Creating your account...';

        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: formData.email,
            password: formData.password
        });

        if (authError) throw authError;

        infoDiv.textContent = '💾 Saving your profile...';

        const { error: profileError } = await supabase.from('profiles').insert([{
            user_id: authData.user.id,
            name: formData.name,
            phone: formData.phone,
            house_number: formData.house_number,
            area_name: formData.area_name,
            landmark: formData.landmark,
            city: formData.city,
            state: formData.state,
            pin_code: formData.pin_code,
            latitude: coords.lat,
            longitude: coords.lng,
            is_provider: formData.is_provider
        }]);

        if (profileError) throw profileError;

        // If user is a provider, save their services
        if (formData.is_provider) {
            infoDiv.textContent = '🔧 Saving provider services...';
            
            const radius = parseInt(document.getElementById('signupRadius').value);
            const selectedServices = [];
            
            // Check which services are selected
            const serviceCheckboxes = [
                'service_electrician',
                'service_plumber',
                'service_ac_repair',
                'service_carpenter',
                'service_painter',
                'service_cleaner'
            ];
            
            serviceCheckboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox && checkbox.checked) {
                    selectedServices.push({
                        provider_id: authData.user.id,
                        service_id: checkbox.value,
                        service_radius: radius
                    });
                }
            });
            
            if (selectedServices.length > 0) {
                const { error: servicesError } = await supabase
                    .from('provider_services')
                    .insert(selectedServices);
                
                if (servicesError) throw servicesError;
            }
            
            // Update profile with radius
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ radius_km: radius })
                .eq('user_id', authData.user.id);
            
            if (updateError) throw updateError;
        }

        currentUser = authData.user;
        await loadProfile();
    } catch (error) {        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        infoDiv.classList.add('hidden');
    }
});

        // Geocoding
        async function getCoordinates(formData) {
            const strategies = [
                formData.house_number 
                    ? `${formData.house_number}, ${formData.area_name}, ${formData.landmark || ''}, ${formData.city}, ${formData.state}, India`.replace(/,\s*,/g, ',')
                    : null,
                formData.landmark
                    ? `${formData.area_name}, ${formData.landmark}, ${formData.city}, ${formData.state}, India`
                    : null,
                `${formData.area_name}, ${formData.city}, ${formData.state}, India`
            ];

            for (let address of strategies.filter(Boolean)) {
                try {
                    const coords = await geocodeAddress(address);
                    if (coords) return coords;
                } catch (error) {
                    console.log('Geocoding failed for:', address);
                }
            }

            const userConfirmed = confirm('📍 Unable to find location from address. Allow GPS access?');
            if (!userConfirmed) throw new Error('Unable to locate address. Please try again or allow location access.');
            
            return await getBrowserLocation();
        }

        async function geocodeAddress(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1&countrycodes=in`;
            const response = await fetch(url, { headers: { 'User-Agent': 'HelpBuddy/1.0' } });
            const data = await response.json();
            
            if (data && data.length > 0) {
                return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            }
            return null;
        }

        function getBrowserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) reject(new Error('Geolocation not supported'));
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                    (error) => reject(new Error('Unable to locate address. Please try again or allow location access.'))
                );
            });
        }

        // Convert Image to Base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Load Profile
        async function loadProfile() {
    // Prevent infinite loop
    if (window.isLoadingProfile) {
        console.log('⚠️ Already loading profile, skipping...');
        return;
    }
    window.isLoadingProfile = true;
    
    console.log('Step 5: loadProfile started');
    showLoading();
    try {
        console.log('Step 6: Fetching profile for user:', currentUser.id);
        const { data, error } = await supabase.from('profiles').select('*').eq('user_id', currentUser.id).single();
        if (error) throw error;
        
        currentProfile = data;
        console.log('Step 7: Profile loaded:', currentProfile);
        displayProfile(data);
        console.log('Step 8: Calling showDashboard');
        showDashboard();
        
        window.isLoadingProfile = false;  // Reset flag
    } catch (error) {
        window.isLoadingProfile = false;  // Reset flag on error too
        alert('Error loading profile: ' + error.message);
        showLogin();
    }
}

        function displayProfile(profile) {
    // Update header username and photo
    const headerUsername = document.getElementById('headerUsername');
    const headerPhoto = document.getElementById('headerUserPhoto');
    const headerPhotoPlaceholder = document.getElementById('headerUserPhotoPlaceholder');
    
    if (headerUsername) {
        headerUsername.textContent = profile.name;
    }
    
    // Display profile photo in header
    if (profile.profile_photo) {
        headerPhoto.src = profile.profile_photo;
        headerPhoto.style.display = 'block';
        headerPhotoPlaceholder.style.display = 'none';
    } else {
        headerPhoto.style.display = 'none';
        headerPhotoPlaceholder.style.display = 'flex';
    }
}

        // Load Dashboard Data
        async function loadDashboardData() {
    if (currentProfile.is_provider) {
        document.getElementById('providerSection').classList.remove('hidden');
        loadProviderResponses();
        loadNearbyRequests();
    }
    
    document.getElementById('seekerSection').classList.remove('hidden');
    loadUserRequests();
}

        // Load User Requests (Seeker View)
        async function loadUserRequests() {
    try {
        const { data, error } = await supabase
            .from('requests')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Ensure filter is set to 'open' on initial load
        if (!currentRequestFilter || currentRequestFilter === '') {
            currentRequestFilter = 'open';
        }

        await displayUserRequests(data || []);
                
                const openRequests = (data || []).filter(r => r.status === 'open');
                document.getElementById('createRequestBtn').disabled = openRequests.length >= 5;
                document.getElementById('requestLimitWarning').classList.toggle('hidden', openRequests.length < 5);
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

async function displayUserRequests(requests) {
    // Determine which container to use based on current filter
    let container;
    if (currentRequestFilter === 'open') {
        container = document.getElementById('openRequestsList');
    } else {
        container = document.getElementById('activeRequestsList');
    }

    if (!container) {
        console.error('Container not found for filter:', currentRequestFilter);
        return;
    }

    if (requests.length === 0) {
        // Update ALL badge counts first
        const openRequestsTotalEl = document.getElementById('openRequestsTotal');
        const activeRequestsTotalEl = document.getElementById('activeRequestsTotal');
        const respondedCountEl = document.getElementById('respondedCount');
        const inProgressCountEl = document.getElementById('inProgressCount');
        const completedCountEl = document.getElementById('completedCount');

        if (openRequestsTotalEl) openRequestsTotalEl.textContent = '0';
        if (activeRequestsTotalEl) activeRequestsTotalEl.textContent = '0';
        if (respondedCountEl) respondedCountEl.textContent = '0';
        if (inProgressCountEl) inProgressCountEl.textContent = '0';
        if (completedCountEl) completedCountEl.textContent = '0';

        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📋</div>
                <div class="empty-state-text">No service requests yet</div>
                <button class="btn" onclick="showCreateRequestForm()">Create Your First Request</button>
            </div>
        `;
        return;
    }

            // Count statistics
            const respondedRequests = [];
            const pendingRequests = [];
            const responseCountMap = {};
            let newMessagesTotal = 0;
            let respondedUnreadCount = 0;
            let pendingUnreadCount = 0;
            let completedUnreadCount = 0;

            // Check for responses and new messages
            for (let req of requests) {
                if (req.status === 'open') {
                    const { data: responses } = await supabase
                        .from('request_responses')
                        .select('id')
                        .eq('request_id', req.id);
                    
                    const responseCount = responses ? responses.length : 0;
                    responseCountMap[req.id] = responseCount;
                    
                    if (responseCount > 0) {
                        respondedRequests.push(req.id);
                    }
                } else if (req.status === 'in_progress') {
                    respondedRequests.push(req.id);
                } else if (req.status === 'pending_completion') {
                    pendingRequests.push(req.id);
                } else if (req.status === 'completed') {
                    respondedRequests.push(req.id);
                }
                
                if ((req.status === 'in_progress' || req.status === 'completed') && req.selected_provider_id) {
                    const { data: chat } = await supabase
    .from('chats')
    .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
    .eq('request_id', req.id)
    .eq('provider_id', req.selected_provider_id)
    .single();
                    
                    if (chat && chat.messages) {
                        // Get last viewed time for seeker
const lastViewedAt = chat.seeker_last_viewed_at;

// Count only messages AFTER last viewed time
const unread = chat.messages.filter(m => 
    m.sender_id !== currentUser.id &&
    (!lastViewedAt || new Date(m.timestamp) > new Date(lastViewedAt))
).length;
                        newMessagesTotal += unread;
                        
                        // Add to category-specific counters
                        if (req.status === 'in_progress') {
                            respondedUnreadCount += unread;
                        } else if (req.status === 'completed') {
                            completedUnreadCount += unread;
                        }
                    }
                } else if (req.status === 'pending_completion' && req.selected_provider_id) {
                    const { data: chat } = await supabase
                        .from('chats')
                        .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
                        .eq('request_id', req.id)
                        .eq('provider_id', req.selected_provider_id)
                        .single();
                    
                    if (chat && chat.messages) {
                        const unread = chat.messages.filter(m => m.sender_id !== currentUser.id).length;
                        newMessagesTotal += unread;
                        pendingUnreadCount += unread;
                    }
                }
            }

            // Update section badges
            const completedRequests = requests.filter(r => r.status === 'completed');
            const activeResponses = requests.filter(r => respondedRequests.includes(r.id) && r.status !== 'completed' && r.status !== 'pending_completion');
            const openWithoutResponse = requests.filter(r => !respondedRequests.includes(r.id) && !pendingRequests.includes(r.id) && r.status === 'open');
            
            // Update section badges with null checks
const openRequestsTotalEl = document.getElementById('openRequestsTotal');
const activeRequestsTotalEl = document.getElementById('activeRequestsTotal');
const respondedCountEl = document.getElementById('respondedCount');
const inProgressCountEl = document.getElementById('inProgressCount');
const completedCountEl = document.getElementById('completedCount');

// Calculate counts for each category
const openCount = openWithoutResponse.length;
const respondedCount = activeResponses.length;
const inProgressCount = pendingRequests.length;
const completedCount = completedRequests.length;

// Update Open Requests heading (just open count)
if (openRequestsTotalEl) openRequestsTotalEl.textContent = openCount;

// Update Active Requests heading (sum of responded + in progress + completed)
const activeTotal = respondedCount + inProgressCount + completedCount;
if (activeRequestsTotalEl) activeRequestsTotalEl.textContent = activeTotal;

// Update individual tab counts
if (respondedCountEl) respondedCountEl.textContent = respondedCount;
if (inProgressCountEl) inProgressCountEl.textContent = inProgressCount;
if (completedCountEl) completedCountEl.textContent = completedCount;

// Update Active Requests heading unread badge - ONLY show if there are unread messages
const activeRequestsUnreadBadge = document.getElementById('activeRequestsUnreadBadge');
if (activeRequestsUnreadBadge) {
    if (newMessagesTotal > 0) {
        const unreadBadgeSpan = activeRequestsUnreadBadge.querySelector('.unread-badge');
        if (unreadBadgeSpan) unreadBadgeSpan.textContent = newMessagesTotal;
        activeRequestsUnreadBadge.style.display = 'inline-flex';
        activeRequestsUnreadBadge.classList.remove('hidden');
    } else {
        activeRequestsUnreadBadge.style.display = 'none';
        activeRequestsUnreadBadge.classList.add('hidden');
    }
}    
            
            
            // Update main header badge (MY REQUESTS)
try {
    const mainHeaderBadge = document.getElementById('myRequestsUnreadBadge');
    if (mainHeaderBadge) {
        const unreadBadge = mainHeaderBadge.querySelector('.unread-badge');
        if (newMessagesTotal > 0) {
            if (unreadBadge) unreadBadge.textContent = newMessagesTotal;
            mainHeaderBadge.classList.remove('hidden');
            mainHeaderBadge.style.display = 'inline-flex';
        } else {
            mainHeaderBadge.classList.add('hidden');
            mainHeaderBadge.style.display = 'none';
        }
    }
} catch (error) {
    console.log('Badge update error (main):', error);
}

// Update individual tab unread badges
try {
    const respondedUnreadBadge = document.getElementById('respondedUnread');
    if (respondedUnreadBadge) {
        const badge = respondedUnreadBadge.querySelector('.unread-badge');
        if (respondedUnreadCount > 0) {
            if (badge) badge.textContent = respondedUnreadCount;
            respondedUnreadBadge.classList.remove('hidden');
            respondedUnreadBadge.style.display = 'inline-flex';
        } else {
            respondedUnreadBadge.classList.add('hidden');
            respondedUnreadBadge.style.display = 'none';
        }
    }
} catch (error) {
    console.log('Badge update error (responded):', error);
}

try {
    const inProgressUnreadBadge = document.getElementById('inProgressUnread');
    if (inProgressUnreadBadge) {
        const badge = inProgressUnreadBadge.querySelector('.unread-badge');
        if (pendingUnreadCount > 0) {
            if (badge) badge.textContent = pendingUnreadCount;
            inProgressUnreadBadge.classList.remove('hidden');
            inProgressUnreadBadge.style.display = 'inline-flex';
        } else {
            inProgressUnreadBadge.classList.add('hidden');
            inProgressUnreadBadge.style.display = 'none';
        }
    }
} catch (error) {
    console.log('Badge update error (in progress):', error);
}

try {
    const completedUnreadBadge = document.getElementById('completedUnread');
    if (completedUnreadBadge) {
        const badge = completedUnreadBadge.querySelector('.unread-badge');
        if (completedUnreadCount > 0) {
            if (badge) badge.textContent = completedUnreadCount;
            completedUnreadBadge.classList.remove('hidden');
            completedUnreadBadge.style.display = 'inline-flex';
        } else {
            completedUnreadBadge.classList.add('hidden');
            completedUnreadBadge.style.display = 'none';
        }
    }
} catch (error) {
    console.log('Badge update error (completed):', error);
}

            // Filter requests based on current filter
let filteredRequests = requests;
if (currentRequestFilter === 'open') {
    filteredRequests = openWithoutResponse;
} else if (currentRequestFilter === 'responded') {
    filteredRequests = activeResponses;
} else if (currentRequestFilter === 'in_progress') {
    filteredRequests = requests.filter(r => pendingRequests.includes(r.id));
} else if (currentRequestFilter === 'completed') {
    filteredRequests = completedRequests;
}

            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div class="empty-state-text">No ${currentRequestFilter} requests</div>
                    </div>
                `;
                return;
            }

            let html = '';            

            for (let req of filteredRequests) {
                const serviceIcon = SERVICE_ICONS[req.service_category] || '🔧';
                const statusClass = `status-${req.status.replace('_', '-')}`;
                let statusText = req.status.replace('_', ' ').toUpperCase();
                const timeAgo = getTimeAgo(new Date(req.created_at));

                let warrantyBadge = '';
                if (req.status === 'completed' && req.warranty_end_date) {
                    const isSeeker = req.user_id === currentUser.id;
                    const isSelectedProvider = req.selected_provider_id === currentProfile.user_id;
                    
                    if (isSeeker || isSelectedProvider) {
                        const warrantyEndDate = new Date(req.warranty_end_date);
                        const today = new Date();
                        const remainingDays = Math.ceil((warrantyEndDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (remainingDays > 0) {
                            warrantyBadge = `<span class="info-badge" style="background: #28a745;">🛡️ ${remainingDays} day${remainingDays > 1 ? 's' : ''} warranty left</span>`;
                        } else if (remainingDays === 0) {
                            warrantyBadge = `<span class="info-badge" style="background: #ffc107; color: #333;">🛡️ Warranty expires today</span>`;
                        } else {
                            warrantyBadge = `<span class="info-badge" style="background: #dc3545;">🛡️ Warranty expired</span>`;
                        }
                    }
                }

                let showChat = false;
                let newMessagesCount = 0;
                let responseCount = 0;
                let showResponses = false;

                if (req.status === 'open') {
                    responseCount = responseCountMap[req.id] || 0;
                    showResponses = responseCount > 0;
                } else if ((req.status === 'in_progress' || req.status === 'pending_completion' || req.status === 'completed') && req.selected_provider_id) {
                    showChat = true;
                    
                    const { data: chat } = await supabase
    .from('chats')
    .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
    .eq('request_id', req.id)
    .eq('provider_id', req.selected_provider_id)
    .single();
                    
                    if (chat && chat.messages) {
                        newMessagesCount = chat.messages.filter(m => m.sender_id !== currentUser.id).length;
                    }
                }

                let reactivateButton = '';
                if (req.status === 'completed' && req.warranty_end_date) {
                    const warrantyEndDate = new Date(req.warranty_end_date);
                    const today = new Date();
                    if (warrantyEndDate > today) {
                        reactivateButton = `<button class="btn btn-select action-btn-compact" onclick="reactivateRequest('${req.id}')">🔄 Reactivate</button>`;
                    }
                }
                                
                // Remove new messages badge - it will only show on Chat button
const responsesBadge = showResponses ? `<span class="info-badge">👥 ${responseCount} Response${responseCount > 1 ? 's' : ''}</span>` : '';

html += `
    <div class="request-card compact">
        <div class="request-card-main">
            <div class="request-card-left">
                <div class="request-title-compact" onclick="toggleRequestDetails(event, '${req.id}')">
                    <span class="urgency-bubble ${req.urgency}"></span>
                    <span class="request-title-text">${serviceIcon} ${req.title}</span>
                    <span class="request-chevron" id="chevron-${req.id}">▼</span>
                </div>
                <div class="request-summary">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                    ${responsesBadge}
                    ${warrantyBadge}
                </div>
                                <div class="request-summary" style="margin-top: 6px; color: #999;">
                                    📍 ${req.request_location_address.split(',').slice(0, 2).join(',')} • 🕒 ${timeAgo}
                                </div>
                            </div>
                            <div class="request-card-right">
    ${showResponses ? '<button class="btn btn-select action-btn-compact" onclick="chatOpenedFrom=\'dashboard\'; viewResponses(\'' + req.id + '\')">View Responses</button>' : ''}
    ${showChat ? `
    <div class="chat-btn-wrapper">
        <button class="btn btn-chat action-btn-compact" onclick="chatOpenedFrom='responses-modal'; closeResponsesModal(); openChat('${req.id}', '${req.selected_provider_id}')">💬 Chat</button>
        ${newMessagesCount > 0 ? `<span class="chat-unread-badge">${newMessagesCount}</span>` : ''}
    </div>
` : ''}
    ${reactivateButton}
</div>
                        </div>
                        <div class="request-details" id="details-resp-${req.id}">
                            <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                            <div class="request-location" style="margin-top: 8px;"><strong>Full Address:</strong> ${req.request_location_address}</div>
                            <div class="request-meta" style="margin-top: 8px;">
    <span class="meta-item">🔧 Service: ${req.service_category}</span>
    <span class="meta-item">⚡ Urgency: ${req.urgency.toUpperCase()}</span>
</div>
                           ${req.status === 'open' ? `
    <div style="display: flex; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
        <button class="btn" style="flex: 1; background: #128C7E; color: white;" onclick="editRequest('${req.id}')">✏️ Edit Request</button>
        <button class="btn btn-cancel" style="flex: 1;" onclick="cancelRequest('${req.id}')">❌ Cancel Request</button>
    </div>
` : ''}
                        </div>
                    </div>
                `;
            }
            
            if (container) {
                container.innerHTML = html;
            } else {
                console.error('Container still null after rendering. Filter:', currentRequestFilter);
            }
        }
            

        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Toggle request details
function toggleRequestDetails(event, requestId) {
    event.stopPropagation();
    const details = document.getElementById('details-' + requestId);
    const chevron = document.getElementById('chevron-' + requestId);
    
    if (!details || !chevron) return; // Safety check
    
    if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        chevron.classList.remove('expanded');
    } else {
        details.classList.add('expanded');
        chevron.classList.add('expanded');
    }
}

        // Open Chat
async function openChat(requestId, providerId) {
    try {
        if (!currentUser || !currentProfile) {
            alert('Session expired. Please login again.');
            showLogin();
            return;
        }
        
        console.log('🔵 Step 1: Opening chat for request:', requestId, 'provider:', providerId);
        showLoading();
        
        // Load request details
        console.log('🔵 Step 2: Fetching request details...');
        const { data: request, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (reqError) {
            console.error('❌ Request fetch error:', reqError);
            throw reqError;
        }
        console.log('✅ Step 2 Complete: Request loaded:', request);
        
        // CHECK IF CHAT EXISTS - if not, create it
        console.log('🔵 Step 3: Checking if chat exists...');
        const { data: existingChat, error: chatCheckError } = await supabase
            .from('chats')
            .select('id')
            .eq('request_id', requestId)
            .eq('provider_id', providerId)
            .maybeSingle();

        // If no chat exists, create one
        if (!existingChat) {
            console.log('⚠️ Chat does not exist, creating new chat...');
            const { error: createError } = await supabase
                .from('chats')
                .insert([{
                    request_id: requestId,
                    provider_id: providerId,
                    messages: []
                }]);
            
            if (createError) {
                console.error('❌ Error creating chat:', createError);
            } else {
                console.log('✅ Chat created successfully');
            }
        } else {
            console.log('✅ Chat already exists');
        }
        
        // CRITICAL FIX: Determine partner ID based on who is viewing
        console.log('🔵 Step 4: Determining partner (current user:', currentProfile.user_id, 'request owner:', request.user_id, ')');
        let partnerId;
        let partnerProfile;
        
        // If current user is the SEEKER (request owner)
        if (currentProfile.user_id === request.user_id) {
            console.log('👤 Current user is SEEKER, fetching PROVIDER profile...');
            // Partner is the PROVIDER
            partnerId = providerId;
            
            const { data: providerData, error: providerError } = await supabase
                .from('profiles')
                .select('*')
                .eq('user_id', providerId)
                .maybeSingle();
            
            if (providerError) {
                console.error('❌ Provider fetch error:', providerError);
                alert('❌ Error loading provider profile: ' + providerError.message);
                showDashboard();
                return;
            }
            
            if (!providerData) {
                console.error('❌ Provider profile not found');
                alert('❌ Provider profile not found.');
                showDashboard();
                return;
            }
            
            partnerProfile = providerData;
            console.log('✅ Provider profile loaded:', partnerProfile.name);
        } 
        // If current user is the PROVIDER
        else {
            console.log('👤 Current user is PROVIDER, fetching SEEKER profile...');
            // Partner is the SEEKER (request owner)
            partnerId = request.user_id;
            
            const { data: seekerData, error: seekerError } = await supabase
                .from('profiles')
                .select('*')
                .eq('user_id', request.user_id)
                .maybeSingle();
            
            if (seekerError) {
                console.error('❌ Seeker fetch error:', seekerError);
                alert('❌ Error loading seeker profile: ' + seekerError.message);
                showDashboard();
                return;
            }
            
            if (!seekerData) {
                console.error('❌ Seeker profile not found');
                alert('❌ Seeker profile not found.');
                showDashboard();
                return;
            }
            
            partnerProfile = seekerData;
            console.log('✅ Seeker profile loaded:', partnerProfile.name);
        }
        
        // Determine chat source
        const chatSource = (currentProfile.user_id === providerId) ? 'myResponses' : 'myRequests';
        
        console.log('🔵 Step 5: Setting up chat data...');
        currentChatData = {
            requestId: requestId,
            providerId: providerId,
            partnerName: partnerProfile.name,
            partnerId: partnerId,
            isProvider: currentProfile.user_id === providerId,
            requestStatus: request.status,
            chatSource: chatSource
        };
        console.log('✅ Chat data ready:', currentChatData);
        
        // Update chat header (while still showing loading)
        console.log('🔵 Step 6: Updating chat UI elements...');
        document.getElementById('chatPartnerName').textContent = partnerProfile.name;
        document.getElementById('chatRequestStatus').textContent = request.status.replace('_', ' ').toUpperCase();

        // Update profile photo
        if (partnerProfile.profile_photo) {
            document.getElementById('chatPartnerPhoto').src = partnerProfile.profile_photo;
            document.getElementById('chatPartnerPhoto').style.display = 'block';
            document.getElementById('chatPartnerPhotoPlaceholder').style.display = 'none';
        } else {
            document.getElementById('chatPartnerPhoto').style.display = 'none';
            document.getElementById('chatPartnerPhotoPlaceholder').style.display = 'flex';
        }
        console.log('✅ Chat UI elements updated');
        
        // Load messages BEFORE showing chat view
        console.log('🔵 Step 7: Loading chat messages...');
        await loadChatMessages();
        console.log('✅ Chat messages loaded');

        // Mark chat as viewed
        console.log('🔵 Step 8: Marking chat as viewed...');
        try {
            const viewedField = currentChatData.isProvider ? 'provider_last_viewed_at' : 'seeker_last_viewed_at';
            
            const { error: viewError } = await supabase
                .from('chats')
                .update({ [viewedField]: new Date().toISOString() })
                .eq('request_id', currentChatData.requestId)
                .eq('provider_id', currentChatData.providerId);
            
            if (viewError) {
                console.error('⚠️ Error marking chat as viewed:', viewError);
            } else {
                console.log('✅ Chat marked as viewed');
            }
        } catch (error) {
            console.error('⚠️ Error updating last viewed timestamp:', error);
        }

        // Check contact sharing status and button visibility
        console.log('🔵 Step 9: Checking contact sharing status...');
        const { data: chatData } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .maybeSingle();

        const contactAlreadyApproved = chatData?.messages?.some(m => 
            m.message_type === 'contact_request' && 
            m.contact_request_status === 'approved'
        );
        console.log('Contact sharing approved:', contactAlreadyApproved);

        console.log('🔵 Step 10: Setting up action buttons...');
        const { data: latestRequest } = await supabase
            .from('requests')
            .select('status, selected_provider_id')
            .eq('id', currentChatData.requestId)
            .single();

        const acceptBtn = document.getElementById('acceptCompletionBtn');
        const rejectBtn = document.getElementById('rejectCompletionBtn');
        const markCompleteBtn = document.getElementById('markCompleteBtn');

        if (markCompleteBtn) markCompleteBtn.style.display = 'none';
        if (acceptBtn) acceptBtn.style.display = 'none';
        if (rejectBtn) rejectBtn.style.display = 'none';

        if (latestRequest) {
            if (currentChatData.isProvider && 
                latestRequest.status === 'in_progress' && 
                latestRequest.selected_provider_id === currentProfile.user_id) {
                if (markCompleteBtn) markCompleteBtn.style.display = 'inline-block';
            }
            
            if (!currentChatData.isProvider && latestRequest.status === 'pending_completion') {
                if (acceptBtn) acceptBtn.style.display = 'inline-block';
                if (rejectBtn) rejectBtn.style.display = 'inline-block';
            }
        }

        // Handle read-only mode for non-selected providers
        const isNonSelectedProvider = currentChatData.isProvider && 
                                      latestRequest && 
                                      (latestRequest.status === 'in_progress' || 
                                       latestRequest.status === 'completed' || 
                                       latestRequest.status === 'pending_completion') && 
                                      latestRequest.selected_provider_id !== currentProfile.user_id;
        
        if (isNonSelectedProvider) {
            console.log('⚠️ Read-only mode enabled (non-selected provider)');
            const messageInput = document.getElementById('chatMessageInput');
            const sendBtn = document.querySelector('.chat-input-wrapper .btn-send');
            const templateBtn = document.querySelector('.template-button');
            const plusBtn = document.querySelector('.plus-button');
            const actionButtons = document.querySelector('.chat-action-buttons');
            
            if (messageInput) {
                messageInput.disabled = true;
                messageInput.placeholder = 'Read-only: This request was assigned to another provider';
                messageInput.style.background = '#f0f0f0';
                messageInput.style.cursor = 'not-allowed';
            }
            
            if (sendBtn) sendBtn.style.display = 'none';
            if (templateBtn) templateBtn.style.display = 'none';
            if (plusBtn) plusBtn.style.display = 'none';
            if (actionButtons) actionButtons.style.display = 'none';
            
            const chatStatus = document.getElementById('chatRequestStatus');
            if (chatStatus) {
                chatStatus.textContent = 'READ-ONLY - ASSIGNED TO ANOTHER PROVIDER';
                chatStatus.style.color = '#dc3545';
            }
        } else {
            const messageInput = document.getElementById('chatMessageInput');
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = 'Type your message...';
                messageInput.style.background = 'white';
                messageInput.style.cursor = 'text';
            }
        }
        console.log('✅ Action buttons configured');
        
        // ⭐ CRITICAL FIX: Show chat view ONLY AFTER everything is loaded
console.log('🔵 Step 11: Showing chat view...');

// Hide all main views EXCEPT dashboardView (because chatView is inside it)
const viewsToHide = ['loginView', 'signupView', 'createRequestView', 
                     'editRequestView', 'editProfileView', 'loadingView'];
viewsToHide.forEach(viewId => {
    const view = document.getElementById(viewId);
    if (view) {
        view.classList.add('hidden');
        view.style.display = 'none';
    }
});

// Hide dashboard sections (seeker/provider sections)
const seekerSection = document.getElementById('seekerSection');
const providerSection = document.getElementById('providerSection');
const createRequestBtn = document.getElementById('createRequestBtn');
const userMenu = document.querySelector('.user-menu');

if (seekerSection) seekerSection.style.display = 'none';
if (providerSection) providerSection.style.display = 'none';
if (createRequestBtn) createRequestBtn.style.display = 'none';

// Keep dashboardView visible (parent container)
const dashboardView = document.getElementById('dashboardView');
if (dashboardView) {
    dashboardView.classList.remove('hidden');
    dashboardView.style.display = 'block';
}

// Show chatView
const chatView = document.getElementById('chatView');
if (chatView) {
    chatView.classList.remove('hidden');
    chatView.style.display = 'block';
    chatView.style.visibility = 'visible';
}

console.log('✅ ✅ ✅ CHAT VIEW NOW VISIBLE ✅ ✅ ✅');
        
        // Start auto-refresh
        console.log('🔵 Step 12: Starting auto-refresh...');
        if (chatRefreshInterval) clearInterval(chatRefreshInterval);
        chatRefreshInterval = setInterval(loadChatMessages, 10000);
        console.log('✅ Auto-refresh started');
        
        console.log('🎉 🎉 🎉 CHAT OPENED SUCCESSFULLY 🎉 🎉 🎉');
        
    } catch (error) {
        console.error('❌ ❌ ❌ ERROR OPENING CHAT:', error);
        alert('Error opening chat: ' + error.message);
        showDashboard();
    }
}

        // Load Chat Messages
async function loadChatMessages() {
    try {
        const { data: chats, error } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .maybeSingle();
        
        const chat = chats;
        
        if (error) {
            console.error('Error fetching chat:', error);
            return;
        }
        
        const messages = chat?.messages || [];
        const container = document.getElementById('chatMessages'); // ✅ MOVED UP - DEFINED BEFORE USE
        
        // If no chat exists and user is non-selected provider, show empty state
        if (!chat && currentChatData.isProvider && currentChatData.requestStatus === 'in_progress') {
            container.innerHTML = '<div class="empty-chat-state"><div class="empty-chat-state-text">No chat history available.</div></div>';
            return;
        }
        
        if (messages.length === 0) {
            container.innerHTML = '<div class="empty-chat-state"><div class="empty-chat-state-text">No messages yet. Start the conversation!</div></div>';
            return;
        }
        
        let html = '';
        messages.forEach((msg, index) => {
            const isSent = msg.sender_id === currentUser.id;
            const messageClass = isSent ? 'sent' : 'received';
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Handle contact request messages
            if (msg.message_type === 'contact_request') {
                const status = msg.contact_request_status || 'pending';
                let cardClass = 'contact-request-card';
                let statusHTML = '';
                
                if (status === 'approved') {
                    cardClass += ' contact-status-approved';
                    statusHTML = '<p style="margin-top: 10px; font-weight: 600;">✅ Approved - Contact details visible below</p>';
                } else if (status === 'declined') {
                    cardClass += ' contact-status-declined';
                    statusHTML = '<p style="margin-top: 10px; font-weight: 600;">❌ Declined</p>';
                } else if (!isSent && status === 'pending') {
                    statusHTML = `
                        <div class="contact-approval-buttons">
                            <button class="btn-approve" onclick="approveContactSharing(${index})">✅ Approve</button>
                            <button class="btn-decline" onclick="declineContactSharing(${index})">❌ Decline</button>
                        </div>
                    `;
                } else if (isSent && status === 'pending') {
                    statusHTML = '<p style="margin-top: 10px; color: #856404; font-size: 12px;">⏳ Waiting for approval...</p>';
                }
                
                html += `
                    <div class="${cardClass}" style="margin: 15px 0;">
                        <div class="contact-request-title">📞 Contact Sharing Request</div>
                        <p style="font-size: 13px; color: #555;">From: ${msg.sender_name}</p>
                        ${statusHTML}
                    </div>
                `;
            } 
            // Handle system messages
            else if (msg.message_type === 'system') {
                html += `
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 8px; font-size: 13px; color: #555;">
                        ${msg.message}
                    </div>
                `;
            }
            // Handle regular messages
            else {
                html += `
                    <div class="message ${messageClass}">
                        <div class="message-bubble">
                            ${msg.message}
                            ${msg.image ? `<img src="${msg.image}" class="message-image" alt="Shared image" onclick="openImagePreview('${msg.image}')">` : ''}
                        </div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }
        });
        
        // Check if contact sharing was approved
        const contactApproved = messages.some(m => 
            m.message_type === 'contact_request' && 
            m.contact_request_status === 'approved'
        );
        
        // Show/hide contact details button in header
        const contactDetailsHeaderBtn = document.getElementById('contactDetailsHeaderBtn');
        const requestContactBtn = document.querySelector('.btn-contact');
        
        if (contactApproved) {
            // Show contact details button in header
            if (contactDetailsHeaderBtn) contactDetailsHeaderBtn.style.display = 'inline-block';
            // Hide request contact sharing button
            if (requestContactBtn) requestContactBtn.style.display = 'none';
        } else {
            // Hide contact details button in header
            if (contactDetailsHeaderBtn) contactDetailsHeaderBtn.style.display = 'none';
            // Show request contact sharing button
            if (requestContactBtn) requestContactBtn.style.display = 'inline-block';
        }
        
        container.innerHTML = html;
        
        // Scroll to bottom to show latest message
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
        
    } catch (error) {
        console.error('Error loading messages:', error);
        const container = document.getElementById('chatMessages');
        if (container) {
            container.innerHTML = '<div class="empty-chat-state"><div class="empty-chat-state-text">Error loading messages. Please refresh.</div></div>';
        }
    }
}


// Open Image Preview (Full Screen)
function openImagePreview(imageUrl) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    modal.innerHTML = `
        <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
        <button style="position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">×</button>
    `;
    
    modal.onclick = () => document.body.removeChild(modal);
    document.body.appendChild(modal);
}
        // Send Message
        async function sendMessage() {
    const input = document.getElementById('chatMessageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Disable button during send to prevent double-clicks
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    try {
        // Get existing chat
        const { data: existingChat, error: fetchError } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Add new message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: message,
            timestamp: new Date().toISOString()
        });
        
        // Upsert chat
        const { error: upsertError } = await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        if (upsertError) throw upsertError;
        
        // Clear input AFTER successful send
        input.value = '';
        
        // Manually toggle buttons after clearing
        sendBtn.classList.remove('show');
        document.getElementById('templateBtn').classList.remove('hide');
        
        // Re-enable button
        sendBtn.disabled = false;
        
        // Reload messages
        await loadChatMessages();
        
    } catch (error) {
        alert('Error sending message: ' + error.message);
        sendBtn.disabled = false;
    }
}

        // Handle Photo Upload
        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const { data: existingChat } = await supabase
                        .from('chats')
                        .select('messages')
                        .eq('request_id', currentChatData.requestId)
                        .eq('provider_id', currentChatData.providerId)
                        .single();
                    
                    let messages = existingChat?.messages || [];
                    
                    messages.push({
                        sender_id: currentUser.id,
                        sender_name: currentProfile.name,
                        message: '📷 Shared a photo',
                        image: e.target.result,
                        timestamp: new Date().toISOString()
                    });
                    
                    await supabase
                        .from('chats')
                        .upsert({
                            request_id: currentChatData.requestId,
                            provider_id: currentChatData.providerId,
                            messages: messages
                        }, { onConflict: 'request_id,provider_id' });
                    
                    event.target.value = '';
                    await loadChatMessages();
                    
                } catch (error) {
                    alert('Error uploading photo: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        // Toggle Template Category
        function toggleTemplateCategory(element) {
            const items = element.nextElementSibling;
            const isCurrentlyOpen = items.classList.contains('open');
            
            // Close all other open categories first (accordion behavior)
            document.querySelectorAll('.template-category-items.open').forEach(openItem => {
                if (openItem !== items) {
                    openItem.classList.remove('open');
                    // Update the arrow icon for closed categories
                    const header = openItem.previousElementSibling;
                    if (header && header.textContent.includes('▶')) {
                        header.innerHTML = header.innerHTML.replace('▶', '▼');
                    }
                }
            });
            
            // Toggle the clicked category
            items.classList.toggle('open');
            element.textContent = element.textContent.includes('▼') 
                ? element.textContent.replace('▼', '▶')
                : element.textContent.replace('▶', '▼');
        }

        // Insert Template
        function insertTemplate(element) {
            document.getElementById('chatMessageInput').value = element.textContent;
            document.getElementById('chatMessageInput').focus();
            closeTemplateModal();
        }

        // Open Template Modal
        function openTemplateModal() {
            const modal = document.getElementById('templateModal');
            const container = document.getElementById('templateCategoriesContainer');
            
            // Determine templates based on chat source (which section the chat came from)
            const templates = (currentChatData.chatSource === 'myRequests') ? seekerTemplatesData : providerTemplatesData;
            
            // Build HTML for modal
            let html = '';
            templates.forEach(category => {
                html += `
                    <div class="template-category-block">
                        <div class="template-category-header" onclick="toggleTemplateCategory(this)">
                            <span>${category.title}</span>
                            <span>▼</span>
                        </div>
                        <div class="template-category-items">
                            ${category.items.map(item => `
                                <div class="template-option" onclick="selectTemplateOption(this)">
                                    ${item}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            modal.classList.add('active');
        }

        // Close Template Modal
        function closeTemplateModal() {
    const modal = document.getElementById('templateModal');
    if (modal) {
        modal.classList.remove('active');
        // Reset all category items to closed state
        document.querySelectorAll('.template-category-items').forEach(item => {
            item.classList.remove('open');
        });
        // Reset all arrows to down position
        document.querySelectorAll('.template-category-header span:last-child').forEach(arrow => {
            arrow.textContent = '▼';
        });
    }
}

// Close template modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('templateModal');
    const templateBtn = document.getElementById('templateBtn');
    const modalContent = document.querySelector('.template-modal-content');
    
    if (modal && modal.classList.contains('active')) {
        if (!modalContent.contains(event.target) && event.target !== templateBtn) {
            closeTemplateModal();
        }
    }
});

// Close contact details modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('contactDetailsModal');
    const modalContent = modal?.querySelector('.modal-content');
    const headerBtn = document.getElementById('contactDetailsHeaderBtn');
    
    if (modal && modal.classList.contains('active')) {
        if (!modalContent.contains(event.target) && event.target !== headerBtn) {
            closeContactDetailsModal();
        }
    }
});

// Close contact details modal on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('contactDetailsModal');
        if (modal && modal.classList.contains('active')) {
            closeContactDetailsModal();
        }
    }
});
        // Select Template Option
        // Select Template Option
        function selectTemplateOption(element) {
            const input = document.getElementById('chatMessageInput');
            const sendBtn = document.getElementById('sendBtn');
            const templateBtn = document.getElementById('templateBtn');
            
            // Set the message
            input.value = element.textContent.trim();
            
            // Show send button, hide template button
            if (input.value.trim().length > 0) {
                sendBtn.classList.add('show');
                templateBtn.classList.add('hide');
            }
            
            // Focus input
            input.focus();
            
            // IMPORTANT: Close modal immediately
            closeTemplateModal();
        }

        // Template Data
        const seekerTemplatesData = [
            {
                title: '💬 Initial Contact',
                items: [
                    'Hi! Can you provide more details about the service?',
                    'What is your availability for this work?',
                    'Can you share your experience with similar work?'
                ]
            },
            {
                title: '📅 Scheduling',
                items: [
                    'When can you start the work?',
                    'How long will it take to complete?',
                    'Can you come today or tomorrow?'
                ]
            },
            {
                title: '💰 Pricing',
                items: [
                    'What will be the estimated cost?',
                    'Do you charge for inspection/visit?',
                    'Is this price negotiable?'
                ]
            },
            {
                title: 'ℹ️ Additional Info',
                items: [
                    'Do you have the necessary tools and equipment?',
                    'Will you provide materials or should I arrange them?',
                    'Can you share photos of previous work?',
                    'Do you offer any warranty on your work?'
                ]
            },
            {
                title: '🤝 Contact & Finalization',
                items: [
                    'Let\'s finalize this deal. Can we exchange contact details?',
                    'I\'d like to proceed with you. When can we meet?',
                    'Sounds good! Please share your contact number.'
                ]
            }
        ];

        const providerTemplatesData = [
            {
                title: '👋 Response',
                items: [
                    'Hi! I\'m available and interested in this work.',
                    'I have experience in this type of work. Happy to help!',
                    'I can start immediately. Let me know if you\'d like to proceed.'
                ]
            },
            {
                title: '💰 Pricing',
                items: [
                    'The estimated cost will be around ₹XXX.',
                    'I can provide a detailed quote after inspection.',
                    'No charges for initial visit and inspection.'
                ]
            },
            {
                title: 'ℹ️ Information Requests',
                items: [
                    'Can you share more details or photos of the problem?',
                    'What is your preferred time for the visit?',
                    'Are there any specific requirements I should know about?'
                ]
            },
            {
                title: '🤝 Contact & Finalization',
                items: [
                    'I\'m ready to start. Can we exchange contact details?',
                    'Please share your address so I can visit.',
                    'Let\'s finalize the schedule. Here\'s my contact number.'
                ]
            },
            {
                title: '✅ Service Completion',
                items: [
                    'Work completed successfully. Please check and confirm.',
                    'Everything is done. Let me know if you need any adjustments.',
                    'The service is complete. Feel free to contact me during warranty period.'
                ]
            }
        ];

        // Request Contact Sharing
       async function requestContactSharing() {
    if (!confirm('📞 REQUEST CONTACT SHARING?\n\n⚠️ WARNING: If approved, BOTH parties will see:\n• Phone number\n• Full address\n\n🔒 Contact info will be visible ONLY after the other person approves.\n\nDo you want to send this request?')) return;
    try {
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .maybeSingle();
        
        let messages = existingChat?.messages || [];
        
        // Check if contact request already exists
        const existingRequest = messages.find(m => 
            m.message_type === 'contact_request' && 
            m.contact_request_status === 'pending'
        );
        
        if (existingRequest) {
            alert('⚠️ Contact sharing request already sent! Waiting for response.');
            return;
        }
        
        // Add contact request message with special type
        const contactRequestMessage = {
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: '📞 Requesting to share contact information for finalizing the deal.',
            message_type: 'contact_request',
            contact_request_status: 'pending',
            timestamp: new Date().toISOString()
        };
        
        messages.push(contactRequestMessage);
        
        const { error: upsertError } = await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        if (upsertError) throw upsertError;
        
        await loadChatMessages();
        alert('✅ Contact sharing request sent! The other person will see it in the chat.');
        
    } catch (error) {
        alert('❌ Error sending contact request: ' + error.message);
        console.error('Contact sharing error:', error);
    }
}

	// Approve Contact Sharing
async function approveContactSharing(messageIndex) {
    // Add confirmation dialog
    if (!confirm('⚠️ SHARE YOUR CONTACT INFORMATION?\n\n📱 This will share:\n• Your phone number\n• Your full address\n\nThe other person will be able to see this information immediately.\n\nDo you want to proceed?')) {
        return;
    }
    
    try {
        const { data: existingChat, error: fetchError } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        if (fetchError) throw fetchError;
        
        let messages = existingChat?.messages || [];
        
        // Update the request message status
        if (messages[messageIndex]) {
            messages[messageIndex].contact_request_status = 'approved';
        } else {
            throw new Error('Contact request message not found');
        }
        
        // Add approval notification message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: '✅ Contact sharing approved! Contact details are now visible to both parties.',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        const { error: updateError } = await supabase
            .from('chats')
            .update({
                messages: messages
            })
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId);
        
        if (updateError) throw updateError;
        
        // Verify the update was successful
        const { data: verifyChat, error: verifyError } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        if (verifyError) throw new Error('Failed to verify approval was saved');
        
        // Check if the approval was saved
        const approvalSaved = verifyChat?.messages?.some(m => 
            m.message_type === 'system' && 
            m.message.includes('Contact sharing approved')
        );
        
        if (!approvalSaved) throw new Error('Approval not saved properly');
        
        await loadChatMessages();
        alert('✅ Contact information is now shared with both parties!');
        
    } catch (error) {
        alert('❌ Error approving contact sharing: ' + error.message);
        console.error('Approval error:', error);
    }
}

// Decline Contact Sharing
async function declineContactSharing(messageIndex) {
    if (!confirm('Decline contact sharing request?')) return;
    
    try {
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Update the request message status
        if (messages[messageIndex]) {
            messages[messageIndex].contact_request_status = 'declined';
        }
        
        // Add decline notification message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: '❌ Contact sharing request declined.',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .update({
                messages: messages
            })
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId);
        
        await loadChatMessages();
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
        // Show Warranty Form
        async function showWarrantyForm() {
            // Security check: Only selected provider can show warranty form
            if (!currentChatData.isProvider) {
                alert('❌ Only the service provider can mark work as complete.');
                return;
            }
            
            // Verify this provider is the selected one
            const { data: request } = await supabase
                .from('requests')
                .select('selected_provider_id, status')
                .eq('id', currentChatData.requestId)
                .single();
            
            if (!request) {
                alert('❌ Request not found.');
                return;
            }
            
            if (request.selected_provider_id !== currentProfile.user_id) {
                alert('❌ You are not the selected provider for this request.');
                return;
            }
            
            if (request.status !== 'in_progress') {
                alert('❌ This request is not in progress.');
                return;
            }
            
            // All checks passed - show the form
            document.getElementById('warrantyForm').classList.remove('hidden');
        }
// Complete Work
async function completeWork() {
    const selectedWarranty = document.querySelector('input[name="warranty"]:checked');
    
    if (!selectedWarranty) {
        alert('Please select a warranty period');
        return;
    }
    
    if (!confirm('Send completion request to the customer?\n\nThe customer will review your work and can approve or reject the completion.')) return;
    
    try {
        const warrantyDays = parseInt(selectedWarranty.value);
        const warrantyEndDate = new Date();
        warrantyEndDate.setDate(warrantyEndDate.getDate() + warrantyDays);
        
        const { error } = await supabase
            .from('requests')
            .update({
                status: 'pending_completion',
                warranty_period: warrantyDays,
                warranty_end_date: warrantyEndDate.toISOString()
            })
            .eq('id', currentChatData.requestId);
        
        if (error) throw error;
        
        // Send completion message
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: `✅ Provider has completed the work and is offering ${warrantyDays === 0 ? 'no warranty' : warrantyDays + ' days warranty'}.\n\n⏳ Waiting for customer approval...`,
            message_type: 'completion_request',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        alert('✅ Completion request sent! The customer will review and approve your work.');
        document.getElementById('warrantyForm').classList.add('hidden');
        document.getElementById('markCompleteBtn').style.display = 'none';
        document.getElementById('chatRequestStatus').textContent = 'PENDING APPROVAL';
        currentChatData.requestStatus = 'pending_completion';
        await loadChatMessages();
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Accept Completion (Seeker)
async function acceptCompletion() {
    if (!confirm('✅ Accept work completion?\n\nThis will mark the request as completed and you can rate the provider.')) return;
    
    try {
        // Update request status to completed
        const { error: updateError } = await supabase
            .from('requests')
            .update({ status: 'completed' })
            .eq('id', currentChatData.requestId);
        
        if (updateError) throw updateError;
        
        // Add system message
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: '✅ Work completion accepted by customer. Request is now completed!',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        // Hide accept/reject buttons
        document.getElementById('acceptCompletionBtn').style.display = 'none';
        document.getElementById('rejectCompletionBtn').style.display = 'none';
        
        // Update chat status display
        document.getElementById('chatRequestStatus').textContent = 'COMPLETED';
        currentChatData.requestStatus = 'completed';
        
        await loadChatMessages();
        
        // Open rating modal
        alert('✅ Work completion accepted! Please rate the provider.');
        openRatingModal(currentChatData.requestId, currentChatData.providerId, currentChatData.partnerName);
        
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}

// Reject Completion (Seeker)
async function rejectCompletion() {
    const reason = prompt('❌ Reject work completion?\n\nPlease provide a reason for rejection (the provider will see this):');
    
    if (!reason || reason.trim() === '') return;
    
    try {
        // Update request status back to in_progress
        const { error: updateError } = await supabase
            .from('requests')
            .update({ status: 'in_progress' })
            .eq('id', currentChatData.requestId);
        
        if (updateError) throw updateError;
        
        // Add system message with rejection reason
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: `❌ Work completion rejected by customer.\n\nReason: ${reason.trim()}\n\nPlease continue working to resolve the issues.`,
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages
            }, { onConflict: 'request_id,provider_id' });
        
        // Hide accept/reject buttons
        document.getElementById('acceptCompletionBtn').style.display = 'none';
        document.getElementById('rejectCompletionBtn').style.display = 'none';
        
        // Update chat status display
        document.getElementById('chatRequestStatus').textContent = 'IN PROGRESS';
        currentChatData.requestStatus = 'in_progress';
        
        await loadChatMessages();
        
        alert('❌ Completion rejected. The provider can see your feedback and will continue working.');
        
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}           

        // View Responses
        async function viewResponses(requestId) {
            selectedResponseRequest = requestId;
            
            try {
                const { data: responses, error } = await supabase
                    .from('request_responses')
                    .select('*, provider_id')
                    .eq('request_id', requestId);
                
                if (error) throw error;
                
                if (!responses || responses.length === 0) {
                    document.getElementById('responsesList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-text">No responses yet</div>
                        </div>
                    `;
			chatOpenedFrom = 'responses-modal'; 
                    document.getElementById('responsesModal').classList.add('active');
                    return;
                }
                
                let html = '';
                
                for (let response of responses) {
                    const { data: provider } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('user_id', response.provider_id)
                        .single();
                    
                    let ratingDisplay = 'No ratings yet';
    if (provider.average_rating && provider.average_rating > 0 && provider.total_ratings > 0) {
        const stars = '⭐'.repeat(Math.round(provider.average_rating));
        ratingDisplay = `${stars} ${provider.average_rating}/5 (${provider.total_ratings} ${provider.total_ratings === 1 ? 'rating' : 'ratings'})`;
    }
                    
                    const { data: request } = await supabase
                        .from('requests')
                        .select('request_latitude, request_longitude')
                        .eq('id', requestId)
                        .single();
                    
                    const distance = calculateDistance(
    provider.latitude,          // ← Provider first
    provider.longitude,
    request.request_latitude,   // ← Request second
    request.request_longitude
);
                    
                    const respondedTime = new Date(response.created_at);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - respondedTime) / 60000);
                    const timeAgo = diffMinutes < 1 ? 'Just now' : 
                                   diffMinutes < 60 ? `${diffMinutes} min ago` :
                                   diffMinutes < 1440 ? `${Math.floor(diffMinutes/60)} hours ago` :
                                   `${Math.floor(diffMinutes/1440)} days ago`;
                    
                   const photoHTML = provider.profile_photo 
    ? `<img src="${provider.profile_photo}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #667eea; margin-bottom: 12px;">`
    : `<div style="width: 60px; height: 60px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 12px;">👤</div>`;

// Check if this provider is selected
                    const { data: requestDetails } = await supabase
                        .from('requests')
                        .select('selected_provider_id, status')
                        .eq('id', requestId)
                        .single();
                    
                    const isSelected = requestDetails?.selected_provider_id === response.provider_id;
                    const requestStatus = requestDetails?.status;
                    
                    // Show different buttons based on selection status
                    let actionButtons = '';
                    
                    if (isSelected) {
                        // Selected provider - always show chat button
                        actionButtons = `
                            <button class="btn btn-view-profile" onclick="viewProviderProfile('${response.provider_id}')">View Profile</button>
                            <button class="btn btn-chat" onclick="closeResponsesModal(); openChat('${requestId}', '${response.provider_id}')">💬 Chat</button>
                        `;
                    } else {
                        // Not selected - show view profile and select button
                        actionButtons = `
                            <button class="btn btn-view-profile" onclick="viewProviderProfile('${response.provider_id}')">View Profile</button>
                            <button class="btn btn-chat" onclick="closeResponsesModal(); openChat('${requestId}', '${response.provider_id}')">💬 Chat</button>
                            <button class="btn btn-select" onclick="selectProvider('${requestId}', '${response.provider_id}')">Select Provider</button>
                        `;
                    }
                    
                    html += `
                        <div class="provider-card">
        <div style="text-align: center;">${photoHTML}</div>
        <div class="provider-name">${provider.name}${isSelected ? ' <span style="color: #667eea; font-weight: bold;">✓ SELECTED</span>' : ''}</div>
        <div class="provider-info">📍 Distance: ${distance} km away</div>
        <div class="provider-info">🕒 Responded: ${timeAgo}</div>
        <div class="rating-display">${ratingDisplay}</div>
        <div class="provider-actions">
            ${actionButtons}
        </div>
    </div>
`;
                }
                
                document.getElementById('responsesList').innerHTML = html;

// Mark that we're in responses modal
chatOpenedFrom = 'responses-modal';
document.getElementById('responsesModal').classList.add('active');
            } catch (error) {
                alert('Error loading responses: ' + error.message);
            }
        }

        // Calculate Distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return parseFloat((R * c).toFixed(2));
        }

        // View Provider Profile
        async function viewProviderProfile(providerId) {
            try {
                const { data: provider } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', providerId)
                    .single();
                
                const { data: services } = await supabase
                    .from('provider_services')
                    .select('service_id')
                    .eq('provider_id', providerId);
                
                const serviceList = services && services.length > 0 
                    ? services.map(s => s.service_id).join(', ')
                    : 'No services listed';
                
                const addr = [provider.house_number, provider.area_name, provider.landmark, provider.city, provider.state, provider.pin_code].filter(Boolean).join(', ');
                
                let ratingDisplay = 'No ratings yet';
let ratingDetailsHTML = '';

if (provider.average_rating && provider.average_rating > 0 && provider.total_ratings > 0) {
    const stars = '⭐'.repeat(Math.round(provider.average_rating));
    ratingDisplay = `${stars} ${provider.average_rating}/5 (${provider.total_ratings} ${provider.total_ratings === 1 ? 'rating' : 'ratings'})`;
    
    // Still fetch review details for display
    const { data: ratings } = await supabase
        .from('ratings')
        .select('rating, review, created_at')
        .eq('provider_id', providerId)
        .order('created_at', { ascending: false });
    
    if (ratings && ratings.length > 0) {
        ratingDetailsHTML = '<hr style="margin: 20px 0;"><h3 style="margin-bottom: 15px;">Recent Reviews:</h3>';
        ratings.slice(0, 3).forEach(r => {
            const reviewStars = '⭐'.repeat(r.rating);
            const reviewDate = new Date(r.created_at).toLocaleDateString();
            ratingDetailsHTML += `
                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${reviewStars} ${r.rating}/5</div>
                    ${r.review ? `<p style="color: #555; margin-bottom: 5px;">"${r.review}"</p>` : ''}
                    <p style="font-size: 12px; color: #999;">${reviewDate}</p>
                </div>
            `;
        });
    }
}
                
                const photoHTML = provider.profile_photo 
                    ? `<div style="text-align: center; margin-bottom: 20px;">
                        <img src="${provider.profile_photo}" 
                             onclick="openImagePreview('${provider.profile_photo}')" 
                             style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; cursor: pointer; transition: transform 0.2s;" 
                             onmouseover="this.style.transform='scale(1.05)'" 
                             onmouseout="this.style.transform='scale(1)'">
                        <p style="font-size: 12px; color: #999; margin-top: 8px;">Click photo to view full size</p>
                       </div>`
                    : `<div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 150px; height: 150px; border-radius: 50%; background: #e0e0e0; display: inline-flex; align-items: center; justify-content: center; font-size: 64px; border: 4px solid #667eea;">👤</div>
                       </div>`;
                
                document.getElementById('profileContent').innerHTML = `
                    ${photoHTML}
                    <div class="profile-details">
                        <p><strong>👤 Name:</strong> ${provider.name}</p>
                        <p><strong>⭐ Rating:</strong> ${ratingDisplay}</p>
                        <p><strong>🔧 Services:</strong> ${serviceList}</p>
                        <p><strong>📍 Address:</strong> ${addr}</p>
                        <p><strong>📌 Note:</strong> Phone number and full contact details will be shared after both parties agree to connect.</p>
                        ${ratingDetailsHTML}
                    </div>
                `;
                
                document.getElementById('profileModal').classList.add('active');
            } catch (error) {
                alert('Error loading profile: ' + error.message);
            }
        }

        // Select Provider
        async function selectProvider(requestId, providerId) {
            if (!confirm('Select this provider? This will change request status to "In Progress" and open chat.')) return;
            
            try {
                const { error } = await supabase
                    .from('requests')
                    .update({ 
                        selected_provider_id: providerId, 
                        status: 'in_progress' 
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                closeResponsesModal();
                closeProfileModal();
                
                alert('✅ Provider selected! Opening chat...');
                await openChat(requestId, providerId);
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Close Modals
function closeResponsesModal() {
    document.getElementById('responsesModal').classList.remove('active');
}

function closeResponsesModalAndGoBack() {
    document.getElementById('responsesModal').classList.remove('active');
    showDashboard();
}

function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('active');
}

// Load Provider Responses
        async function loadProviderResponses() {
    try {
        // Get all responses by this provider
        const { data: responses, error: respError } = await supabase
            .from('request_responses')
            .select('*')
            .eq('provider_id', currentProfile.user_id)
            .order('created_at', { ascending: false });
        
        if (respError) throw respError;
        
        if (!responses || responses.length === 0) {
            document.getElementById('myResponsesList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">💬</div>
                    <div class="empty-state-text">No responses yet. Respond to nearby requests to start!</div>
                </div>
            `;
            document.getElementById('myResponsesTotal').textContent = '0';
            document.getElementById('myResponsesNew').classList.add('hidden');
            return;
        }
        
        // Get full request details for each response
        const requestIds = responses.map(r => r.request_id);
        const { data: requests, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .in('id', requestIds);
        
        if (reqError) throw reqError;
        
        // Get seeker profiles
        const userIds = requests.map(r => r.user_id);
        const { data: seekers, error: seekerError } = await supabase
            .from('profiles')
            .select('user_id, name')
            .in('user_id', userIds);
        
        if (seekerError) throw seekerError;
        
        // Check for unread messages in each chat
        const chatChecks = await Promise.all(responses.map(async (response) => {
            const { data: chat } = await supabase
                .from('chats')
                .select('messages, seeker_last_viewed_at, provider_last_viewed_at')
                .eq('request_id', response.request_id)
                .eq('provider_id', currentProfile.user_id)
                .single();
            
            if (!chat || !chat.messages) return { requestId: response.request_id, hasMessages: false, unreadCount: 0 };
            
            // Get last viewed time for provider
const lastViewedAt = chat.provider_last_viewed_at;

// Count only messages AFTER last viewed time
const unreadCount = chat.messages.filter(m => 
    m.sender_id !== currentProfile.user_id &&
    (!lastViewedAt || new Date(m.timestamp) > new Date(lastViewedAt))
).length;
            
            return { 
                requestId: response.request_id, 
                hasMessages: chat.messages.length > 0,
                unreadCount: unreadCount
            };
        }));
        
        // Combine all data - EXCLUDE missed opportunities (they now belong in Work Opportunities)
const combinedData = responses.map(response => {
    const request = requests.find(r => r.id === response.request_id);
    
    // Skip if request was deleted or invalid
    if (!request || !request.request_latitude || !request.request_longitude) {
        return null;
    }
    
    // Check if this is a "missed opportunity"
    const isMissedOpportunity = (request.status === 'in_progress' || request.status === 'completed' || request.status === 'pending_completion') && 
                               request.selected_provider_id !== currentProfile.user_id;
    
    // CRITICAL: Skip missed opportunities - they belong in Work Opportunities section now
    if (isMissedOpportunity) {
        return null;
    }
    
    const seeker = seekers.find(s => s.user_id === request.user_id);
    const chatInfo = chatChecks.find(c => c.requestId === response.request_id);
    
    return {
        ...response,
        request: request,
        seekerName: seeker?.name || 'Unknown',
        hasMessages: chatInfo?.hasMessages || false,
        unreadCount: chatInfo?.unreadCount || 0
    };
}).filter(data => data !== null);

// Pass only active responses to display function (no missed opportunities)
await displayProviderResponses(combinedData);

// Update total badge (only active responses, excluding missed)
document.getElementById('myResponsesTotal').textContent = combinedData.length;
        
    } catch (error) {
        console.error('Error loading provider responses:', error);
    } 
}

async function displayProviderResponses(activeResponses) {
    const container = document.getElementById('myResponsesList');
    
    // Check if no active responses
    if (!activeResponses || activeResponses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">💬</div>
                <div class="empty-state-text">No responses yet. Respond to nearby requests to start!</div>
            </div>
        `;
        document.getElementById('myResponsesTotal').textContent = '0';
        const myResponsesNewEl = document.getElementById('myResponsesNew');
        if (myResponsesNewEl) {
            myResponsesNewEl.classList.add('hidden');
            myResponsesNewEl.style.display = 'none';
        }
        return;
    }
    
    // NEW LOGIC: Separate into 4 categories
    const activeNegotiating = activeResponses.filter(r => 
        r.request.status === 'open' // Still negotiating, not selected yet
    );
    
    const inProgress = activeResponses.filter(r => 
        r.request.status === 'in_progress' && 
        !r.request.warranty_end_date // In progress but NOT reactivated
    );
    
    const reactivated = activeResponses.filter(r => 
        r.request.status === 'in_progress' && 
        r.request.warranty_end_date // In progress AND was completed before (has warranty date)
    );
    
    const completedResponses = activeResponses.filter(r => 
        r.request.status === 'completed'
    );
    
    // NEW: Add sub-tabs for Active, In Progress, Reactivated, Completed
    let tabsHTML = '<div class="sub-tabs" style="margin-bottom: 20px;">';
    
    // Tab 1: Active (Negotiating)
    if (activeNegotiating.length > 0) {
        tabsHTML += `<button class="sub-tab ${currentResponseFilter === 'active' ? 'active' : ''}" onclick="filterResponses('active')">🔄 Active <span class="count-badge">${activeNegotiating.length}</span></button>`;
    }
    
    // Tab 2: In Progress
    if (inProgress.length > 0) {
        tabsHTML += `<button class="sub-tab ${currentResponseFilter === 'in_progress' ? 'active' : ''}" onclick="filterResponses('in_progress')">⚙️ In Progress <span class="count-badge">${inProgress.length}</span></button>`;
    }
    
    // Tab 3: Reactivated
    if (reactivated.length > 0) {
        tabsHTML += `<button class="sub-tab ${currentResponseFilter === 'reactivated' ? 'active' : ''}" onclick="filterResponses('reactivated')">🔁 Reactivated <span class="count-badge">${reactivated.length}</span></button>`;
    }
    
    // Tab 4: Completed
    if (completedResponses.length > 0) {
        tabsHTML += `<button class="sub-tab ${currentResponseFilter === 'completed' ? 'active' : ''}" onclick="filterResponses('completed')">✅ Completed <span class="count-badge">${completedResponses.length}</span></button>`;
    }
    
    tabsHTML += '</div>';
    
    // NEW: Determine which data to show based on filter
    let responsesData = activeNegotiating; // Default to Active
    
    if (currentResponseFilter === 'active') {
        responsesData = activeNegotiating;
    } else if (currentResponseFilter === 'in_progress') {
        responsesData = inProgress;
    } else if (currentResponseFilter === 'reactivated') {
        responsesData = reactivated;
    } else if (currentResponseFilter === 'completed') {
        responsesData = completedResponses;
    }
    
    // NEW: If filtered data is empty, show empty state
    if (!responsesData || responsesData.length === 0) {
        let emptyIcon = '💬';
        let emptyText = 'active responses';
        
        if (currentResponseFilter === 'active') {
            emptyIcon = '🔄';
            emptyText = 'active negotiating requests';
        } else if (currentResponseFilter === 'in_progress') {
            emptyIcon = '⚙️';
            emptyText = 'in progress requests';
        } else if (currentResponseFilter === 'reactivated') {
            emptyIcon = '🔁';
            emptyText = 'reactivated requests';
        } else if (currentResponseFilter === 'completed') {
            emptyIcon = '✅';
            emptyText = 'completed requests';
        }
        
        container.innerHTML = tabsHTML + `
            <div class="empty-state">
                <div class="empty-state-icon">${emptyIcon}</div>
                <div class="empty-state-text">No ${emptyText} yet</div>
            </div>
        `;
        return;
    }
    
    // Count unread messages from ALL active responses (not just in progress)
const totalUnread = activeResponses.reduce((sum, d) => sum + (d.unreadCount || 0), 0);
    
    // Update section badges - show total unread count with chat bubble icon
    const myResponsesNewEl = document.getElementById('myResponsesNew');
    if (myResponsesNewEl) {
        if (totalUnread > 0) {
            const unreadBadge = myResponsesNewEl.querySelector('.unread-badge');
            if (unreadBadge) {
                unreadBadge.textContent = totalUnread;
            }
            myResponsesNewEl.classList.remove('hidden');
            myResponsesNewEl.style.display = 'inline-flex';
        } else {
            myResponsesNewEl.classList.add('hidden');
            myResponsesNewEl.style.display = 'none';
        }
    }
    
    let html = tabsHTML; // Start with tabs
    
    for (let data of responsesData) {
        const req = data.request;
        if (!req) continue;
        
        const icon = SERVICE_ICONS[req.service_category] || '🔧';
        const timeAgo = getTimeAgo(new Date(data.created_at));
        
        // Determine status
        let statusBadge = '';
        let chatButton = '';

        if (data.isMissedOpportunity) {
            // Read-only chat button
            chatButton = `<button class="btn btn-chat action-btn-compact" style="background: #6c757d;" onclick="openChat('${req.id}', '${currentProfile.user_id}')">👁️ View Chat</button>`;
        } else {
            // Active response - normal buttons with unread badge
            const unreadBadgeHTML = data.unreadCount > 0 ? `<span class="chat-unread-badge">${data.unreadCount}</span>` : '';
            
            if (req.status === 'completed') {
                statusBadge = '<span class="status-badge status-completed">✅ COMPLETED</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">👁️ View Chat</button>${unreadBadgeHTML}</div>`;
            } else if (req.status === 'pending_completion' && req.selected_provider_id === currentProfile.user_id) {
                statusBadge = '<span class="status-badge" style="background: #fff3cd; color: #856404;">⏳ PENDING APPROVAL</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">💬 Chat</button>${unreadBadgeHTML}</div>`;
            } else if (req.status === 'in_progress' && req.selected_provider_id === currentProfile.user_id) {
                statusBadge = '<span class="status-badge" style="background: #cce5ff; color: #004085;">🔄 IN PROGRESS</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">💬 Chat</button>${unreadBadgeHTML}</div>`;
            } else if (req.status === 'open') {
                statusBadge = '<span class="status-badge status-open">⏳ PENDING</span>';
                chatButton = `<div class="chat-btn-wrapper"><button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">💬 Chat</button>${unreadBadgeHTML}</div>`;
            }
        }
        
        // Calculate remaining warranty if completed
        let warrantyBadge = '';
        if (req.status === 'completed' && req.warranty_end_date) {
            // Only show warranty if this provider is the SELECTED provider who did the work
            if (req.selected_provider_id === currentProfile.user_id) {
                const warrantyEndDate = new Date(req.warranty_end_date);
                const today = new Date();
                const remainingDays = Math.ceil((warrantyEndDate - today) / (1000 * 60 * 60 * 24));
                
                if (remainingDays > 0) {
                    warrantyBadge = `<span class="info-badge" style="background: #28a745;">🛡️ ${remainingDays} day${remainingDays > 1 ? 's' : ''} warranty</span>`;
                } else if (remainingDays === 0) {
                    warrantyBadge = `<span class="info-badge" style="background: #ffc107; color: #333;">🛡️ Warranty expires today</span>`;
                } else {
                    warrantyBadge = `<span class="info-badge" style="background: #dc3545;">🛡️ Warranty expired</span>`;
                }
            }
        }
        
        const distance = calculateDistance(
            currentProfile.latitude,
            currentProfile.longitude,
            req.request_latitude,
            req.request_longitude
        );
        
        html += `
            <div class="request-card compact">
                <div class="request-card-main">
                    <div class="request-card-left">
                        <div class="request-title-compact" onclick="toggleRequestDetails(event, 'resp-${req.id}')">
                            <span class="urgency-bubble ${req.urgency}"></span>
                            <span class="request-title-text">${icon} ${req.title}</span>
                            <span class="request-chevron" id="chevron-resp-${req.id}">▼</span>
                        </div>
                        <div class="request-summary">
                            ${statusBadge}                                                                    
                            ${warrantyBadge}
                        </div>
                        <div class="request-summary" style="margin-top: 6px; color: #999;">
                            👤 ${data.seekerName} • 📍 ${distance} km • 🕒 ${timeAgo}
                        </div>
                    </div>
                    <div class="request-card-right">
                        ${chatButton}
                    </div>
                </div>
                <div class="request-details" id="details-resp-${req.id}">
                    <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                    <div class="request-location" style="margin-top: 8px;"><strong>Location:</strong> ${req.request_location_address}</div>
                    <div class="request-meta" style="margin-top: 8px;">
                        <span class="meta-item">🔧 Service: ${req.service_category}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

        // Load Nearby Requests (Provider View)
async function loadNearbyRequests() {
    try {
        // Step 1: Get all open requests
        const { data: allRequests, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .eq('status', 'open');
        
        if (reqError) throw reqError;

        // Step 2: Get provider's responses to filter them out
        const { data: myResponses, error: respError } = await supabase
            .from('request_responses')
            .select('request_id')
            .eq('provider_id', currentProfile.user_id);
        
        if (respError) throw respError;
        
        const respondedIds = new Set((myResponses || []).map(r => r.request_id));

        const nearby = [];
        
        // Step 3: Filter requests
        for (let req of allRequests || []) {
            // Skip if already responded
            if (respondedIds.has(req.id)) continue;
            
            // Calculate distance
            const distance = calculateDistance(
                currentProfile.latitude,
                currentProfile.longitude,
                req.request_latitude,
                req.request_longitude
            );
            
            // Check if provider offers this service
            const { data: providerServices } = await supabase
                .from('provider_services')
                .select('*')
                .eq('provider_id', currentProfile.user_id)
                .eq('service_id', req.service_category);

            if (!providerServices || providerServices.length === 0) continue;
            
            const serviceRadius = providerServices[0].service_radius;
            
            // Check if within service radius
            if (distance <= serviceRadius) {
                nearby.push({
                    ...req,
                    distance: distance,
                    serviceRadius: serviceRadius
                });
            }
        }

        // Step 4: Get missed opportunities
        const { data: allRespondedRequests, error: allReqError } = await supabase
            .from('requests')
            .select('*')
            .in('id', Array.from(respondedIds));

        if (allReqError) throw allReqError;

        const missedOpportunities = [];

        for (let req of allRespondedRequests || []) {
            const isMissed = (req.status === 'in_progress' || req.status === 'completed' || req.status === 'pending_completion') && 
                             req.selected_provider_id !== currentProfile.user_id;
            
            if (isMissed && req.request_latitude && req.request_longitude) {
                const distance = calculateDistance(
                    currentProfile.latitude,
                    currentProfile.longitude,
                    req.request_latitude,
                    req.request_longitude
                );
                
                missedOpportunities.push({
                    ...req,
                    distance: distance
                });
            }
        }

        // Step 5: Update badges
        const availableCount = nearby.length;
        const totalElement = document.getElementById('availableWorkTotal');
        const newElement = document.getElementById('availableWorkNew');

        if (totalElement) totalElement.textContent = availableCount;

        const lastOpenedAt = currentProfile.available_work_last_opened_at;
        let newCount = 0;

        if (!lastOpenedAt) {
            newCount = nearby.length;
        } else {
            const lastOpenedDate = new Date(lastOpenedAt);
            newCount = nearby.filter(r => {
                const requestCreatedAt = new Date(r.created_at);
                return requestCreatedAt > lastOpenedDate;
            }).length;
        }

        if (newElement) {
            if (newCount > 0) {
                newElement.textContent = `🆕 ${newCount}`;
                newElement.classList.remove('hidden');
                newElement.style.display = 'inline-block';
            } else {
                newElement.classList.add('hidden');
                newElement.style.display = 'none';
            }
        }

        // Step 6: CALL the display function (not define it)
        displayNearbyRequests(nearby, missedOpportunities);
        
    } catch (error) {
        console.error('Error loading nearby requests:', error);
    }
}

// Step 6: Pass both available and missed to display function
async function displayNearbyRequests(availableRequests, missedRequests) {
    const container = document.getElementById('nearbyRequestsList');
const tabsContainer = document.getElementById('urgencyTabs');

// Handle empty state for both available and missed
if ((!availableRequests || availableRequests.length === 0) && (!missedRequests || missedRequests.length === 0)) {
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">💼</div>
            <div class="empty-state-text">No work opportunities available</div>
        </div>
    `;
    tabsContainer.innerHTML = '';
    document.getElementById('availableWorkTotal').textContent = '0';
    document.getElementById('availableWorkNew').classList.add('hidden');
    return;
}

// Determine which data to show based on current filter
let requests = availableRequests || [];
if (window.currentWorkFilter === 'missed') {
    requests = missedRequests || [];
}

    // Count by urgency for tabs
    const urgentCount = requests.filter(r => r.urgency === 'urgent').length;
    const normalCount = requests.filter(r => r.urgency === 'normal').length;
    const flexibleCount = requests.filter(r => r.urgency === 'low').length;
    const newCount = requests.filter(r => {
        const hoursSince = (new Date() - new Date(r.created_at)) / (1000 * 60 * 60);
        return hoursSince < 2;
    }).length;

    // Update section badges
    document.getElementById('availableWorkTotal').textContent = requests.length;
    if (newCount > 0) {
        document.getElementById('availableWorkNew').textContent = `🆕 ${newCount}`;
        document.getElementById('availableWorkNew').classList.remove('hidden');
    } else {
        document.getElementById('availableWorkNew').classList.add('hidden');
    }

    // Build subtabs for Available Work and Missed Opportunities
const availableCount = availableRequests ? availableRequests.length : 0;
const missedCount = missedRequests ? missedRequests.length : 0;
const currentFilter = window.currentWorkFilter || 'available';

let tabsHTML = '';

// Available Work tab
if (availableCount > 0) {
    tabsHTML += `<button class="sub-tab ${currentFilter === 'available' ? 'active' : ''}" onclick="filterWorkOpportunities('available')">📍 Available Work <span class="count-badge">${availableCount}</span></button>`;
}

// Missed Opportunities tab
if (missedCount > 0) {
    tabsHTML += `<button class="sub-tab ${currentFilter === 'missed' ? 'active' : ''}" onclick="filterWorkOpportunities('missed')">⛔ Missed Opportunities <span class="count-badge">${missedCount}</span></button>`;
}

tabsContainer.innerHTML = tabsHTML;

    // Filter by urgency
    let filteredRequests = requests;
    if (currentUrgencyFilter !== 'all') {
        filteredRequests = requests.filter(r => r.urgency === currentUrgencyFilter);
    }

    if (filteredRequests.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📍</div>
                <div class="empty-state-text">No ${currentUrgencyFilter} requests available</div>
            </div>
        `;
        return;
    }

    // Build HTML for requests
    let html = '';
    
    for (let req of filteredRequests) {
        const icon = SERVICE_ICONS[req.service_category] || '🔧';
        const timeAgo = getTimeAgo(new Date(req.created_at));                                         
        const newBadge = ((new Date() - new Date(req.created_at)) / (1000 * 60 * 60)) < 2 ? '<span class="info-badge">🆕 NEW</span>' : '';
        
        html += `
            <div class="request-card compact">
                <div class="request-card-main">
                    <div class="request-card-left">
                        <div class="request-title-compact" onclick="toggleRequestDetails(event, 'nearby-${req.id}')">
    <span class="urgency-bubble ${req.urgency}"></span>
    <span class="request-title-text">${icon} ${req.title}</span>
    <span class="request-chevron" id="chevron-nearby-${req.id}">▼</span>
</div>
                        <div class="request-summary">
    <span class="info-badge">📍 ${req.distance} km</span>
    ${newBadge}
</div>
                        <div class="request-summary" style="margin-top: 6px; color: #999;">
                            🕒 ${timeAgo} • 🔧 ${req.service_category}
                        </div>
                    </div>
                    <div class="request-card-right">
    <button class="btn btn-respond action-btn-compact" onclick="respondToRequest('${req.id}')">Respond</button>
</div>
                </div>
                <div class="request-details" id="details-nearby-${req.id}">
                    <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                    <div class="request-location" style="margin-top: 8px;"><strong>Location:</strong> ${req.request_location_address}</div>
                    <div class="request-meta" style="margin-top: 8px;">
                        <span class="meta-item">📏 Distance: ${req.distance} km</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}                		

// Respond to Request (Provider)
        async function respondToRequest(requestId) {
            const respondBtn = event.target;
            respondBtn.disabled = true;
            respondBtn.textContent = 'Checking...';
            
            try {
                const { data: existingResponse, error: checkError } = await supabase
                    .from('request_responses')
                    .select('id')
                    .eq('request_id', requestId)
                    .eq('provider_id', currentProfile.user_id);

                if (checkError) throw checkError;

                if (existingResponse && existingResponse.length > 0) {
                    alert('⚠️ You have already responded to this request!');
                    respondBtn.textContent = '✅ Responded';
                    respondBtn.style.background = '#6c757d';
                    respondBtn.disabled = false;
                    return;
                }

                const { error: insertError } = await supabase
                    .from('request_responses')
                    .insert([{
                        request_id: requestId,
                        provider_id: currentProfile.user_id,
                        status: 'pending',
                        availability: 'available',
                        response_message: `Hi! I am interested in providing this service.`
                    }]);

                if (insertError) throw insertError;

                alert('✅ Response sent successfully! The seeker will see your response and can chat with you.');

// Reload dashboard to move request from Available Work to My Responses
await loadProviderResponses();
await loadNearbyRequests();

// Change button to show "Responded"
respondBtn.textContent = '✅ Responded';
respondBtn.style.background = '#6c757d';
respondBtn.disabled = false;
                
            } catch (error) {
                alert('❌ Error: ' + error.message);
                respondBtn.disabled = false;
                respondBtn.textContent = 'Respond to Request';
            }
        }

        // Cancel Request
        async function cancelRequest(requestId) {
            if (!confirm('⚠️ Are you sure you want to cancel this request?')) return;
            
            try {
                const { error } = await supabase
                    .from('requests')
                    .delete()
                    .eq('id', requestId);
                
                if (error) throw error;
                
                alert('✅ Request cancelled successfully');
                loadUserRequests();
            } catch (error) {
                alert('Error cancelling request: ' + error.message);
            }
        }

// Reactivate Request (during warranty period)
        async function reactivateRequest(requestId) {
            if (!confirm('🔄 Reactivate this request?\n\nThe provider will be notified that you need service again within the warranty period. The same process will repeat.')) return;
            
            try {
                // Get request details to find selected provider
                const { data: request, error: reqError } = await supabase
                    .from('requests')
                    .select('selected_provider_id')
                    .eq('id', requestId)
                    .single();
                
                if (reqError || !request) throw reqError || new Error('Request not found');
                
                // Update request status
                const { error: updateError } = await supabase
                    .from('requests')
                    .update({
                        status: 'in_progress',
                        warranty_period: null,
                        warranty_end_date: null
                    })
                    .eq('id', requestId);
                
                if (updateError) throw updateError;
                
                // Add system message to chat
                const { data: existingChat } = await supabase
                    .from('chats')
                    .select('messages')
                    .eq('request_id', requestId)
                    .eq('provider_id', request.selected_provider_id)
                    .single();
                
                let messages = existingChat?.messages || [];
                
                messages.push({
                    sender_id: currentUser.id,
                    sender_name: currentProfile.name,
                    message: '🔄 Seeker has reactivated this request. Service needed again within warranty period.',
                    message_type: 'system',
                    timestamp: new Date().toISOString()
                });
                
                await supabase
                    .from('chats')
                    .upsert({
                        request_id: requestId,
                        provider_id: request.selected_provider_id,
                        messages: messages
                    }, { onConflict: 'request_id,provider_id' });
                
                alert('✅ Request reactivated! The provider will be notified.');
                loadUserRequests();
                
            } catch (error) {
                alert('Error reactivating request: ' + error.message);
            }
        }

// Edit Request - Load form with existing data
        async function editRequest(requestId) {
            try {
                showLoading();
                
                // Check if request has any responses
                const { data: responses } = await supabase
                    .from('request_responses')
                    .select('id')
                    .eq('request_id', requestId);
                
                if (responses && responses.length > 0) {
                    alert('⚠️ Cannot edit request after providers have responded. Please cancel and create a new request.');
                    showDashboard();
                    return;
                }
                
                // Load request data
                const { data: request, error } = await supabase
                    .from('requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (error) throw error;
                
                if (request.status !== 'open') {
                    alert('⚠️ Only open requests can be edited.');
                    showDashboard();
                    return;
                }
                
                // Show edit view and populate form
                hideAllViews();
                document.getElementById('editRequestView').classList.remove('hidden');
                
                // Populate form fields
                document.getElementById('editRequestId').value = request.id;
                document.getElementById('editServiceType').value = request.service_category;
                document.getElementById('editRequestTitle').value = request.title;
                document.getElementById('editRequestDescription').value = request.description;
                
                // Update character counters
                document.getElementById('editTitleCounter').textContent = request.title.length;
                document.getElementById('editDescCounter').textContent = request.description.length;
                
                // Set urgency
                document.getElementById('editUrgentRadio').checked = request.urgency === 'urgent';
                document.getElementById('editNormalRadio').checked = request.urgency === 'normal';
                document.getElementById('editLowRadio').checked = request.urgency === 'low';
                
                // Show current location (read-only)
                document.getElementById('currentLocationText').textContent = request.request_location_address;
                
            } catch (error) {
                alert('Error loading request: ' + error.message);
                showDashboard();
            }
        }

// Edit Request Form Submission
        document.getElementById('editRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('editRequestError');
            const infoDiv = document.getElementById('editRequestInfo');
            const submitBtn = document.getElementById('updateRequestBtn');

            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';

            try {
                const requestId = document.getElementById('editRequestId').value;
                const title = document.getElementById('editRequestTitle').value.trim();
                const description = document.getElementById('editRequestDescription').value.trim();
                const urgency = document.querySelector('input[name="editUrgency"]:checked').value;

                const updateData = {
                    title: title,
                    description: description,
                    urgency: urgency
                };

                infoDiv.textContent = '💾 Updating request...';
                infoDiv.classList.remove('hidden');
                const { error } = await supabase
                    .from('requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                infoDiv.classList.add('hidden');
                alert('✅ Request updated successfully!');
                showDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = '💾 Update Request';
                infoDiv.classList.add('hidden');
            }
        });

        // Create Request
        document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('createRequestError');
            const infoDiv = document.getElementById('createRequestInfo');
            const submitBtn = document.getElementById('submitRequestBtn');

            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';

            try {
                const serviceType = document.getElementById('serviceType').value;
                const title = document.getElementById('requestTitle').value.trim();
                const description = document.getElementById('requestDescription').value.trim();
                const urgency = document.querySelector('input[name="urgency"]:checked').value;

                const useDifferentLocation = document.getElementById('differentLocation').checked;
                let locationData;

                if (useDifferentLocation) {
                    const customLocation = {
                        area_name: document.getElementById('customAreaName').value.trim(),
                        landmark: document.getElementById('customLandmark').value.trim() || null,
                        city: document.getElementById('customCity').value,
                        state: document.getElementById('customState').value,
                        pin_code: document.getElementById('customPinCode').value.trim()
                    };

                    infoDiv.textContent = '📍 Finding service location...';
                    infoDiv.classList.remove('hidden');

                    const coords = await getCoordinates(customLocation);
                    
                    locationData = {
                        address: [customLocation.area_name, customLocation.landmark, customLocation.city, customLocation.state, customLocation.pin_code].filter(Boolean).join(', '),
                        latitude: coords.lat,
                        longitude: coords.lng
                    };
                } else {
                    locationData = {
                        address: [currentProfile.area_name, currentProfile.landmark, currentProfile.city, currentProfile.state, currentProfile.pin_code].filter(Boolean).join(', '),
                        latitude: currentProfile.latitude,
                        longitude: currentProfile.longitude
                    };
                }

                infoDiv.textContent = '💾 Creating request...';

                const { error } = await supabase.from('requests').insert([{
                    user_id: currentUser.id,
                    service_category: serviceType,
                    title: title,
                    description: description,
                    urgency: urgency,
                    request_location_address: locationData.address,
                    request_latitude: locationData.latitude,
                    request_longitude: locationData.longitude,
                    status: 'open',
                    chat_status: 'active'
                }]);

                if (error) throw error;

                infoDiv.classList.add('hidden');
                alert('✅ Request created successfully!');
                showDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Request';
                infoDiv.classList.add('hidden');
            }
        });

// Edit Profile Form Submission
document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const errorDiv = document.getElementById('editProfileError');
    const infoDiv = document.getElementById('editProfileInfo');
    const submitBtn = document.getElementById('saveProfileBtn');
    
    errorDiv.classList.add('hidden');
    infoDiv.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    try {
        const formData = {
            name: document.getElementById('editName').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            house_number: document.getElementById('editHouseNumber').value.trim() || null,
            area_name: document.getElementById('editAreaName').value.trim(),
            landmark: document.getElementById('editLandmark').value.trim() || null,
            city: document.getElementById('editCity').value,
            state: document.getElementById('editState').value,
            pin_code: document.getElementById('editPinCode').value.trim(),
            is_provider: currentProfile.is_provider,
            radius_km: parseInt(document.getElementById('editRadius').value)
        };
        
        // Handle profile photo update
        const photoFile = document.getElementById('editPhoto').files[0];
        if (photoFile) {
            if (photoFile.size > 2 * 1024 * 1024) {
                throw new Error('Profile photo size should be less than 2MB');
            }
            infoDiv.textContent = '📸 Uploading new profile photo...';
            infoDiv.classList.remove('hidden');
            formData.profile_photo = await convertImageToBase64(photoFile);
        } else {
            // Don't update photo if no file selected - keep existing
            delete formData.profile_photo;
        }
        
        // Check if address changed
        const addressChanged = 
            formData.area_name !== currentProfile.area_name ||
            formData.city !== currentProfile.city ||
            formData.state !== currentProfile.state ||
            formData.pin_code !== currentProfile.pin_code;
        
        if (addressChanged) {
            infoDiv.textContent = '📍 Updating location...';
            infoDiv.classList.remove('hidden');
            
            const coords = await getCoordinates(formData);
            formData.latitude = coords.lat;
            formData.longitude = coords.lng;
        }
        
        infoDiv.textContent = '💾 Saving profile...';
        infoDiv.classList.remove('hidden');
        
        // Update profile
        const { error: profileError } = await supabase
            .from('profiles')
            .update(formData)
            .eq('user_id', currentProfile.user_id);
        
        if (profileError) throw profileError;
        
        // If provider was toggled OFF, remove all services
        if (!formData.is_provider && currentProfile.is_provider) {
            const { error: deleteError } = await supabase
                .from('provider_services')
                .delete()
                .eq('provider_id', currentProfile.user_id);
            
            if (deleteError) throw deleteError;
        }
        
        // If radius changed, update all existing services
        if (formData.is_provider && formData.radius_km !== currentProfile.radius_km) {
            const { error: updateRadiusError } = await supabase
                .from('provider_services')
                .update({ service_radius: formData.radius_km })
                .eq('provider_id', currentProfile.user_id);
            
            if (updateRadiusError) throw updateRadiusError;
        }
        
        alert('✅ Profile updated successfully!');

// Re-enable button before redirect
submitBtn.disabled = false;
submitBtn.textContent = '💾 Save Changes';
infoDiv.classList.add('hidden');

// Reload profile data silently (without showing loading screen)
const { data, error } = await supabase.from('profiles').select('*').eq('user_id', currentUser.id).single();
if (!error) {
    currentProfile = data;
}

// ✅ CRITICAL: Hide edit profile view explicitly
const editView = document.getElementById('editProfileView');
if (editView) {
    editView.classList.add('hidden');
    editView.style.display = 'none';
}

// Go back to dashboard
showDashboard();
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = '💾 Save Changes';
        infoDiv.classList.add('hidden');
    }
});

        // Logout
        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
            }
            
            await supabase.auth.signOut();
            currentUser = null;
            currentProfile = null;
            location.reload();
        }

// Collapsible Section Management
        let currentRequestFilter = 'open'; // Default to 'open' tab
        let currentUrgencyFilter = 'all';
	
	// User dropdown toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('active');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('userDropdown');
    
    if (userMenu && dropdown && !userMenu.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});
        
	async function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            
            // Check if this section is currently expanded
            const isCurrentlyExpanded = content.classList.contains('expanded');
            
            // List of all collapsible sections
            const allSections = ['openRequests', 'activeRequests', 'myResponses', 'availableWork'];
            
            // Close ALL sections first (accordion behavior)
            allSections.forEach(section => {
                const sectionContent = document.getElementById(section + 'Content');
                const sectionIcon = document.getElementById(section + 'Icon');
                
                if (sectionContent) sectionContent.classList.remove('expanded');
                if (sectionIcon) sectionIcon.classList.remove('expanded');
            });
            
            // If the clicked section was closed, open it now
            // If it was already open, leave it closed (toggle behavior)
            if (!isCurrentlyExpanded) {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                
                // NEW: If opening "Work Opportunities", mark all requests as seen
                if (sectionId === 'availableWork' && currentProfile && currentProfile.is_provider) {
                    await markAvailableWorkAsSeen();
                }
                
                // FIX: Auto-load content for Active Requests section
                if (sectionId === 'activeRequests') {
                    // Trigger the default selected tab (Responded)
                    setTimeout(() => {
                        filterActiveRequests('responded');
                    }, 100);
                }
            }
        }

        function filterMyRequests(filter) {
    currentRequestFilter = filter;
    
    // Update active tab - remove all active classes first
    const allTabs = document.querySelectorAll('#seekerSection .sub-tab');
    if (allTabs && allTabs.length > 0) {
        allTabs.forEach(tab => {
            tab.classList.remove('active');
        });
    }
    
    // Add active class to clicked tab
    if (event && event.target) {
        const clickedButton = event.target.closest('.sub-tab');
        if (clickedButton) {
            clickedButton.classList.add('active');
        }
    }
    
    // Reload and filter requests
    loadUserRequests();
}

function filterActiveRequests(filter) {
    currentRequestFilter = filter;
    
    // Update active tab - remove all active classes first
    const allTabs = document.querySelectorAll('#activeRequestsContent .sub-tab');
    if (allTabs && allTabs.length > 0) {
        allTabs.forEach(tab => {
            tab.classList.remove('active');
        });
    }
    
    // Add active class to clicked tab
    if (event && event.target) {
        const clickedButton = event.target.closest('.sub-tab');
        if (clickedButton) {
            clickedButton.classList.add('active');
        }
    }
    
    // Reload and filter requests
    loadUserRequests();
}

        function filterByUrgency(urgency) {
            currentUrgencyFilter = urgency;
            
            // Update active tab
            document.querySelectorAll('#urgencyTabs .sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload and filter nearby requests
            loadNearbyRequests();
        }

        function filterResponses(filter) {
            currentResponseFilter = filter;
            
            // Update active tab - find tabs within MY RESPONSES section only
            const responsesTabs = document.querySelectorAll('#myResponsesList .sub-tab');
            if (responsesTabs && responsesTabs.length > 0) {
                responsesTabs.forEach(tab => {
                    tab.classList.remove('active');
                });
            }
            
            // Add active class to clicked tab
            if (event && event.target) {
                const clickedButton = event.target.closest('.sub-tab');
                if (clickedButton) {
                    clickedButton.classList.add('active');
                }
            }
            
            // Reload provider responses with new filter
            loadProviderResponses();
        }

        function updateSectionBadges() {
            // This will be called after loading data to update badge counts
        }

	// Mark all available work requests as seen
        async function markAvailableWorkAsSeen() {
            try {
                const now = new Date().toISOString();
                
                // Update profile with current timestamp
                const { error } = await supabase
                    .from('profiles')
                    .update({ available_work_last_opened_at: now })
                    .eq('user_id', currentProfile.user_id);
                
                if (error) throw error;
                
                // Update local profile
                currentProfile.available_work_last_opened_at = now;
                
                // Reload nearby requests to update badge to 0
                await loadNearbyRequests();
                
            } catch (error) {
                console.error('Error marking available work as seen:', error);
            }
        }

	// Filter work opportunities (Available vs Missed)
function filterWorkOpportunities(filter) {
    window.currentWorkFilter = filter;
    
    // Update active tab
    const tabs = document.querySelectorAll('#urgencyTabs .sub-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // Reload nearby requests to refresh display
    loadNearbyRequests();
}
	
	
        // ========== AUTOCOMPLETE FUNCTIONS ==========
        
        // Debounce function to avoid too many API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Fetch city suggestions from Nominatim
        async function getCitySuggestions(query) {
            if (query.length < 2) return [];
            
            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)},India&format=json&limit=8&addressdetails=1`;
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'HelpBuddy/1.0' }
                });
                const data = await response.json();
                
                // Extract unique city names
                const cities = [];
                const seen = new Set();
                
                data.forEach(item => {
                    const city = item.address?.city || 
                                item.address?.town || 
                                item.address?.village || 
                                item.address?.municipality;
                    
                    if (city && !seen.has(city.toLowerCase())) {
                        seen.add(city.toLowerCase());
                        cities.push({
                            name: city,
                            state: item.address?.state || ''
                        });
                    }
                });
                
                return cities;
            } catch (error) {
                console.error('Error fetching city suggestions:', error);
                return [];
            }
        }

        
        // Setup city autocomplete
        function setupCityAutocomplete() {
            // Setup for SIGNUP form (id="city")
            const cityInput = document.getElementById('city');
            if (cityInput) {
                setupCityAutocompleteForField(cityInput, 'citySuggestions', 'state');
            }
            
            // Setup for EDIT PROFILE form (id="editCity")
            const editCityInput = document.getElementById('editCity');
            if (editCityInput) {
                setupCityAutocompleteForField(editCityInput, 'editCitySuggestions', 'editState');
            }
        }

        // Generic setup for any city field
        function setupCityAutocompleteForField(inputElement, suggestionsId, stateFieldId) {
            const debouncedSearch = debounce(async (query) => {
                if (query.length < 2) {
                    document.getElementById(suggestionsId).classList.remove('active');
                    return;
                }
                
                // Show loading
                const container = document.getElementById(suggestionsId);
                if (!container) return;
                
                container.innerHTML = '<div class="suggestion-item loading">Searching...</div>';
                container.classList.add('active');
                
                const suggestions = await getCitySuggestions(query);
                showCitySuggestionsForField(inputElement, suggestions, suggestionsId, stateFieldId);
            }, 300);
            
            inputElement.addEventListener('input', (e) => {
                debouncedSearch(e.target.value.trim());
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                const suggestionsContainer = document.getElementById(suggestionsId);
                if (suggestionsContainer && !inputElement.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.classList.remove('active');
                }
            });
        }

        // Show suggestions for specific field
        function showCitySuggestionsForField(inputElement, suggestions, suggestionsId, stateFieldId) {
            const container = document.getElementById(suggestionsId);
            if (!container) return;
            
            if (suggestions.length === 0) {
                container.classList.remove('active');
                return;
            }
            
            let html = '';
            suggestions.forEach(item => {
                const cityName = item.name.replace(/'/g, "\\'");
                const stateName = item.state.replace(/'/g, "\\'");
                html += `
                    <div class="suggestion-item" onclick="selectCityForField('${inputElement.id}', '${cityName}', '${stateFieldId}', '${stateName}', '${suggestionsId}')">
                        ${item.name}${item.state ? ', ' + item.state : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.classList.add('active');
        }

        // Select city for specific field
        function selectCityForField(inputId, cityName, stateFieldId, stateName, suggestionsId) {
            const cityInput = document.getElementById(inputId);
            if (cityInput) {
                cityInput.value = cityName;
            }
            
            // Auto-fill state if available
            const stateField = document.getElementById(stateFieldId);
            if (stateName && stateField) {
                if (stateField.tagName === 'SELECT') {
                    // Try to find matching state in dropdown
                    const options = Array.from(stateField.options);
                    const matchingOption = options.find(opt => opt.value === stateName);
                    if (matchingOption) {
                        stateField.value = stateName;
                    }
                } else {
                    // If it's a text input (for future state autocomplete)
                    stateField.value = stateName;
                }
            }
            
            // Hide suggestions
            const container = document.getElementById(suggestionsId);
            if (container) {
                container.classList.remove('active');
            }
        }

	// Rating System Functions
        let currentRatingData = null;
        let selectedRating = 0;

        function openRatingModal(requestId, providerId, providerName) {
            currentRatingData = { requestId, providerId, providerName };
            selectedRating = 0;
            
            document.getElementById('ratingProviderName').textContent = providerName;
            document.getElementById('ratingReview').value = '';
            document.getElementById('reviewCounter').textContent = '0';
            document.getElementById('ratingError').classList.add('hidden');
            document.getElementById('ratingText').textContent = 'Select Rating';
            
            // Reset stars
            document.querySelectorAll('.star').forEach(star => {
                star.classList.remove('selected');
                star.textContent = '☆';
            });
            
            document.getElementById('ratingModal').classList.add('active');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
            currentRatingData = null;
            selectedRating = 0;
        }

	// Contact Details Modal Functions
        async function openContactDetailsModal() {
            try {
                // Get partner's profile
                const { data: partnerProfile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', currentChatData.partnerId)
                    .single();
                
                if (error || !partnerProfile) {
                    alert('Error loading contact details');
                    return;
                }
                
                const partnerAddress = [
                    partnerProfile.house_number,
                    partnerProfile.area_name,
                    partnerProfile.landmark,
                    partnerProfile.city,
                    partnerProfile.state,
                    partnerProfile.pin_code
                ].filter(Boolean).join(', ');
                
                document.getElementById('contactDetailsModalContent').innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 12px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">👤</div>
                            <h3 style="color: #333; margin-bottom: 5px;">${partnerProfile.name}</h3>
                        </div>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin-bottom: 15px;">
                            <p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>📱 Phone:</strong> <a href="tel:${partnerProfile.phone}" style="color: #2196f3; text-decoration: none; font-weight: 600;">${partnerProfile.phone}</a></p>
                            <p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>📍 Address:</strong> ${partnerAddress}</p>
                        </div>
                        <p style="font-size: 12px; color: #666; text-align: center; font-style: italic; background: #fff3cd; padding: 10px; border-radius: 6px; margin: 0;">
                            🔒 This information is visible because both parties approved contact sharing
                        </p>
                    </div>
                `;
                
                document.getElementById('contactDetailsModal').classList.add('active');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function closeContactDetailsModal() {
            document.getElementById('contactDetailsModal').classList.remove('active');
        }	

        function selectRating(rating) {
            selectedRating = rating;
            
            const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('ratingText').textContent = ratingTexts[rating];
            
            // Update star display
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('selected');
                    star.textContent = '★';
                } else {
                    star.classList.remove('selected');
                    star.textContent = '☆';
                }
            });
        }

	async function openChatPartnerProfile() {
    try {
        // Get partner's full profile
        const { data: partnerProfile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', currentChatData.partnerId)
            .single();
        
        if (error || !partnerProfile) {
            alert('Error loading partner profile');
            return;
        }
        
        // Get partner's services if they are a provider
        let servicesHTML = '';
        if (partnerProfile.is_provider) {
            const { data: services } = await supabase
                .from('provider_services')
                .select('service_id')
                .eq('provider_id', partnerProfile.user_id);
            
            if (services && services.length > 0) {
                const serviceNames = {
                    electrician: '🔧 Electrician',
                    plumber: '🚰 Plumber',
                    ac_repair: '❄️ AC Repair',
                    carpenter: '🔨 Carpenter',
                    painter: '🎨 Painter',
                    cleaner: '🧹 Cleaner'
                };
                servicesHTML = '<h3 style="margin-top: 20px; margin-bottom: 10px;">Services Provided:</h3><div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                services.forEach(s => {
                    servicesHTML += `<span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">${serviceNames[s.service_id] || s.service_id}</span>`;
                });
                servicesHTML += '</div>';
            }
        }
        
        // Get partner's ratings
        let ratingsHTML = '';
if (partnerProfile.average_rating && partnerProfile.average_rating > 0 && partnerProfile.total_ratings > 0) {
    const stars = '⭐'.repeat(Math.round(partnerProfile.average_rating));
    ratingsHTML = `<h3 style="margin-top: 20px; margin-bottom: 10px;">Rating: ${stars} ${partnerProfile.average_rating}/5 (${partnerProfile.total_ratings} ${partnerProfile.total_ratings === 1 ? 'review' : 'reviews'})</h3>`;
    
    // Fetch review details for display
    const { data: ratings } = await supabase
        .from('ratings')
        .select('rating, review, created_at')
        .eq('provider_id', partnerProfile.user_id)
        .order('created_at', { ascending: false });
    
    if (ratings && ratings.length > 0) {
        ratingsHTML += '<div style="margin-top: 10px;">';
        ratings.slice(0, 3).forEach(r => {
            const reviewStars = '⭐'.repeat(r.rating);
            const reviewDate = new Date(r.created_at).toLocaleDateString();
            ratingsHTML += `
                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${reviewStars} ${r.rating}/5</div>
                    ${r.review ? `<p style="color: #555; margin-bottom: 5px; font-size: 14px;">"${r.review}"</p>` : ''}
                    <p style="font-size: 12px; color: #999;">${reviewDate}</p>
                </div>
            `;
        });
        ratingsHTML += '</div>';
    }
}
        
        // Build full address
        const partnerAddress = [
            partnerProfile.house_number,
            partnerProfile.area_name,
            partnerProfile.landmark,
            partnerProfile.city,
            partnerProfile.state,
            partnerProfile.pin_code
        ].filter(Boolean).join(', ');
        
        // Build profile photo HTML
        const photoHTML = partnerProfile.profile_photo 
            ? `<img src="${partnerProfile.profile_photo}" 
                    onclick="event.stopPropagation(); openImagePreview('${partnerProfile.profile_photo}')" 
                    style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; cursor: pointer; transition: transform 0.2s; margin-bottom: 15px;" 
                    onmouseover="this.style.transform='scale(1.05)'" 
                    onmouseout="this.style.transform='scale(1)'"
                    title="Click to view full size">`
            : `<div style="width: 120px; height: 120px; border-radius: 50%; background: #e0e0e0; display: inline-flex; align-items: center; justify-content: center; font-size: 48px; border: 4px solid #667eea; margin-bottom: 15px;">👤</div>`;
        
        // Display in modal
        document.getElementById('profileContent').innerHTML = `
            <div style="text-align: center;">
                ${photoHTML}
                <h2 style="color: #333; margin: 10px 0;">${partnerProfile.name}</h2>
            </div>
            
            <div style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin: 20px 0;">
                <p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>📍 Address:</strong> ${partnerAddress}</p>
                ${partnerProfile.is_provider ? `<p style="margin: 12px 0; color: #333; font-size: 15px;"><strong>📏 Service Radius:</strong> ${partnerProfile.radius_km} km</p>` : ''}
            </div>
            
            ${servicesHTML}
            ${ratingsHTML}
            
            <p style="font-size: 12px; color: #666; text-align: center; font-style: italic; background: #fff3cd; padding: 10px; border-radius: 6px; margin-top: 20px;">
                🔒 Full contact details are visible only after both parties approve contact sharing
            </p>
        `;
        
        document.getElementById('profileModal').classList.add('active');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}	

async function submitRating() {
    if (selectedRating === 0) {
        document.getElementById('ratingError').textContent = 'Please select a rating';
        document.getElementById('ratingError').classList.remove('hidden');
        return;
    }
    
    const submitBtn = document.getElementById('submitRatingBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
        const review = document.getElementById('ratingReview').value.trim();
        
        const { error } = await supabase
            .from('ratings')
            .insert([{
                request_id: currentRatingData.requestId,
                seeker_id: currentUser.id,
                provider_id: currentRatingData.providerId,
                rating: selectedRating,
                review: review || null
            }]);
        
        if (error) throw error;
        
        alert('✅ Rating submitted successfully! Thank you for your feedback.');
        closeRatingModal();
        await loadUserRequests();
        viewResponses(currentRatingData.requestId);
        
    } catch (error) {
        document.getElementById('ratingError').textContent = 'Error: ' + error.message;
        document.getElementById('ratingError').classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Rating';
    }
}

       // Toggle Send Button based on text input
        function toggleSendButton() {
            const input = document.getElementById('chatMessageInput');
            const sendBtn = document.getElementById('sendBtn');
            const templateBtn = document.getElementById('templateBtn');
            
            if (input.value.trim().length > 0) {
                sendBtn.classList.add('show');
                templateBtn.classList.add('hide');
            } else {
                sendBtn.classList.remove('show');
                templateBtn.classList.remove('hide');
            }
        }

        // Toggle Privacy Notice
        function togglePrivacyNotice() {
            const notice = document.getElementById('privacyNotice');
            notice.classList.toggle('show');
        }

        // Show Attachment Options
        function showAttachmentOptions() {
            document.getElementById('photoInput').click();
        }

</script>
</body>
</html>