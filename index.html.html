<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelpBuddy - Service Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 40px; max-width: 1200px; margin: 0 auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-container { display: flex; align-items: center; gap: 10px; font-size: 28px; font-weight: 700; color: #667eea; }
        .user-menu { position: relative; }
        .user-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .user-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 10px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); min-width: 180px; display: none; z-index: 1000; overflow: hidden; }
        .user-dropdown.active { display: block; animation: dropdownSlide 0.2s ease-out; }
        @keyframes dropdownSlide { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-item { padding: 12px 20px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; color: #333; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f8f9fa; color: #667eea; }
	h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        h2 { color: #333; margin-bottom: 20px; font-size: 1.5em; }
        h3 { color: #667eea; margin: 20px 0 15px; font-size: 1.2em; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; font-family: inherit; }
        textarea { resize: vertical; min-height: 100px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-full { width: 100%; }
        .btn-secondary { background: #6c757d; margin-left: 10px; }
        .btn-respond { background: #28a745; padding: 8px 16px; font-size: 14px; }
        .btn-select { background: #007bff; padding: 8px 16px; font-size: 14px; }
        .btn-view-profile { background: #17a2b8; padding: 8px 16px; font-size: 14px; }
        .btn-cancel { background: #dc3545; padding: 8px 16px; font-size: 14px; }
        .btn-edit { background: #ffc107; padding: 8px 16px; font-size: 14px; color: #333; }
        .btn-chat { background: #28a745; padding: 8px 16px; font-size: 14px; }
        .btn-complete { background: #ff6b6b; padding: 10px 20px; font-size: 14px; }
        .btn-contact { background: #17a2b8; padding: 10px 20px; font-size: 14px; }
        .error { background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .success { background: #efe; border: 1px solid #cfc; color: #3c3; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .info { background: #e3f2fd; border: 1px solid #90caf9; color: #1976d2; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .hidden { display: none; }
        .profile-info { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
        .profile-info p { margin-bottom: 10px; color: #555; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input { width: auto; }
        .required { color: #e74c3c; }
        .char-counter { font-size: 12px; color: #999; text-align: right; margin-top: 5px; }
        .urgency-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .urgency-option { flex: 1; min-width: 150px; }
        .urgency-option input[type="radio"] { display: none; }
        .urgency-label { display: block; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .urgency-option input[type="radio"]:checked + .urgency-label { border-color: #667eea; background: #f0f4ff; font-weight: 600; }
        .urgency-label:hover { border-color: #667eea; }
        .request-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .request-card:hover { box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-color: #667eea; transform: translateY(-2px); }
        .request-card.compact { 
    padding: 18px 20px; 
    margin-bottom: 24px; 
    background: #ffffff; 
    border: 3px solid #d0d0d0; 
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}
.request-card.compact:last-child { margin-bottom: 0; }
        .request-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .request-card-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .request-card-left { flex: 1; min-width: 200px; }
        .request-card-right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .request-title-compact { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; line-height: 1.3; }
        .request-summary { font-size: 13px; color: #666; line-height: 1.4; }
        .request-details { margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0; display: none; }
        .request-details.expanded { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .expand-btn { background: none; border: none; color: #667eea; font-size: 12px; font-weight: 600; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .expand-btn:hover { background: #f0f4ff; }
        .notification-badge { background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .urgent-indicator { background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
        .info-badge { background: #17a2b8; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .action-btn-compact { padding: 8px 14px; font-size: 13px; border-radius: 6px; font-weight: 600; }
        .section-summary { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
        .stat-badge { background: #f0f4ff; color: #667eea; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; border: 1px solid #d0d9ff; }
        .request-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .request-meta { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .meta-item { font-size: 13px; color: #666; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-open { background: #d4edda; color: #155724; }
        .status-in-progress { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .urgency-urgent { color: #dc3545; font-weight: 600; }
        .urgency-normal { color: #ffc107; font-weight: 600; }
        .urgency-low { color: #28a745; font-weight: 600; }
        .request-description { color: #555; margin-bottom: 15px; line-height: 1.5; }
        .request-location { font-size: 14px; color: #666; margin-bottom: 15px; }
        .request-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .response-badge { display: inline-block; background: #007bff; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 10px; }
        .distance-badge { display: inline-block; background: #17a2b8; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-state-text { font-size: 18px; margin-bottom: 30px; }
        .request-limit-warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 500; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .collapsible-section { margin-bottom: 25px; }
        .section-toggle { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; padding: 18px 24px; width: 100%; text-align: left; cursor: pointer; font-size: 16px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .section-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4); }
        .section-toggle:active { transform: translateY(0); }
        .section-toggle-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .section-toggle-right { display: flex; align-items: center; gap: 10px; }
        .toggle-icon { font-size: 20px; transition: transform 0.3s; }
        .toggle-icon.expanded { transform: rotate(180deg); }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .section-content.expanded { max-height: 5000px; transition: max-height 0.5s ease-in; }
        .section-inner { padding: 20px 0 0 0; }
        .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .sub-tab { background: white; border: 2px solid #e0e0e0; color: #666; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; }
        .sub-tab:hover { border-color: #667eea; color: #667eea; }
        .sub-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; color: white; }
        .count-badge { background: rgba(255, 255, 255, 0.3); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 700; }
        .new-badge { background: #dc3545; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; animation: pulse 2s infinite; }
	.two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification-count { background: #dc3545; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 24px; font-weight: 600; color: #333; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .close-btn:hover { color: #333; }
        .provider-card { background: #f5f5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .provider-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .provider-info { font-size: 13px; color: #666; margin-bottom: 8px; }
        .rating-display { font-size: 14px; color: #667eea; font-weight: 600; margin-bottom: 12px; }
        .provider-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .profile-modal-content { background: white; border-radius: 12px; padding: 20px; }
        .profile-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .profile-details { color: #555; line-height: 1.8; }
        .profile-details p { margin-bottom: 10px; }
        /* Chat Styles */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 100px); max-height: 700px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-header-left { flex: 1; }
        .chat-partner-name { font-size: 18px; font-weight: 700; margin-bottom: 6px; letter-spacing: 0.3px; }
        .chat-status { font-size: 13px; opacity: 0.85; font-weight: 500; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 24px 20px; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%); display: flex; flex-direction: column; gap: 12px; }
        .message { display: flex; flex-direction: column; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { align-items: flex-end; }
        .message.received { align-items: flex-start; }
        .message-bubble { max-width: 65%; padding: 14px 18px; border-radius: 18px; word-wrap: break-word; line-height: 1.4; font-size: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
        .message.sent .message-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 6px 20px; font-weight: 500; }
        .message.received .message-bubble { background: white; color: #333; border: 1.5px solid #e8e8e8; border-radius: 20px 20px 20px 6px; }
        .message-time { font-size: 12px; color: #999; margin-top: 6px; padding: 0 6px; }
        .message-image { max-width: 100%; max-height: 280px; border-radius: 12px; margin-top: 10px; cursor: pointer; transition: transform 0.2s; }
        .message-image:hover { transform: scale(1.02); }
        .empty-chat-state { display: flex; align-items: center; justify-content: center; height: 100%; color: #999; text-align: center; padding: 20px; }
        .empty-chat-state-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-chat-state-text { font-size: 16px; color: #666; }
        
        .chat-templates { background: #f0f2f5; padding: 16px; border-top: 2px solid #e8e8e8; max-height: 220px; overflow-y: auto; }
        .template-category { margin-bottom: 12px; }
        .template-category:last-child { margin-bottom: 0; }
        .template-category-title { font-weight: 700; color: #667eea; font-size: 13px; cursor: pointer; user-select: none; padding: 10px 12px; background: white; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #667eea; }
        .template-category-title:hover { background: #e9ecef; transform: translateX(2px); }
        .template-items { margin-top: 8px; margin-left: 0; display: none; padding: 0 8px; }
        .template-items.open { display: flex; flex-direction: column; gap: 6px; animation: expandDown 0.2s ease-out; }
        @keyframes expandDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .template-item { padding: 10px 14px; background: white; border-radius: 8px; margin-bottom: 0; font-size: 13px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; color: #555; font-weight: 500; line-height: 1.3; }
        .template-item:hover { background: #667eea; color: white; border-left-color: #764ba2; transform: translateX(4px); box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2); }
        
        .chat-input-area { background: white; padding: 18px; border-top: 2px solid #e8e8e8; border-radius: 0; }
        .privacy-notice { background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); padding: 14px 16px; border-radius: 10px; font-size: 13px; color: #7d5d00; margin-bottom: 16px; border-left: 4px solid #ffc107; display: flex; gap: 10px; align-items: flex-start; }
        .privacy-notice strong { color: #5d4700; font-weight: 700; }
        .chat-action-buttons { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .chat-action-buttons .btn { padding: 10px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; transition: all 0.2s; }
        .contact-request-card { background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); padding: 16px; border-radius: 12px; margin: 10px 0; border-left: 4px solid #ffc107; }
.contact-request-title { font-weight: 700; color: #5d4700; margin-bottom: 10px; font-size: 14px; }
.contact-approval-buttons { display: flex; gap: 10px; margin-top: 12px; }
.btn-approve { background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
.btn-approve:hover { background: #218838; }
.btn-decline { background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
.btn-decline:hover { background: #c82333; }
.contact-status-approved { background: #d4edda; border-left-color: #28a745; color: #155724; }
.contact-status-declined { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
.contact-details-card { background: #e3f2fd; padding: 14px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #2196f3; }
.contact-details-card p { margin: 6px 0; font-size: 13px; color: #0d47a1; }
	.chat-input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .chat-input-wrapper textarea { flex: 1; min-height: 48px; max-height: 120px; padding: 12px 14px; border: 1.5px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 15px; resize: none; transition: all 0.2s; }
        .chat-input-wrapper textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .chat-input-wrapper .btn { padding: 12px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; }
        .file-input-label { background: #6c757d; color: white; padding: 11px 13px; border-radius: 8px; cursor: pointer; font-size: 18px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 48px; }
        .file-input-label:hover { background: #5a6268; transform: scale(1.05); }
        
        /* Warranty Form */
        .warranty-form { background: linear-gradient(135deg, #f0f4ff 0%, #f8f9fa 100%); padding: 18px; border-radius: 12px; margin-top: 16px; border: 2px solid #e8ecff; }
        .warranty-form h3 { margin-top: 0; margin-bottom: 16px; color: #333; font-size: 15px; font-weight: 700; }
        .warranty-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .warranty-option { flex: 1; min-width: 110px; }
        .warranty-option input[type="radio"] { display: none; }
        .warranty-option label { display: block; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 600; font-size: 13px; color: #555; }
        .warranty-option input[type="radio"]:checked + label { border-color: #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #e9ecff 100%); color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .warranty-form .btn { margin-top: 16px; font-size: 14px; }
        
/* Template Modal Styles */
        .template-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center; }
        .template-modal.active { display: flex; }
        .template-modal-content { background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; max-height: 70vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .template-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .template-modal-title { font-size: 20px; font-weight: 700; color: #333; }
        .template-close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; transition: color 0.2s; }
        .template-close-btn:hover { color: #333; }
        .template-categories { display: flex; flex-direction: column; gap: 16px; }
        .template-category-block { border: 1.5px solid #e8e8e8; border-radius: 12px; overflow: hidden; }
        .template-category-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 16px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; user-select: none; }
        .template-category-header:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .template-category-items { display: none; background: #f9f9f9; }
        .template-category-items.open { display: flex; flex-direction: column; }
        .template-option { padding: 12px 16px; border-bottom: 1px solid #e8e8e8; cursor: pointer; transition: all 0.2s; font-size: 13px; color: #555; line-height: 1.4; }
        .template-option:last-child { border-bottom: none; }
        .template-option:hover { background: #e9ecef; color: #333; padding-left: 20px; }
        .template-button { background: #667eea; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 18px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; min-width: 44px; height: 44px; }
        .template-button:hover { background: #764ba2; transform: scale(1.05); }

/* Rating Modal Styles */
        .rating-stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .star { font-size: 48px; cursor: pointer; transition: all 0.2s; color: #ddd; user-select: none; }
        .star:hover { transform: scale(1.2); }
        .star.selected { color: #ffc107; }
        .star.hovered { color: #ffc107; }

        @media (max-width: 768px) { 
            .row { grid-template-columns: 1fr; } 
            .urgency-group { flex-direction: column; } 
            .request-actions { flex-direction: column; } 
            .btn-secondary { margin-left: 0; margin-top: 10px; } 
            .two-column { grid-template-columns: 1fr; } 
            .modal-content { max-width: 95%; } 
            .chat-container { height: calc(100vh - 80px); }
            .message-bubble { max-width: 85%; }
            .chat-messages { padding: 16px 12px; gap: 8px; }
            .chat-header { padding: 16px; }
            .chat-input-area { padding: 14px; }
        }.message-bubble { max-width: 85%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ù HelpBuddy</h1>
        
        <!-- Login View -->
        <div id="loginView" class="hidden">
            <h2>Welcome Back</h2>
            <div id="loginError" class="error hidden"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Password <span class="required">*</span></label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-full">Login</button>
                <button type="button" class="btn btn-secondary btn-full" onclick="showSignup()">Sign Up</button>
            </form>
        </div>

        <!-- Signup View -->
        <div id="signupView" class="hidden">
            <h2>Create Account</h2>
            <div id="signupError" class="error hidden"></div>
            <div id="signupInfo" class="info hidden"></div>
            <form id="signupForm">
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" id="signupName" required>
                </div>
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone Number <span class="required">*</span></label>
                    <input type="tel" id="signupPhone" pattern="[0-9]{10}" required>
                </div>
                <div class="form-group">
                    <label>Password <span class="required">*</span></label>
                    <input type="password" id="signupPassword" minlength="6" required>
                </div>
                <h3>üìç Address Details</h3>
                <div class="form-group">
                    <label>House Number</label>
                    <input type="text" id="houseNumber">
                </div>
                <div class="form-group">
                    <label>Area Name <span class="required">*</span></label>
                    <input type="text" id="areaName" required>
                </div>
                <div class="form-group">
                    <label>Landmark</label>
                    <input type="text" id="landmark">
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>City <span class="required">*</span></label>
                        <select id="city" required>
                            <option value="">Select City</option>
                            <option value="Panipat">Panipat</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Hisar">Hisar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>State <span class="required">*</span></label>
                        <select id="state" required>
                            <option value="">Select State</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Delhi">Delhi</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>PIN Code <span class="required">*</span></label>
                    <input type="text" id="pinCode" pattern="[0-9]{6}" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="isProvider">
                    <label for="isProvider" style="margin: 0;">I want to provide services</label>
                </div>
                <button type="submit" class="btn btn-full">Sign Up</button>
                <button type="button" class="btn btn-secondary btn-full" onclick="showLogin()">Back to Login</button>
            </form>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
    <div class="dashboard-header">
        <div class="header-left">
            <div class="logo-container">
                ü§ù HelpBuddy
            </div>
        </div>
        <div class="user-menu">
            <button class="user-button" onclick="toggleUserDropdown()">
                <span id="headerUsername">User</span>
                <span>‚ñº</span>
            </button>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item" onclick="showEditProfile(); toggleUserDropdown();">
                    üë§ Profile
                </div>
                <div class="dropdown-item" onclick="handleLogout()">
                    üö™ Logout
                </div>
            </div>
        </div>
    </div>
            <div class="two-column">
                <!-- Seeker Section -->
                <div id="seekerSection">
                    <div class="section-header">
                        <button class="btn" onclick="showCreateRequestForm()" id="createRequestBtn">+ Create Request</button>
                    </div>
                    <div id="requestLimitWarning" class="request-limit-warning hidden">‚ö†Ô∏è Maximum 5 open requests reached</div>
                    
                    <div class="collapsible-section">
                        <button class="section-toggle" onclick="toggleSection('myRequests')">
                            <div class="section-toggle-left">
                                <span>üìã MY REQUESTS</span>
                                <span class="count-badge" id="myRequestsTotal">0</span>
                                <span class="new-badge hidden" id="myRequestsNew">üî¥ 0</span>
                            </div>
                            <div class="section-toggle-right">
                                <span class="toggle-icon" id="myRequestsIcon">‚ñº</span>
                            </div>
                        </button>
                        <div class="section-content" id="myRequestsContent">
                            <div class="section-inner">
                                <div class="sub-tabs">
                                    <button class="sub-tab active" onclick="filterMyRequests('all')">All</button>
                                    <button class="sub-tab" onclick="filterMyRequests('open')">üìã Open <span class="count-badge" id="openCount">0</span></button>
                                    <button class="sub-tab" onclick="filterMyRequests('responded')">üí¨ Responded <span class="count-badge" id="respondedCount">0</span></button>
                                </div>
                                <div id="myRequestsList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Provider Section -->
                <div id="providerSection" class="hidden">
                    <div class="collapsible-section">
                        <button class="section-toggle" onclick="toggleSection('myResponses')">
                            <div class="section-toggle-left">
                                <span>üí¨ MY RESPONSES</span>
                                <span class="count-badge" id="myResponsesTotal">0</span>
                                <span class="new-badge hidden" id="myResponsesNew">üî¥ 0</span>
                            </div>
                            <div class="section-toggle-right">
                                <span class="toggle-icon" id="myResponsesIcon">‚ñº</span>
                            </div>
                        </button>
                        <div class="section-content" id="myResponsesContent">
                            <div class="section-inner">
                                <div id="myResponsesList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapsible-section">
                        <button class="section-toggle" onclick="toggleSection('availableWork')">
                            <div class="section-toggle-left">
                                <span>üìç AVAILABLE WORK</span>
                                <span class="count-badge" id="availableWorkTotal">0</span>
                                <span class="new-badge hidden" id="availableWorkNew">üÜï 0</span>
                            </div>
                            <div class="section-toggle-right">
                                <span class="toggle-icon" id="availableWorkIcon">‚ñº</span>
                            </div>
                        </button>
                        <div class="section-content" id="availableWorkContent">
                            <div class="section-inner">
                                <div class="sub-tabs" id="urgencyTabs">
                                    <!-- Tabs will be dynamically generated -->
                                </div>
                                <div id="nearbyRequestsList"></div>
                            </div>
                        </div>
                    </div>
                </div>            </div>

            <button class="btn btn-full" onclick="handleLogout()" style="margin-top: 20px;">Logout</button>
        </div>

        <!-- Create Request View -->
        <div id="createRequestView" class="hidden">
            <button class="btn btn-secondary" onclick="backFromChat()">‚Üê Back to Responses</button>
            <h2 style="margin-top: 20px;">Create Service Request</h2>
            <div id="createRequestError" class="error hidden"></div>
            <div id="createRequestInfo" class="info hidden"></div>
            <form id="createRequestForm">
                <div class="form-group">
                    <label>Service Type <span class="required">*</span></label>
                    <select id="serviceType" required>
                        <option value="">Select Service</option>
                        <option value="electrician">üîß Electrician</option>
                        <option value="plumber">üö∞ Plumber</option>
                        <option value="ac_repair">‚ùÑÔ∏è AC Repair</option>
                        <option value="carpenter">üî® Carpenter</option>
                        <option value="painter">üé® Painter</option>
                        <option value="cleaner">üßπ Cleaner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="requestTitle" required minlength="10" maxlength="100">
                    <div class="char-counter"><span id="titleCounter">0</span>/100</div>
                </div>
                <div class="form-group">
                    <label>Description <span class="required">*</span></label>
                    <textarea id="requestDescription" required minlength="20" maxlength="500"></textarea>
                    <div class="char-counter"><span id="descCounter">0</span>/500</div>
                </div>
                <div class="form-group">
                    <label>Urgency <span class="required">*</span></label>
                    <div class="urgency-group">
                        <div class="urgency-option">
                            <input type="radio" name="urgency" id="urgentRadio" value="urgent" required>
                            <label for="urgentRadio" class="urgency-label">üî¥ Urgent</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="urgency" id="normalRadio" value="normal" required>
                            <label for="normalRadio" class="urgency-label">üü° Normal</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="urgency" id="lowRadio" value="low" required>
                            <label for="lowRadio" class="urgency-label">üü¢ Low</label>
                        </div>
                    </div>
                </div>
                <h3>üìç Service Location</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="differentLocation" onchange="toggleLocationFields()">
                    <label for="differentLocation" style="margin: 0;">Use different location for this service</label>
                </div>
                <div id="customLocationFields" class="hidden">
                    <div class="form-group">
                        <label>Area Name <span class="required">*</span></label>
                        <input type="text" id="customAreaName">
                    </div>
                    <div class="form-group">
                        <label>Landmark</label>
                        <input type="text" id="customLandmark">
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>City <span class="required">*</span></label>
                            <select id="customCity">
                                <option value="">Select</option>
                                <option value="Panipat">Panipat</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Hisar">Hisar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>State <span class="required">*</span></label>
                            <select id="customState">
                                <option value="">Select</option>
                                <option value="Haryana">Haryana</option>
                                <option value="Delhi">Delhi</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>PIN Code <span class="required">*</span></label>
                        <input type="text" id="customPinCode" pattern="[0-9]{6}">
                    </div>
                </div>
                <button type="submit" class="btn btn-full" id="submitRequestBtn">Create Request</button>
            </form>
        </div>
<!-- Edit Request View -->
        <div id="editRequestView" class="hidden">
            <button class="btn btn-secondary" onclick="backToDashboard()">‚Üê Back to Dashboard</button>
            <h2 style="margin-top: 20px;">Edit Service Request</h2>
            <div id="editRequestError" class="error hidden"></div>
            <div id="editRequestInfo" class="info hidden"></div>
            <form id="editRequestForm">
                <input type="hidden" id="editRequestId">
                
                <div class="form-group">
                    <label>Service Type <span class="required">*</span></label>
                    <select id="editServiceType" disabled>
                        <option value="">Select Service</option>
                        <option value="electrician">üîß Electrician</option>
                        <option value="plumber">üö∞ Plumber</option>
                        <option value="ac_repair">‚ùÑÔ∏è AC Repair</option>
                        <option value="carpenter">üî® Carpenter</option>
                        <option value="painter">üé® Painter</option>
                        <option value="cleaner">üßπ Cleaner</option>
                    </select>
                    <small style="color: #999; font-size: 12px;">Service type cannot be changed after creation</small>
                </div>
                
                <div class="form-group">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="editRequestTitle" required minlength="10" maxlength="100">
                    <div class="char-counter"><span id="editTitleCounter">0</span>/100</div>
                </div>
                
                <div class="form-group">
                    <label>Description <span class="required">*</span></label>
                    <textarea id="editRequestDescription" required minlength="20" maxlength="500"></textarea>
                    <div class="char-counter"><span id="editDescCounter">0</span>/500</div>
                </div>
                
                <div class="form-group">
                    <label>Urgency <span class="required">*</span></label>
                    <div class="urgency-group">
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editUrgentRadio" value="urgent" required>
                            <label for="editUrgentRadio" class="urgency-label">üî¥ Urgent</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editNormalRadio" value="normal" required>
                            <label for="editNormalRadio" class="urgency-label">üü° Normal</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" name="editUrgency" id="editLowRadio" value="low" required>
                            <label for="editLowRadio" class="urgency-label">üü¢ Low</label>
                        </div>
                    </div>
                </div>
                
                <h3>üìç Service Location</h3>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <p style="color: #333; font-size: 14px; margin-bottom: 8px; font-weight: 600;">üìç Current Location:</p>
                    <p style="color: #555; font-size: 14px; line-height: 1.6;" id="currentLocationText"></p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px; font-style: italic;">
                        ‚ÑπÔ∏è Location and service type cannot be changed after request creation. If you need to change these, please cancel this request and create a new one.
                    </p>
                </div>
                
                <button type="submit" class="btn btn-full" id="updateRequestBtn">üíæ Update Request</button>            </form>
        </div>

<!-- Edit Profile View -->
<div id="editProfileView" class="hidden">
    <button class="btn btn-secondary" onclick="backToDashboard()">‚Üê Back to Dashboard</button>
    <h2 style="margin-top: 20px;">Edit Profile</h2>
    <div id="editProfileError" class="error hidden"></div>
    <div id="editProfileInfo" class="info hidden"></div>
    
    <form id="editProfileForm">
        <h3>üë§ Personal Information</h3>
        <div class="form-group">
            <label>Full Name <span class="required">*</span></label>
            <input type="text" id="editName" required>
        </div>
        <div class="form-group">
            <label>Phone Number <span class="required">*</span></label>
            <input type="tel" id="editPhone" pattern="[0-9]{10}" required>
        </div>
        
        <h3>üìç Address Details</h3>
        <div class="form-group">
            <label>House Number</label>
            <input type="text" id="editHouseNumber">
        </div>
        <div class="form-group">
            <label>Area Name <span class="required">*</span></label>
            <input type="text" id="editAreaName" required>
        </div>
        <div class="form-group">
            <label>Landmark</label>
            <input type="text" id="editLandmark">
        </div>
        <div class="row">
            <div class="form-group">
                <label>City <span class="required">*</span></label>
                <select id="editCity" required>
                    <option value="">Select City</option>
                    <option value="Panipat">Panipat</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Hisar">Hisar</option>
                </select>
            </div>
            <div class="form-group">
                <label>State <span class="required">*</span></label>
                <select id="editState" required>
                    <option value="">Select State</option>
                    <option value="Haryana">Haryana</option>
                    <option value="Delhi">Delhi</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>PIN Code <span class="required">*</span></label>
            <input type="text" id="editPinCode" pattern="[0-9]{6}" required>
        </div>
        
        <h3>üîß Provider Settings</h3>
<div style="margin-bottom: 20px;">
    <button type="button" class="btn" id="toggleProviderBtn" onclick="toggleProviderStatus()" style="width: 100%;">
        <span id="providerStatusText">Loading...</span>
    </button>
</div>
        
        <div id="providerSettings" class="hidden">
            <div class="form-group">
                <label>Service Radius <span class="required">*</span></label>
                <select id="editRadius">
                    <option value="2">2 km</option>
                    <option value="5">5 km</option>
                    <option value="10">10 km</option>
                    <option value="15">15 km</option>
                    <option value="20">20 km</option>
                    <option value="30">30 km</option>
                    <option value="50">50 km</option>
                </select>
            </div>
            
            <h3>üìã Services I Provide</h3>
            <div id="currentServicesList" style="margin-bottom: 20px;"></div>
            
            <div class="form-group">
                <label>Add New Service</label>
                <div style="display: flex; gap: 10px;">
                    <select id="newServiceSelect" style="flex: 1;">
                        <option value="">Select Service to Add</option>
                        <option value="electrician">üîß Electrician</option>
                        <option value="plumber">üö∞ Plumber</option>
                        <option value="ac_repair">‚ùÑÔ∏è AC Repair</option>
                        <option value="carpenter">üî® Carpenter</option>
                        <option value="painter">üé® Painter</option>
                        <option value="cleaner">üßπ Cleaner</option>
                    </select>
                    <button type="button" class="btn" onclick="addService()">Add Service</button>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-full" id="saveProfileBtn">üíæ Save Changes</button>
    </form>
</div>
        <!-- Chat View -->
        <div id="chatView" class="hidden">
            <button class="btn btn-secondary" onclick="backToDashboard()">‚Üê Back to Dashboard</button>
            <div class="chat-container" style="margin-top: 20px;">
                <div class="chat-header">
                    <div class="chat-partner-name" id="chatPartnerName">Chat</div>
                    <div class="chat-status">Request Status: <span id="chatRequestStatus">In Progress</span></div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>
                
                                
                <div class="chat-input-area">
                    <div class="privacy-notice">
                        üîí <strong>Privacy Protected:</strong> Phone numbers and addresses are hidden until both parties agree to share contact information.
                    </div>
                    
                    <div class="chat-action-buttons">
                        <button class="btn btn-contact" onclick="requestContactSharing()">üìû Request Contact Sharing</button>
                        <button class="btn btn-complete" id="markCompleteBtn" onclick="showWarrantyForm()" style="display: none;">‚úÖ Mark Work Complete</button>
                    </div>
                    
                    <div id="warrantyForm" class="warranty-form hidden">
                        <h3>Select Warranty Period</h3>
                        <div class="warranty-options">
                            <div class="warranty-option">
                                <input type="radio" name="warranty" id="warranty1" value="1">
                                <label for="warranty1">1 Month</label>
                            </div>
                            <div class="warranty-option">
                                <input type="radio" name="warranty" id="warranty3" value="3">
                                <label for="warranty3">3 Months</label>
                            </div>
                            <div class="warranty-option">
                                <input type="radio" name="warranty" id="warranty6" value="6">
                                <label for="warranty6">6 Months</label>
                            </div>
                            <div class="warranty-option">
                                <input type="radio" name="warranty" id="warranty12" value="12">
                                <label for="warranty12">12 Months</label>
                            </div>
                        </div>
                        <button class="btn btn-full" onclick="completeWork()" style="margin-top: 15px;">Confirm Completion</button>
                    </div>
                    
                    <div class="chat-input-wrapper">
                        <label class="file-input-label" style="padding: 12px; cursor: pointer;">
                            üì∑
                            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                        </label>
                        <textarea id="chatMessageInput" placeholder="Type your message..." rows="2"></textarea>
                        <button class="template-button" onclick="openTemplateModal()" title="Quick Templates">üìã</button>
                        <button class="btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Responses Modal -->
        <div id="responsesModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">üë• Providers Who Responded</h2>
                    <button class="close-btn" onclick="closeResponsesModal()">√ó</button>
                </div>
                <div id="responsesList"></div>
            </div>
        </div>

        <!-- Provider Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">üë§ Provider Profile</h2>
                    <button class="close-btn" onclick="closeProfileModal()">√ó</button>
                </div>
                <div id="profileContent"></div>
            </div>
        </div>
<!-- Template Modal -->
        <div id="templateModal" class="template-modal">
            <div class="template-modal-content">
                <div class="template-modal-header">
                    <h2 class="template-modal-title">üìã Quick Templates</h2>
                    <button class="template-close-btn" onclick="closeTemplateModal()">√ó</button>
                </div>
                <div class="template-categories" id="templateCategoriesContainer"></div>
            </div>
        </div>

<!-- Rating Modal -->
        <div id="ratingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">‚≠ê Rate Provider</h2>
                    <button class="close-btn" onclick="closeRatingModal()">√ó</button>
                </div>
                <div id="ratingModalContent">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="font-size: 16px; color: #555; margin-bottom: 10px;">How was your experience with <strong id="ratingProviderName"></strong>?</p>
                        <p style="font-size: 14px; color: #999;">Your rating helps others make better decisions</p>
                    </div>
                    
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1" onclick="selectRating(1)">‚òÜ</span>
                        <span class="star" data-rating="2" onclick="selectRating(2)">‚òÜ</span>
                        <span class="star" data-rating="3" onclick="selectRating(3)">‚òÜ</span>
                        <span class="star" data-rating="4" onclick="selectRating(4)">‚òÜ</span>
                        <span class="star" data-rating="5" onclick="selectRating(5)">‚òÜ</span>
                    </div>
                    
                    <div style="text-align: center; margin: 15px 0;">
                        <span id="ratingText" style="font-size: 18px; font-weight: 600; color: #667eea;">Select Rating</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Review (Optional)</label>
                        <textarea id="ratingReview" placeholder="Share your experience with others..." rows="4" maxlength="500"></textarea>
                        <div class="char-counter"><span id="reviewCounter">0</span>/500</div>
                    </div>
                    
                    <div id="ratingError" class="error hidden"></div>
                    
                    <button class="btn btn-full" onclick="submitRating()" id="submitRatingBtn">Submit Rating</button>
                </div>
            </div>
        </div>

        <!-- Loading View -->

        <!-- Loading View -->
        <div id="loadingView" class="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nzhivzzzcanniejzqvsc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56aGl2enp6Y2FubmllanpxdnNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTcxMDEsImV4cCI6MjA3NTIzMzEwMX0.ex0z4DZF38IKc57l6V3X-DofTi6ZZUfPVFrajo1cBRY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let currentProfile = null;
        let selectedResponseRequest = null;
        let currentChatData = null;
        let chatRefreshInterval = null;

        const SERVICE_ICONS = {
            electrician: 'üîß',
            plumber: 'üö∞',
            ac_repair: '‚ùÑÔ∏è',
            carpenter: 'üî®',
            painter: 'üé®',
            cleaner: 'üßπ'
        };

        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) { 
                currentUser = user; 
                await loadProfile(); 
            } else { 
                showLogin(); 
            }
            setupCharCounters();
        });

        function hideAllViews() { 
            document.querySelectorAll('.container > div:not(.modal)').forEach(div => {
                div.classList.add('hidden');
            });
        }

        function showLogin() { hideAllViews(); document.getElementById('loginView').classList.remove('hidden'); }
        function showSignup() { hideAllViews(); document.getElementById('signupView').classList.remove('hidden'); }
        function showDashboard() { 
            hideAllViews(); 
            document.getElementById('dashboardView').classList.remove('hidden'); 
            loadDashboardData(); 
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
                chatRefreshInterval = null;
            }
        }
        function showLoading() { hideAllViews(); document.getElementById('loadingView').classList.remove('hidden'); }
        async function showCreateRequestForm() { 
            hideAllViews(); 
            document.getElementById('createRequestView').classList.remove('hidden'); 
            document.getElementById('createRequestForm').reset(); 
            document.getElementById('titleCounter').textContent = '0';
            document.getElementById('descCounter').textContent = '0';
            
            // Filter services based on provider's existing services
            await filterServiceDropdown();
        }
        
        async function filterServiceDropdown() {
            const serviceSelect = document.getElementById('serviceType');
            
            // If user is not a provider, show all services
            if (!currentProfile.is_provider) {
                return;
            }
            
            try {
                // Get provider's services
                const { data: providerServices, error } = await supabase
                    .from('provider_services')
                    .select('service_id')
                    .eq('provider_id', currentProfile.user_id);
                
                if (error) {
                    console.error('Error fetching provider services:', error);
                    return;
                }
                
                // Get list of services the provider already provides
                const providedServices = providerServices ? providerServices.map(s => s.service_id) : [];
                
                // Get all options except the first one (Select Service)
                const options = Array.from(serviceSelect.options).slice(1);
                
                // Hide options for services the provider already provides
                options.forEach(option => {
                    if (providedServices.includes(option.value)) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = '';
                    }
                });
                
            } catch (error) {
                console.error('Error filtering services:', error);
            }
        }
        function backToDashboard() { showDashboard(); }

async function showEditProfile() {
    hideAllViews();
    document.getElementById('editProfileView').classList.remove('hidden');
    
    // Pre-fill form with current profile data
    document.getElementById('editName').value = currentProfile.name;
    document.getElementById('editPhone').value = currentProfile.phone;
    document.getElementById('editHouseNumber').value = currentProfile.house_number || '';
    document.getElementById('editAreaName').value = currentProfile.area_name;
    document.getElementById('editLandmark').value = currentProfile.landmark || '';
    document.getElementById('editCity').value = currentProfile.city;
    document.getElementById('editState').value = currentProfile.state;
    document.getElementById('editPinCode').value = currentProfile.pin_code;
    document.getElementById('editRadius').value = currentProfile.radius_km || 10;
    
    updateProviderButton();
    
    if (currentProfile.is_provider) {
        await loadCurrentServices();
    }
}

async function loadCurrentServices() {
    try {
        const { data: services, error } = await supabase
            .from('provider_services')
            .select('service_id')
            .eq('provider_id', currentProfile.user_id);
        
        if (error) throw error;
        
        const container = document.getElementById('currentServicesList');
        
        if (!services || services.length === 0) {
            container.innerHTML = '<p style="color: #999; font-style: italic;">No services added yet</p>';
            return;
        }
        
        const serviceNames = {
            electrician: 'üîß Electrician',
            plumber: 'üö∞ Plumber',
            ac_repair: '‚ùÑÔ∏è AC Repair',
            carpenter: 'üî® Carpenter',
            painter: 'üé® Painter',
            cleaner: 'üßπ Cleaner'
        };
        
        container.innerHTML = services.map(s => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <span>${serviceNames[s.service_id] || s.service_id}</span>
                <button type="button" class="btn btn-cancel" onclick="removeService('${s.service_id}')">Remove</button>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading services:', error);
    }
}

async function addService() {
    const select = document.getElementById('newServiceSelect');
    const serviceId = select.value;
    
    if (!serviceId) {
        alert('Please select a service to add');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('provider_services')
            .insert([{
                provider_id: currentProfile.user_id,
                service_id: serviceId,
                service_radius: currentProfile.radius_km || 10
            }]);
        
        if (error) throw error;
        
        alert('‚úÖ Service added successfully!');
        select.value = '';
        await loadCurrentServices();
        
    } catch (error) {
        alert('Error adding service: ' + error.message);
    }
}

async function removeService(serviceId) {
    if (!confirm('Remove this service? This will permanently delete it from your profile.')) return;
    
    try {
        const { error } = await supabase
            .from('provider_services')
            .delete()
            .eq('provider_id', currentProfile.user_id)
            .eq('service_id', serviceId);
        
        if (error) throw error;
        
        alert('‚úÖ Service removed successfully!');
        await loadCurrentServices();
        
    } catch (error) {
        alert('Error removing service: ' + error.message);
    }
}

function backFromChat() {
    if (currentChatData && currentChatData.isPreSelection) {
        // If chatting before selection, go back to responses
        viewResponses(currentChatData.requestId);
    } else {
        // If chatting after selection, go to dashboard
        showDashboard();
    }
}

        function setupCharCounters() {
            const titleInput = document.getElementById('requestTitle');
            const descInput = document.getElementById('requestDescription');
            const editTitleInput = document.getElementById('editRequestTitle');
            const editDescInput = document.getElementById('editRequestDescription');
            
            if (titleInput) {
                titleInput.addEventListener('input', (e) => { 
                    document.getElementById('titleCounter').textContent = e.target.value.length; 
                });
            }
            
            if (descInput) {
                descInput.addEventListener('input', (e) => { 
                    document.getElementById('descCounter').textContent = e.target.value.length; 
                });
            }
            
            if (editTitleInput) {
                editTitleInput.addEventListener('input', (e) => { 
                    document.getElementById('editTitleCounter').textContent = e.target.value.length; 
                });
            }
            
            if (editDescInput) {
                editDescInput.addEventListener('input', (e) => { 
                    document.getElementById('editDescCounter').textContent = e.target.value.length; 
                });
            }
        }

        function toggleLocationFields() {
            const checked = document.getElementById('differentLocation').checked;
            document.getElementById('customLocationFields').classList.toggle('hidden', !checked);
        }

function updateProviderButton() {
    const btn = document.getElementById('toggleProviderBtn');
    const text = document.getElementById('providerStatusText');
    const isProvider = document.getElementById('editIsProvider') ? 
                       document.getElementById('editIsProvider').checked : 
                       currentProfile.is_provider;
    
    if (isProvider) {
        text.textContent = '‚úÖ Providing Services (Click to Stop)';
        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
    } else {
        text.textContent = '‚ùå Not Providing Services (Click to Start)';
        btn.style.background = 'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)';
    }
    
    document.getElementById('providerSettings').classList.toggle('hidden', !isProvider);
}

async function toggleProviderStatus() {
    const isCurrentlyProvider = currentProfile.is_provider;
    
    if (!isCurrentlyProvider) {
        // User wants to become a provider
        const confirmed = confirm('‚ö†Ô∏è Start providing services?\n\nYou will receive notifications for service requests in your selected area. You can add services and set your service radius.');
        
        if (confirmed) {
            currentProfile.is_provider = true;
            updateProviderButton();
        }
    } else {
        // User wants to stop being a provider
        const confirmed = confirm('‚ö†Ô∏è Stop providing services?\n\nYou will no longer receive notifications for service requests. All your services will be removed from your profile.');
        
        if (confirmed) {
            currentProfile.is_provider = false;
            updateProviderButton();
        }
    }
}

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: document.getElementById('loginEmail').value.trim(),
                    password: document.getElementById('loginPassword').value
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                await loadProfile();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // Signup
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('signupError');
            const infoDiv = document.getElementById('signupInfo');
            
            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            
            try {
                const formData = {
                    email: document.getElementById('signupEmail').value.trim(),
                    password: document.getElementById('signupPassword').value,
                    name: document.getElementById('signupName').value.trim(),
                    phone: document.getElementById('signupPhone').value.trim(),
                    house_number: document.getElementById('houseNumber').value.trim() || null,
                    area_name: document.getElementById('areaName').value.trim(),
                    landmark: document.getElementById('landmark').value.trim() || null,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    pin_code: document.getElementById('pinCode').value.trim(),
                    is_provider: document.getElementById('isProvider').checked
                };

                infoDiv.textContent = 'üìç Finding your location...';
                infoDiv.classList.remove('hidden');

                const coords = await getCoordinates(formData);

                infoDiv.textContent = 'üîê Creating your account...';

                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: formData.email,
                    password: formData.password
                });

                if (authError) throw authError;

                infoDiv.textContent = 'üíæ Saving your profile...';

                const { error: profileError } = await supabase.from('profiles').insert([{
                    user_id: authData.user.id,
                    name: formData.name,
                    phone: formData.phone,
                    house_number: formData.house_number,
                    area_name: formData.area_name,
                    landmark: formData.landmark,
                    city: formData.city,
                    state: formData.state,
                    pin_code: formData.pin_code,
                    latitude: coords.lat,
                    longitude: coords.lng,
                    is_provider: formData.is_provider
                }]);

                if (profileError) throw profileError;

                currentUser = authData.user;
                await loadProfile();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                infoDiv.classList.add('hidden');
            }
        });

        // Geocoding
        async function getCoordinates(formData) {
            const strategies = [
                formData.house_number 
                    ? `${formData.house_number}, ${formData.area_name}, ${formData.landmark || ''}, ${formData.city}, ${formData.state}, India`.replace(/,\s*,/g, ',')
                    : null,
                formData.landmark
                    ? `${formData.area_name}, ${formData.landmark}, ${formData.city}, ${formData.state}, India`
                    : null,
                `${formData.area_name}, ${formData.city}, ${formData.state}, India`
            ];

            for (let address of strategies.filter(Boolean)) {
                try {
                    const coords = await geocodeAddress(address);
                    if (coords) return coords;
                } catch (error) {
                    console.log('Geocoding failed for:', address);
                }
            }

            const userConfirmed = confirm('üìç Unable to find location from address. Allow GPS access?');
            if (!userConfirmed) throw new Error('Unable to locate address. Please try again or allow location access.');
            
            return await getBrowserLocation();
        }

        async function geocodeAddress(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1&countrycodes=in`;
            const response = await fetch(url, { headers: { 'User-Agent': 'HelpBuddy/1.0' } });
            const data = await response.json();
            
            if (data && data.length > 0) {
                return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            }
            return null;
        }

        function getBrowserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) reject(new Error('Geolocation not supported'));
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                    (error) => reject(new Error('Unable to locate address. Please try again or allow location access.'))
                );
            });
        }

        // Load Profile
        async function loadProfile() {
            showLoading();
            try {
                const { data, error } = await supabase.from('profiles').select('*').eq('user_id', currentUser.id).single();
                if (error) throw error;
                
                currentProfile = data;
                displayProfile(data);
                showDashboard();
            } catch (error) {
                alert('Error loading profile: ' + error.message);
                showLogin();
            }
        }

        function displayProfile(profile) {
    // Update header username
    const headerUsername = document.getElementById('headerUsername');
    if (headerUsername) {
        headerUsername.textContent = profile.name;
    }
}

        // Load Dashboard Data
        async function loadDashboardData() {
    if (currentProfile.is_provider) {
        document.getElementById('providerSection').classList.remove('hidden');
        loadProviderResponses();
        loadNearbyRequests();
    }
    
    document.getElementById('seekerSection').classList.remove('hidden');
    loadUserRequests();
}

        // Load User Requests (Seeker View)
        async function loadUserRequests() {
            try {
                const { data, error } = await supabase
                    .from('requests')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                await displayUserRequests(data || []);
                
                const openRequests = (data || []).filter(r => r.status === 'open');
                document.getElementById('createRequestBtn').disabled = openRequests.length >= 5;
                document.getElementById('requestLimitWarning').classList.toggle('hidden', openRequests.length < 5);
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        async function displayUserRequests(requests) {
            const container = document.getElementById('myRequestsList');

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No service requests yet</div>
                        <button class="btn" onclick="showCreateRequestForm()">Create Your First Request</button>
                    </div>
                `;
                
                // Update badges
                document.getElementById('myRequestsTotal').textContent = '0';
                document.getElementById('myRequestsNew').classList.add('hidden');
                document.getElementById('openCount').textContent = '0';
                document.getElementById('respondedCount').textContent = '0';
                return;
            }

            // Count statistics
            const respondedRequests = [];
            let newMessagesTotal = 0;

            // Check for responses and new messages
            for (let req of requests) {
                if (req.status === 'open') {
                    const { data: responses } = await supabase
                        .from('request_responses')
                        .select('id')
                        .eq('request_id', req.id);
                    
                    if (responses && responses.length > 0) {
                        respondedRequests.push(req.id);
                    }
                } else if (req.status === 'in_progress' || req.status === 'completed') {
                    // In progress and completed requests also count as "responded"
                    respondedRequests.push(req.id);
                }
                
                if ((req.status === 'in_progress' || req.status === 'completed') && req.selected_provider_id) {
                    const { data: chat } = await supabase
                        .from('chats')
                        .select('messages')
                        .eq('request_id', req.id)
                        .eq('provider_id', req.selected_provider_id)
                        .single();
                    
                    if (chat && chat.messages) {
                        const unread = chat.messages.filter(m => m.sender_id !== currentUser.id).length;
                        newMessagesTotal += unread;
                    }
                }
            }
            // Update section badges
            document.getElementById('myRequestsTotal').textContent = requests.length;
            document.getElementById('openCount').textContent = requests.filter(r => !respondedRequests.includes(r.id) && r.status === 'open').length;
            document.getElementById('respondedCount').textContent = respondedRequests.length;
            if (newMessagesTotal > 0) {
                document.getElementById('myRequestsNew').textContent = `üî¥ ${newMessagesTotal}`;
                document.getElementById('myRequestsNew').classList.remove('hidden');
            } else {
                document.getElementById('myRequestsNew').classList.add('hidden');
            }

            // Filter requests based on current filter
            let filteredRequests = requests;
            if (currentRequestFilter === 'open') {
                filteredRequests = requests.filter(r => !respondedRequests.includes(r.id) && r.status === 'open');
            } else if (currentRequestFilter === 'responded') {
                filteredRequests = requests.filter(r => respondedRequests.includes(r.id) || r.status === 'in_progress' || r.status === 'completed');
            }

            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No ${currentRequestFilter} requests</div>
                    </div>
                `;
                return;
            }

            let html = '';
            
            for (let req of filteredRequests) {
                const serviceIcon = SERVICE_ICONS[req.service_category] || 'üîß';
                const statusClass = `status-${req.status.replace('_', '-')}`;
                const statusText = req.status.replace('_', ' ').toUpperCase();
                const timeAgo = getTimeAgo(new Date(req.created_at));

                let responseCount = 0;
                let showResponses = false;
                let showChat = false;
                let newMessagesCount = 0;
                
                if (req.status === 'open') {
                    const { data: responses } = await supabase
                        .from('request_responses')
                        .select('id')
                        .eq('request_id', req.id);
                    
                    responseCount = responses ? responses.length : 0;
                    showResponses = responseCount > 0;
                } else if (req.status === 'in_progress' && req.selected_provider_id) {
                    showChat = true;
                    
                    const { data: chat } = await supabase
                        .from('chats')
                        .select('messages')
                        .eq('request_id', req.id)
                        .eq('provider_id', req.selected_provider_id)
                        .single();
                    
                    if (chat && chat.messages) {
                        newMessagesCount = chat.messages.filter(m => m.sender_id !== currentUser.id).length;
                    }
                }

                const urgencyBadge = req.urgency === 'urgent' ? '<span class="urgent-indicator">‚ö° URGENT</span>' : '';
                const newMessagesBadge = newMessagesCount > 0 ? `<span class="notification-badge">üí¨ ${newMessagesCount} New</span>` : '';
                const responsesBadge = showResponses ? `<span class="info-badge">üë• ${responseCount} Response${responseCount > 1 ? 's' : ''}</span>` : '';

                html += `
                    <div class="request-card compact">
                        <div class="request-card-main">
                            <div class="request-card-left">
                                <div class="request-title-compact">${serviceIcon} ${req.title}</div>
                                <div class="request-summary">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                    ${urgencyBadge}
                                    ${responsesBadge}
                                    ${newMessagesBadge}
                                </div>
                                <div class="request-summary" style="margin-top: 6px; color: #999;">
                                    üìç ${req.request_location_address.split(',').slice(0, 2).join(',')} ‚Ä¢ üïí ${timeAgo}
                               </div>
                            </div>
                        </div>
                        <div class="request-card-right">
                                ${req.status === 'open' ? '<button class="btn btn-edit action-btn-compact" onclick="editRequest(\'' + req.id + '\')">‚úèÔ∏è Edit</button>' : ''}
                                ${showResponses ? '<button class="btn btn-select action-btn-compact" onclick="viewResponses(\'' + req.id + '\')">View Responses</button>' : ''}
                                ${showChat ? '<button class="btn btn-chat action-btn-compact" onclick="openChat(\'' + req.id + '\', \'' + req.selected_provider_id + '\')">üí¨ Chat</button>' : ''}
                                <button class="expand-btn" onclick="toggleRequestDetails(event, '${req.id}')">Details ‚ñº</button>
                            </div>
                        <div class="request-details" id="details-${req.id}">
                            <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                            <div class="request-location" style="margin-top: 8px;"><strong>Full Address:</strong> ${req.request_location_address}</div>
                            <div class="request-meta" style="margin-top: 8px;">
                                <span class="meta-item">üîß Service: ${req.service_category}</span>
                            </div>
                            ${req.status === 'open' ? `<button class="btn btn-cancel" style="margin-top: 12px;" onclick="cancelRequest('${req.id}')">Cancel Request</button>` : ''}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
            

        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Toggle request details
        function toggleRequestDetails(event, requestId) {
            event.stopPropagation();
            const details = document.getElementById('details-' + requestId);
            const btn = event.target;
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                btn.textContent = 'Details ‚ñº';
            } else {
                details.classList.add('expanded');
                btn.textContent = 'Details ‚ñ≤';
            }
        }

        // Open Chat
// Open Chat Before Selection (Multi-Chat)
async function openChatBeforeSelection(requestId, providerId, chatSource = 'myRequests') {
    try {
        closeResponsesModal();
        
        if (!currentUser || !currentProfile) {
            alert('Session expired. Please login again.');
            showLogin();
            return;
        }
        
        showLoading();
        
        const { data: request, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .eq('id', requestId)
            .single();
        
        if (reqError) throw reqError;
        
        const { data: provider, error: providerError } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', providerId)
            .single();
        
        if (providerError) throw providerError;
        
        currentChatData = {
            requestId: requestId,
            providerId: providerId,
            partnerName: provider.name,
            partnerId: providerId,
            isProvider: false,
            requestStatus: request.status,
            isPreSelection: request.status === 'open',
            chatSource: chatSource
        };
        
        hideAllViews();
        document.getElementById('chatView').classList.remove('hidden');
        
        document.getElementById('chatPartnerName').textContent = `Chat with ${provider.name}`;
        document.getElementById('chatRequestStatus').textContent = request.status.replace('_', ' ').toUpperCase();
        
        document.getElementById('markCompleteBtn').style.display = 'none';
        
        await loadChatMessages();
        
        if (chatRefreshInterval) clearInterval(chatRefreshInterval);
        chatRefreshInterval = setInterval(loadChatMessages, 10000);
        
    } catch (error) {
        console.error('Error opening chat:', error);
        alert('Error opening chat: ' + error.message);
        closeResponsesModal();
        showDashboard();
    }
}
        async function openChat(requestId, providerId) {
            try {
                showLoading();
                
                // Load request details
                const { data: request, error: reqError } = await supabase
                    .from('requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (reqError) throw reqError;
                
                // Load partner profile
                const partnerId = currentProfile.user_id === request.user_id ? providerId : request.user_id;
                const { data: partner, error: partnerError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', partnerId)
                    .single();
                
                if (partnerError) throw partnerError;
                
                // Determine chat source: if current user is the provider, it's myResponses; otherwise myRequests
                const chatSource = (currentProfile.user_id === providerId) ? 'myResponses' : 'myRequests';
                
                currentChatData = {
                    requestId: requestId,
                    providerId: providerId,
                    partnerName: partner.name,
                    partnerId: partnerId,
                    isProvider: currentProfile.user_id === providerId,
                    requestStatus: request.status,
                    chatSource: chatSource
                };
                
                // Show chat view
                hideAllViews();
                document.getElementById('chatView').classList.remove('hidden');
                
                // Update chat header
                document.getElementById('chatPartnerName').textContent = `Chat with ${partner.name}`;
                document.getElementById('chatRequestStatus').textContent = request.status.replace('_', ' ').toUpperCase();
                
                // Show appropriate templates
                if (currentChatData.isProvider) {
                    
                    document.getElementById('markCompleteBtn').style.display = 'inline-block';
                } else {
                    
                    document.getElementById('markCompleteBtn').style.display = 'none';
                }
                
                // Load messages
                await loadChatMessages();
                
                // Start auto-refresh
                if (chatRefreshInterval) clearInterval(chatRefreshInterval);
                chatRefreshInterval = setInterval(loadChatMessages, 10000);
                
            } catch (error) {
                alert('Error opening chat: ' + error.message);
                showDashboard();
            }
        }

        // Load Chat Messages
        async function loadChatMessages() {
    try {
        const { data: chat, error } = await supabase
            .from('chats')
            .select('messages, contact_sharing_status')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        const messages = chat?.messages || [];
        const contactSharingApproved = chat?.contact_sharing_status === 'approved';
        const container = document.getElementById('chatMessages');
        
        if (messages.length === 0) {
            container.innerHTML = '<div class="empty-chat-state"><div class="empty-chat-state-text">No messages yet. Start the conversation!</div></div>';
            return;
        }
        
        let html = '';
        messages.forEach((msg, index) => {
            const isSent = msg.sender_id === currentUser.id;
            const messageClass = isSent ? 'sent' : 'received';
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Handle contact request messages
            if (msg.message_type === 'contact_request') {
                const status = msg.contact_request_status || 'pending';
                let cardClass = 'contact-request-card';
                let statusHTML = '';
                
                if (status === 'approved') {
                    cardClass += ' contact-status-approved';
                    statusHTML = '<p style="margin-top: 10px; font-weight: 600;">‚úÖ Approved - Contact details visible below</p>';
                } else if (status === 'declined') {
                    cardClass += ' contact-status-declined';
                    statusHTML = '<p style="margin-top: 10px; font-weight: 600;">‚ùå Declined</p>';
                } else if (!isSent && status === 'pending') {
                    // Show approval buttons to receiver
                    statusHTML = `
                        <div class="contact-approval-buttons">
                            <button class="btn-approve" onclick="approveContactSharing(${index})">‚úÖ Approve</button>
                            <button class="btn-decline" onclick="declineContactSharing(${index})">‚ùå Decline</button>
                        </div>
                    `;
                } else if (isSent && status === 'pending') {
                    statusHTML = '<p style="margin-top: 10px; color: #856404; font-size: 12px;">‚è≥ Waiting for approval...</p>';
                }
                
                html += `
                    <div class="${cardClass}" style="margin: 15px 0;">
                        <div class="contact-request-title">üìû Contact Sharing Request</div>
                        <p style="font-size: 13px; color: #555;">From: ${msg.sender_name}</p>
                        ${statusHTML}
                    </div>
                `;
            } 
            // Handle system messages
            else if (msg.message_type === 'system') {
                html += `
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 8px; font-size: 13px; color: #555;">
                        ${msg.message}
                    </div>
                `;
            }
            // Handle regular messages
            else {
                html += `
                    <div class="message ${messageClass}">
                        <div class="message-bubble">
                            ${msg.message}
                            ${msg.image ? `<img src="${msg.image}" class="message-image" alt="Shared image" onclick="openImagePreview('${msg.image}')">` : ''}
                        </div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }
        });
        
        // Show contact details if approved
        if (contactSharingApproved) {
            html += await generateContactDetailsCard();
        }
        
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
        
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

// Generate Contact Details Card
async function generateContactDetailsCard() {
    try {
        // Get partner's profile
        const { data: partnerProfile } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', currentChatData.partnerId)
            .single();
        
        if (!partnerProfile) return '';
        
        const partnerAddress = [
            partnerProfile.house_number,
            partnerProfile.area_name,
            partnerProfile.landmark,
            partnerProfile.city,
            partnerProfile.state,
            partnerProfile.pin_code
        ].filter(Boolean).join(', ');
        
        return `
            <div class="contact-details-card" style="margin: 20px 0;">
                <div style="font-weight: 700; color: #0d47a1; margin-bottom: 12px; font-size: 15px;">
                    üìû Contact Details - ${partnerProfile.name}
                </div>
                <p><strong>üì± Phone:</strong> ${partnerProfile.phone}</p>
                <p><strong>üìç Address:</strong> ${partnerAddress}</p>
                <p style="font-size: 11px; color: #666; margin-top: 10px; font-style: italic;">
                    ‚ÑπÔ∏è Contact information is only visible because both parties approved sharing.
                </p>
            </div>
        `;
    } catch (error) {
        console.error('Error generating contact details:', error);
        return '';
    }
}

// Open Image Preview (Full Screen)
function openImagePreview(imageUrl) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    modal.innerHTML = `
        <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
        <button style="position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">√ó</button>
    `;
    
    modal.onclick = () => document.body.removeChild(modal);
    document.body.appendChild(modal);
}
        // Send Message
        async function sendMessage() {
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                // Get existing chat
                const { data: existingChat, error: fetchError } = await supabase
                    .from('chats')
                    .select('messages')
                    .eq('request_id', currentChatData.requestId)
                    .eq('provider_id', currentChatData.providerId)
                    .single();
                
                let messages = existingChat?.messages || [];
                
                // Add new message
                messages.push({
                    sender_id: currentUser.id,
                    sender_name: currentProfile.name,
                    message: message,
                    timestamp: new Date().toISOString()
                });
                
                // Upsert chat
                const { error: upsertError } = await supabase
                    .from('chats')
                    .upsert({
                        request_id: currentChatData.requestId,
                        provider_id: currentChatData.providerId,
                        messages: messages
                    }, { onConflict: 'request_id,provider_id' });
                
                if (upsertError) throw upsertError;
                
                input.value = '';
                await loadChatMessages();
                
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        }

        // Handle Photo Upload
        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const { data: existingChat } = await supabase
                        .from('chats')
                        .select('messages')
                        .eq('request_id', currentChatData.requestId)
                        .eq('provider_id', currentChatData.providerId)
                        .single();
                    
                    let messages = existingChat?.messages || [];
                    
                    messages.push({
                        sender_id: currentUser.id,
                        sender_name: currentProfile.name,
                        message: 'üì∑ Shared a photo',
                        image: e.target.result,
                        timestamp: new Date().toISOString()
                    });
                    
                    await supabase
                        .from('chats')
                        .upsert({
                            request_id: currentChatData.requestId,
                            provider_id: currentChatData.providerId,
                            messages: messages
                        }, { onConflict: 'request_id,provider_id' });
                    
                    event.target.value = '';
                    await loadChatMessages();
                    
                } catch (error) {
                    alert('Error uploading photo: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        // Toggle Template Category
        function toggleTemplateCategory(element) {
            const items = element.nextElementSibling;
            const isCurrentlyOpen = items.classList.contains('open');
            
            // Close all other open categories first (accordion behavior)
            document.querySelectorAll('.template-category-items.open').forEach(openItem => {
                if (openItem !== items) {
                    openItem.classList.remove('open');
                    // Update the arrow icon for closed categories
                    const header = openItem.previousElementSibling;
                    if (header && header.textContent.includes('‚ñ∂')) {
                        header.innerHTML = header.innerHTML.replace('‚ñ∂', '‚ñº');
                    }
                }
            });
            
            // Toggle the clicked category
            items.classList.toggle('open');
            element.textContent = element.textContent.includes('‚ñº') 
                ? element.textContent.replace('‚ñº', '‚ñ∂')
                : element.textContent.replace('‚ñ∂', '‚ñº');
        }

        // Insert Template
        function insertTemplate(element) {
            document.getElementById('chatMessageInput').value = element.textContent;
            document.getElementById('chatMessageInput').focus();
            closeTemplateModal();
        }

        // Open Template Modal
        function openTemplateModal() {
            const modal = document.getElementById('templateModal');
            const container = document.getElementById('templateCategoriesContainer');
            
            // Determine templates based on chat source (which section the chat came from)
            const templates = (currentChatData.chatSource === 'myRequests') ? seekerTemplatesData : providerTemplatesData;
            
            // Build HTML for modal
            let html = '';
            templates.forEach(category => {
                html += `
                    <div class="template-category-block">
                        <div class="template-category-header" onclick="toggleTemplateCategory(this)">
                            <span>${category.title}</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="template-category-items">
                            ${category.items.map(item => `
                                <div class="template-option" onclick="selectTemplateOption(this)">
                                    ${item}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            modal.classList.add('active');
        }

        // Close Template Modal
        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        

        // Select Template Option
        function selectTemplateOption(element) {
            document.getElementById('chatMessageInput').value = element.textContent.trim();
            document.getElementById('chatMessageInput').focus();
            closeTemplateModal();
        }

        // Template Data
        const seekerTemplatesData = [
            {
                title: 'üí¨ Initial Contact',
                items: [
                    'Hi! Can you provide more details about the service?',
                    'What is your availability for this work?',
                    'Can you share your experience with similar work?'
                ]
            },
            {
                title: 'üìÖ Scheduling',
                items: [
                    'When can you start the work?',
                    'How long will it take to complete?',
                    'Can you come today or tomorrow?'
                ]
            },
            {
                title: 'üí∞ Pricing',
                items: [
                    'What will be the estimated cost?',
                    'Do you charge for inspection/visit?',
                    'Is this price negotiable?'
                ]
            },
            {
                title: '‚ÑπÔ∏è Additional Info',
                items: [
                    'Do you have the necessary tools and equipment?',
                    'Will you provide materials or should I arrange them?',
                    'Can you share photos of previous work?',
                    'Do you offer any warranty on your work?'
                ]
            },
            {
                title: 'ü§ù Contact & Finalization',
                items: [
                    'Let\'s finalize this deal. Can we exchange contact details?',
                    'I\'d like to proceed with you. When can we meet?',
                    'Sounds good! Please share your contact number.'
                ]
            }
        ];

        const providerTemplatesData = [
            {
                title: 'üëã Response',
                items: [
                    'Hi! I\'m available and interested in this work.',
                    'I have experience in this type of work. Happy to help!',
                    'I can start immediately. Let me know if you\'d like to proceed.'
                ]
            },
            {
                title: 'üí∞ Pricing',
                items: [
                    'The estimated cost will be around ‚ÇπXXX.',
                    'I can provide a detailed quote after inspection.',
                    'No charges for initial visit and inspection.'
                ]
            },
            {
                title: '‚ÑπÔ∏è Information Requests',
                items: [
                    'Can you share more details or photos of the problem?',
                    'What is your preferred time for the visit?',
                    'Are there any specific requirements I should know about?'
                ]
            },
            {
                title: 'ü§ù Contact & Finalization',
                items: [
                    'I\'m ready to start. Can we exchange contact details?',
                    'Please share your address so I can visit.',
                    'Let\'s finalize the schedule. Here\'s my contact number.'
                ]
            },
            {
                title: '‚úÖ Service Completion',
                items: [
                    'Work completed successfully. Please check and confirm.',
                    'Everything is done. Let me know if you need any adjustments.',
                    'The service is complete. Feel free to contact me during warranty period.'
                ]
            }
        ];

        // Request Contact Sharing
        async function requestContactSharing() {
    if (!confirm('üìû REQUEST CONTACT SHARING?\n\n‚ö†Ô∏è WARNING: If approved, BOTH parties will see:\n‚Ä¢ Phone number\n‚Ä¢ Full address\n\nüîí Contact info will be visible ONLY after the other person approves.\n\nDo you want to send this request?')) return;
    try {
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages, contact_sharing_status')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Add contact request message with special type
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: 'üìû Requesting to share contact information for finalizing the deal.',
            message_type: 'contact_request',
            contact_request_status: 'pending',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages,
                contact_sharing_status: 'pending'
            }, { onConflict: 'request_id,provider_id' });
        
        await loadChatMessages();
        alert('‚úÖ Contact sharing request sent!');
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

	// Approve Contact Sharing
async function approveContactSharing(messageIndex) {
    try {
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Update the request message status
        if (messages[messageIndex]) {
            messages[messageIndex].contact_request_status = 'approved';
        }
        
        // Add approval notification message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: '‚úÖ Contact sharing approved! Contact details are now visible to both parties.',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .upsert({
                request_id: currentChatData.requestId,
                provider_id: currentChatData.providerId,
                messages: messages,
                contact_sharing_status: 'approved'
            }, { onConflict: 'request_id,provider_id' });
        
        await loadChatMessages();
        alert('‚úÖ Contact information is now shared!');
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Decline Contact Sharing
async function declineContactSharing(messageIndex) {
    if (!confirm('Decline contact sharing request?')) return;
    
    try {
        const { data: existingChat } = await supabase
            .from('chats')
            .select('messages')
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId)
            .single();
        
        let messages = existingChat?.messages || [];
        
        // Update the request message status
        if (messages[messageIndex]) {
            messages[messageIndex].contact_request_status = 'declined';
        }
        
        // Add decline notification message
        messages.push({
            sender_id: currentUser.id,
            sender_name: currentProfile.name,
            message: '‚ùå Contact sharing request declined.',
            message_type: 'system',
            timestamp: new Date().toISOString()
        });
        
        await supabase
            .from('chats')
            .update({
                messages: messages
            })
            .eq('request_id', currentChatData.requestId)
            .eq('provider_id', currentChatData.providerId);
        
        await loadChatMessages();
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
        // Show Warranty Form
        function showWarrantyForm() {
            document.getElementById('warrantyForm').classList.remove('hidden');
        }

        // Complete Work
        async function completeWork() {
            const selectedWarranty = document.querySelector('input[name="warranty"]:checked');
            
            if (!selectedWarranty) {
                alert('Please select a warranty period');
                return;
            }
            
            if (!confirm('Mark this work as completed? This will start the warranty period.')) return;
            
            try {
                const warrantyMonths = parseInt(selectedWarranty.value);
                const warrantyEndDate = new Date();
                warrantyEndDate.setMonth(warrantyEndDate.getMonth() + warrantyMonths);
                
                const { error } = await supabase
                    .from('requests')
                    .update({
                        status: 'completed',
                        warranty_period: warrantyMonths,
                        warranty_end_date: warrantyEndDate.toISOString()
                    })
                    .eq('id', currentChatData.requestId);
                
                if (error) throw error;
                
                // Send completion message
                const { data: existingChat } = await supabase
                    .from('chats')
                    .select('messages')
                    .eq('request_id', currentChatData.requestId)
                    .eq('provider_id', currentChatData.providerId)
                    .single();
                
                let messages = existingChat?.messages || [];
                
                messages.push({
                    sender_id: currentUser.id,
                    sender_name: currentProfile.name,
                    message: `‚úÖ Work marked as completed! Warranty: ${warrantyMonths} month${warrantyMonths > 1 ? 's' : ''}.`,
                    timestamp: new Date().toISOString()
                });
                
                await supabase
                    .from('chats')
                    .upsert({
                        request_id: currentChatData.requestId,
                        provider_id: currentChatData.providerId,
                        messages: messages
                    }, { onConflict: 'request_id,provider_id' });
                
                alert('‚úÖ Work completed successfully! Warranty period started.');
                document.getElementById('warrantyForm').classList.add('hidden');
                document.getElementById('chatRequestStatus').textContent = 'COMPLETED';
                currentChatData.requestStatus = 'completed';
                await loadChatMessages();
                
                // Open rating modal for seeker
                if (!currentChatData.isProvider) {
                    setTimeout(() => {
                        openRatingModal(currentChatData.requestId, currentChatData.providerId, currentChatData.partnerName);
                    }, 1000);
                }
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // View Responses
        async function viewResponses(requestId) {
            selectedResponseRequest = requestId;
            
            try {
                const { data: responses, error } = await supabase
                    .from('request_responses')
                    .select('*, provider_id')
                    .eq('request_id', requestId);
                
                if (error) throw error;
                
                if (!responses || responses.length === 0) {
                    document.getElementById('responsesList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-text">No responses yet</div>
                        </div>
                    `;
                    document.getElementById('responsesModal').classList.add('active');
                    return;
                }
                
                let html = '';
                
                for (let response of responses) {
                    const { data: provider } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('user_id', response.provider_id)
                        .single();
                    
                    const { data: ratings } = await supabase
                        .from('ratings')
                        .select('rating')
                        .eq('provider_id', response.provider_id);
                    
                    let ratingDisplay = 'No ratings yet';
                    if (ratings && ratings.length > 0) {
                        const avgRating = (ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length).toFixed(1);
                        const stars = '‚≠ê'.repeat(Math.round(avgRating));
                        ratingDisplay = `${stars} ${avgRating}/5 (${ratings.length} ${ratings.length === 1 ? 'rating' : 'ratings'})`;
                    }
                    
                    const { data: request } = await supabase
                        .from('requests')
                        .select('request_latitude, request_longitude')
                        .eq('id', requestId)
                        .single();
                    
                    const distance = calculateDistance(
                        request.request_latitude,
                        request.request_longitude,
                        provider.latitude,
                        provider.longitude
                    );
                    
                    const respondedTime = new Date(response.created_at);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - respondedTime) / 60000);
                    const timeAgo = diffMinutes < 1 ? 'Just now' : 
                                   diffMinutes < 60 ? `${diffMinutes} min ago` :
                                   diffMinutes < 1440 ? `${Math.floor(diffMinutes/60)} hours ago` :
                                   `${Math.floor(diffMinutes/1440)} days ago`;
                    
                    html += `
    <div class="provider-card">
        <div class="provider-name">üë§ ${provider.name}</div>
        <div class="provider-info">üìç Distance: ${distance} km away</div>
        <div class="provider-info">üïí Responded: ${timeAgo}</div>
        <div class="rating-display">${ratingDisplay}</div>
        <div class="provider-actions">
            <button class="btn btn-view-profile" onclick="viewProviderProfile('${response.provider_id}')">View Profile</button>
            <button class="btn btn-chat" onclick="openChatBeforeSelection('${requestId}', '${response.provider_id}')">üí¨ Chat</button>
            <button class="btn btn-select" onclick="selectProvider('${requestId}', '${response.provider_id}')">Select Provider</button>
        </div>
    </div>
`;
                }
                
                document.getElementById('responsesList').innerHTML = html;
                document.getElementById('responsesModal').classList.add('active');
            } catch (error) {
                alert('Error loading responses: ' + error.message);
            }
        }

        // Calculate Distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return parseFloat((R * c).toFixed(2));
        }

        // View Provider Profile
        async function viewProviderProfile(providerId) {
            try {
                const { data: provider } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', providerId)
                    .single();
                
                const { data: services } = await supabase
                    .from('provider_services')
                    .select('service_id')
                    .eq('provider_id', providerId);
                
                const serviceList = services && services.length > 0 
                    ? services.map(s => s.service_id).join(', ')
                    : 'No services listed';
                
                const addr = [provider.house_number, provider.area_name, provider.landmark, provider.city, provider.state, provider.pin_code].filter(Boolean).join(', ');
                
                const { data: ratings } = await supabase
                    .from('ratings')
                    .select('rating, review, created_at')
                    .eq('provider_id', providerId)
                    .order('created_at', { ascending: false });
                
                let ratingDisplay = 'No ratings yet';
                let ratingDetailsHTML = '';
                
                if (ratings && ratings.length > 0) {
                    const avgRating = (ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length).toFixed(1);
                    const stars = '‚≠ê'.repeat(Math.round(avgRating));
                    ratingDisplay = `${stars} ${avgRating}/5 (${ratings.length} ${ratings.length === 1 ? 'rating' : 'ratings'})`;
                    
                    // Show recent reviews
                    ratingDetailsHTML = '<hr style="margin: 20px 0;"><h3 style="margin-bottom: 15px;">Recent Reviews:</h3>';
                    ratings.slice(0, 3).forEach(r => {
                        const reviewStars = '‚≠ê'.repeat(r.rating);
                        const reviewDate = new Date(r.created_at).toLocaleDateString();
                        ratingDetailsHTML += `
                            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${reviewStars} ${r.rating}/5</div>
                                ${r.review ? `<p style="color: #555; margin-bottom: 5px;">"${r.review}"</p>` : ''}
                                <p style="font-size: 12px; color: #999;">${reviewDate}</p>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('profileContent').innerHTML = `
                    <div class="profile-details">
                        <p><strong>üë§ Name:</strong> ${provider.name}</p>
                        <p><strong>‚≠ê Rating:</strong> ${ratingDisplay}</p>
                        <p><strong>üîß Services:</strong> ${serviceList}</p>
                        <p><strong>üìç Address:</strong> ${addr}</p>
                        <p><strong>üìå Note:</strong> Phone number and full contact details will be shared after both parties agree to connect.</p>
                        ${ratingDetailsHTML}
                    </div>
                `;
                
                document.getElementById('profileModal').classList.add('active');
            } catch (error) {
                alert('Error loading profile: ' + error.message);
            }
        }

        // Select Provider
        async function selectProvider(requestId, providerId) {
            if (!confirm('Select this provider? This will change request status to "In Progress" and open chat.')) return;
            
            try {
                const { error } = await supabase
                    .from('requests')
                    .update({ 
                        selected_provider_id: providerId, 
                        status: 'in_progress' 
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                closeResponsesModal();
                closeProfileModal();
                
                alert('‚úÖ Provider selected! Opening chat...');
                await openChat(requestId, providerId);
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Close Modals
        function closeResponsesModal() {
            document.getElementById('responsesModal').classList.remove('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

// Load Provider Responses
        async function loadProviderResponses() {
    try {
        // Get all responses by this provider
        const { data: responses, error: respError } = await supabase
            .from('request_responses')
            .select('*')
            .eq('provider_id', currentProfile.user_id)
            .order('created_at', { ascending: false });
        
        if (respError) throw respError;
        
        if (!responses || responses.length === 0) {
            document.getElementById('myResponsesList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí¨</div>
                    <div class="empty-state-text">No responses yet. Respond to nearby requests to start!</div>
                </div>
            `;
            document.getElementById('myResponsesTotal').textContent = '0';
            document.getElementById('myResponsesNew').classList.add('hidden');
            return;
        }
        
        // Get full request details for each response
        const requestIds = responses.map(r => r.request_id);
        const { data: requests, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .in('id', requestIds);
        
        if (reqError) throw reqError;
        
        // Get seeker profiles
        const userIds = requests.map(r => r.user_id);
        const { data: seekers, error: seekerError } = await supabase
            .from('profiles')
            .select('user_id, name')
            .in('user_id', userIds);
        
        if (seekerError) throw seekerError;
        
        // Check for unread messages in each chat
        const chatChecks = await Promise.all(responses.map(async (response) => {
            const { data: chat } = await supabase
                .from('chats')
                .select('messages')
                .eq('request_id', response.request_id)
                .eq('provider_id', currentProfile.user_id)
                .single();
            
            if (!chat || !chat.messages) return { requestId: response.request_id, hasMessages: false, unreadCount: 0 };
            
            const unreadCount = chat.messages.filter(m => 
                m.sender_id !== currentProfile.user_id
            ).length;
            
            return { 
                requestId: response.request_id, 
                hasMessages: chat.messages.length > 0,
                unreadCount: unreadCount
            };
        }));
        
        // Combine all data - filter out invalid/deleted requests
        const combinedData = responses.map(response => {
            const request = requests.find(r => r.id === response.request_id);
            
            // Skip if request was deleted or invalid
            if (!request || !request.request_latitude || !request.request_longitude) {
                return null;
            }
            
            const seeker = seekers.find(s => s.user_id === request.user_id);
            const chatInfo = chatChecks.find(c => c.requestId === response.request_id);
            
            return {
                ...response,
                request: request,
                seekerName: seeker?.name || 'Unknown',
                hasMessages: chatInfo?.hasMessages || false,
                unreadCount: chatInfo?.unreadCount || 0
            };
        }).filter(data => data !== null);
        
        await displayProviderResponses(combinedData);
        document.getElementById('myResponsesTotal').textContent = combinedData.length;
        
    } catch (error) {
        console.error('Error loading provider responses:', error);
    } 
}

async function displayProviderResponses(responsesData) {
            const container = document.getElementById('myResponsesList');
            
            if (!responsesData || responsesData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <div class="empty-state-text">No responses yet. Respond to nearby requests to start!</div>
                    </div>
                `;
                document.getElementById('myResponsesTotal').textContent = '0';
                document.getElementById('myResponsesNew').classList.add('hidden');
                return;
            }
            
            // Count statistics
            const unreadTotal = responsesData.reduce((sum, d) => sum + (d.unreadCount || 0), 0);
            
            // Update section badges
            document.getElementById('myResponsesTotal').textContent = responsesData.length;
            if (unreadTotal > 0) {
                document.getElementById('myResponsesNew').textContent = `üî¥ ${unreadTotal}`;
                document.getElementById('myResponsesNew').classList.remove('hidden');
            } else {
                document.getElementById('myResponsesNew').classList.add('hidden');
            }
            
            let html = '';
            
            for (let data of responsesData) {
                const req = data.request;
                if (!req) continue;
                
                const icon = SERVICE_ICONS[req.service_category] || 'üîß';
                const timeAgo = getTimeAgo(new Date(data.created_at));
                
                // Determine status
                let statusBadge = '';
                let chatButton = '';
                
                if (req.status === 'completed') {
                    statusBadge = '<span class="status-badge status-completed">‚úÖ COMPLETED</span>';
                    chatButton = `<button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">View Chat</button>`;
                } else if (req.status === 'in_progress' && req.selected_provider_id === currentProfile.user_id) {
                    statusBadge = '<span class="status-badge status-in-progress">üîÑ IN PROGRESS</span>';
                    chatButton = `<button class="btn btn-chat action-btn-compact" onclick="openChat('${req.id}', '${currentProfile.user_id}')">üí¨ Chat</button>`;
                } else if (req.status === 'in_progress' && req.selected_provider_id !== currentProfile.user_id) {
                    statusBadge = '<span class="status-badge" style="background: #f8d7da; color: #721c24;">‚ùå Not Selected</span>';
                } else if (req.status === 'open') {
                    statusBadge = '<span class="status-badge status-open">‚è≥ PENDING</span>';
                    chatButton = `<button class="btn btn-chat action-btn-compact" onclick="openChatBeforeSelection('${req.id}', '${currentProfile.user_id}', 'myResponses')">üí¨ Chat</button>`;
                }
                
                const urgencyBadge = req.urgency === 'urgent' ? '<span class="urgent-indicator">‚ö° URGENT</span>' : '';
                const unreadBadge = data.unreadCount > 0 ? `<span class="notification-badge">üí¨ ${data.unreadCount} New</span>` : '';
                
                const distance = calculateDistance(
                    currentProfile.latitude,
                    currentProfile.longitude,
                    req.request_latitude,
                    req.request_longitude
                );
                
                html += `
                    <div class="request-card compact">
                        <div class="request-card-main">
                            <div class="request-card-left">
                                <div class="request-title-compact">${icon} ${req.title}</div>
                                <div class="request-summary">
                                    ${statusBadge}
                                    ${urgencyBadge}
                                    ${unreadBadge}
                                </div>
                                <div class="request-summary" style="margin-top: 6px; color: #999;">
                                    üë§ ${data.seekerName} ‚Ä¢ üìç ${distance} km ‚Ä¢ üïí ${timeAgo}
                                </div>
                            </div>
                            <div class="request-card-right">
                                ${chatButton}
                                <button class="expand-btn" onclick="toggleRequestDetails(event, 'resp-${req.id}')">Details ‚ñº</button>
                            </div>
                        </div>
                        <div class="request-details" id="details-resp-${req.id}">
                            <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                            <div class="request-location" style="margin-top: 8px;"><strong>Location:</strong> ${req.request_location_address}</div>
                            <div class="request-meta" style="margin-top: 8px;">
                                <span class="meta-item">üîß Service: ${req.service_category}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Load Nearby Requests (Provider View)
        async function loadNearbyRequests() {
    try {
        const { data: allRequests, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .eq('status', 'open');
        
        if (reqError) throw reqError;

        const nearby = [];
        
        for (let req of allRequests || []) {
            const distance = calculateDistance(
                currentProfile.latitude,
                currentProfile.longitude,
                req.request_latitude,
                req.request_longitude
            );
            
            const { data: providerServices } = await supabase
                .from('provider_services')
                .select('*')
                .eq('provider_id', currentProfile.user_id)
                .eq('service_id', req.service_category);

            if (!providerServices || providerServices.length === 0) continue;
            
            const serviceRadius = providerServices[0].service_radius;
            
            if (distance <= serviceRadius) {
                nearby.push({
                    ...req,
                    distance: distance,
                    serviceRadius: serviceRadius
                });
            }
        }

        // Update badges safely
        const totalCount = nearby.length;
        const totalElement = document.getElementById('availableWorkTotal');
        const newElement = document.getElementById('availableWorkNew');
        
        if (totalElement) totalElement.textContent = totalCount;
        
        const newCount = nearby.filter(r => {
            const hoursSince = (new Date() - new Date(r.created_at)) / (1000 * 60 * 60);
            return hoursSince < 2;
        }).length;
        
        if (newElement) {
            if (newCount > 0) {
                newElement.textContent = `üÜï ${newCount}`;
                newElement.classList.remove('hidden');
            } else {
                newElement.classList.add('hidden');
            }
        }
        
        displayNearbyRequests(nearby);
        
    } catch (error) {
        console.error('Error loading nearby requests:', error);
    }
}

async function displayNearbyRequests(requests) {
            const container = document.getElementById('nearbyRequestsList');
            const tabsContainer = document.getElementById('urgencyTabs');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <div class="empty-state-text">No nearby requests available</div>
                    </div>
                `;
                tabsContainer.innerHTML = '';
                document.getElementById('availableWorkTotal').textContent = '0';
                document.getElementById('availableWorkNew').classList.add('hidden');
                return;
            }

            // Count by urgency
            const urgentCount = requests.filter(r => r.urgency === 'urgent').length;
            const normalCount = requests.filter(r => r.urgency === 'normal').length;
            const flexibleCount = requests.filter(r => r.urgency === 'low').length;
            const newCount = requests.filter(r => {
                const hoursSince = (new Date() - new Date(r.created_at)) / (1000 * 60 * 60);
                return hoursSince < 2;
            }).length;

            // Update section badges
            document.getElementById('availableWorkTotal').textContent = requests.length;
            if (newCount > 0) {
                document.getElementById('availableWorkNew').textContent = `üÜï ${newCount}`;
                document.getElementById('availableWorkNew').classList.remove('hidden');
            } else {
                document.getElementById('availableWorkNew').classList.add('hidden');
            }

            // Build dynamic tabs based on available urgencies
            let tabsHTML = '<button class="sub-tab ' + (currentUrgencyFilter === 'all' ? 'active' : '') + '" onclick="filterByUrgency(\'all\')">All <span class="count-badge">' + requests.length + '</span></button>';
            
            if (urgentCount > 0) {
                tabsHTML += '<button class="sub-tab ' + (currentUrgencyFilter === 'urgent' ? 'active' : '') + '" onclick="filterByUrgency(\'urgent\')">‚ö° URGENT <span class="count-badge">' + urgentCount + '</span></button>';
            }
            if (normalCount > 0) {
                tabsHTML += '<button class="sub-tab ' + (currentUrgencyFilter === 'normal' ? 'active' : '') + '" onclick="filterByUrgency(\'normal\')">üü° NORMAL <span class="count-badge">' + normalCount + '</span></button>';
            }
	    if (flexibleCount > 0) {
                tabsHTML += '<button class="sub-tab ' + (currentUrgencyFilter === 'low' ? 'active' : '') + '" onclick="filterByUrgency(\'low\')">üü¢ FLEXIBLE <span class="count-badge">' + flexibleCount + '</span></button>';
            }
            
            tabsContainer.innerHTML = tabsHTML;

            // Filter requests based on current urgency filter
            let filteredRequests = requests;
            if (currentUrgencyFilter !== 'all') {
                filteredRequests = requests.filter(r => r.urgency === currentUrgencyFilter);
            }

            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <div class="empty-state-text">No ${currentUrgencyFilter} requests available</div>
                    </div>
                `;
                return;
            }

            let html = '';
            
            for (let req of filteredRequests) {
                const icon = SERVICE_ICONS[req.service_category] || 'üîß';
                const timeAgo = getTimeAgo(new Date(req.created_at));
                
                // Check if provider already responded
                const { data: existingResponse } = await supabase
                    .from('request_responses')
                    .select('id')
                    .eq('request_id', req.id)
                    .eq('provider_id', currentProfile.user_id);
                
                const hasResponded = existingResponse && existingResponse.length > 0;
                const buttonText = hasResponded ? '‚úÖ Responded' : 'Respond';
                const buttonStyle = hasResponded ? 'background: #6c757d;' : '';
                const buttonClass = hasResponded ? 'btn-secondary' : 'btn-respond';
                
                const urgencyBadge = req.urgency === 'urgent' ? '<span class="urgent-indicator">‚ö° URGENT</span>' : 
                                     req.urgency === 'normal' ? '<span style="background: #ffc107; color: #333; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">üü° NORMAL</span>' :
                                     '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">üü¢ FLEXIBLE</span>';
                
                const newBadge = ((new Date() - new Date(req.created_at)) / (1000 * 60 * 60)) < 2 ? '<span class="info-badge">üÜï NEW</span>' : '';
                
                html += `
                    <div class="request-card compact">
                        <div class="request-card-main">
                            <div class="request-card-left">
                                <div class="request-title-compact">${icon} ${req.title}</div>
                                <div class="request-summary">
                                    <span class="info-badge">üìç ${req.distance} km</span>
                                    ${urgencyBadge}
                                    ${newBadge}
                                </div>
                                <div class="request-summary" style="margin-top: 6px; color: #999;">
                                    üïí ${timeAgo} ‚Ä¢ üîß ${req.service_category}
                                </div>
                            </div>
                            <div class="request-card-right">
                                <button class="btn ${buttonClass} action-btn-compact" onclick="respondToRequest('${req.id}')" style="${buttonStyle}">${buttonText}</button>
                                <button class="expand-btn" onclick="toggleRequestDetails(event, 'nearby-${req.id}')">Details ‚ñº</button>
                            </div>
                        </div>
                        <div class="request-details" id="details-nearby-${req.id}">
                            <div class="request-description"><strong>Description:</strong> ${req.description}</div>
                            <div class="request-location" style="margin-top: 8px;"><strong>Location:</strong> ${req.request_location_address}</div>
                            <div class="request-meta" style="margin-top: 8px;">
                                <span class="meta-item">üìè Distance: ${req.distance} km</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

// Respond to Request (Provider)
        async function respondToRequest(requestId) {
            const respondBtn = event.target;
            respondBtn.disabled = true;
            respondBtn.textContent = 'Checking...';
            
            try {
                const { data: existingResponse, error: checkError } = await supabase
                    .from('request_responses')
                    .select('id')
                    .eq('request_id', requestId)
                    .eq('provider_id', currentProfile.user_id);

                if (checkError) throw checkError;

                if (existingResponse && existingResponse.length > 0) {
                    alert('‚ö†Ô∏è You have already responded to this request!');
                    respondBtn.textContent = '‚úÖ Responded';
                    respondBtn.style.background = '#6c757d';
                    respondBtn.disabled = false;
                    return;
                }

                const { error: insertError } = await supabase
                    .from('request_responses')
                    .insert([{
                        request_id: requestId,
                        provider_id: currentProfile.user_id,
                        status: 'pending',
                        availability: 'available',
                        response_message: `Hi! I am interested in providing this service.`
                    }]);

                if (insertError) throw insertError;

                alert('‚úÖ Response sent successfully! The seeker will see your response and can chat with you.');
                
                // Change button to show "Responded"
                respondBtn.textContent = '‚úÖ Responded';
                respondBtn.style.background = '#6c757d';
                respondBtn.disabled = false;
                
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                respondBtn.disabled = false;
                respondBtn.textContent = 'Respond to Request';
            }
        }

        // Cancel Request
        async function cancelRequest(requestId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to cancel this request?')) return;
            
            try {
                const { error } = await supabase
                    .from('requests')
                    .delete()
                    .eq('id', requestId);
                
                if (error) throw error;
                
                alert('‚úÖ Request cancelled successfully');
                loadUserRequests();
            } catch (error) {
                alert('Error cancelling request: ' + error.message);
            }
        }

// Edit Request - Load form with existing data
        async function editRequest(requestId) {
            try {
                showLoading();
                
                // Check if request has any responses
                const { data: responses } = await supabase
                    .from('request_responses')
                    .select('id')
                    .eq('request_id', requestId);
                
                if (responses && responses.length > 0) {
                    alert('‚ö†Ô∏è Cannot edit request after providers have responded. Please cancel and create a new request.');
                    showDashboard();
                    return;
                }
                
                // Load request data
                const { data: request, error } = await supabase
                    .from('requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (error) throw error;
                
                if (request.status !== 'open') {
                    alert('‚ö†Ô∏è Only open requests can be edited.');
                    showDashboard();
                    return;
                }
                
                // Show edit view and populate form
                hideAllViews();
                document.getElementById('editRequestView').classList.remove('hidden');
                
                // Populate form fields
                document.getElementById('editRequestId').value = request.id;
                document.getElementById('editServiceType').value = request.service_category;
                document.getElementById('editRequestTitle').value = request.title;
                document.getElementById('editRequestDescription').value = request.description;
                
                // Update character counters
                document.getElementById('editTitleCounter').textContent = request.title.length;
                document.getElementById('editDescCounter').textContent = request.description.length;
                
                // Set urgency
                document.getElementById('editUrgentRadio').checked = request.urgency === 'urgent';
                document.getElementById('editNormalRadio').checked = request.urgency === 'normal';
                document.getElementById('editLowRadio').checked = request.urgency === 'low';
                
                // Show current location (read-only)
                document.getElementById('currentLocationText').textContent = request.request_location_address;
                
            } catch (error) {
                alert('Error loading request: ' + error.message);
                showDashboard();
            }
        }

// Edit Request Form Submission
        document.getElementById('editRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('editRequestError');
            const infoDiv = document.getElementById('editRequestInfo');
            const submitBtn = document.getElementById('updateRequestBtn');

            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';

            try {
                const requestId = document.getElementById('editRequestId').value;
                const title = document.getElementById('editRequestTitle').value.trim();
                const description = document.getElementById('editRequestDescription').value.trim();
                const urgency = document.querySelector('input[name="editUrgency"]:checked').value;

                const updateData = {
                    title: title,
                    description: description,
                    urgency: urgency
                };

                infoDiv.textContent = 'üíæ Updating request...';
                infoDiv.classList.remove('hidden');
                const { error } = await supabase
                    .from('requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                infoDiv.classList.add('hidden');
                alert('‚úÖ Request updated successfully!');
                showDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Update Request';
                infoDiv.classList.add('hidden');
            }
        });

        // Create Request
        document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('createRequestError');
            const infoDiv = document.getElementById('createRequestInfo');
            const submitBtn = document.getElementById('submitRequestBtn');

            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';

            try {
                const serviceType = document.getElementById('serviceType').value;
                const title = document.getElementById('requestTitle').value.trim();
                const description = document.getElementById('requestDescription').value.trim();
                const urgency = document.querySelector('input[name="urgency"]:checked').value;

                const useDifferentLocation = document.getElementById('differentLocation').checked;
                let locationData;

                if (useDifferentLocation) {
                    const customLocation = {
                        area_name: document.getElementById('customAreaName').value.trim(),
                        landmark: document.getElementById('customLandmark').value.trim() || null,
                        city: document.getElementById('customCity').value,
                        state: document.getElementById('customState').value,
                        pin_code: document.getElementById('customPinCode').value.trim()
                    };

                    infoDiv.textContent = 'üìç Finding service location...';
                    infoDiv.classList.remove('hidden');

                    const coords = await getCoordinates(customLocation);
                    
                    locationData = {
                        address: [customLocation.area_name, customLocation.landmark, customLocation.city, customLocation.state, customLocation.pin_code].filter(Boolean).join(', '),
                        latitude: coords.lat,
                        longitude: coords.lng
                    };
                } else {
                    locationData = {
                        address: [currentProfile.area_name, currentProfile.landmark, currentProfile.city, currentProfile.state, currentProfile.pin_code].filter(Boolean).join(', '),
                        latitude: currentProfile.latitude,
                        longitude: currentProfile.longitude
                    };
                }

                infoDiv.textContent = 'üíæ Creating request...';

                const { error } = await supabase.from('requests').insert([{
                    user_id: currentUser.id,
                    service_category: serviceType,
                    title: title,
                    description: description,
                    urgency: urgency,
                    request_location_address: locationData.address,
                    request_latitude: locationData.latitude,
                    request_longitude: locationData.longitude,
                    status: 'open',
                    chat_status: 'active'
                }]);

                if (error) throw error;

                infoDiv.classList.add('hidden');
                alert('‚úÖ Request created successfully!');
                showDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Request';
                infoDiv.classList.add('hidden');
            }
        });

// Edit Profile Form Submission
document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const errorDiv = document.getElementById('editProfileError');
    const infoDiv = document.getElementById('editProfileInfo');
    const submitBtn = document.getElementById('saveProfileBtn');
    
    errorDiv.classList.add('hidden');
    infoDiv.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    try {
        const formData = {
            name: document.getElementById('editName').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            house_number: document.getElementById('editHouseNumber').value.trim() || null,
            area_name: document.getElementById('editAreaName').value.trim(),
            landmark: document.getElementById('editLandmark').value.trim() || null,
            city: document.getElementById('editCity').value,
            state: document.getElementById('editState').value,
            pin_code: document.getElementById('editPinCode').value.trim(),
            is_provider: currentProfile.is_provider,
            radius_km: parseInt(document.getElementById('editRadius').value)
        };
        
        // Check if address changed
        const addressChanged = 
            formData.area_name !== currentProfile.area_name ||
            formData.city !== currentProfile.city ||
            formData.state !== currentProfile.state ||
            formData.pin_code !== currentProfile.pin_code;
        
        if (addressChanged) {
            infoDiv.textContent = 'üìç Updating location...';
            infoDiv.classList.remove('hidden');
            
            const coords = await getCoordinates(formData);
            formData.latitude = coords.lat;
            formData.longitude = coords.lng;
        }
        
        infoDiv.textContent = 'üíæ Saving profile...';
        infoDiv.classList.remove('hidden');
        
        // Update profile
        const { error: profileError } = await supabase
            .from('profiles')
            .update(formData)
            .eq('user_id', currentProfile.user_id);
        
        if (profileError) throw profileError;
        
        // If provider was toggled OFF, remove all services
        if (!formData.is_provider && currentProfile.is_provider) {
            const { error: deleteError } = await supabase
                .from('provider_services')
                .delete()
                .eq('provider_id', currentProfile.user_id);
            
            if (deleteError) throw deleteError;
        }
        
        // If radius changed, update all existing services
        if (formData.is_provider && formData.radius_km !== currentProfile.radius_km) {
            const { error: updateRadiusError } = await supabase
                .from('provider_services')
                .update({ service_radius: formData.radius_km })
                .eq('provider_id', currentProfile.user_id);
            
            if (updateRadiusError) throw updateRadiusError;
        }
        
        alert('‚úÖ Profile updated successfully!');
        await loadProfile();
        showDashboard();
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üíæ Save Changes';
        infoDiv.classList.add('hidden');
    }
});

        // Logout
        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
            }
            
            await supabase.auth.signOut();
            currentUser = null;
            currentProfile = null;
            location.reload();
        }

// Collapsible Section Management
        let currentRequestFilter = 'all';
        let currentUrgencyFilter = 'all';
	
	// User dropdown toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('active');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('userDropdown');
    
    if (userMenu && dropdown && !userMenu.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});
        
	function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        function filterMyRequests(filter) {
            currentRequestFilter = filter;
            
            // Update active tab
            document.querySelectorAll('#seekerSection .sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload and filter requests
            loadUserRequests();
        }

        function filterByUrgency(urgency) {
            currentUrgencyFilter = urgency;
            
            // Update active tab
            document.querySelectorAll('#urgencyTabs .sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload and filter nearby requests
            loadNearbyRequests();
        }

        function updateSectionBadges() {
            // This will be called after loading data to update badge counts
        }

// Rating System Functions
        let currentRatingData = null;
        let selectedRating = 0;

        function openRatingModal(requestId, providerId, providerName) {
            currentRatingData = { requestId, providerId, providerName };
            selectedRating = 0;
            
            document.getElementById('ratingProviderName').textContent = providerName;
            document.getElementById('ratingReview').value = '';
            document.getElementById('reviewCounter').textContent = '0';
            document.getElementById('ratingError').classList.add('hidden');
            document.getElementById('ratingText').textContent = 'Select Rating';
            
            // Reset stars
            document.querySelectorAll('.star').forEach(star => {
                star.classList.remove('selected');
                star.textContent = '‚òÜ';
            });
            
            document.getElementById('ratingModal').classList.add('active');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
            currentRatingData = null;
            selectedRating = 0;
        }

        function selectRating(rating) {
            selectedRating = rating;
            
            const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('ratingText').textContent = ratingTexts[rating];
            
            // Update star display
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('selected');
                    star.textContent = '‚òÖ';
                } else {
                    star.classList.remove('selected');
                    star.textContent = '‚òÜ';
                }
            });
        }

        async function submitRating() {
            if (selectedRating === 0) {
                document.getElementById('ratingError').textContent = 'Please select a rating';
                document.getElementById('ratingError').classList.remove('hidden');
                return;
            }
            
            const submitBtn = document.getElementById('submitRatingBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                // Check for duplicate rating
                const { data: existingRating } = await supabase
                    .from('ratings')
                    .select('id')
                    .eq('request_id', currentRatingData.requestId)
                    .eq('user_id', currentUser.id);
                
                if (existingRating && existingRating.length > 0) {
                    alert('‚ö†Ô∏è You have already rated this provider for this request!');
                    closeRatingModal();
                    return;
                }
                
                const review = document.getElementById('ratingReview').value.trim();
                
                const { error } = await supabase
                    .from('ratings')
                    .insert([{
                        request_id: currentRatingData.requestId,
                        user_id: currentUser.id,
                        provider_id: currentRatingData.providerId,
                        rating: selectedRating,
                        review: review || null
                    }]);
                
                if (error) throw error;
                
                alert('‚úÖ Rating submitted successfully! Thank you for your feedback.');
                closeRatingModal();
                loadUserRequests();
                
            } catch (error) {
                document.getElementById('ratingError').textContent = 'Error: ' + error.message;
                document.getElementById('ratingError').classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Rating';
            }
        }

        // Review character counter
        document.addEventListener('DOMContentLoaded', () => {
            const reviewTextarea = document.getElementById('ratingReview');
            if (reviewTextarea) {
                reviewTextarea.addEventListener('input', (e) => {
                    document.getElementById('reviewCounter').textContent = e.target.value.length;
                });
            }
        });
    </script>
</body>
</html>